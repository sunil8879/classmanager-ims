<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Supabase JS Library CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Class Manager - IMS</title>
    <!-- PWA Setup -->
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
:root {
            --aquamarine: #7FFFD4;
            --white: #ffffff;
            --dark: #000000;
            --shadow-aqua: #66ccaa; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--white);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- HEADER & 3D SPLIT TITLE --- */
        header {
            background: linear-gradient(135deg, var(--white), var(--aquamarine));
            padding: 30px 5%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            border-bottom: 5px solid #000;
        }

        .rotating-logo {
            width: 60px; height: 60px;
            background: #000; border-radius: 20%;
            display: flex; align-items: center; justify-content: center;
            animation: rotate3D 5s linear infinite;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .rotating-logo img { width: 100%; height: 100%; object-fit: contain; }
        @keyframes rotate3D { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }

 /* --- TITLE BOX FIX --- */
        .title-box {
            transform: rotate(-3deg);
            text-align: center;
            display: flex;         /* Use flexbox to stack items */
            flex-direction: column; /* Stack vertically */
            align-items: center;    /* Center horizontally */
        }

        .tagline {
            display: block;         /* Force it to its own line */
            font-size: 1.5rem;
            color: #000;
            font-weight: 600;
            margin-top: 10px;       /* Adds space between Title and Tagline */
            letter-spacing: 2px;
            font-family: 'Times New Roman', Times, serif;
        }
        .main-title {
            font-size: 4rem; font-weight: 900; line-height: 1;
            display: inline-block; text-transform: uppercase;
            background: linear-gradient(to bottom, #ff0000 50%, #000000 50%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(1px 1px 0px #ccc) drop-shadow(2px 2px 0px #bbb) drop-shadow(3px 3px 0px #aaa) drop-shadow(5px 5px 10px rgba(0,0,0,0.4));
        }

        /* --- SIDE-BY-SIDE LAYOUT --- */
        .app-container {
            display: flex;
            flex-direction: row; /* FORCES SIDE BY SIDE */
            flex: 1;
            width: 100%;
        }

        /* --- LEFT SIDEBAR (PURE WHITE) --- */
        nav.sidebar {
            width: 300px;
            min-width: 300px;
            background: #ffffff;
            padding: 30px 15px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .nav-tab {
            width: 100%;
            padding: 15px 20px;
            border: none;
            background: #ffffff;
            color: #000000 !important;
            text-align: left;
            font-size: 1.1rem;
            font-weight: bold;
            font-family: 'Times New Roman', Times, serif !important;
            cursor: pointer;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-radius: 10px;
            /* 3D EFFECT */
            box-shadow: 0 5px 0px #cccccc, 0 5px 10px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .nav-tab:hover {
            transform: translateY(-5px); /* RISE UP */
            box-shadow: 0 10px 0px #bbbbbb, 0 15px 25px rgba(0,0,0,0.15);
        }

        .nav-tab.active { background: #f0f0f0; border-left: 6px solid #ff0000; top: 2px; }

        /* --- RIGHT MAIN AREA (AQUAMARINE) --- */
        main.content {
            flex: 1;
            padding: 50px;
            background: var(--aquamarine);
            font-family: 'Times New Roman', Times, serif !important;
            color: #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .content-section { display: none; width: 100%; animation: fadeIn 0.5s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS (AQUAMARINE WITH 3D RISE) --- */
        .card {
            background: var(--aquamarine);
            color: #000000;
            padding: 40px;
            border-radius: 20px;
            margin: 0 auto 40px;
            max-width: 900px;
            border: 2px solid #000;
            /* 3D EFFECT */
            box-shadow: 0 10px 0px var(--shadow-aqua), 0 15px 30px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
        }

        .card:hover {
            transform: translateY(-10px); /* RISE UP */
            box-shadow: 0 20px 0px var(--shadow-aqua), 0 30px 45px rgba(0,0,0,0.3);
        }

        .card h3, .card h2, .card h4 {
            color: #000 !important;
            font-family: 'Times New Roman', Times, serif !important;
            margin-bottom: 20px;
            text-decoration: underline;
        }

        /* Forms & Writeup centered on Home, but structured on Internal */
        .bullet-list { list-style: none; padding: 0; margin: 20px auto; display: inline-block; text-align: left; }
        .bullet-list li { margin: 12px 0; padding-left: 30px; position: relative; font-size: 1.3rem; }
        .bullet-list li::before { content: '✕'; color: #ff0000; position: absolute; left: 0; font-weight: bold; }

        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; text-align: left;
        }

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-weight: bold; color: #000; }

        input, select, textarea {
            padding: 12px; border: 1px solid #000; border-radius: 8px;
            font-family: 'Times New Roman', Times, serif !important;
            background: #fff; color: #000;
        }

        .button-row { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .btn-add, .btn-edit, .btn-fetch {
            padding: 12px 25px; border-radius: 8px; border: 1px solid #000; color: white;
            font-family: 'Times New Roman', Times, serif !important; font-weight: bold;
            box-shadow: 0 4px 0px rgba(0,0,0,0.3); cursor: pointer;
        }
        .btn-add { background: #27ae60; }
        .btn-edit { background: #f39c12; }
        .btn-fetch { background: #007bff; }

        /* --- FOOTER (Times New Roman, 5 Columns) --- */
        footer {
            background: #1a1a1a;
            color: white;
            padding: 60px 5% 40px;
            font-family: 'Times New Roman', Times, serif !important;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 50px;
            text-align: left;
        }

        .footer-col h4 { color: var(--aquamarine); margin-bottom: 20px; text-transform: uppercase; }
        .footer-col ul { list-style: none; }
        .footer-col ul li a { color: #ccc; text-decoration: none; }
        .footer-bottom { border-top: 1px solid #333; padding-top: 30px; text-align: center; }

        /* PWA INSTALL BUTTON (RESTORED) */
        #pwa-install-btn {
            position: fixed; bottom: 30px; right: 30px;
            background: white; color: #ff0000; border: 3px solid #ff0000;
            padding: 15px 30px; border-radius: 50px; font-weight: 900;
            font-family: 'Times New Roman', Times, serif !important;
            cursor: pointer; z-index: 10000; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: 0.3s;
        }
        #pwa-install-btn:hover { transform: scale(1.1) translateY(-5px); background: #ff0000; color: #fff; }

        @media (max-width: 992px) {
            .app-container { flex-direction: column; }
            nav.sidebar { width: 100%; min-width: 100%; flex-direction: row; overflow-x: auto; height: auto; }
            .nav-tab { white-space: nowrap; width: auto; }
            .footer-grid { grid-template-columns: repeat(2, 1fr); }
        }




/* --- AUTH STATUS BAR --- */
        #auth-status-bar {
            display: none; /* Hidden by default, shown via JS */
            flex-direction: row;
        }

        .btn-logout {
            background: #ff0000;
            color: #fff;
            border: 1px solid #000;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Times New Roman', Times, serif !important;
            font-weight: bold;
            box-shadow: 0 4px 0px #990000;
            transition: 0.2s;
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0px #990000;
        }

        .btn-logout:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0px #990000;
        }



#absent-wa-link {
    box-shadow: 0 4px 0px #128C7E;
    transition: 0.2s;
}
#absent-wa-link:hover {
    transform: translateY(-3px);
    box-shadow: 0 7px 0px #128C7E;
}


#upi-qr-area {
    box-shadow: 0 10px 0px #cccccc;
    transition: 0.3s;
}
#upi-qr-area:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 0px #bbbbbb;
}
#upi-qr-img {
    display: block;
    margin: 0 auto;
}




--shadow-aqua: #66ccaa; 
    }

    /* ADD THIS DASHBOARD CSS */
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        width: 100%;
        max-width: 900px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        text-align: center;
        border: 1px solid #000;
    }
    .stat-card p { font-weight: bold; font-size: 0.9rem; color: #666; margin-bottom: 10px; }
    .stat-card h4 { font-size: 2rem !important; margin: 0 !important; text-decoration: none !important; }

    * { box-sizing: border-box; margin: 0; padding: 0; }







/* --- MOBILE COMPLIANCE ADDITIONS (OVERRIDE ONLY) --- */
@media (max-width: 768px) {
    /* 1. Shrink the giant 3D title so it fits on one screen */
    .main-title { 
        font-size: 1.8rem !important; 
    }
    .tagline { 
        font-size: 0.9rem !important; 
    }
    header { 
        flex-direction: column !important; 
        padding: 15px !important; 
        gap: 10px !important; 
    }

    /* 2. Change Sidebar to a Horizontal Scroll bar at the top */
    .app-container { 
        flex-direction: column !important; 
    }
    nav.sidebar {
        width: 100% !important;
        min-width: 100% !important;
        flex-direction: row !important;
        overflow-x: auto !important;
        padding: 10px !important;
        position: sticky !important;
        top: 0 !important;
        background: #fff !important;
        border-bottom: 2px solid #ddd !important;
        z-index: 1000 !important;
    }
    .nav-tab {
        margin-bottom: 0 !important;
        margin-right: 10px !important;
        padding: 10px 15px !important;
        font-size: 0.85rem !important;
        white-space: nowrap !important; /* Prevents text from wrapping */
    }

    /* 3. Reduce huge desktop padding and stack all grids into 1 column */
    main.content { 
        padding: 15px !important; 
    }
    .card { 
        padding: 20px !important; 
        margin-bottom: 20px !important; 
    }
    .form-grid, .dashboard-stats, .feature-grid, .footer-grid {
        grid-template-columns: 1fr !important; 
    }

    /* 4. Make buttons easier to click with thumbs */
    .button-row { 
        flex-direction: column !important; 
        width: 100% !important; 
    }
    .btn-add, .btn-edit, .btn-fetch { 
        width: 100% !important; 
    }

    /* 5. Adjust Auth bar for small screens */
    #auth-status-bar {
        flex-direction: column !important;
        gap: 10px !important;
        text-align: center !important;
    }
}
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <!-- Provision for Logo -->
            <div class="rotating-logo">
    <img src="classmanager.png" alt="ClassManager Logo">
</div>

        </div>
        <div class="title-box">
            <h1 class="main-title">CLASS MANAGER- IMS</h1>
            <span class="tagline">Track Right, Grow Bright.</span>
        </div>
    </header>






<!-- ADD THIS NEW BAR HERE -->
<div id="auth-status-bar" style="display: none; background: #ffffff; padding: 10px 5%; border-bottom: 2px solid #000; justify-content: space-between; align-items: center; font-family: 'Times New Roman', Times, serif;">
    <h3 id="user-greeting" style="color: #000; margin: 0;"></h3>
    <button id="logout-btn" onclick="handleLogout()" class="btn-logout">Logout</button>
</div>








    <div class="app-container">
        <aside class="sidebar">
            <button class="nav-tab active" onclick="showSection('home')"><i class="fas fa-home"></i> Home</button>
            <button class="nav-tab" onclick="showSection('login')"><i class="fas fa-user-lock"></i> Login System</button>
            <button class="nav-tab" onclick="showSection('students')"><i class="fas fa-user-graduate"></i> Student Management</button>
            <button class="nav-tab" onclick="showSection('fee')"><i class="fas fa-money-bill-wave"></i> Fee Management</button>
            <button class="nav-tab" onclick="showSection('batch')"><i class="fas fa-layer-group"></i> Batch Management</button>
            <button class="nav-tab" onclick="showSection('attendance')"><i class="fas fa-clipboard-check"></i> Attendance</button>
            <button class="nav-tab" onclick="showSection('admin')"><i class="fas fa-user-shield"></i> Admin Dashboard</button>
            <button class="nav-tab" onclick="showSection('reminder')"><i class="fas fa-bell"></i> Fee Reminder System</button>
            <button class="nav-tab" onclick="showSection('leads')"><i class="fas fa-funnel-dollar"></i> Lead Management</button>
            <button class="nav-tab" onclick="showSection('expense')"><i class="fas fa-wallet"></i> Expense Tracking</button>
            <button class="nav-tab" onclick="showSection('teacher')"><i class="fas fa-chalkboard-teacher"></i> Teacher Portal</button>
            <button class="nav-tab" onclick="showSection('student-p')"><i class="fas fa-user"></i> Students Portal</button>
            <button class="nav-tab" onclick="showSection('id-gen')"><i class="fas fa-id-card"></i> ID Card Generator</button>
            <button class="nav-tab" onclick="showSection('cert-gen')"><i class="fas fa-certificate"></i> Certificate Generator</button>
            <button class="nav-tab" onclick="showSection('tracking')"><i class="fas fa-chart-line"></i> Performance Tracking</button>
<button class="nav-tab" onclick="showSection('exam-mod')"><i class="fas fa-file-signature"></i> Exam Management</button>
<button class="nav-tab" onclick="showSection('t-attn-mod')"><i class="fas fa-user-check"></i> Teacher Attendance</button>
        </aside>

        <main class="content" id="main-content">
            <!-- DEFAULT HOME PAGE -->
           <!-- DEFAULT HOME PAGE -->
            <section id="home" class="content-section active">
    <!-- 1. DISPLAY THIS ONLY FOR LOGGED-IN OWNERS -->
    <div id="home-user-view" style="display: none; width: 100%;">
        <div class="dashboard-stats" style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px;">
            <div class="stat-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); text-align: center; border: 1px solid #000; min-width: 200px; border-bottom: 5px solid #27ae60;">
                <p style="font-weight: bold; color: #666; margin-bottom: 10px;">ADMISSIONS</p>
                <h4 id="home-total-stu" style="font-size: 2.5rem; margin: 0; color: #000;">0</h4>
                <small>Active Students</small>
            </div>
            <div class="stat-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); text-align: center; border: 1px solid #000; min-width: 200px; border-bottom: 5px solid #1877F2;">
                <p style="font-weight: bold; color: #666; margin-bottom: 10px;">COLLECTION</p>
                <h4 id="home-total-coll" style="font-size: 2.5rem; margin: 0; color: #000;">₹ 0</h4>
                <small>Total Received</small>
            </div>
            <div class="stat-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); text-align: center; border: 1px solid #000; min-width: 200px; border-bottom: 5px solid #ff0000;">
                <p style="font-weight: bold; color: #666; margin-bottom: 10px;">PENDING</p>
                <h4 id="home-total-pend" style="font-size: 2.5rem; margin: 0; color: #ff0000;">₹ 0</h4>
                <small>Outstanding Fees</small>
            </div>
        </div>
    </div>

    <!-- 2. DISPLAY THIS FOR VISITORS (YOUR ORIGINAL CONTENT) -->
    <div id="home-visitor-view">
        <div class="card">
            <h2 class="hero-title" style="color: white; text-decoration: none;">Still managing your institute manually?</h2>
            <ul class="bullet-list">
                <li>Tracking fees in notebooks?</li>
                <li>Forgetting pending payments?</li>
                <li>Managing students in Excel?</li>
                <li>Confused batch records?</li>
            </ul>
            <span class="solve-text">ClassManager solves all this.</span>
        </div>
    </div>

    <!-- The rest of your "Features" list stays here below -->
    <hr style="margin: 40px 0; border: 1px solid rgba(0,0,0,0.1);">
    <h2 style="font-size: 2.2rem; margin-bottom: 30px;">Everything you need to manage your institute</h2>
    <!-- ... (rest of your feature-grid code) ... -->
</section>

          <!-- 1. LOGIN SYSTEM -->

<section id="login" class="content-section">
    <div style="display: flex; gap: 40px; flex-wrap: wrap;">
        <!-- Signup -->
        <div class="card" style="flex: 1; min-width: 320px;">
            <h3>Signup</h3>
            <div class="form-grid" style="grid-template-columns: 1fr;" id="signup-form">
                <input type="text" id="sig-name" placeholder="Full Name">
                <select id="sig-role">
                    <option value="">Select Status</option>
                    <option>Owner</option>
                    <option>Teacher</option>
                    <option>Student</option>
                </select>
                <input type="email" id="sig-email" placeholder="Email Id">
                
                <div style="position: relative;">
                    <input type="password" id="sig-pass" placeholder="Password (Min 6 chars)" style="width: 100%;">
                    <i class="fas fa-eye" onclick="togglePass('sig-pass')" style="position: absolute; right: 10px; top: 12px; cursor: pointer; color: #666;"></i>
                </div>

                <select id="sig-state">
                    <option value="">Select State / UT</option>
                    <optgroup label="States">
                        <option>Andhra Pradesh</option><option>Arunachal Pradesh</option><option>Assam</option><option>Bihar</option><option>Chhattisgarh</option><option>Goa</option><option>Gujarat</option><option>Haryana</option><option>Himachal Pradesh</option><option>Jharkhand</option><option>Karnataka</option><option>Kerala</option><option>Madhya Pradesh</option><option>Maharashtra</option><option>Manipur</option><option>Meghalaya</option><option>Mizoram</option><option>Nagaland</option><option>Odisha</option><option>Punjab</option><option>Rajasthan</option><option>Sikkim</option><option>Tamil Nadu</option><option>Telangana</option><option>Tripura</option><option>Uttar Pradesh</option><option>Uttarakhand</option><option>West Bengal</option>
                    </optgroup>
                    <optgroup label="Union Territories">
                        <option>Andaman and Nicobar Islands</option><option>Chandigarh</option><option>Dadra and Nagar Haveli and Daman and Diu</option><option>Delhi</option><option>Jammu and Kashmir</option><option>Ladakh</option><option>Lakshadweep</option><option>Puducherry</option>
                    </optgroup>
                </select>

                <input type="text" id="sig-mobile" placeholder="10-Digit Mobile Number" maxlength="10">
                
                <div class="button-row">
                    <button class="btn-fetch" onclick="handleSignup()">Sign up</button>
                    <button class="btn-edit" style="background:#666;" onclick="clearForm('signup-form')">Clear</button>
                </div>
            </div>
        </div>

        <!-- Login -->
        <div class="card" style="flex: 1; min-width: 320px;">
            <h3>Login</h3>
            <div class="form-grid" style="grid-template-columns: 1fr;" id="login-form">
                <select id="log-role">
                    <option value="">Select Status</option>
                    <option>Owner</option>
                    <option>Teacher</option>
                    <option>Student</option>
                </select>
                <input type="email" id="log-email" placeholder="Email Id">
                <div style="position: relative;">
                    <input type="password" id="log-pass" placeholder="Password">
                    <i class="fas fa-eye" onclick="togglePass('log-pass')" style="position: absolute; right: 10px; top: 12px; cursor: pointer; color: #666;"></i>
                </div>
                <div class="button-row">
                    <button class="btn-add" onclick="handleLogin()">Login</button>
                    <button class="btn-edit" style="background:#666;" onclick="clearForm('login-form')">Clear</button>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- 2. STUDENT MANAGEMENT -->
<!-- 2. STUDENT MANAGEMENT -->
<section id="students" class="content-section">
    <div class="card">
        <h3><i class="fas fa-user-plus"></i> Student Management</h3>
        <div class="form-grid">
            <div class="input-group"><label>Admission Date</label><input type="date" id="stu-date"></div>
            <div class="input-group"><label>Full Name</label><input type="text" id="stu-name" placeholder="Full Name"></div>
            <div class="input-group"><label>Mobile Number (10 Digits)</label><input type="text" id="stu-mobile" placeholder="Mobile" maxlength="10"></div>
            <div class="input-group"><label>Father's Mobile</label><input type="text" id="stu-father" maxlength="10"></div>
            <div class="input-group"><label>Mother's Mobile</label><input type="text" id="stu-mother" maxlength="10"></div>
            <div class="input-group"><label>Class / Standard</label><input type="text" id="stu-standard"></div>
            <div class="input-group"><label>Batch Time</label><input type="time" id="stu-batch"></div>
            <div class="input-group"><label>Course</label><input type="text" id="stu-course" placeholder="Course"></div>
            
            <div class="input-group"><label>Total Fees</label><input type="number" id="stu-total" oninput="calcStuPending()"></div>
            <div class="input-group"><label>Paid Amount</label><input type="number" id="stu-paid" oninput="calcStuPending()"></div>
            <div class="input-group"><label>Pending Amount</label><input type="number" id="stu-pending" readonly style="background:#eee;"></div>
            
            <div class="input-group">
                <label>Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="stu-roll" placeholder="Click Generate" readonly style="background: #eee;">
                    <button class="btn-fetch" onclick="generateRollNow()" style="padding: 5px;">Gen</button>
                </div>
            </div>
            <div class="input-group"><label>Course End Date</label><input type="date" id="stu-end-date"></div>
        </div>
        <div class="button-row">
           <button class="btn-add" onclick="addStudent()">ADD Student</button>
           <button class="btn-edit" onclick="editStudentByRoll()">EDIT (by Roll No)</button>
           <button class="btn-fetch" onclick="fetchStudentByRoll()">FETCH (by Roll No)</button>
           <button class="btn-edit" style="background:#666;" onclick="clearStudentForm()">Clear</button>
        </div>
    </div>
</section>
<!-- 3. FEE MANAGEMENT -->
<!-- 3. FEE MANAGEMENT -->
<section id="fee" class="content-section">
    <!-- Part 1: FEE DETAILS -->
    <div class="card" style="margin-bottom: 30px;">
        <h3>1. FEE DETAILS</h3>
        <div class="form-grid">
            <div class="input-group"><label>Date Today</label><input type="date" id="fee-today"></div>
            <div class="input-group"><label>Roll Number</label><input type="text" id="fee-roll" placeholder="IMS-2026-XXXX"></div>
            <div class="input-group"><label>Full Name</label><input type="text" id="fee-name" placeholder="Initial + Surname"></div>
            <div class="input-group"><label>Date of Joining</label><input type="date" id="fee-join-date"></div>
            <div class="input-group"><label>Course Name</label><input type="text" id="fee-course" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Total Fees</label><input type="number" id="fee-total"></div>
            <div class="input-group"><label>Previously Paid</label><input type="number" id="fee-prev-paid" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Amount Now Paying</label><input type="number" id="fee-paid-now" oninput="calcPendingFee()"></div>
            <div class="input-group"><label>Pending Fees</label><input type="number" id="fee-pending" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Due Dates</label><input type="text" id="fee-due-dates" placeholder="March 2026, July 2026"></div>
            <div class="input-group">
                <label>Status</label>
                <select id="fee-status"><option value="Active">Active</option><option value="Closed">Closed</option></select>
            </div>
        </div>
        <div class="button-row">
            <button class="btn-fetch" onclick="fetchFeeByRoll()">FETCH Details</button>
            <button class="btn-add" onclick="saveFeeUpdate()">ADD Payment</button>
        </div>



<!-- START: UPI QR Generator Area -->
<div id="upi-qr-area" style="display: none; margin-top: 30px; padding: 20px; background: #fff; border-radius: 15px; border: 2px solid #000; text-align: center;">
    <h4 style="color: #000; margin-bottom: 15px;">Scan to Pay Fees</h4>
    <div id="qr-container" style="background: #fff; padding: 10px; display: inline-block; border-radius: 10px; border: 1px solid #ddd;">
        <img id="upi-qr-img" src="" alt="UPI QR Code" style="width: 200px; height: 200px;">
    </div>
    <p style="margin-top: 10px; font-weight: bold; color: #1877F2;">Amount: ₹ <span id="disp-qr-amt">0</span></p>
    <p style="font-size: 0.8rem; color: #666;">Generated for: <span id="disp-qr-name">Student</span></p>
</div>

<div class="button-row" style="margin-top: 15px;">
    <button class="btn-add" style="background: #1877F2; width: 100%;" onclick="generateUPIQR()">
        <i class="fas fa-qrcode"></i> GENERATE PAYMENT QR
    </button>
</div>
<!-- END: UPI QR Generator Area -->
    </div>

    <!-- Part 2: FEES PORTAL -->
    <div class="card" style="margin-bottom: 30px; border-top-color: #007bff;">
        <h3>2. FEES PORTAL</h3>
        <div class="form-grid">
            <div class="input-group"><label>Filter Month & Year (Calendar)</label><input type="month" id="portal-calendar" onchange="loadFeesPortal()"></div>
            <div class="input-group"><label>Select Year for Collection</label><input type="number" id="portal-year" value="2026" onchange="loadFeesPortal()"></div>
        </div>
        <div class="dashboard-stats">
            <div class="stat-card"><p>Active Students</p><h4 id="stat-active-count">0</h4></div>
            <div class="stat-card"><p>Total Received</p><h4 id="stat-total-received">₹ 0</h4></div>
            <div class="stat-card"><p>Total Pending</p><h4 id="stat-total-pending" style="color:red;">₹ 0</h4></div>
            <div class="stat-card"><p id="yearly-label">Yearly Collection</p><h4 id="stat-yearly" style="color:green;">₹ 0</h4></div>
        </div>
    </div>

    <!-- Part 3: PAYMENT LOG -->
    <div class="card">
        <h3>3. PAYMENT LOG</h3>
        <div class="form-grid">
            <div class="input-group"><label>Select Month (Calendar)</label><input type="month" id="log-calendar"></div>
            <div class="input-group"><label>Student Roll Number</label><input type="text" id="log-roll" placeholder="IMS-XXXX"></div>
            <button class="btn-fetch" style="margin-top:25px;" onclick="fetchPaymentLog()">View Payments</button>
        </div>
        <div id="log-result" style="margin-top:20px; padding:15px; background:#f9f9f9; border-radius:8px;">
            <i>Select month and roll number to view history.</i>
        </div>
    </div>
</section>
<!-- 4. BATCH MANAGEMENT -->
<section id="batch" class="content-section">
    <div class="card">
        <h3><i class="fas fa-layer-group"></i> Batch Management</h3>
        <div class="form-grid">
            <input type="text" id="batch-name" placeholder="Batch Name">
            <input type="text" id="batch-teacher-id" placeholder="Teacher ID (e.g. TCH-1234)">
            <input type="text" id="batch-teacher-name" placeholder="Teacher Name">
            <input type="time" id="batch-time">
            <input type="text" id="batch-subject" placeholder="Subject Name">
            <input type="number" id="batch-students" placeholder="Students Allotted">
            <input type="text" id="batch-remarks" placeholder="Remarks">
        </div>
        <div class="button-row">
            <button class="btn-add" onclick="addBatch()">ADD Batch</button>
            <button class="btn-fetch" onclick="fetchBatch()">FETCH (by Name)</button>
        </div>
    </div>
</section>

<!-- 5. ATTENDANCE -->
<!-- 5. ATTENDANCE -->
<section id="attendance" class="content-section">
    <div class="card">
        <h3><i class="fas fa-clipboard-check"></i> Attendance Tracker</h3>
        
        <!-- Student Link Fields -->
        <div class="form-grid">
            <div class="input-group">
                <label>Student Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="attn-roll" placeholder="e.g. IMS-2026-1234">
                    <button class="btn-fetch" onclick="fetchStudentForAttn()" style="padding: 5px 10px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group">
                <label>Student Name</label>
                <input type="text" id="attn-name" readonly style="background: #eee;" placeholder="Fetched automatically">
            </div>
        </div>

        <hr style="margin: 20px 0;">

        <div class="form-grid">
            <div class="input-group">
                <label>View Monthly Record (Old Calendar)</label>
                <input type="month" id="attn-month-view">
            </div>
            <div class="input-group">
                <label>Total Present</label>
                <input type="number" id="attn-total-p" placeholder="0" readonly>
            </div>
            <div class="input-group">
                <label>Total Absent</label>
                <input type="number" id="attn-total-a" placeholder="0" readonly>
            </div>
        </div>

        <!-- Hidden Date Picker that will be triggered by buttons -->
        <input type="date" id="attn-date-picker" style="display: none;">

        <div class="button-row">
            <button class="btn-add" onclick="triggerAttendance('Present')">
                <i class="fas fa-check-circle"></i> MARK PRESENT
            </button>
            <button class="btn-edit" style="background: #e74c3c;" onclick="triggerAttendance('Absent')">
                <i class="fas fa-times-circle"></i> MARK ABSENT
            </button>
            <button class="btn-fetch" onclick="fetchAttendanceByPrompt()">
                <i class="fas fa-sync"></i> Fetch Statistics
            </button>
        </div>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">* Clicking Mark buttons will open a calendar to select the date.</p>



<div id="whatsapp-alert-area" style="display: none; margin-top: 20px; padding: 15px; background: #fff; border-radius: 10px; border: 2px dashed #25D366; text-align: center;">
            <p style="color: #000; font-weight: bold; margin-bottom: 10px;">⚠️ Student is Absent! Notify parents?</p>
            <a id="absent-wa-link" href="#" target="_blank" style="background: #25D366; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fab fa-whatsapp"></i> SEND ABSENT ALERT
            </a>
        </div>



    </div>
</section>

<!-- 6. ADMIN DASHBOARD -->
<!-- 6. ADMIN DASHBOARD -->
<section id="admin" class="content-section">
    <div class="card" style="margin-bottom: 20px; border-top-color: #007bff;">
        <h3><i class="fas fa-chart-pie"></i> Analytics Filter</h3>
        <div class="form-grid">
            <div class="input-group">
                <label>Report Type</label>
                <select id="admin-filter-type" onchange="toggleAdminCalendar()">
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>
            <div class="input-group" id="admin-month-container">
                <label>Select Month</label>
                <input type="month" id="admin-filter-month" onchange="loadAdminDashboard()">
            </div>
            <div class="input-group" id="admin-year-container" style="display:none;">
                <label>Select Year</label>
                <input type="number" id="admin-filter-year" value="2026" onchange="loadAdminDashboard()">
            </div>
            <div class="input-group" id="admin-quarter-container" style="display:none;">
                <label>Select Quarter</label>
                <select id="admin-filter-quarter" onchange="loadAdminDashboard()">
                    <option value="1">Q1 (Jan - Mar)</option>
                    <option value="2">Q2 (Apr - Jun)</option>
                    <option value="3">Q3 (Jul - Sep)</option>
                    <option value="4">Q4 (Oct - Dec)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="dashboard-stats">
        <div class="stat-card">
            <p>Total Students</p>
            <h4 id="dash-students">0</h4>
            <small class="filter-label"></small>
        </div>
        <div class="stat-card">
            <p>Total Revenue</p>
            <h4 id="dash-revenue" style="color: green;">₹ 0</h4>
            <small class="filter-label"></small>
        </div>
        <div class="stat-card">
            <p>Pending Fees</p>
            <h4 id="dash-pending" style="color: red;">₹ 0</h4>
            <small class="filter-label"></small>
        </div>
        <div class="stat-card">
            <p>Attendance Avg</p>
            <h4 id="dash-attendance">0%</h4>
            <small class="filter-label"></small>
        </div>
    </div>

    <div class="card" style="margin-top:20px;">
        <h3><i class="fas fa-bell" style="color: #f39c12;"></i> Upcoming Fee Reminders (Current Month)</h3>
        <div id="reminder-list" style="margin-top:15px; max-height: 300px; overflow-y: auto;">
            <p>Loading reminders...</p>
        </div>
    </div>
</section>

<!-- 7. FEE REMINDER -->
<!-- 7. FEE REMINDER SYSTEM -->
<section id="reminder" class="content-section">
    <div class="card" style="border-top-color: #f39c12;">
        <h3><i class="fas fa-bell"></i> Fee Reminder Dashboard</h3>
        
        <!-- Year Filter -->
        <div class="input-group" style="max-width: 250px; margin-bottom: 20px;">
            <label>Select Admission Year</label>
            <input type="number" id="remind-year" value="2026" onchange="loadFeeReminders()">
        </div>

        <div class="dashboard-stats">
            <div class="stat-card" style="border-bottom-color: #e74c3c;">
                <p>Total Pending Fees (<span class="display-year">2026</span>)</p>
                <h4 id="remind-total-amt" style="color: #e74c3c;">₹ 0</h4>
            </div>
            <div class="stat-card" style="border-bottom-color: #f39c12;">
                <p>Pending Students (<span class="display-year">2026</span>)</p>
                <h4 id="remind-stu-count">0</h4>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3><i class="fas fa-list-ul"></i> Active Students with Pending Fees</h3>
        <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">List shows only "Active" students with a balance > ₹0.</p>
        
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                <thead>
                    <tr style="background: #f4f7f6; text-align: left; border-bottom: 2px solid #ddd;">
                        <th style="padding: 12px;">Roll Number</th>
                        <th style="padding: 12px;">Student Name</th>
                        <th style="padding: 12px;">Mobile</th>
                        <th style="padding: 12px;">Pending Amount</th>
                        <th style="padding: 12px;">Action</th>
                    </tr>
                </thead>
                <tbody id="reminder-table-body">
                    <!-- Dynamic Rows Here -->
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- 8. LEAD MANAGEMENT -->
<!-- 8. LEAD MANAGEMENT -->
<section id="leads" class="content-section">
    <div class="card">
        <h3><i class="fas fa-funnel-dollar"></i> Lead Management</h3>
        <div class="form-grid">
            <input type="text" id="lead-name" placeholder="Full Name">
            <input type="text" id="lead-contact" placeholder="Contact Number">
            <input type="email" id="lead-email" placeholder="Email Address">
            <input type="text" id="lead-course" placeholder="Interested Course">
            <input type="date" id="lead-date" placeholder="Date of Visit">
            <input type="text" id="lead-ref" placeholder="Reference (How they found us)">
            <select id="lead-status">
                <option value="Follow up">Status: Follow up</option>
                <option value="Converted">Converted</option>
                <option value="Not interested">Not interested</option>
            </select>
            <input type="text" id="lead-remarks" placeholder="Remarks">
        </div>
        <div class="button-row">
            <button class="btn-add" onclick="addLead()">ADD Lead</button>
            <button class="btn-fetch" onclick="fetchLead()">FETCH (by Contact)</button>
            <button class="btn-edit" style="background:#666;" onclick="clearLeadForm()">Clear</button>
        </div>
    </div>
</section>

<!-- 9. EXPENSE TRACKING -->
<!-- 9. EXPENSE TRACKING -->
<!-- 9. EXPENSE TRACKING -->
<section id="expense" class="content-section">
    <div class="card" style="border-top-color: #ff0000;">
        <h3><i class="fas fa-wallet"></i> Monthly Expense & Income Tracker</h3>
        
        <!-- CALENDAR HEADER -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 20px;">
            <div class="input-group" style="flex: 1;">
                <label>Select Month & Year</label>
                <input type="month" id="exp-month-year" onchange="fetchAutoFees()">
            </div>
            <p style="flex: 1; font-size: 0.85rem; color: #666;">* Selecting a month will automatically pull the actual Fees Collection from the database.</p>
        </div>

        <div class="form-grid">
            <div class="input-group"><label>Rent</label><input type="number" id="exp-rent" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Electricity</label><input type="number" id="exp-elec" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Maintenance</label><input type="number" id="exp-maint" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Teacher Salaries</label><input type="number" id="exp-t-sal" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Admin Salaries</label><input type="number" id="exp-a-sal" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Marketing</label><input type="number" id="exp-mark" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Other Expenses</label><input type="number" id="exp-other" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Other Income</label><input type="number" id="exp-income" value="0" oninput="calculateFinancials()"></div>
        </div>

        <div class="stat-card" style="background: #eefbff; margin-top: 20px; text-align: left;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <p>Total Fees Collection (Auto): <b id="disp-auto-fees" style="color: blue;">₹ 0.00</b></p>
                    <p>Total Expenses: <b id="disp-total-exp" style="color: red;">₹ 0.00</b></p>
                </div>
                <div style="text-align: right; border-left: 1px solid #ccc; padding-left: 20px;">
                    <h4 style="color: green;">TOTAL INCOME: <span id="disp-total-income">₹ 0.00</span></h4>
                    <p>Cost to Income Ratio: <b id="disp-ratio">0%</b></p>
                </div>
            </div>
        </div>

        <div class="button-row">
           <button class="btn-add" onclick="saveExpenses()">ADD RECORD</button>
           <button class="btn-fetch" onclick="fetchSavedExpense()">FETCH (by Month)</button>
           <button class="btn-edit" style="background:#666;" onclick="clearExpenseForm()">CLEAR</button>
        </div>
    </div>
</section>

<!-- 10. REPORTS -->
<section id="reports" class="content-section">
    <div class="card">
        <h3>Reports Center</h3>
        <ul style="line-height: 2.5;">
            <li><a href="#"><i class="fas fa-file-invoice"></i> Monthly Collection Report</a></li>
            <li><a href="#"><i class="fas fa-user-chart"></i> Student Report</a></li>
            <li><a href="#"><i class="fas fa-layer-group"></i> Batch Report</a></li>
            <li><a href="#"><i class="fas fa-check-double"></i> Attendance Report</a></li>
        </ul>
    </div>
</section>


<!-- 11. TEACHER PORTAL -->
<!-- 11. TEACHER PORTAL -->
<section id="teacher" class="content-section">
    <div class="card">
        <h3>Teacher Management</h3>
        <div class="form-grid">
            <!-- ID GENERATOR -->
       <div class="input-group" style="grid-column: 1 / -1; margin-bottom: 10px;">
                <label>Teacher ID</label>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <input type="text" id="tch-id" readonly style="flex: 1; background: #eee; border: 2px solid #007bff; padding: 10px;" placeholder="ID">
                    <button type="button" onclick="generateTchID()" 
                            style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; display: block !important; visibility: visible !important;">
                        GEN
                    </button>
                </div>
            </div>
            <!-- OTHER FIELDS -->
            <div class="input-group"><label>Teacher Name</label><input type="text" id="tch-name"></div>
            <div class="input-group"><label>Age</label><input type="number" id="tch-age"></div>
            <div class="input-group"><label>Joining Date</label><input type="date" id="tch-join"></div>
            <div class="input-group"><label>Qualification</label><input type="text" id="tch-qual"></div>
            <div class="input-group"><label>Subject Taught</label><input type="text" id="tch-subject"></div>
            <div class="input-group"><label>Salary</label><input type="number" id="tch-salary"></div>
        </div>
        <div class="button-row">
            <button class="btn-add" onclick="addTeacherDetails()">ADD Teacher</button>
            <button class="btn-fetch" onclick="fetchTeacher()">FETCH (ID)</button>
        </div>
    </div>
</section>
<!-- 12. STUDENT PORTAL (VIEW ONLY) -->
<!-- 12. STUDENT PORTAL (VIEW ONLY) -->
<section id="student-p" class="content-section">
    <div class="card" style="border-top-color: #007bff;">
        <h3><i class="fas fa-user-graduate"></i> Personal Student Dashboard</h3>
        
        <!-- Input Section -->
        <div class="form-grid" style="background: #f8f9fa; padding: 15px; border-radius: 10px; align-items: end;">
            <div class="input-group">
                <label>Enter Roll Number</label>
                <input type="text" id="portal-roll-input" placeholder="e.g. IMS-2026-1234">
            </div>
            <div class="input-group">
                <label>Select Month & Year</label>
                <input type="month" id="portal-month-input">
            </div>
            <button class="btn-fetch" onclick="fetchStudentPortalData()" style="height: 45px; font-weight: 800;">
                FETCH PERFORMANCE
            </button>
        </div>

        <hr style="margin: 30px 0;">

        <!-- Result Section (Hidden by default) -->
        <div id="portal-display-area" style="display: none;">
            <div class="form-grid" style="font-size: 1rem; line-height: 2;">
                <div>
                    <p><b>Full Name:</b> <span id="p-name">---</span></p>
                    <p><b>Course Name:</b> <span id="p-course">---</span></p>
                    <p><b>Assign Teacher:</b> <span id="p-teacher">---</span></p>
                    <p><b>Date of Joining:</b> <span id="p-join">---</span></p>
                </div>
                <div style="border-left: 1px solid #ddd; padding-left: 20px;">
                    <p><b>Total Fees Paid:</b> <span id="p-paid" style="color: green; font-weight: bold;">₹ 0</span></p>
                    <p><b>Total Fees Pending:</b> <span id="p-pending" style="color: red; font-weight: bold;">₹ 0</span></p>
                    <p><b>Days Present:</b> <span id="p-present">0</span></p>
                    <p><b>Days Absent:</b> <span id="p-absent">0</span></p>
                </div>
            </div>

            <!-- Exam Performance Card -->
            <div style="margin-top: 20px; background: #fff8ee; padding: 20px; border-radius: 12px; border: 1px solid #f39c12;">
                <h4 style="color: #f39c12; margin-bottom: 10px;"><i class="fas fa-chart-line"></i> Exam Performance</h4>
                <div class="dashboard-stats" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card" style="padding: 10px;">
                        <small>Total Marks</small>
                        <h4 id="p-total-score">0</h4>
                    </div>
                    <div class="stat-card" style="padding: 10px;">
                        <small>Exams Taken</small>
                        <h4 id="p-exam-count">0</h4>
                    </div>
                    <div class="stat-card" style="padding: 10px; border-bottom-color: #f39c12;">
                        <small>% Score</small>
                        <h4 id="p-percent">0%</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resources Section -->
    <div class="card" style="margin-top: 20px; background: #f0faff;">
        <h4><i class="fas fa-book"></i> Institute Resources</h4>
        <p>Access your study materials and textbooks below:</p>
        <a href="#" style="display: inline-block; margin-top: 10px; color: #007bff; font-weight: 600; text-decoration: none; border-bottom: 2px solid #007bff;">
            <i class="fas fa-external-link-alt"></i> Open Digital Library (Books & Resources)
        </a>
    </div>
</section>



<!-- 13. ID CARD GENERATOR -->
<!-- 13. ID CARD GENERATOR -->
<!-- 13. ID CARD GENERATOR -->
<section id="id-gen" class="content-section">
    <div class="card">
        <h3><i class="fas fa-id-card"></i> ID Card Generator</h3>
        <p>Enter Student Mobile Number and upload a photo:</p>
        
        <div class="form-grid">
            <input type="text" id="id-fetch-mobile" placeholder="Student Mobile Number">
            
            <div class="input-group">
                <label>Upload Photo</label>
                <input type="file" id="id-photo-input" accept="image/*">
            </div>

            <button class="btn-fetch" onclick="generateIDCard()">Generate & Preview</button>
        </div>

        <hr style="margin: 20px 0;">

        <!-- ID Card Visual Preview -->
        <div id="id-card-preview-area" style="display: none; justify-content: center; margin-top: 20px;">
            <div id="id-card-visual" style="width: 350px; height: 500px; background: white; border: 2px solid #007bff; border-radius: 15px; position: relative; font-family: Arial; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden;">
                
                <!-- Header -->
                <div style="background: #007bff; color: white; padding: 15px; text-align: center;">
                    <h2 id="card-inst-name" style="margin: 0; font-size: 1.2rem;">INSTITUTE NAME</h2>
                    <small id="card-branch-name">Main Branch</small>
                </div>

                <!-- Body -->
                <div style="padding: 20px; text-align: center;">
                    <!-- Photo Display -->
                    <div style="width: 100px; height: 110px; background: #eee; margin: 0 auto 15px; border: 2px solid #7FFFD4; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                        <img id="card-photo-display" src="" alt="Photo" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                        <div id="card-photo-placeholder" style="font-size: 3rem; color: #ccc;"><i class="fas fa-user"></i></div>
                    </div>

                    <!-- Details Area -->
                    <h2 id="card-student-name" style="color: #333; margin: 5px 0; font-size: 1.4rem;">Student Name</h2>
                    <p style="margin: 2px 0; color: #666;">Roll No: <b id="card-roll">---</b></p>
                    
                    <div style="text-align: center; margin-top: 20px; font-size: 0.9rem; line-height: 1.6;">
                        <p><b>Course:</b> <span id="card-course">---</span></p>
                        <p><b>Batch:</b> <span id="card-batch">---</span></p>
                        <p><b>Duration:</b> <span id="card-start">---</span> to <span id="card-end">---</span></p>
                    </div>
                </div>

                <!-- Footer -->
                <div style="position: absolute; bottom: 0; width: 100%; border-top: 1px dashed #ccc; padding: 15px; text-align: center; background: #fafafa;">
                    <div style="margin-bottom: 5px; font-weight: bold; color: #007bff;">
                       <span id="card-sign-name">Admin</span>
                    </div>
                    <small style="color: #999;">Authorised Signatory</small>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; width: 100%;">
            <button id="id-print-btn" class="btn-add" style="display: none; margin: 20px auto;" onclick="printIDCard()">
                <i class="fas fa-print"></i> Print ID Card
            </button>
        </div>
    </div>
</section>
<!-- 14. CERTIFICATE GENERATOR -->
<!-- 14. CERTIFICATE GENERATOR -->
<section id="cert-gen" class="content-section">
    <div class="card">
        <h3><i class="fas fa-certificate"></i> Professional Certificate Generator</h3>
        <div class="form-grid">
            <input type="text" id="cert-fetch-mobile" placeholder="Enter Student Mobile">
            <button class="btn-fetch" onclick="generateCertificate()">Generate Certificate</button>
        </div>

        <hr style="margin: 30px 0;">

        <!-- Certificate Preview Area -->
        <div id="cert-preview-area" style="display: none; justify-content: center;">
            <div id="certificate-visual" style="width: 800px; height: 600px; background: white; border: 15px double #007bff; padding: 40px; position: relative; font-family: 'Poppins', sans-serif; box-shadow: 0 15px 40px rgba(0,0,0,0.2); background-image: radial-gradient(#7FFFD4 0.5px, transparent 0.5px); background-size: 20px 20px;">
                
                <!-- Logo Provision (Top Right) -->
                <div style="position: absolute; top: 30px; right: 30px; width: 80px; height: 80px;">
                    <img src="classmanager.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
                </div>

                <!-- Certificate Content -->
                <div style="text-align: center; margin-top: 20px;">
                    <h1 style="color: #007bff; font-size: 3.5rem; margin-bottom: 0; font-weight: 800;">CERTIFICATE</h1>
                    <p style="letter-spacing: 5px; color: #333; font-weight: 600;">OF COMPLETION</p>
                    
                    <div style="margin-top: 40px;">
                        <p style="font-size: 1.2rem; color: #666;">This is to certify that</p>
                        <h2 id="cert-name" style="font-size: 2.5rem; color: #ff0000; border-bottom: 2px solid #ccc; display: inline-block; padding: 0 30px; margin: 10px 0;">Student Name</h2>
                        <p style="font-size: 1.1rem; color: #666; margin-top: 15px;">
                            Roll Number: <b id="cert-roll">---</b> | Certificate No: <b id="cert-number" style="color: #007bff;">---</b>
                        </p>
                    </div>

                    <div style="margin-top: 30px; line-height: 1.8;">
                        <p style="font-size: 1.3rem; color: #333;">
                            has <b>Successfully Completed the Course</b> in <br>
                            <span id="cert-course" style="font-size: 1.8rem; color: #007bff; font-weight: 700;">Course Name</span>
                        </p>
                        <p style="font-size: 1.1rem;">Course Duration: <span id="cert-duration">---</span></p>
                    </div>

                    <!-- Signatory Section -->
                    <div style="margin-top: 60px; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 50px;">
                        <div style="text-align: center;">
                            <p style="margin: 0; font-weight: bold; border-top: 1px solid #333; padding-top: 5px;" id="cert-inst-branch">Main Branch</p>
                            <small>Institute Branch</small>
                        </div>
                        <div style="text-align: center;">
                            <p style="margin: 0; font-family: 'Brush Script MT', cursive; font-size: 1.8rem; color: #333;" id="cert-signatory">Admin Name</p>
                            <p style="margin: 0; font-weight: bold; border-top: 1px solid #333; padding-top: 5px;">Authorised Signatory</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button id="cert-print-btn" class="btn-add" style="display: none; margin: 30px auto;" onclick="printCertificate()">
            <i class="fas fa-print"></i> Print Certificate
        </button>
    </div>
</section>

<!-- 15. PERFORMANCE TRACKING -->
<section id="tracking" class="content-section">
    <div class="card">
        <h3><i class="fas fa-chart-line"></i> Student Performance Tracking</h3>
        <div class="form-grid">
            <input type="text" id="perf-fetch-mobile" placeholder="Enter Student Mobile">
            <button class="btn-fetch" onclick="fetchPerformanceData()">Fetch Performance</button>
        </div>

        <hr style="margin: 20px 0;">

        <!-- Performance Dashboard (Hidden until fetched) -->
        <div id="performance-report-area" style="display: none;">
            <div class="form-grid">
                <div class="input-group"><label>Date Today</label><input type="text" id="perf-today" readonly></div>
                <div class="input-group"><label>Full Name</label><input type="text" id="perf-name" readonly></div>
                <div class="input-group"><label>Roll Number</label><input type="text" id="perf-roll" readonly></div>
                <div class="input-group"><label>Course</label><input type="text" id="perf-course" readonly></div>
                <div class="input-group"><label>Date of Joining</label><input type="text" id="perf-joining" readonly></div>
                <div class="input-group"><label>Course Duration</label><input type="text" id="perf-duration" readonly></div>
            </div>

            <div class="dashboard-stats" style="margin: 20px 0;">
                <div class="stat-card" style="border-bottom-color: #ff0000;">
                    <p>Days Absent (This Month)</p>
                    <h4 id="perf-absent">0</h4>
                </div>
                <div class="stat-card" style="border-bottom-color: #27ae60;">
                    <p>Attendance %</p>
                    <h4 id="perf-attendance-pct">0%</h4>
                </div>
            </div>

            <div class="card" style="background: #f0fffb; border: 1px solid var(--aquamarine);">
                <h4>Exam Scores & Grading</h4>
                <div class="form-grid">
                    <div class="input-group"><label>Total Marks Secured</label><input type="number" id="perf-marks" oninput="calculateAvgScore()"></div>
                    <div class="input-group"><label>Total No. of Exams</label><input type="number" id="perf-exam-count" oninput="calculateAvgScore()"></div>
                    <div class="input-group"><label>Average Score (%)</label><input type="text" id="perf-avg-display" readonly style="font-weight: bold; color: #007bff;"></div>
                    <div class="input-group"><label>Teacher's Name</label><input type="text" id="perf-teacher"></div>
                </div>
                <button class="btn-add" style="width: 100%; margin-top: 10px;" onclick="savePerformanceData()">Update Performance Record</button>
            </div>
        </div>
    </div>
</section>





<!-- EXAM MANAGEMENT SECTION -->
<section id="exam-mod" class="content-section">
    <div class="card">
        <h3><i class="fas fa-file-alt"></i> Exam Record Entry</h3>
        <div class="form-grid">
            <div class="input-group"><label>Exam Date</label><input type="date" id="ex-date"></div>
            <div class="input-group">
                <label>Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="ex-roll" placeholder="IMS-XXXX">
                    <button class="btn-fetch" onclick="fetchStudentForExam()" style="padding: 5px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group"><label>Full Name</label><input type="text" id="ex-name" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Course</label><input type="text" id="ex-course" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Total Marks</label><input type="number" id="ex-total" oninput="calcExamResult()"></div>
            <div class="input-group"><label>Marks Obtained</label><input type="number" id="ex-obt" oninput="calcExamResult()"></div>
            <div class="input-group"><label>Percentage (%)</label><input type="text" id="ex-pct" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Result</label><input type="text" id="ex-res" readonly style="font-weight:bold; background:#eee;"></div>
        </div>
        <div class="button-row">
            <button class="btn-add" onclick="addExamRecord()">ADD Result</button>
            <button class="btn-fetch" onclick="fetchExamByRoll()">FETCH (Roll No)</button>
        </div>
    </div>
</section>

<!-- TEACHER ATTENDANCE SECTION -->
<section id="t-attn-mod" class="content-section">
    <div class="card">
        <h3><i class="fas fa-calendar-check"></i> Staff Attendance Tracker</h3>
        <div class="form-grid">
            <div class="input-group"><label>Select Month/Year</label><input type="month" id="t-attn-month"></div>
            <div class="input-group">
                <label>Teacher ID</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="t-attn-id" placeholder="TCH-XXXX">
                    <button class="btn-fetch" onclick="fetchTeacherForTAttn()" style="padding: 5px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group"><label>Full Name</label><input type="text" id="t-attn-name" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Last Marked Status</label><input type="text" id="t-attn-status" readonly style="background:#eee;"></div>
        </div>
        <!-- Hidden Date Picker -->
        <input type="date" id="t-date-picker" style="display:none;">
        <div class="button-row">
            <button class="btn-add" onclick="triggerTAttn('Present')">MARK PRESENT</button>
            <button class="btn-edit" style="background:#e74c3c;" onclick="triggerTAttn('Absent')">MARK ABSENT</button>
            <button class="btn-fetch" onclick="fetchTeacherHistory()">FETCH Records</button>
        </div>
    </div>
</section>
        </main>
    </div>

    <footer>
        <div class="footer-grid">
            <div class="footer-col">
                <h4>Product</h4>
                <ul>
                    <li><a href="features.html">Features</a></li>
                    <li><a href="pricing.html">Pricing</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Support</h4>
                <ul>
                    <li><a href="FAQ.html">FAQs</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Company</h4>
                <ul>
                    <li><a href="about.html">About</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Legal</h4>
                <ul>
                    <li><a href="privacy.html">Privacy Policy</a></li>
                    <li><a href="terms.html">Terms</a></li>
                    <li><a href="disclaimer.html">Disclaimer</a></li>
                    <li><a href="refund.html">Refund Policy</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Social Media</h4>
                <ul>
                    <li><a href="https://www.linkedin.com/in/sunil-vasarkar-216184158/"><i class="fab fa-linkedin"></i> Linkedin</a></li>
                </ul>
            </div>
        </div>
     <div class="footer-bottom">
            <p>Made in India | Built for coaching institutes</p>
            <p>2026 ClassManager. All rights Reserved</p>
        </div>
    </footer>
<script>
/* ==========================================
   1. CORE INITIALIZATION
   ========================================== */
/* ==========================================
   1. CORE INITIALIZATION
   ========================================== */
const _supabaseUrl = 'https://erzwijnlbnwjdlluvxyk.supabase.co';
const _supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyendpam5sYm53amRsbHV2eHlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNTkzMDgsImV4cCI6MjA4NjgzNTMwOH0.H8c9tT5HsxeL4xJAM9KrKmb1v6KKO8dZ-NOB-Pz2G2k';
const db =  supabase.createClient(_supabaseUrl, _supabaseKey);

// ADD THESE TWO LINES HERE
let sessionInstID = ""; 
let sessionUserName = "";

async function checkCurrentSession() {
    const { data: { user } } = await db.auth.getUser();
    if (user) {
        const { data: profile } = await db.from('profiles').select('full_name, institute_id').eq('id', user.id).single();
        if (profile) {
            sessionUserName = profile.full_name;
            sessionInstID = profile.institute_id; 

            document.getElementById('auth-status-bar').style.display = 'flex';
            document.getElementById('user-greeting').innerText = `Welcome ${sessionUserName} (${sessionInstID})`;
            
            // SHOW the Stats, HIDE the "Still managing manually" text
            document.getElementById('home-visitor-view').style.display = 'none';
            document.getElementById('home-user-view').style.display = 'block';
            
            loadHomeDashboardStats();
        }
    } else {
        document.getElementById('auth-status-bar').style.display = 'none';
        document.getElementById('home-visitor-view').style.display = 'block';
        document.getElementById('home-user-view').style.display = 'none';
    }
}
checkCurrentSession();

// Helper to get input values easily
const val = (id, selector) => {
    const el = document.querySelector(`${id} ${selector}`);
    if (!el) {
        console.warn(`Element ${id} ${selector} not found`);
        return ""; // Return empty string instead of crashing
    }
    return el.value;
};
/* ==========================================
   2. LOGIN SYSTEM (Signup, Login, Auth)
   ========================================== */
/* ==========================================
   UPDATED LOGIN & SIGNUP WITH VALIDATION
   ========================================== */

// 1. Toggle Password Visibility
function togglePass(id) {
    const el = document.getElementById(id);
    el.type = el.type === "password" ? "text" : "password";
}

// 2. Clear Form Data
function clearForm(formId) {
    const inputs = document.querySelectorAll(`#${formId} input, #${formId} select`);
    inputs.forEach(input => input.value = "");
}

// 3. Validation Helpers
function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function isValidMobile(mobile) {
    return /^[6-9]\d{9}$/.test(mobile); // Indian mobile starts with 6,7,8,9
}

// 4. Handle Signup
async function handleSignup() {
    const name = document.getElementById('sig-name').value.trim();
    const role = document.getElementById('sig-role').value;
    const email = document.getElementById('sig-email').value.trim();
    const pass = document.getElementById('sig-pass').value;
    const state = document.getElementById('sig-state').value;
    const mobile = document.getElementById('sig-mobile').value.trim();

    // ADDITION: Generate a unique Institute ID (e.g., CM-4821)
    const newInstID = "CM-" + Math.floor(1000 + Math.random() * 9000);

    // Validations
    if (!name) return alert("Error: Please enter Full Name");
    if (!role) return alert("Error: Please select your Status (Role)");
    if (!isValidEmail(email)) return alert("Error: Please enter a valid Email ID");
    if (pass.length < 6) return alert("Error: Password must be at least 6 characters long");
    if (!state) return alert("Error: Please select your State/UT");
    if (!isValidMobile(mobile)) return alert("Error: Please enter a valid 10-digit Indian Mobile Number");

    const { data, error } = await db.auth.signUp({ email, password: pass });

    if (error) return alert("Signup Failed: " + error.message);

    if (data.user) {
        // Create Profile in DB
        const { error: profileError } = await db.from('profiles').insert([{ 
            id: data.user.id, 
            full_name: name, 
            email: email, 
            role: role, 
            mobile_number: mobile,
            state: state,
            institute_id: newInstID // ADDITION: Link the user to the generated ID
        }]);

        if (profileError) alert("Profile Error: " + profileError.message);
        else {
            // ADDITION: Added the ID to the success message
            alert("Success! Account created. Your Institute ID is: " + newInstID + ". Please check your email for verification.");
            clearForm('signup-form');
        }
    }
}
// 5. Handle Login
// 5. Updated Handle Login with Role Verification
// Global variable to store name for the "Bye Bye" message


// 1. Updated Handle Login
async function handleLogin() {
    const roleSelected = document.getElementById('log-role').value;
    const email = document.getElementById('log-email').value.trim();
    const pass = document.getElementById('log-pass').value;

    if (!roleSelected || !email || !pass) return alert("Error: Please fill all login fields");

    const { data, error } = await db.auth.signInWithPassword({ email, password: pass });
    
    if (error) return alert("Login Failed: " + error.message);

    // Fetch profile to get the Full Name
    const { data: profile, error: profileError } = await db
        .from('profiles')
        .select('full_name, role')
        .eq('id', data.user.id)
        .single();

    if (profileError || !profile) {
        await db.auth.signOut();
        return alert("Error: Profile not found.");
    }

    if (profile.role !== roleSelected) {
        await db.auth.signOut();
        return alert(`Access Denied: You are registered as "${profile.role}".`);
    }

    // SUCCESS LOGIC
    sessionUserName = profile.full_name;
    
    // Update UI
    document.getElementById('auth-status-bar').style.display = 'flex';
    document.getElementById('user-greeting').innerText = "Welcome " + sessionUserName;
    document.getElementById('logout-btn').style.display = 'block';

    alert(`Login Successful! Welcome ${sessionUserName}.`);
    showSection('home'); // Automatically take them to home after login
}

// 2. New Handle Logout Function
async function handleLogout() {
    const { error } = await db.auth.signOut();
    
    if (error) {
        alert("Error logging out: " + error.message);
    } else {
        // Change message to "Bye Bye"
        document.getElementById('user-greeting').innerText = "Bye Bye " + sessionUserName;
        document.getElementById('logout-btn').style.display = 'none';

        // Wait 2 seconds so they can read the message, then refresh or hide sections
        setTimeout(() => {
            alert("Session Closed.");
            location.reload(); // Refresh to clear all sensitive data from memory
        }, 2000);
    }
}

async function loadHomeDashboardStats() {
    if (!sessionInstID) return;
    const { data: students } = await db.from('students')
        .select('paid_amount, pending_amount')
        .eq('institute_id', sessionInstID)
        .eq('status', 'Active');

    if (students) {
        const totalStu = students.length;
        const totalColl = students.reduce((sum, s) => sum + (Number(s.paid_amount) || 0), 0);
        const totalPend = students.reduce((sum, s) => sum + (Number(s.pending_amount) || 0), 0);

        document.getElementById('home-total-stu').innerText = totalStu;
        document.getElementById('home-total-coll').innerText = "₹ " + totalColl.toLocaleString('en-IN');
        document.getElementById('home-total-pend').innerText = "₹ " + totalPend.toLocaleString('en-IN');
    }
}

/* ==========================================
   HOME DASHBOARD STATS LOGIC
   ========================================== */

/* ==========================================
   3. STUDENT MANAGEMENT (Add, Edit, Fetch)
   ========================================== */
/* ==========================================
   UPDATED STUDENT MANAGEMENT LOGIC
   ========================================== */

// 1. Auto-Calculate Pending Amount
function calcStuPending() {
    const total = parseFloat(document.getElementById('stu-total').value) || 0;
    const paid = parseFloat(document.getElementById('stu-paid').value) || 0;
    if (paid > total) {
        alert("Error: Paid amount cannot be more than Total Fees");
        document.getElementById('stu-paid').value = total;
        document.getElementById('stu-pending').value = 0;
    } else {
        document.getElementById('stu-pending').value = total - paid;
    }
}

// 2. Clear Form
function clearStudentForm() {
    const ids = ['stu-date','stu-name','stu-mobile','stu-father','stu-mother','stu-standard','stu-batch','stu-course','stu-total','stu-paid','stu-pending','stu-roll','stu-end-date'];
    ids.forEach(id => document.getElementById(id).value = "");
}

// 3. Generate Roll Number Immediately
function generateRollNow() {
    const year = new Date().getFullYear();
    const random = Math.floor(1000 + Math.random() * 9000);
    document.getElementById('stu-roll').value = `IMS-${year}-${random}`;
}

// 4. Validation & Add Student
async function addStudent() {
if (!sessionInstID || sessionInstID === "") {
        return alert("Error: Institute ID is missing. Please refresh the page or log in again.");
    }
    // 1. Get Values from UI
    const admissionDate = document.getElementById('stu-date').value;
    const endDate = document.getElementById('stu-end-date').value;
    const mobile = document.getElementById('stu-mobile').value;
    const fMobile = document.getElementById('stu-father').value;
    const mMobile = document.getElementById('stu-mother').value;
    const roll = document.getElementById('stu-roll').value;
    const today = new Date().setHours(0,0,0,0);

    // 2. Validations
    if (!admissionDate) return alert("Error: Admission Date is required.");
    if (!roll) return alert("Error: Please click 'Gen' to create a Roll Number first.");
    if (mobile.length !== 10) return alert("Error: Mobile Number must be 10 digits.");

    // 3. Check if this Roll Number already exists in the database to prevent the "Duplicate" error
    const { data: existingRoll } = await db.from('student_details').select('roll_number').eq('roll_number', roll).single();
    if (existingRoll) {
        return alert("Error: This Roll Number (" + roll + ") is already assigned to someone else. Please generate a new one.");
    }

    // 4. Prepare the Data Object
    const stuData = {
 institute_id: sessionInstID,
        admission_date: admissionDate,
        full_name: document.getElementById('stu-name').value,
        mobile: mobile,
        father_mobile: fMobile,
        mother_mobile: mMobile,
        standard: document.getElementById('stu-standard').value,
        batch_time: document.getElementById('stu-batch').value,
        course: document.getElementById('stu-course').value,
        total_fees: parseFloat(document.getElementById('stu-total').value) || 0,
        paid_amount: parseFloat(document.getElementById('stu-paid').value) || 0,
        pending_amount: parseFloat(document.getElementById('stu-pending').value) || 0,
        roll_number: roll,
        user_id: (await db.auth.getUser()).data.user?.id 
    };

    // 5. Save to 'students' table
    const { data: newStu, error: stuError } = await db.from('students').insert([stuData]).select();

    if (stuError) {
        console.error(stuError);
        return alert("Save Error: " + stuError.message);
    }

    // 6. Save to 'student_details' using UPSERT (This prevents the 'Unique Constraint' crash)
    if (newStu && newStu[0]) {
        const { error: detailError } = await db.from('student_details').upsert([{
 institute_id: sessionInstID,
            student_id: newStu[0].id,
            roll_number: roll,
            course_end_date: endDate
        }], { onConflict: 'student_id' }); // If ID exists, it updates; it won't crash.
        
        if (detailError) {
            alert("Error in secondary details: " + detailError.message);
        } else {
            alert("SUCCESS! Student " + stuData.full_name + " saved with Roll No: " + roll);
            clearStudentForm();
        }
    }
}

// 5. Fetch Details by Roll Number
async function fetchStudentByRoll() {
    // 1. Session Safety Check
    if (!sessionInstID) {
        await checkCurrentSession();
    }
    if (!sessionInstID) return alert("Error: Institute ID not loaded.");

    let roll = prompt("Enter Student Roll Number:");
    if (!roll) return;

    roll = roll.trim().toUpperCase(); 

    // 2. Fetch all columns from students and course_end_date from details
    const { data, error } = await db
        .from('student_details')
        .select(`
            roll_number, 
            course_end_date, 
            students (
                admission_date, 
                full_name, 
                mobile, 
                father_mobile, 
                mother_mobile, 
                standard, 
                batch_time, 
                course, 
                total_fees, 
                paid_amount, 
                pending_amount
            )
        `)
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (error) return alert("Database Error: " + error.message);
    if (!data || !data.students) {
        return alert("NOT FOUND: Roll Number '" + roll + "' not found in your institute.");
    }

    const s = data.students;

    // 3. POPULATE EVERY FIELD IN THE FORM
    document.getElementById('stu-date').value = s.admission_date || "";
    document.getElementById('stu-name').value = s.full_name || "";
    document.getElementById('stu-mobile').value = s.mobile || "";
    document.getElementById('stu-father').value = s.father_mobile || "";
    document.getElementById('stu-mother').value = s.mother_mobile || "";
    document.getElementById('stu-standard').value = s.standard || "";
    document.getElementById('stu-batch').value = s.batch_time || "";
    document.getElementById('stu-course').value = s.course || "";
    document.getElementById('stu-total').value = s.total_fees || 0;
    document.getElementById('stu-paid').value = s.paid_amount || 0;
    document.getElementById('stu-pending').value = s.pending_amount || 0;
    
    // Values from the student_details table
    document.getElementById('stu-roll').value = data.roll_number || "";
    document.getElementById('stu-end-date').value = data.course_end_date || "";

    alert("Full Profile Loaded for " + s.full_name);
}
// 6. Edit Details by Roll Number
async function editStudentByRoll() {
    const roll = document.getElementById('stu-roll').value;
    const admissionDate = document.getElementById('stu-date').value;
    const endDate = document.getElementById('stu-end-date').value;
    const today = new Date().setHours(0,0,0,0);

    if (!roll) return alert("Error: Please fetch a student first using Roll Number.");

    // Re-validate dates before updating
    if (new Date(admissionDate).setHours(0,0,0,0) < today) 
        return alert("Error: Admission Date cannot be in the past.");
    if (new Date(endDate).setHours(0,0,0,0) < today) 
        return alert("Error: Course End Date cannot be in the past.");

    // 1. Find the internal ID linked to this Roll Number
    const { data: detail, error: fetchErr } = await db.from('student_details')
        .select('student_id')
        .eq('roll_number', roll)
        .single();

    if (fetchErr || !detail) return alert("Error finding student link.");

    // 2. Prepare the data exactly as it appears in the UI
    const updateData = {
        admission_date: admissionDate,
        full_name: document.getElementById('stu-name').value,
        mobile: document.getElementById('stu-mobile').value,
        father_mobile: document.getElementById('stu-father').value,
        mother_mobile: document.getElementById('stu-mother').value,
        standard: document.getElementById('stu-standard').value,
        batch_time: document.getElementById('stu-batch').value,
        course: document.getElementById('stu-course').value,
        total_fees: parseFloat(document.getElementById('stu-total').value) || 0,
        paid_amount: parseFloat(document.getElementById('stu-paid').value) || 0,
        pending_amount: parseFloat(document.getElementById('stu-pending').value) || 0 // CRITICAL LINE
    };

    // 3. Update the main students table
    const { error: stuErr } = await db.from('students').update(updateData).eq('id', detail.student_id);
    
    // 4. Update the course end date in the details table
    const { error: detErr } = await db.from('student_details').update({
        course_end_date: endDate
    }).eq('student_id', detail.student_id);

    if (stuErr || detErr) {
        alert("Update Failed: " + (stuErr?.message || detErr?.message));
    } else {
        alert("Success: Student details for " + roll + " have been updated.");
    }
}
/* ==========================================
   4. FEE MANAGEMENT (Stats & Links)
   ========================================== */
/* ==========================================
   UPDATED FEE MANAGEMENT LOGIC
   ========================================== */
/* ==========================================
   FEE MANAGEMENT LOGIC (FIXED)
   ========================================== */

// 1. Math: Total - (Previous + Now) = New Pending
function calcPendingFee() {
    const total = parseFloat(document.getElementById('fee-total').value) || 0;
    const prev = parseFloat(document.getElementById('fee-prev-paid').value) || 0;
    const now = parseFloat(document.getElementById('fee-paid-now').value) || 0;
    
    const remaining = total - (prev + now);
    document.getElementById('fee-pending').value = remaining.toFixed(2);
}

function clearFeeForm() {
    ['fee-roll','fee-name','fee-course','fee-total','fee-prev-paid','fee-paid-now','fee-pending','fee-due-dates','fee-today'].forEach(id => {
        document.getElementById(id).value = "";
    });
}

// 2. Fetch Student with Balance
async function fetchFeeByRoll() {
    // 1. Clean the input (remove spaces and make uppercase)
    const rawInput = document.getElementById('fee-roll').value;
    if (!rawInput) return alert("Please enter a Roll Number first.");
    const roll = rawInput.trim().toUpperCase();
    document.getElementById('fee-roll').value = roll;

    // 2. STEP ONE: Find the Roll Number in 'student_details' to get the internal Student ID
    const { data: detailRecord, error: detailError } = await db.from('student_details')
        .select('student_id')
        .eq('roll_number', roll)
 .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (detailError) return alert("System Error: " + detailError.message);
    
    if (!detailRecord) {
        return alert("Error: Roll Number '" + roll + "' not found in admission records.");
    }

    // 3. STEP TWO: Use the student_id we just found to get the full profile from 'students' table
    const { data: s, error: studentError } = await db.from('students')
        .select('*')
        .eq('id', detailRecord.student_id)
        .maybeSingle();

    if (studentError || !s) {
        return alert("Error: Found the roll number, but could not load the student's financial profile.");
    }

    // 4. POPULATE THE UI
    document.getElementById('fee-name').value = s.full_name;
    document.getElementById('fee-course').value = s.course;
    document.getElementById('fee-total').value = s.total_fees;
    document.getElementById('fee-prev-paid').value = s.paid_amount;
    document.getElementById('fee-status').value = s.status || "Active";
    document.getElementById('fee-due-dates').value = s.due_dates || "";
    
    // Set payment date to today
    document.getElementById('fee-today').value = new Date().toISOString().split('T')[0];

    // Calculate the math automatically
    calcPendingFee();
    
    alert("Details successfully loaded for " + s.full_name);
}

// 3. Save Payment & Record in History
async function saveFeeUpdate() {
    const roll = document.getElementById('fee-roll').value;
    const nowPaying = parseFloat(document.getElementById('fee-paid-now').value) || 0;
    const totalFees = parseFloat(document.getElementById('fee-total').value) || 0;
    const payDate = document.getElementById('fee-today').value;
    const fullNameVal = document.getElementById('fee-name').value.trim();
    const prevPaidVal = parseFloat(document.getElementById('fee-prev-paid').value) || 0;
    const joinDateVal = document.getElementById('fee-join-date').value;
    const todayStr = new Date().toISOString().split('T')[0];

    // Validations
    if (!roll || !payDate) return alert("Error: Roll Number and Date are required.");
    if (fullNameVal.split(/\s+/).filter(w => w.length > 0).length < 2) return alert("Error: Enter Full Name (First + Surname).");
    if (joinDateVal > todayStr) return alert("Error: Date of Joining cannot be in future.");
    if (prevPaidVal > totalFees) return alert("Error: Previously Paid cannot exceed Total Fees.");
    if (nowPaying > (totalFees - prevPaidVal)) return alert("Error: Payment exceeds remaining balance.");

    const { data: detail } = await db.from('student_details').select('student_id').eq('roll_number', roll).single();
    if(!detail) return alert("Fetch student first.");

    const newPaidTotal = prevPaidVal + nowPaying;

    // 1. Update Students Table
    const { error: upError } = await db.from('students').update({
        paid_amount: newPaidTotal,
        pending_amount: totalFees - newPaidTotal,
        status: document.getElementById('fee-status').value,
        due_dates: document.getElementById('fee-due-dates').value
    }).eq('id', detail.student_id);

    if (upError) return alert(upError.message);

    // 2. Insert into payment_history (Crucial for Logs)
    const monthYearStr = new Date(payDate).toLocaleString('default', { month: 'long', year: 'numeric' });
    const { error: histError } = await db.from('payment_history').insert([{
 institute_id: sessionInstID,
        student_id: detail.student_id,
        roll_number: roll,
        amount: nowPaying,
        payment_date: payDate,
        month_year: monthYearStr
    }]);

    if (histError) alert("Balance updated, but log failed: " + histError.message);
    else {
        alert("Payment Recorded & Logged!");
        fetchFeeByRoll();
        loadFeesPortal();
    }
}

async function loadFeesPortal() {
    const year = document.getElementById('portal-year').value || "2026";
    
    // 1. Get Totals for Active Students
    const { data: students } = await db.from('students').select('*').eq('status', 'Active')
	.eq('institute_id', sessionInstID);
    if (students) {
        document.getElementById('stat-active-count').innerText = students.length;
        document.getElementById('stat-total-received').innerText = "₹ " + students.reduce((s, st) => s + (st.paid_amount || 0), 0).toLocaleString();
        document.getElementById('stat-total-pending').innerText = "₹ " + students.reduce((s, st) => s + (st.pending_amount || 0), 0).toLocaleString();
    }

    // 2. Yearly Collection (Fixed query: gte/lte handles Date types better than LIKE)
    const startYear = `${year}-01-01`;
    const endYear = `${year}-12-31`;
    
    const { data: history } = await db.from('payment_history')
        .select('amount')
        .gte('payment_date', startYear)
        .lte('payment_date', endYear);

    const totalYearly = history ? history.reduce((s, p) => s + (parseFloat(p.amount) || 0), 0) : 0;
    
    document.getElementById('yearly-label').innerText = year + " Total Collection";
    document.getElementById('stat-yearly').innerText = "₹ " + totalYearly.toLocaleString();
}
async function fetchPaymentLog() {
    const roll = document.getElementById('log-roll').value;
    const monthInput = document.getElementById('log-calendar').value; // YYYY-MM
    if(!roll || !monthInput) return alert("Please select Roll Number and Month Calendar.");

    const formattedMonth = new Date(monthInput + "-01").toLocaleString('default', { month: 'long', year: 'numeric' });
    const { data, error } = await db.from('payment_history').select('*').eq('roll_number', roll).eq('month_year', formattedMonth);

    const logDiv = document.getElementById('log-result');
    if (data && data.length > 0) {
        logDiv.innerHTML = `<strong>Payments for ${formattedMonth}:</strong><br>` + 
            data.map(p => `<p style="color:green;">✔ ₹${p.amount} on ${p.payment_date}</p>`).join('');
    } else {
        logDiv.innerHTML = `<span style="color:red;">No records found for ${formattedMonth}.</span>`;
    }
}





async function generateUPIQR() {
    // 1. Get current data from the Fee Form
    const amount = document.getElementById('fee-paid-now').value;
    const studentName = document.getElementById('fee-name').value;
    const roll = document.getElementById('fee-roll').value;

    // 2. Validation
    if (!amount || amount <= 0) return alert("Please enter the 'Amount Now Paying' first.");
    if (!studentName) return alert("Please fetch student details first.");

    // 3. Get UPI ID (VPA) from the owner
    // For a production system, we pull this from 'institute_settings' table.
    // As a shortcut, we will prompt once or you can hardcode it.
    let upiID = prompt("Enter Institute UPI ID (e.g., owner@okaxis or 9876543210@upi):");
    
    if (!upiID) return;

    // 4. Construct the UPI String
    // Format: upi://pay?pa=VPA&pn=NAME&am=AMOUNT&tn=REMARK&cu=INR
    const payeeName = encodeURIComponent("ClassManager Institute");
    const remarks = encodeURIComponent(`Fees-${roll}`);
    const upiString = `upi://pay?pa=${upiID}&pn=${payeeName}&am=${amount}&tn=${remarks}&cu=INR`;

    // 5. Use Google Chart API or GoQR to generate the image
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiString)}`;

    // 6. Update UI
    document.getElementById('upi-qr-img').src = qrUrl;
    document.getElementById('disp-qr-amt').innerText = amount;
    document.getElementById('disp-qr-name').innerText = studentName;
    document.getElementById('upi-qr-area').style.display = 'block';

    // Scroll to the QR code so the user sees it
    document.getElementById('upi-qr-area').scrollIntoView({ behavior: 'smooth' });
}
/* ==========================================
   5. BATCH MANAGEMENT
   ========================================== */
async function addBatch() {
    const batchData = {
 institute_id: sessionInstID,
        batch_name: document.getElementById('batch-name').value,
        teacher_id: document.getElementById('batch-teacher-id').value,
        teacher_name: document.getElementById('batch-teacher-name').value,
        batch_time: document.getElementById('batch-time').value,
        subject_name: document.getElementById('batch-subject').value,
        students_allotted: parseInt(document.getElementById('batch-students').value) || 0,
        remarks: document.getElementById('batch-remarks').value
    };

    const { error } = await db.from('batches').insert([batchData]);
    if (error) alert("Save Error: " + error.message);
    else alert("Batch Saved Successfully!");
}

// 4. THE MISSING FETCH FUNCTION
async function fetchBatch() {
    const name = prompt("Enter Batch Name to search:");
    if (!name) return;

    const { data, error } = await db.from('batches')
        .select('*')
        .eq('batch_name', name)
 .eq('institute_id', sessionInstID)
        .single();

    if (error || !data) return alert("Batch not found.");

    document.getElementById('batch-name').value = data.batch_name;
    document.getElementById('batch-teacher-id').value = data.teacher_id;
    document.getElementById('batch-teacher-name').value = data.teacher_name;
    document.getElementById('batch-time').value = data.batch_time;
    document.getElementById('batch-subject').value = data.subject_name;
    document.getElementById('batch-students').value = data.students_allotted;
    document.getElementById('batch-remarks').value = data.remarks;
    alert("Batch details loaded!");
}
async function editBatch() {
    const tID = val('#batch', 'input[placeholder="Teacher ID"]');
    const updateData = {
        batch_name: val('#batch', 'input[placeholder="Batch Name"]'),
        batch_time: val('#batch', 'input[type="time"]'),
        subject_name: val('#batch', 'input[placeholder="Subject Name"]')
    };
    const { error } = await db.from('batches').update(updateData).eq('teacher_id', tID);
    if (error) alert(error.message); else alert("Batch Updated Successfully!");
}
/* ==========================================
   6. ATTENDANCE (Mark & Fetch)
   ========================================== */
/* ==========================================
   UPDATED ATTENDANCE LOGIC
   ========================================== */

// 1. Fetch Student Name using Roll Number for the UI
async function fetchStudentForAttn() {
    const roll = document.getElementById('attn-roll').value.trim(); // .trim() handles accidental spaces
    if (!roll) return alert("Please enter a Roll Number");

    // Query the main 'students' table directly
    const { data, error } = await db
        .from('students')
        .select('full_name')
        .eq('roll_number', roll)
 .eq('institute_id', sessionInstID)
        .single();

    if (error || !data) {
        console.error("Fetch Error:", error);
        alert("Error: Roll Number '" + roll + "' not found in admission records.");
        document.getElementById('attn-name').value = "";
    } else {
        document.getElementById('attn-name').value = data.full_name;
    }
}
// 2. Trigger the calendar popup
let currentAttnStatus = "";
function triggerAttendance(status) {
    const name = document.getElementById('attn-name').value;
    if (!name) return alert("Please fetch a student by Roll Number first!");
    
    currentAttnStatus = status;
    const picker = document.getElementById('attn-date-picker');
    
    // Programmatically open the calendar
    picker.showPicker(); 
    
    // Listen for the date selection
    picker.onchange = async function() {
        if (this.value) {
            await saveAttendance(this.value, currentAttnStatus);
            this.value = ""; // reset
        }
    };
}

// 3. Save to Supabase
/* ==========================================
   FIXED ATTENDANCE & STATISTICS LOGIC
   ========================================== */

// 1. SAVE ATTENDANCE (Fixing the NULL user_id)
async function saveAttendance(dateValue, status) {
    const roll = document.getElementById('attn-roll').value.trim();
    if (!roll) return alert("Enter Roll Number first.");

    // Get Student ID and current User Session
    const { data: student } = await db.from('students').select('id').eq('roll_number', roll).single();
    const { data: { user } } = await db.auth.getUser(); // Fetches active login session

    if (!student) return alert("Student record not found.");
    if (!user) return alert("Error: You must be logged in to mark attendance.");

    const monthYear = new Date(dateValue).toLocaleString('default', { month: 'long', year: 'numeric' });

    const { error } = await db.from('attendance').insert([{
 institute_id: sessionInstID,
        student_id: student.id,
        roll_number: roll,
        attendance_date: dateValue,
        status: status,
        month_year: monthYear,
        user_id: user.id // Captures the ID of the person (Owner/Teacher) marking it
    }]);

    if (error) alert("Error: " + error.message);
    else alert(`Success: Marked ${status} for ${dateValue}`);


// NEW ALERT LOGIC
      // REFINED ALERT LOGIC: Connects to Parent Mobile Numbers
        if (status === "Absent") {
            const stuName = document.getElementById('attn-name').value;
            
            // 1. Fetch Father, Mother, and Student mobile numbers from the database
            const { data: stuData } = await db.from('students')
                .select('mobile, father_mobile, mother_mobile')
                .eq('roll_number', roll)
                .single();
            
            if (stuData) {
                // 2. Priority Logic: Use Father's mobile, if empty use Mother's, if empty use Student's
                const targetMobile = stuData.father_mobile || stuData.mother_mobile || stuData.mobile;
                
                if (targetMobile) {
                    const alertArea = document.getElementById('whatsapp-alert-area');
                    const waLink = document.getElementById('absent-wa-link');
                    
                    // Formulate the message to the Parent
                    const msg = encodeURIComponent(`Dear Parent, this is to inform you that your child ${stuName} was ABSENT for class on ${dateValue}. Please ensure their regular attendance. Regards, ClassManager IMS.`);
                    
                    waLink.href = `https://wa.me/91${targetMobile}?text=${msg}`;
                    alertArea.style.display = 'block'; 
                }
            }
        } else {
            document.getElementById('whatsapp-alert-area').style.display = 'none'; 
        }
}

// 2. FETCH STATISTICS (Displaying data in UI)
async function fetchAttendanceByPrompt() {
    // A. Input Verification
    const roll = prompt("Enter Student Roll Number to see statistics:");
    if (!roll) return;

    const monthView = document.getElementById('attn-month-view').value; // YYYY-MM from calendar
    if (!monthView) return alert("Please select a month in the 'View Monthly Record' calendar first.");

    // B. Format the month string to match database (e.g., "March 2026")
    const dateObj = new Date(monthView + "-01");
    const targetMonthYear = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    // C. Query Database for Present Days
    const { count: pCount, error: pErr } = await db.from('attendance')
        .select('*', { count: 'exact', head: true })
        .eq('roll_number', roll)
        .eq('month_year', targetMonthYear)
        .eq('status', 'Present');

    // D. Query Database for Absent Days
    const { count: aCount, error: aErr } = await db.from('attendance')
        .select('*', { count: 'exact', head: true })
        .eq('roll_number', roll)
        .eq('month_year', targetMonthYear)
        .eq('status', 'Absent');

    if (pErr || aErr) return alert("Error fetching stats.");

    // E. Update UI Fields
    document.getElementById('attn-total-p').value = pCount || 0;
    document.getElementById('attn-total-a').value = aCount || 0;
    document.getElementById('attn-roll').value = roll;
    
    // Automatically fetch name so user knows who the stats belong to
    fetchStudentForAttn(); 
    
    alert(`Statistics for ${roll} in ${targetMonthYear} updated successfully!`);
}
/* ==========================================
   7. ADMIN DASHBOARD (Dynamic Counts)
   ========================================== */
/* ==========================================
   DYNAMIC ADMIN DASHBOARD LOGIC
   ========================================== */

// 1. Toggle visibility of calendars based on filter type
function toggleAdminCalendar() {
    const type = document.getElementById('admin-filter-type').value;
    document.getElementById('admin-month-container').style.display = type === 'monthly' ? 'block' : 'none';
    document.getElementById('admin-year-container').style.display = (type === 'yearly' || type === 'quarterly') ? 'block' : 'none';
    document.getElementById('admin-quarter-container').style.display = type === 'quarterly' ? 'block' : 'none';
    loadAdminDashboard();
}

// 2. Main Loader Function
async function loadAdminDashboard() {
    const type = document.getElementById('admin-filter-type').value;
    const year = document.getElementById('admin-filter-year').value;
    let startDate, endDate, label;

    // A. Determine Date Range
    if (type === 'monthly') {
        const monthVal = document.getElementById('admin-filter-month').value;
        if(!monthVal) return;
        startDate = `${monthVal}-01`;
        endDate = `${monthVal}-31`;
        label = new Date(startDate).toLocaleString('default', { month: 'short', year: 'numeric' });
    } else if (type === 'yearly') {
        startDate = `${year}-01-01`;
        endDate = `${year}-12-31`;
        label = `Year ${year}`;
    } else if (type === 'quarterly') {
        const q = document.getElementById('admin-filter-quarter').value;
        const qMap = { "1": ["01-01", "03-31"], "2": ["04-01", "06-30"], "3": ["07-01", "09-30"], "4": ["10-01", "12-31"] };
        startDate = `${year}-${qMap[q][0]}`;
        endDate = `${year}-${qMap[q][1]}`;
        label = `Q${q} ${year}`;
    }

    document.querySelectorAll('.filter-label').forEach(el => el.innerText = label);

    // B. Query Total Students (Joined in this period)
    const { count: stuCount } = await db.from('students')
        .select('*', { count: 'exact', head: true })
 .eq('institute_id', sessionInstID)
        .gte('admission_date', startDate)
        .lte('admission_date', endDate);
    document.getElementById('dash-students').innerText = stuCount || 0;

    // C. Query Total Revenue (Payments made in this period)
    const { data: revenueData } = await db.from('payment_history')
        .select('amount')
        .gte('payment_date', startDate)
        .lte('payment_date', endDate);
    const totalRev = revenueData ? revenueData.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0) : 0;
    document.getElementById('dash-revenue').innerText = `₹ ${totalRev.toLocaleString('en-IN')}`;

    // D. Query Pending Fees (From students active in this period)
    const { data: pendingData } = await db.from('students')
        .select('pending_amount')
        .eq('status', 'Active')
        .gte('admission_date', startDate)
        .lte('admission_date', endDate);
    const totalPen = pendingData ? pendingData.reduce((sum, p) => sum + (parseFloat(p.pending_amount) || 0), 0) : 0;
    document.getElementById('dash-pending').innerText = `₹ ${totalPen.toLocaleString('en-IN')}`;

    // E. Query Attendance %
    const { data: attData } = await db.from('attendance')
        .select('status')
        .gte('attendance_date', startDate)
        .lte('attendance_date', endDate);
    
    if (attData && attData.length > 0) {
        const present = attData.filter(a => a.status === 'Present').length;
        const percent = ((present / attData.length) * 100).toFixed(1);
        document.getElementById('dash-attendance').innerText = `${percent}%`;
    } else {
        document.getElementById('dash-attendance').innerText = `0%`;
    }

    // F. Load Current Month Reminders (Auto-populated)
    loadReminders();
}

// 3. Load Fee Reminders for the Current Month
async function loadReminders() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

    const { data: reminders, error } = await db.from('students')
        .select('full_name, roll_number, pending_amount, mobile')
        .eq('status', 'Active')
        .gt('pending_amount', 0);

    const container = document.getElementById('reminder-list');
    if (reminders && reminders.length > 0) {
        let html = '<table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">';
        html += '<tr style="background:#eee; text-align:left;"><th>Student</th><th>Roll No</th><th>Pending</th><th>Action</th></tr>';
        
        reminders.forEach(r => {
            html += `<tr style="border-bottom: 1px solid #ddd;">
                <td style="padding:10px;">${r.full_name}</td>
                <td>${r.roll_number}</td>
                <td style="color:red; font-weight:bold;">₹${r.pending_amount}</td>
                <td><a href="https://wa.me/91${r.mobile}?text=Reminder: Fee pending ₹${r.pending_amount}" target="_blank" style="color:green;"><i class="fab fa-whatsapp"></i> Notify</a></td>
            </tr>`;
        });
        html += '</table>';
        container.innerHTML = html;
    } else {
        container.innerHTML = "<p style='color:gray;'>No pending fees for the current month.</p>";
    }
}

/* ==========================================
   8. FEE REMINDER (SMS/WhatsApp)
   ========================================== */
async function loadFeeReminders() {
    const selectedYear = document.getElementById('remind-year').value || 2026;
    const startDate = `${selectedYear}-01-01`;
    const endDate = `${selectedYear}-12-31`;

    // Update labels in UI
    document.querySelectorAll('.display-year').forEach(el => el.innerText = selectedYear);

    try {
        // Fetch Active students with pending balance admitted in the selected year
        const { data: students, error } = await db
            .from('students')
            .select('full_name, roll_number, mobile, pending_amount')
            .eq('status', 'Active')
            .gt('pending_amount', 0)
            .gte('admission_date', startDate)
            .lte('admission_date', endDate);

        if (error) throw error;

        const tableBody = document.getElementById('reminder-table-body');
        let totalPendingAmt = 0;
        let pendingStuCount = 0;

        if (students && students.length > 0) {
            tableBody.innerHTML = ''; // Clear old rows
            pendingStuCount = students.length;

            students.forEach(s => {
                totalPendingAmt += parseFloat(s.pending_amount) || 0;

                // Create WhatsApp Message
                const msg = encodeURIComponent(`Hello ${s.full_name}, this is a reminder regarding your pending fee of ₹${s.pending_amount} for the year ${selectedYear}. Please settle it at the earliest. Thank you.`);
                
                tableBody.innerHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px; font-weight: bold;">${s.roll_number}</td>
                        <td style="padding: 12px;">${s.full_name}</td>
                        <td style="padding: 12px;">${s.mobile}</td>
                        <td style="padding: 12px; color: red; font-weight: bold;">₹ ${parseFloat(s.pending_amount).toLocaleString('en-IN')}</td>
                        <td style="padding: 12px;">
                            <a href="https://wa.me/91${s.mobile}?text=${msg}" target="_blank" 
                               style="background: #25D366; color: white; padding: 6px 12px; border-radius: 5px; text-decoration: none; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px;">
                               <i class="fab fa-whatsapp"></i> Send Reminder
                            </a>
                        </td>
                    </tr>
                `;
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #888;">No active students with pending fees found for this year.</td></tr>';
        }

        // Update Stats
        document.getElementById('remind-total-amt').innerText = `₹ ${totalPendingAmt.toLocaleString('en-IN')}`;
        document.getElementById('remind-stu-count').innerText = pendingStuCount;

    } catch (err) {
        console.error("Reminder Error:", err.message);
    }
}

/* ==========================================
   9. LEAD MANAGEMENT
   ========================================== */
/* ==========================================
   LEAD MANAGEMENT LOGIC (FIXED)
   ========================================== */

function clearLeadForm() {
    ['lead-name','lead-contact','lead-email','lead-course','lead-date','lead-ref','lead-status','lead-remarks'].forEach(id => {
        document.getElementById(id).value = (id === 'lead-status') ? 'Follow up' : '';
    });
}

async function addLead() {
    const leadData = {
 institute_id: sessionInstID,
        full_name: document.getElementById('lead-name').value,
        contact: document.getElementById('lead-contact').value,
        email: document.getElementById('lead-email').value, // NO MORE NULL
        interested_course: document.getElementById('lead-course').value,
        date_of_visit: document.getElementById('lead-date').value,
        reference: document.getElementById('lead-ref').value, // NO MORE NULL
        status: document.getElementById('lead-status').value,
        remarks: document.getElementById('lead-remarks').value
    };

    if (!leadData.full_name || !leadData.contact) {
        return alert("Error: Name and Contact are mandatory.");
    }

    const { error } = await db.from('leads').insert([leadData]);

    if (error) {
        alert("Save Error: " + error.message);
    } else {
        alert("Lead for " + leadData.full_name + " saved successfully!");
        clearLeadForm();
    }
}

async function fetchLead() {
    const contact = prompt("Enter Lead Contact Number:");
    if (!contact) return;

    const { data, error } = await db
        .from('leads')
        .select('*')
        .eq('contact', contact)
 .eq('institute_id', sessionInstID)
        .single();

    if (error || !data) return alert("Lead not found.");

    document.getElementById('lead-name').value = data.full_name;
    document.getElementById('lead-contact').value = data.contact;
    document.getElementById('lead-email').value = data.email || "";
    document.getElementById('lead-course').value = data.interested_course || "";
    document.getElementById('lead-date').value = data.date_of_visit || "";
    document.getElementById('lead-ref').value = data.reference || "";
    document.getElementById('lead-status').value = data.status || "Follow up";
    document.getElementById('lead-remarks').value = data.remarks || "";
    
    alert("Lead details loaded!");
}
/* ==========================================
   10. EXPENSE TRACKING (Add, Edit, Fetch)
   ========================================== */
// Function to calculate totals and profit
/* ==========================================
   EXPENSE LOGIC (MANUAL ENTRY)
   ========================================== */

/* ==========================================
   EXPENSE & INCOME LOGIC (SYNCED)
   ========================================== */

// 1. AUTO-POPULATE Fees from Payment History
async function fetchAutoFees() {
    const monthVal = document.getElementById('exp-month-year').value;
    if (!monthVal) return;

    // Convert YYYY-MM to "Month Year" format (e.g., "March 2026")
    const dateObj = new Date(monthVal + "-01");
    const targetMonthYear = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    console.log("Fetching collection for: " + targetMonthYear);

    const { data, error } = await db
        .from('payment_history')
        .select('amount')
        .eq('month_year', targetMonthYear)
 .eq('institute_id', sessionInstID);

    const total = data ? data.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0) : 0;
    
    document.getElementById('disp-auto-fees').innerText = "₹ " + total.toLocaleString('en-IN');
    calculateFinancials(); // Refresh math
}

// 2. FORMULA CALCULATION
function calculateFinancials() {
    const fees = parseFloat(document.getElementById('disp-auto-fees').innerText.replace(/[₹, ]/g, '')) || 0;
    const otherInc = parseFloat(document.getElementById('exp-income').value) || 0;
    
    // Expenses
    const e1 = parseFloat(document.getElementById('exp-rent').value) || 0;
    const e2 = parseFloat(document.getElementById('exp-elec').value) || 0;
    const e3 = parseFloat(document.getElementById('exp-maint').value) || 0;
    const e4 = parseFloat(document.getElementById('exp-t-sal').value) || 0;
    const e5 = parseFloat(document.getElementById('exp-a-sal').value) || 0;
    const e6 = parseFloat(document.getElementById('exp-mark').value) || 0;
    const e7 = parseFloat(document.getElementById('exp-other').value) || 0;

    const totalExp = e1 + e2 + e3 + e4 + e5 + e6 + e7;
    const totalIncome = (fees + otherInc) - totalExp;
    
    // Cost to Income Ratio Formula
    let ratio = 0;
    if ((fees + otherInc) > 0) {
        ratio = (totalExp / (fees + otherInc)) * 100;
    }

    // Update UI
    document.getElementById('disp-total-exp').innerText = "₹ " + totalExp.toLocaleString('en-IN');
    document.getElementById('disp-total-income').innerText = "₹ " + totalIncome.toLocaleString('en-IN');
    document.getElementById('disp-total-income').style.color = totalIncome >= 0 ? "green" : "red";
    document.getElementById('disp-ratio').innerText = ratio.toFixed(1) + "%";
}

// 3. SAVE TO SUPABASE
async function saveExpenses() {
    const monthYear = document.getElementById('exp-month-year').value;
    if (!monthYear) return alert("Select Month & Year first.");

    const fees = parseFloat(document.getElementById('disp-auto-fees').innerText.replace(/[₹, ]/g, '')) || 0;
    const otherInc = parseFloat(document.getElementById('exp-income').value) || 0;

    const dataObj = {
 institute_id: sessionInstID,
        month_year: monthYear,
        rent: parseFloat(document.getElementById('exp-rent').value) || 0,
        electricity: parseFloat(document.getElementById('exp-elec').value) || 0,
        maintenance: parseFloat(document.getElementById('exp-maint').value) || 0,
        teacher_salary: parseFloat(document.getElementById('exp-t-sal').value) || 0,
        admin_salary: parseFloat(document.getElementById('exp-a-sal').value) || 0,
        marketing: parseFloat(document.getElementById('exp-mark').value) || 0,
        other_exp: parseFloat(document.getElementById('exp-other').value) || 0,
        other_income: otherInc,
        auto_fees_collected: fees,
        total_expenses: parseFloat(document.getElementById('disp-total-exp').innerText.replace(/[₹, ]/g, '')),
        total_income_net: parseFloat(document.getElementById('disp-total-income').innerText.replace(/[₹, ]/g, '')),
        cost_income_ratio: parseFloat(document.getElementById('disp-ratio').innerText)
    };

    const { error } = await db.from('expenses').upsert([dataObj]);
    if (error) alert("Save Error: " + error.message);
    else alert("Financial record for " + monthYear + " saved successfully!");
}

// 4. FETCH SAVED DATA
async function fetchSavedExpense() {
    const monthYear = document.getElementById('exp-month-year').value;
    if (!monthYear) return alert("Select Month & Year to fetch.");

    const { data, error } = await db.from('expenses').select('*').eq('month_year', monthYear).single();
    if (error || !data) return alert("No saved record found for this month.");

    document.getElementById('exp-rent').value = data.rent;
    document.getElementById('exp-elec').value = data.electricity;
    document.getElementById('exp-maint').value = data.maintenance;
    document.getElementById('exp-t-sal').value = data.teacher_salary;
    document.getElementById('exp-a-sal').value = data.admin_salary;
    document.getElementById('exp-mark').value = data.marketing;
    document.getElementById('exp-other').value = data.other_exp;
    document.getElementById('exp-income').value = data.other_income;
    
    fetchAutoFees(); // This will refresh the fees and trigger the math calculation
}

function clearExpenseForm() {
    const inputs = ['exp-rent','exp-elec','exp-maint','exp-t-sal','exp-a-sal','exp-mark','exp-other','exp-income'];
    inputs.forEach(id => document.getElementById(id).value = 0);
    calculateFinancials();
}
/* ==========================================
   11. TEACHER PORTAL (Admin Side)
   ========================================== */
function generateTchID() {
    const random = Math.floor(1000 + Math.random() * 9000);
    const id = "TCH-" + random;
    const field = document.getElementById('tch-id');
    if (field) {
        field.value = id;
        console.log("Teacher ID Created: " + id);
    } else {
        alert("System Error: 'tch-id' input not found in HTML!");
    }
}

/* ==========================================
   COMPLETE FEE PORTAL LOGIC
   ========================================== */
async function loadFeesPortal() {
    console.log("Syncing Fees Portal Statistics...");

    try {
        // 1. FETCH DATA FROM STUDENTS TABLE (Active Students Only)
        // We fetch paid_amount and pending_amount for the totals
        const { data: students, error: stuError } = await db
            .from('students')
            .select('paid_amount, pending_amount')
            .eq('status', 'Active');

        if (stuError) throw stuError;

        if (students) {
            const activeCount = students.length;
            const totalReceived = students.reduce((sum, s) => sum + (parseFloat(s.paid_amount) || 0), 0);
            const totalPending = students.reduce((sum, s) => sum + (parseFloat(s.pending_amount) || 0), 0);

            // Update UI Counters
            const elCount = document.getElementById('stat-active-count');
            const elRec = document.getElementById('stat-total-received');
            const elPen = document.getElementById('stat-total-pending');

            if (elCount) elCount.innerText = activeCount;
            if (elRec) elRec.innerText = "₹ " + totalReceived.toLocaleString('en-IN');
            if (elPen) elPen.innerText = "₹ " + totalPending.toLocaleString('en-IN');
        }

        // 2. FETCH DATA FROM PAYMENT HISTORY (Yearly Collection Stats)
        // Get the year from the UI input
        const yearInput = document.getElementById('portal-year');
        const selectedYear = yearInput ? yearInput.value : new Date().getFullYear();

        // Calculate start and end of the year for the database query
        const startDate = `${selectedYear}-01-01`;
        const endDate = `${selectedYear}-12-31`;

        const { data: history, error: histError } = await db
            .from('payment_history')
            .select('amount')
            .gte('payment_date', startDate)
            .lte('payment_date', endDate);

        if (histError) throw histError;

        const yearlySum = history ? history.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0) : 0;

        // Update Yearly UI
        const elYearly = document.getElementById('stat-yearly');
        const elLabel = document.getElementById('yearly-label');

        if (elYearly) elYearly.innerText = "₹ " + yearlySum.toLocaleString('en-IN');
        if (elLabel) elLabel.innerText = selectedYear + " Total Collection";

    } catch (err) {
        console.error("Fee Portal Refresh Failed:", err.message);
    }
}
// 2. Clear Form
function clearTeacherForm() {
    const ids = ['tch-id','tch-name','tch-age','tch-gender','tch-join','tch-qual','tch-subject','tch-salary'];
    ids.forEach(id => document.getElementById(id).value = "");
}

// 3. ADD TEACHER
async function addTeacherDetails() {
    const id = document.getElementById('tch-id').value;
    const name = document.getElementById('tch-name').value;

    if (!id || !name) return alert("Error: Click GEN and enter Teacher Name.");

    const { error } = await db.from('teacher_details').insert([{
 institute_id: sessionInstID,
        id: id,
        teacher_name: name,
        age: parseInt(document.getElementById('tch-age').value) || 0,
        joining_date: document.getElementById('tch-join').value,
        qualification: document.getElementById('tch-qual').value,
        subject_taught: document.getElementById('tch-subject').value,
        salary_offered: parseFloat(document.getElementById('tch-salary').value) || 0
    }]);

    if (error) alert("DB Error: " + error.message);
    else alert("Teacher Saved Successfully!");
}
// 4. FETCH TEACHER (By ID)
async function fetchTeacher() {
    const id = prompt("Enter Teacher ID to fetch (e.g., TCH-1234):");
    if (!id) return;

    const { data, error } = await db.from('teacher_details').select('*').eq('id', id)
 .eq('institute_id', sessionInstID)
.single();

    if (error || !data) return alert("Error: Teacher not found with ID " + id);

    // Populate UI
    document.getElementById('tch-id').value = data.id;
    document.getElementById('tch-name').value = data.teacher_name;
    document.getElementById('tch-age').value = data.age;
    document.getElementById('tch-gender').value = data.gender;
    document.getElementById('tch-join').value = data.joining_date;
    document.getElementById('tch-qual').value = data.qualification;
    document.getElementById('tch-subject').value = data.subject_taught;
    document.getElementById('tch-salary').value = data.salary_offered;

    alert("Details Loaded for " + data.teacher_name);
}

// 5. EDIT TEACHER
async function editTeacher() {
    const id = document.getElementById('tch-id').value;
    if (!id) return alert("Error: Fetch a teacher first using FETCH button.");

    const tchData = {
        teacher_name: document.getElementById('tch-name').value,
        age: parseInt(document.getElementById('tch-age').value) || 0,
        gender: document.getElementById('tch-gender').value,
        joining_date: document.getElementById('tch-join').value,
        qualification: document.getElementById('tch-qual').value,
        subject_taught: document.getElementById('tch-subject').value,
        salary_offered: parseFloat(document.getElementById('tch-salary').value) || 0
    };

    const { error } = await db.from('teacher_details').update(tchData).eq('id', id);

    if (error) alert("Update Error: " + error.message);
    else alert("Success! Teacher details updated.");
}
/* ==========================================
   12. STUDENT PORTAL (View Only)
   ========================================== */
/* ==========================================
   STUDENT PORTAL DATA SYNC
   ========================================== */
async function fetchStudentPortalData() {
    const roll = document.getElementById('portal-roll-input').value.trim();
    const monthVal = document.getElementById('portal-month-input').value;

    if (!roll || !monthVal) {
        return alert("Please enter Roll Number and select a Month.");
    }

    // Convert YYYY-MM to "Month Year" for attendance query
    const dateObj = new Date(monthVal + "-01");
    const targetMonthYear = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    try {
        // 1. Fetch Student & Fee Data
        const { data: student, error: stuErr } = await db
            .from('students')
            .select('*')
            .eq('roll_number', roll)
            .single();

        if (stuErr || !student) throw new Error("Student Roll Number not found.");

if (monthVal < student.admission_date.substring(0, 7)) return alert("NOT AVAILABLE: Selected month is before the student's date of joining.");

        // 2. Fetch Attendance Data for the selected month
        const { data: attendance } = await db
            .from('attendance')
            .select('status')
            .eq('roll_number', roll)
            .eq('month_year', targetMonthYear);

        const presentDays = attendance ? attendance.filter(a => a.status === 'Present').length : 0;
        const absentDays = attendance ? attendance.filter(a => a.status === 'Absent').length : 0;

        // 3. Fetch Performance Data (Exams)
        const { data: performance } = await db
            .from('performance_tracking')
            .select('*')
            .eq('student_id', student.id)
            .single();

        // 4. Update UI
        document.getElementById('portal-display-area').style.display = 'block';
        
        // Basic Info
        document.getElementById('p-name').innerText = student.full_name;
        document.getElementById('p-course').innerText = student.course || "N/A";
        document.getElementById('p-join').innerText = student.admission_date;
        
        // Fee Info
        document.getElementById('p-paid').innerText = "₹ " + (student.paid_amount || 0).toLocaleString('en-IN');
        document.getElementById('p-pending').innerText = "₹ " + (student.pending_amount || 0).toLocaleString('en-IN');
        
        // Attendance Info
        document.getElementById('p-present').innerText = presentDays;
        document.getElementById('p-absent').innerText = absentDays;

        // Performance & Teacher Info
        if (performance) {
            const marks = parseFloat(performance.total_marks_secured) || 0;
            const exams = parseInt(performance.total_exams) || 0;
            const percent = exams > 0 ? ((marks / (exams * 100)) * 100).toFixed(1) : 0;

            document.getElementById('p-teacher').innerText = performance.teacher_name || "N/A";
            document.getElementById('p-total-score').innerText = marks;
            document.getElementById('p-exam-count').innerText = exams;
            document.getElementById('p-percent').innerText = percent + "%";
        } else {
            document.getElementById('p-teacher').innerText = "Not Assigned";
            document.getElementById('p-total-score').innerText = "0";
            document.getElementById('p-exam-count').innerText = "0";
            document.getElementById('p-percent').innerText = "0%";
        }

    } catch (err) {
        alert(err.message);
        document.getElementById('portal-display-area').style.display = 'none';
    }
}
/* ==========================================
   13. GENERATORS (ID Card & Certificate)
   ========================================== */
/* ==========================================
   ID CARD GENERATION LOGIC
   ========================================== */
async function generateIDCard() {
    const mobile = document.getElementById('id-fetch-mobile').value.trim();
    const photoInput = document.getElementById('id-photo-input');
    
    if(!mobile) return alert("Please enter a mobile number");

    // 1. Handle Photo Preview First
    const photoDisplay = document.getElementById('card-photo-display');
    const placeholder = document.getElementById('card-photo-placeholder');
    
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            photoDisplay.src = e.target.result;
            photoDisplay.style.display = 'block';
            placeholder.style.display = 'none';
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        // Reset to placeholder if no file selected
        photoDisplay.style.display = 'none';
        placeholder.style.display = 'block';
    }

    // 2. Fetch Student Data from Supabase
    const { data: student, error: stuErr } = await db
        .from('students')
        .select('*')
        .eq('mobile', mobile)
        .single();

    if (stuErr || !student) return alert("Student not found with this mobile number.");

    // 3. Fetch Roll Number and End Date from Details
    const { data: detail } = await db
        .from('student_details')
        .select('*')
        .eq('student_id', student.id)
        .single();

    // 4. Update the Visual Card UI
    document.getElementById('card-student-name').innerText = student.full_name;
    document.getElementById('card-course').innerText = student.course || "N/A";
    document.getElementById('card-batch').innerText = student.batch_time || "N/A";
    document.getElementById('card-start').innerText = student.admission_date || "N/A";
    
    // Data from details table
    document.getElementById('card-roll').innerText = detail ? detail.roll_number : "PENDING";
    document.getElementById('card-end').innerText = detail ? detail.course_end_date : "N/A";

    // 5. Show the Preview Area and Print Button
    document.getElementById('id-card-preview-area').style.display = 'flex';
    document.getElementById('id-print-btn').style.display = 'block';
    
    console.log("ID Card Generated for: " + student.full_name);
}

/* ==========================================
   CERTIFICATE GENERATION LOGIC
   ========================================== */
async function generateCertificate() {
    const mobile = document.getElementById('cert-fetch-mobile').value;
    if(!mobile) return alert("Please enter mobile number");

    // 1. Fetch Student Data
    const { data: student, error: err1 } = await db.from('students').select('*').eq('mobile', mobile).single();
    if (err1 || !student) return alert("Student not found.");

    // 2. Fetch Extended Details (Roll No & End Date)
    const { data: details } = await db.from('student_details').select('*').eq('student_id', student.id).single();
    if (!details) return alert("ID card details not found. Please save student management details first.");

    // 3. Fetch Institute Settings
    const { data: settings } = await db.from('institute_settings').select('*').limit(1).single();

    // 4. Generate or Fetch unique Certificate Number
    let certNo;
    const { data: existingCert } = await db.from('certificates').select('cert_number').eq('student_id', student.id).single();
    
    if (existingCert) {
        certNo = existingCert.cert_number;
    } else {
        const randomID = Math.floor(1000 + Math.random() * 9000);
        certNo = `IMS/CERT/${new Date().getFullYear()}/${randomID}`;
        // Save it so it never changes for this student
        await db.from('certificates').insert([{
 institute_id: sessionInstID, student_id: student.id, cert_number: certNo }]);
    }

    // 5. Populate Template
    document.getElementById('cert-name').innerText = student.full_name;
    document.getElementById('cert-roll').innerText = details.roll_number;
    document.getElementById('cert-number').innerText = certNo;
    document.getElementById('cert-course').innerText = student.course;
    
    // Duration Logic
    const duration = `${student.admission_date} to ${details.course_end_date || 'Ongoing'}`;
    document.getElementById('cert-duration').innerText = duration;
    
    document.getElementById('cert-inst-branch').innerText = settings.branch_name;
    document.getElementById('cert-signatory').innerText = settings.authorised_signatory;

    // 6. Show Preview
    document.getElementById('cert-preview-area').style.display = 'flex';
    document.getElementById('cert-print-btn').style.display = 'block';
}

function printCertificate() {
    const content = document.getElementById('certificate-visual').outerHTML;
    const win = window.open('', '_blank', 'width=1000,height=800');
    win.document.write(`
        <html>
            <head>
                <title>IMS Certificate</title>
                <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
                <style>
                    body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
                    @media print { @page { size: landscape; margin: 0; } }
                </style>
            </head>
            <body onload="window.print(); window.close();">${content}</body>
        </html>
    `);
    win.document.close();
}

/* ==========================================
   14. PERFORMANCE TRACKING
   ========================================== */
/* ==========================================
   PERFORMANCE TRACKING LOGIC
   ========================================== */

// 1. Calculate Average Score Formula
function calculateAvgScore() {
    const marks = parseFloat(document.getElementById('perf-marks').value) || 0;
    const exams = parseInt(document.getElementById('perf-exam-count').value) || 0;
    
    if (exams > 0) {
        // Formula: (Marks / (Exams * 100)) * 100 -> Simplified: Marks / Exams
        const avg = (marks / exams).toFixed(2);
        document.getElementById('perf-avg-display').value = avg + "%";
    } else {
        document.getElementById('perf-avg-display').value = "0%";
    }
}

// 2. Fetch and Calculate All Data
async function fetchPerformanceData() {
    const mobile = document.getElementById('perf-fetch-mobile').value.trim();
    if (!mobile) return alert("Please enter the Student Mobile Number");

    if (!sessionInstID) return alert("Login required.");

    try {
        // STEP 1: Find Student by Mobile in 'students' table
        const { data: student, error: stuErr } = await db
            .from('students')
            .select('id, full_name, roll_number, course, admission_date')
            .eq('mobile', mobile)
            .eq('institute_id', sessionInstID)
            .maybeSingle();

        if (stuErr) throw stuErr;
        if (!student) return alert("No student found with this mobile number in your institute.");

        const roll = student.roll_number;

        // STEP 2: Fetch all marks for this Roll Number from 'exam' table
        const { data: examRecords, error: examErr } = await db
            .from('exam')
            .select('marks_obtained, total_marks')
            .eq('roll_number', roll)
            .eq('institute_id', sessionInstID);

        if (examErr) throw examErr;

        // STEP 3: Fetch existing summary from 'performance_tracking' (for Teacher Name)
        const { data: summary } = await db
            .from('performance_tracking')
            .select('teacher_name')
            .eq('roll_number', roll)
            .eq('institute_id', sessionInstID)
            .maybeSingle();

        // STEP 4: Calculate Totals
        let totalObtained = 0;
        let examCount = 0;
        let avgPercent = 0;

        if (examRecords && examRecords.length > 0) {
            examCount = examRecords.length;
            totalObtained = examRecords.reduce((sum, r) => sum + (parseFloat(r.marks_obtained) || 0), 0);
            const totalPossible = examRecords.reduce((sum, r) => sum + (parseFloat(r.total_marks) || 0), 0);
            avgPercent = totalPossible > 0 ? (totalObtained / totalPossible) * 100 : 0;
        }

        // STEP 5: Populate the UI
        document.getElementById('perf-today').value = new Date().toLocaleDateString();
        document.getElementById('perf-name').value = student.full_name;
        document.getElementById('perf-roll').value = roll;
        document.getElementById('perf-course').value = student.course || "N/A";
        document.getElementById('perf-joining').value = student.admission_date || "N/A";
        
        // Auto-calculated fields
        document.getElementById('perf-marks').value = totalObtained;
        document.getElementById('perf-exam-count').value = examCount;
        document.getElementById('perf-avg-display').value = avgPercent.toFixed(2) + "%";
        
        // Populate teacher name if it was saved before
        document.getElementById('perf-teacher').value = summary ? summary.teacher_name : "";

        // Show the UI
        document.getElementById('performance-report-area').style.display = 'block';
        alert(`Found ${student.full_name}. Performance synced from ${examCount} exam records.`);

    } catch (err) {
        console.error("Link Error:", err);
        alert("Database connection error: " + err.message);
    }
}
// 3. Save performance to database
async function savePerformanceData() {
    const roll = document.getElementById('perf-roll').value;
    if (!roll) return alert("Please fetch a student first.");

    const updateData = {
        institute_id: sessionInstID,
        roll_number: roll,
        total_marks_secured: parseFloat(document.getElementById('perf-marks').value) || 0,
        total_exams: parseInt(document.getElementById('perf-exam-count').value) || 0,
        teacher_name: document.getElementById('perf-teacher').value,
        updated_at: new Date().toISOString()
    };

    // This uses the 'onConflict' rule we set in SQL in Part 1
    const { error } = await db
        .from('performance_tracking')
        .upsert(updateData, { onConflict: 'roll_number, institute_id' });

    if (error) alert("Save Error: " + error.message);
    else alert("Performance summary updated successfully!");
}

/* ==========================================
   EXAM MODULE LOGIC
   ========================================== */

async function fetchStudentForExam() {
    const roll = document.getElementById('ex-roll').value.trim().toUpperCase();
    if(!roll) return alert("Enter Roll Number");
    const { data } = await db.from('students').select('full_name, course').eq('roll_number', roll).eq('institute_id', sessionInstID).maybeSingle();
    if(data) {
        document.getElementById('ex-name').value = data.full_name;
        document.getElementById('ex-course').value = data.course;
    } else alert("Student not found in your institute.");
}

function calcExamResult() {
    const total = parseFloat(document.getElementById('ex-total').value) || 0;
    const obt = parseFloat(document.getElementById('ex-obt').value) || 0;
    
    if (total > 0) {
        const pctValue = (obt / total) * 100;
        document.getElementById('ex-pct').value = pctValue.toFixed(2); // Store as number for DB
        
        let res = "";
        if (pctValue >= 85) res = "Distinction";
        else if (pctValue >= 75) res = "A Grade";
        else if (pctValue >= 60) res = "B Grade";
        else if (pctValue >= 40) res = "C Grade";
        else res = "Failed";
        
        document.getElementById('ex-res').value = res;
    }
}


async function addExamRecord() {
    if(!sessionInstID) return alert("Login required");
    
    const record = {
        institute_id: sessionInstID,
        exam_date: document.getElementById('ex-date').value,
        roll_number: document.getElementById('ex-roll').value.toUpperCase(),
        full_name: document.getElementById('ex-name').value,
        course_name: document.getElementById('ex-course').value,
        total_marks: parseFloat(document.getElementById('ex-total').value),
        marks_obtained: parseFloat(document.getElementById('ex-obt').value),
        percentage: parseFloat(document.getElementById('ex-pct').value), // Numerical
        result: document.getElementById('ex-res').value
    };

    if(!record.exam_date || !record.roll_number) return alert("Please fill Date and Roll Number");

    const { error } = await db.from('exam').insert([record]);
    if(error) alert("Error: " + error.message); 
    else alert("Exam Result Saved Successfully!");
}


async function fetchExamByRoll() {
    const roll = prompt("Enter Roll Number to see last exam:");
    const { data, error } = await db.from('exam').select('*').eq('roll_number', roll.toUpperCase()).eq('institute_id', sessionInstID).order('exam_date', {ascending: false}).limit(1).maybeSingle();
    if(data) {
        document.getElementById('ex-date').value = data.exam_date;
        document.getElementById('ex-roll').value = data.roll_number;
        document.getElementById('ex-name').value = data.full_name;
        document.getElementById('ex-course').value = data.course_name;
        document.getElementById('ex-total').value = data.total_marks;
        document.getElementById('ex-obt').value = data.marks_obtained;
        calcExamResult();
    } else alert("No exam records found.");
}

/* ==========================================
   TEACHER ATTENDANCE LOGIC
   ========================================== */

async function fetchTeacherForTAttn() {
    const tid = document.getElementById('t-attn-id').value.trim().toUpperCase();
    const { data } = await db.from('teacher_details').select('teacher_name').eq('id', tid).eq('institute_id', sessionInstID).maybeSingle();
    if(data) document.getElementById('t-attn-name').value = data.teacher_name;
    else alert("Teacher ID not found.");
}

function triggerTAttn(status) {
    const name = document.getElementById('t-attn-name').value;
    if(!name) return alert("Fetch Teacher first");
    const picker = document.getElementById('t-date-picker');
    picker.showPicker();
    picker.onchange = async () => {
        if(!picker.value) return;
        const monthYear = new Date(picker.value).toLocaleString('default', { month: 'long', year: 'numeric' });
        const { error } = await db.from('teachers_attendance').insert([{
            institute_id: sessionInstID,
            teacher_id: document.getElementById('t-attn-id').value.toUpperCase(),
            full_name: name,
            attendance_date: picker.value,
            status: status,
            month_year: monthYear
        }]);
        if(error) alert(error.message); 
        else {
            alert("Teacher marked " + status);
            document.getElementById('t-attn-status').value = status;
        }
    };
}

async function fetchTeacherHistory() {
    const tid = document.getElementById('t-attn-id').value.toUpperCase();
    const month = document.getElementById('t-attn-month').value; // YYYY-MM
    if(!tid || !month) return alert("Select Teacher ID and Month");
    const monthYear = new Date(month + "-01").toLocaleString('default', { month: 'long', year: 'numeric' });
    
    const { count } = await db.from('teachers_attendance')
        .select('*', { count: 'exact', head: true })
        .eq('teacher_id', tid).eq('month_year', monthYear).eq('status', 'Present');
    
    alert(`Teacher ${tid} was Present for ${count} days in ${monthYear}`);
}
/* ==========================================
   15. NAVIGATION & INIT
   ========================================== */
/* ==========================================
   FINAL NAVIGATION & AUTO-POPULATION LOGIC
   ========================================== */
function showSection(id) {
    // 1. UI SWITCHING: Hide all sections and show the target one
    const sections = document.querySelectorAll('.content-section');
    sections.forEach(s => s.classList.remove('active'));

    const targetSection = document.getElementById(id);
    if (targetSection) {
        targetSection.classList.add('active');
        console.log("Navigated to: " + id);
    } else {
        console.error("Error: Section ID '" + id + "' does not exist in HTML.");
        return;
    }

    // 2. DATA AUTO-POPULATION: Trigger specific loaders based on the tab
    try {
        switch (id) {
            case 'admin':
                // Set default month to current month for Admin Dashboard if empty
                const adminMonthInput = document.getElementById('admin-filter-month');
                if (adminMonthInput && !adminMonthInput.value) {
                    adminMonthInput.value = new Date().toISOString().substring(0, 7);
                }
                if (typeof loadAdminDashboard === 'function') loadAdminDashboard();
                break;

            case 'fee':
                // Auto-load Fee Management Summary
                if (typeof loadFeesPortal === 'function') loadFeesPortal();
                break;

            case 'reminder':
                // Auto-load Fee Reminder Dashboard
                if (typeof loadFeeReminders === 'function') loadFeeReminders();
                break;

            case 'student-p':
                // Auto-load Personal Student Portal
                if (typeof loadStudentPortal === 'function') loadStudentPortal();
                break;

            default:
                // No auto-population required for other sections
                break;
        }
    } catch (err) {
        // This catch block prevents a crash in one module from killing the whole app
        console.warn("Auto-population notice for section [" + id + "]: " + err.message);
    }
}


/* --- PWA INSTALL LOGIC WRAPPED IN DOM CONTENT LOADED --- */
document.addEventListener('DOMContentLoaded', () => {
    let deferredPrompt;
    const installBtn = document.getElementById('pwa-install-btn');

    // 1. Listen for the browser's install signal
    window.addEventListener('beforeinstallprompt', (e) => {
        // Stop the browser from showing its own small bar
        e.preventDefault();
        // Save the event so we can use it when the user clicks our button
        deferredPrompt = e;
        
        // Show our flamboyant install button
        if (installBtn) {
            installBtn.style.display = 'flex';
        }
    });

    // 2. Handle the click on our custom button
    if (installBtn) {
        installBtn.addEventListener('click', () => {
            if (deferredPrompt) {
                // Show the official prompt
                deferredPrompt.prompt();
                
                // See what the user chose
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User installed IMS');
                    }
                    // Hide our button regardless of choice
                    installBtn.style.display = 'none';
                    deferredPrompt = null;
                });
            }
        });
    }

    // 3. Hide button if already installed
    window.addEventListener('appinstalled', () => {
        if (installBtn) installBtn.style.display = 'none';
        deferredPrompt = null;
        console.log('IMS installed successfully');
    });
});
    </script>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
    .then(() => console.log("IMS Service Worker Registered"))
    .catch(err => console.log("Service Worker Failed", err));
}
</script>
<!-- PWA Install Button -->
<button id="pwa-install-btn" style="display: none;">
    <i class="fas fa-download"></i> INSTALL APP
</button>
</body>
</html>
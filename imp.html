<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Supabase JS Library CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <title>Class Manager - IMS</title>
    <!-- PWA Setup -->
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
:root {
            --aquamarine: #7FFFD4;
            --white: #ffffff;
            --dark: #000000;
            --shadow-aqua: #66ccaa; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--white);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- HEADER & 3D SPLIT TITLE --- */
        header {
            background: linear-gradient(135deg, var(--white), var(--aquamarine));
            padding: 30px 5%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            border-bottom: 5px solid #000;
        }

        .rotating-logo {
            width: 60px; height: 60px;
            background: #000; border-radius: 20%;
            display: flex; align-items: center; justify-content: center;
            animation: rotate3D 5s linear infinite;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .rotating-logo img { width: 100%; height: 100%; object-fit: contain; }
        @keyframes rotate3D { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }

 /* --- TITLE BOX FIX --- */
        .title-box {
            transform: rotate(-3deg);
            text-align: center;
            display: flex;         /* Use flexbox to stack items */
            flex-direction: column; /* Stack vertically */
            align-items: center;    /* Center horizontally */
        }

        .tagline {
            display: block;         /* Force it to its own line */
            font-size: 1.5rem;
            color: #000;
            font-weight: 600;
            margin-top: 10px;       /* Adds space between Title and Tagline */
            letter-spacing: 2px;
            font-family: 'Times New Roman', Times, serif;
        }
        .main-title {
            font-size: 4rem; font-weight: 900; line-height: 1;
            display: inline-block; text-transform: uppercase;
            background: linear-gradient(to bottom, #ff0000 50%, #000000 50%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(1px 1px 0px #ccc) drop-shadow(2px 2px 0px #bbb) drop-shadow(3px 3px 0px #aaa) drop-shadow(5px 5px 10px rgba(0,0,0,0.4));
        }

        /* --- SIDE-BY-SIDE LAYOUT --- */
        .app-container {
            display: flex;
            flex-direction: row; /* FORCES SIDE BY SIDE */
            flex: 1;
            width: 100%;
        }

        /* --- LEFT SIDEBAR (PURE WHITE) --- */
        nav.sidebar {
            width: 300px;
            min-width: 300px;
            background: #ffffff;
            padding: 30px 15px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .nav-tab {
height: 65px; white-space: nowrap;
            width: 100%;
            padding: 15px 20px;
            border: none;
            background: #ffffff;
            color: #000000 !important;
            text-align: left;
            font-size: 1.1rem;
            font-weight: bold;
            font-family: 'Times New Roman', Times, serif !important;
            cursor: pointer;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-radius: 10px;
            /* 3D EFFECT */
            box-shadow: 0 5px 0px #cccccc, 0 5px 10px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .nav-tab:hover {
            transform: translateY(-5px); /* RISE UP */
            box-shadow: 0 10px 0px #bbbbbb, 0 15px 25px rgba(0,0,0,0.15);
        }

        .nav-tab.active { background: #f0f0f0; border-left: 6px solid #ff0000; top: 2px; }

        /* --- RIGHT MAIN AREA (AQUAMARINE) --- */
        main.content {
            flex: 1;
            padding: 50px;
            background: var(--aquamarine);
            font-family: 'Times New Roman', Times, serif !important;
            color: #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .content-section { display: none; width: 100%; animation: fadeIn 0.5s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS (AQUAMARINE WITH 3D RISE) --- */
        .card {
            background: var(--aquamarine);
            color: #000000;
            padding: 40px;
            border-radius: 20px;
            margin: 0 auto 40px;
            max-width: 900px;
            border: 2px solid #000;
            /* 3D EFFECT */
            box-shadow: 0 10px 0px var(--shadow-aqua), 0 15px 30px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
        }

        .card:hover {
            transform: translateY(-10px); /* RISE UP */
            box-shadow: 0 20px 0px var(--shadow-aqua), 0 30px 45px rgba(0,0,0,0.3);
        }

        .card h3, .card h2, .card h4 {
            color: #000 !important;
            font-family: 'Times New Roman', Times, serif !important;
            margin-bottom: 20px;
            text-decoration: underline;
        }

        /* Forms & Writeup centered on Home, but structured on Internal */
        .bullet-list { list-style: none; padding: 0; margin: 20px auto; display: inline-block; text-align: left; }
        .bullet-list li { margin: 12px 0; padding-left: 30px; position: relative; font-size: 1.3rem; }
        .bullet-list li::before { content: '✕'; color: #ff0000; position: absolute; left: 0; font-weight: bold; }

        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; text-align: left;
        }

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-weight: bold; color: #000; }

        input, select, textarea {
            padding: 12px; border: 1px solid #000; border-radius: 8px;
            font-family: 'Times New Roman', Times, serif !important;
            background: #fff; color: #000;
        }

        .button-row { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .btn-add, .btn-edit, .btn-fetch {
            padding: 12px 25px; border-radius: 8px; border: 1px solid #000; color: white;
            font-family: 'Times New Roman', Times, serif !important; font-weight: bold;
            box-shadow: 0 4px 0px rgba(0,0,0,0.3); cursor: pointer;
        }
        .btn-add { background: #27ae60; }
        .btn-edit { background: #f39c12; }
        .btn-fetch { background: #007bff; }

        /* --- FOOTER (Times New Roman, 5 Columns) --- */
        footer {
            background: #1a1a1a;
            color: white;
            padding: 60px 5% 40px;
            font-family: 'Times New Roman', Times, serif !important;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 50px;
            text-align: left;
        }

        .footer-col h4 { color: var(--aquamarine); margin-bottom: 20px; text-transform: uppercase; }
        .footer-col ul { list-style: none; }
        .footer-col ul li a { color: #ccc; text-decoration: none; }
        .footer-bottom { border-top: 1px solid #333; padding-top: 30px; text-align: center; }

        /* PWA INSTALL BUTTON (RESTORED) */
        #pwa-install-btn {
            position: fixed; bottom: 30px; right: 30px;
            background: white; color: #ff0000; border: 3px solid #ff0000;
            padding: 15px 30px; border-radius: 50px; font-weight: 900;
            font-family: 'Times New Roman', Times, serif !important;
            cursor: pointer; z-index: 10000; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: 0.3s;
        }
        #pwa-install-btn:hover { transform: scale(1.1) translateY(-5px); background: #ff0000; color: #fff; }

        @media (max-width: 992px) {
            .app-container { flex-direction: column; }
            nav.sidebar { width: 100%; min-width: 100%; flex-direction: row; overflow-x: auto; height: auto; }
            .nav-tab { white-space: nowrap; width: auto; }
            .footer-grid { grid-template-columns: repeat(2, 1fr); }
        }




/* --- AUTH STATUS BAR --- */
        #auth-status-bar {
            display: none; /* Hidden by default, shown via JS */
            flex-direction: row;
        }

        .btn-logout {
            background: #ff0000;
            color: #fff;
            border: 1px solid #000;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Times New Roman', Times, serif !important;
            font-weight: bold;
            box-shadow: 0 4px 0px #990000;
            transition: 0.2s;
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0px #990000;
        }

        .btn-logout:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0px #990000;
        }



#absent-wa-link {
    box-shadow: 0 4px 0px #128C7E;
    transition: 0.2s;
}
#absent-wa-link:hover {
    transform: translateY(-3px);
    box-shadow: 0 7px 0px #128C7E;
}


#upi-qr-area {
    box-shadow: 0 10px 0px #cccccc;
    transition: 0.3s;
}
#upi-qr-area:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 0px #bbbbbb;
}
#upi-qr-img {
    display: block;
    margin: 0 auto;
}




--shadow-aqua: #66ccaa; 
    }

    /* ADD THIS DASHBOARD CSS */
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        width: 100%;
        max-width: 900px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        text-align: center;
        border: 1px solid #000;
    }
    .stat-card p { font-weight: bold; font-size: 0.9rem; color: #666; margin-bottom: 10px; }
    .stat-card h4 { font-size: 2rem !important; margin: 0 !important; text-decoration: none !important; }

    * { box-sizing: border-box; margin: 0; padding: 0; }







/* --- MOBILE COMPLIANCE ADDITIONS (OVERRIDE ONLY) --- */
@media (max-width: 768px) {
    /* 1. Shrink the giant 3D title so it fits on one screen */
    .main-title { 
        font-size: 1.8rem !important; 
    }
    .tagline { 
        font-size: 0.9rem !important; 
    }
    header { 
        flex-direction: column !important; 
        padding: 15px !important; 
        gap: 10px !important; 
    }

    /* 2. Change Sidebar to a Horizontal Scroll bar at the top */
    .app-container { 
        flex-direction: column !important; 
    }
    nav.sidebar {
        width: 100% !important;
        min-width: 100% !important;
        flex-direction: row !important;
        overflow-x: auto !important;
        padding: 10px !important;
        position: sticky !important;
        top: 0 !important;
        background: #fff !important;
        border-bottom: 2px solid #ddd !important;
        z-index: 1000 !important;
    }
    .nav-tab {
        margin-bottom: 0 !important;
        margin-right: 10px !important;
        padding: 10px 15px !important;
        font-size: 0.85rem !important;
        white-space: nowrap !important; /* Prevents text from wrapping */
    }

    /* 3. Reduce huge desktop padding and stack all grids into 1 column */
    main.content { 
        padding: 15px !important; 
    }
    .card { 
        padding: 20px !important; 
        margin-bottom: 20px !important; 
    }
    .form-grid, .dashboard-stats, .feature-grid, .footer-grid {
        grid-template-columns: 1fr !important; 
    }

    /* 4. Make buttons easier to click with thumbs */
    .button-row { 
        flex-direction: column !important; 
        width: 100% !important; 
    }
    .btn-add, .btn-edit, .btn-fetch { 
        width: 100% !important; 
    }

    /* 5. Adjust Auth bar for small screens */
    #auth-status-bar {
        flex-direction: column !important;
        gap: 10px !important;
        text-align: center !important;
    }
}








.btn-time-table {
    display: inline-block;
    background: #4CAF50; /* green button */
    color: white;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
    text-decoration: none;
    transition: background 0.3s;
}

.btn-time-table:hover {
    background: #45a049;
}


@media (max-width: 768px) { .nav-tab { width: 220px !important; min-width: 220px !important; } }
@media (max-width: 768px) { nav.sidebar { flex-direction: column !important; } .nav-tab { width: 100% !important; margin-right: 0 !important; margin-bottom: 10px !important; justify-content: flex-start !important; padding-left: 25% !important; } .nav-tab i { width: 30px !important; text-align: center !important; } }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <!-- Provision for Logo -->
            <div class="rotating-logo">
    <img src="classmanager.png" alt="ClassManager Logo">
</div>

        </div>
        <div class="title-box">
            <h1 class="main-title">CLASS MANAGER- IMS</h1>
            <span class="tagline">Track Right, Grow Bright.</span>
        </div>
    </header>

<div style="text-align:center; margin:20px;"><a href="time_table.html" target="_blank" style="background-color:#007bff;color:white;padding:10px 20px;border-radius:5px;text-decoration:none;font-weight:bold;"><i class="fas fa-calendar-alt"></i> Open Time Table</a></div>






<!-- ADD THIS NEW BAR HERE -->
<div id="auth-status-bar" style="display: none; background: #ffffff; padding: 10px 5%; border-bottom: 2px solid #000; justify-content: space-between; align-items: center; font-family: 'Times New Roman', Times, serif;">
    <h3 id="user-greeting" style="color: #000; margin: 0;"></h3>
    <button id="logout-btn" onclick="handleLogout()" class="btn-logout">Logout</button>
</div>








    <div class="app-container">
        <aside class="sidebar">
            <button class="nav-tab active" onclick="showSection('home')"><i class="fas fa-home"></i>1. Home</button>
            <button class="nav-tab" onclick="showSection('login')"><i class="fas fa-user-lock"></i> 2. Login System</button>
            <button class="nav-tab" onclick="showSection('students')"><i class="fas fa-user-graduate"></i> 3. Student Management</button>
            <button class="nav-tab" onclick="showSection('fee')"><i class="fas fa-money-bill-wave"></i> 4. Fee Management</button>
            <button class="nav-tab" onclick="showSection('batch')"><i class="fas fa-layer-group"></i> 5. Batch Management</button>
            <button class="nav-tab" onclick="showSection('attendance')"><i class="fas fa-clipboard-check"></i> 6. Attendance</button>
            <button class="nav-tab" onclick="showSection('admin')"><i class="fas fa-user-shield"></i> 7. Admin Dashboard</button>
            <button class="nav-tab" onclick="showSection('reminder')"><i class="fas fa-bell"></i> 8. Fee Reminder System</button>
            <button class="nav-tab" onclick="showSection('leads')"><i class="fas fa-funnel-dollar"></i> 9. Lead Management</button>
            <button class="nav-tab" onclick="showSection('expense')"><i class="fas fa-wallet"></i> 10. Expense Tracking</button>
            <button class="nav-tab" onclick="showSection('teacher')"><i class="fas fa-chalkboard-teacher"></i> 11. Teacher Portal</button>
            <button class="nav-tab" onclick="showSection('student-p')"><i class="fas fa-user"></i> 12. Students Portal</button>
            <button class="nav-tab" onclick="showSection('id-gen')"><i class="fas fa-id-card"></i> 13. ID Card Generator</button>
            <button class="nav-tab" onclick="showSection('cert-gen')"><i class="fas fa-certificate"></i> 14. Certificate Generator</button>
            <button class="nav-tab" onclick="showSection('tracking')"><i class="fas fa-chart-line"></i> 15. Performance Tracking</button>
<button class="nav-tab" onclick="showSection('exam-mod')"><i class="fas fa-file-signature"></i> 16. Exam Management</button>
<button class="nav-tab" onclick="showSection('t-attn-mod')"><i class="fas fa-user-check"></i> 17. Teacher Attendance</button>
<button class="nav-tab" onclick="showSection('allocation-mod')"><i class="fas fa-link"></i> 18. Student Allocation</button>
<button class="nav-tab" onclick="showSection('message-corner'); msgEngine('General');"><i class="fas fa-comments"></i> 19. Message Corner</button>
<button class="nav-tab" onclick="showSection('calendar-mod')"><i class="fas fa-calendar-alt"></i> 20. Academic Calendar</button>
<button class="nav-tab" onclick="showSection('alumni-mod')"><i class="fas fa-user-graduate"></i> 21. Alumni Section</button>
<button class="nav-tab" onclick="showSection('inventory-mod')"><i class="fas fa-boxes"></i> 22. Inventory Manager</button>
<button class="nav-tab" onclick="showSection('scholarship-mod')"><i class="fas fa-award"></i> 23. Scholarship Tracker</button>
<button class="nav-tab" onclick="showSection('ptm-mod')"><i class="fas fa-handshake"></i> 24. PTM Schedule</button>
<button class="nav-tab" onclick="showSection('batch-master')"><i class="fas fa-users-cog"></i> 25. Batch Master</button>


        </aside>

        <main class="content" id="main-content">
            <!-- DEFAULT HOME PAGE -->
           <!-- DEFAULT HOME PAGE -->
            <section id="home" class="content-section active">
    <!-- 1. LOGGED-IN VIEW -->
    <div id="home-user-view" style="display: none; width: 100%;">
        <div class="dashboard-stats" style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px;">
            <div class="stat-card" style="border-bottom: 5px solid #27ae60;">
                <p>ADMISSIONS</p><h4 id="home-total-stu">0</h4><small>Active Students</small>
            </div>
            <div class="stat-card" style="border-bottom: 5px solid #1877F2;">
                <p>COLLECTION</p><h4 id="home-total-coll">₹ 0</h4><small>Total Received</small>
            </div>
            <div class="stat-card" style="border-bottom: 5px solid #ff0000;">
                <p>PENDING</p><h4 id="home-total-pend">₹ 0</h4><small>Outstanding Fees</small>
            </div>
<!-- ADDED: INVENTORY INCOME CARD -->
<div class="stat-card" style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); text-align: center; border: 1px solid #000; min-width: 200px; border-bottom: 5px solid #673ab7;">
    <p style="font-weight: bold; color: #666; margin-bottom: 10px;">INVENTORY INCOME</p>
    <h4 id="home-total-inventory" style="font-size: 2.5rem; margin: 0; color: #000;">₹ 0</h4>
    <small>Current Month Sales</small>
</div>
<!-- FINANCIAL FORECAST HIGHLIGHTS (Next 6 Months) -->
<h3 style="margin-top: 30px; text-decoration: none;">Incoming Fees (6-Month Forecast)</h3>
<div id="forecast-cards" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
    <!-- Month cards will be auto-generated here by JavaScript -->
</div>

<!-- GOOGLE CHART & SLICER CONTAINER -->
<div id="home_dashboard_div" style="width: 100%; max-width: 900px; margin: 0 auto; background: white; padding: 20px; border: 2px solid #000; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
    <div id="home_filter_div" style="background: #f0fdfa; padding: 10px; border-radius: 10px; border: 1px solid #7FFFD4; margin-bottom: 20px;"></div>
    <div id="home_line_chart" style="height: 400px; width: 100%;"></div>
</div>
        </div>
    </div>

<!-- 2. VISITOR VIEW -->
    <div id="home-visitor-view" style="width: 100%; text-align: center; margin-bottom: 30px;">
        
        <!-- The Image -->
        <img src="classmanager1.png" alt="ClassManager Overview" style="max-width: 100%; height: auto; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); margin-bottom: 50px;">
        
        <!-- The Features Section -->
        <h2 class="hero-title" style="font-family: 'Times New Roman', Times, serif; font-size: 2.5rem; color: #000; margin-bottom: 30px; text-decoration: underline;">
            Why coaching institutes choose ClassManager
        </h2>
        
        <div class="feature-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; width: 100%; max-width: 1100px; margin: 0 auto;">
            <div class="card" style="padding: 25px; margin: 0;">
                <h4 style="margin: 0; text-decoration: none;"><i class="fas fa-clock" style="color: #ff0000; margin-bottom:10px; display:block; font-size:1.8rem;"></i>Save hours daily</h4>
            </div>
            
            <div class="card" style="padding: 25px; margin: 0;">
                <h4 style="margin: 0; text-decoration: none;"><i class="fas fa-money-check-alt" style="color: #27ae60; margin-bottom:10px; display:block; font-size:1.8rem;"></i>Never miss fee collection</h4>
            </div>
            
            <div class="card" style="padding: 25px; margin: 0;">
                <h4 style="margin: 0; text-decoration: none;"><i class="fas fa-tasks" style="color: #1877F2; margin-bottom:10px; display:block; font-size:1.8rem;"></i>Stay fully organized</h4>
            </div>
            
            <div class="card" style="padding: 25px; margin: 0;">
                <h4 style="margin: 0; text-decoration: none;"><i class="fas fa-globe" style="color: #f39c12; margin-bottom:10px; display:block; font-size:1.8rem;"></i>Access anywhere anytime</h4>
            </div>
            
            <div class="card" style="padding: 25px; margin: 0;">
                <h4 style="margin: 0; text-decoration: none;"><i class="fas fa-laptop" style="color: #673ab7; margin-bottom:10px; display:block; font-size:1.8rem;"></i>Works on mobile & desktop</h4>
            </div>
        </div>

<!-- Everything You Need Section -->
        <div style="margin-top: 70px;">
            <h2 class="hero-title" style="font-family: 'Times New Roman', Times, serif; font-size: 2.5rem; color: #000; margin-bottom: 40px; text-decoration: underline;">
                Everything you need to manage your institute
            </h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; width: 100%; max-width: 1100px; margin: 0 auto;">
                
                <!-- Card 1 -->
                <div style="background: #ffffff; color: #000000; border: 2px solid #000; border-radius: 15px; padding: 30px; text-align: left; box-shadow: 0 8px 0px #cccccc, 0 15px 25px rgba(0,0,0,0.1); transition: 0.3s;" onmouseover="this.style.transform='translateY(-8px)'" onmouseout="this.style.transform='translateY(0)'">
                    <h3 style="margin-bottom: 15px; color: #000; font-size: 1.4rem; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-user-graduate" style="color: #007bff; font-size: 1.8rem;"></i> Student Management
                    </h3>
                    <p style="font-size: 1.05rem; font-weight: 600; color: #444; line-height: 1.5;">Centralized database for all student profiles and documents.</p>
                </div>

                <!-- Card 2 -->
                <div style="background: #ffffff; color: #000000; border: 2px solid #000; border-radius: 15px; padding: 30px; text-align: left; box-shadow: 0 8px 0px #cccccc, 0 15px 25px rgba(0,0,0,0.1); transition: 0.3s;" onmouseover="this.style.transform='translateY(-8px)'" onmouseout="this.style.transform='translateY(0)'">
                    <h3 style="margin-bottom: 15px; color: #000; font-size: 1.4rem; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-money-bill-wave" style="color: #27ae60; font-size: 1.8rem;"></i> Fee Tracking
                    </h3>
                    <p style="font-size: 1.05rem; font-weight: 600; color: #444; line-height: 1.5;">Automated receipts and pending fee alerts for parents.</p>
                </div>

                <!-- Card 3 -->
                <div style="background: #ffffff; color: #000000; border: 2px solid #000; border-radius: 15px; padding: 30px; text-align: left; box-shadow: 0 8px 0px #cccccc, 0 15px 25px rgba(0,0,0,0.1); transition: 0.3s;" onmouseover="this.style.transform='translateY(-8px)'" onmouseout="this.style.transform='translateY(0)'">
                    <h3 style="margin-bottom: 15px; color: #000; font-size: 1.4rem; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-layer-group" style="color: #f39c12; font-size: 1.8rem;"></i> Batch Management
                    </h3>
                    <p style="font-size: 1.05rem; font-weight: 600; color: #444; line-height: 1.5;">Organize students into batches with scheduled timings.</p>
                </div>

                <!-- Card 4 -->
                <div style="background: #ffffff; color: #000000; border: 2px solid #000; border-radius: 15px; padding: 30px; text-align: left; box-shadow: 0 8px 0px #cccccc, 0 15px 25px rgba(0,0,0,0.1); transition: 0.3s;" onmouseover="this.style.transform='translateY(-8px)'" onmouseout="this.style.transform='translateY(0)'">
                    <h3 style="margin-bottom: 15px; color: #000; font-size: 1.4rem; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-clipboard-check" style="color: #e74c3c; font-size: 1.8rem;"></i> Attendance Tracking
                    </h3>
                    <p style="font-size: 1.05rem; font-weight: 600; color: #444; line-height: 1.5;">Digital attendance with instant SMS notification to parents.</p>
                </div>

                <!-- Card 5 -->
                <div style="background: #ffffff; color: #000000; border: 2px solid #000; border-radius: 15px; padding: 30px; text-align: left; box-shadow: 0 8px 0px #cccccc, 0 15px 25px rgba(0,0,0,0.1); transition: 0.3s;" onmouseover="this.style.transform='translateY(-8px)'" onmouseout="this.style.transform='translateY(0)'">
                    <h3 style="margin-bottom: 15px; color: #000; font-size: 1.4rem; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-pie" style="color: #9b59b6; font-size: 1.8rem;"></i> Reports & Dashboard
                    </h3>
                    <p style="font-size: 1.05rem; font-weight: 600; color: #444; line-height: 1.5;">Comprehensive visual reports for growth and revenue.</p>
                </div>

                <!-- Card 6 -->
                <div style="background: #ffffff; color: #000000; border: 2px solid #000; border-radius: 15px; padding: 30px; text-align: left; box-shadow: 0 8px 0px #cccccc, 0 15px 25px rgba(0,0,0,0.1); transition: 0.3s;" onmouseover="this.style.transform='translateY(-8px)'" onmouseout="this.style.transform='translateY(0)'">
                    <h3 style="margin-bottom: 15px; color: #000; font-size: 1.4rem; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-funnel-dollar" style="color: #1abc9c; font-size: 1.8rem;"></i> Enquiry Management
                    </h3>
                    <p style="font-size: 1.05rem; font-weight: 600; color: #444; line-height: 1.5;">Convert leads into admissions with effective follow-ups.</p>
                </div>

            </div>
        </div>


    </div>
</section>
          <!-- 1. LOGIN SYSTEM -->

<section id="login" class="content-section">
    <div style="display: flex; gap: 40px; flex-wrap: wrap;">
        <!-- Signup -->
        <div class="card" style="flex: 1; min-width: 320px;">
            <h3>Signup</h3>
            <div class="form-grid" style="grid-template-columns: 1fr;" id="signup-form">
                <input type="text" id="sig-name" placeholder="Full Name">

               <select id="sig-role" onchange="toggleInstIdField()">
                    <option value="">Select Status</option>
                    <option>Owner</option>
                    <option>Teacher</option>
                    <option>Student</option>
                </select>
                <!-- NEW: Hidden field that only shows for Teachers/Students -->
                <input type="text" id="sig-inst-id" placeholder="Enter Owner's Institute ID (e.g. CM-1234)" style="display: none; border: 2px solid #007bff;">


                <input type="email" id="sig-email" placeholder="Email Id">
                
                <div style="position: relative;">
                    <input type="password" id="sig-pass" placeholder="Password (Min 6 chars)" style="width: 100%;">
                    <i class="fas fa-eye" onclick="togglePass('sig-pass')" style="position: absolute; right: 10px; top: 12px; cursor: pointer; color: #666;"></i>
                </div>

                <select id="sig-state">
                    <option value="">Select State / UT</option>
                    <optgroup label="States">
                        <option>Andhra Pradesh</option><option>Arunachal Pradesh</option><option>Assam</option><option>Bihar</option><option>Chhattisgarh</option><option>Goa</option><option>Gujarat</option><option>Haryana</option><option>Himachal Pradesh</option><option>Jharkhand</option><option>Karnataka</option><option>Kerala</option><option>Madhya Pradesh</option><option>Maharashtra</option><option>Manipur</option><option>Meghalaya</option><option>Mizoram</option><option>Nagaland</option><option>Odisha</option><option>Punjab</option><option>Rajasthan</option><option>Sikkim</option><option>Tamil Nadu</option><option>Telangana</option><option>Tripura</option><option>Uttar Pradesh</option><option>Uttarakhand</option><option>West Bengal</option>
                    </optgroup>
                    <optgroup label="Union Territories">
                        <option>Andaman and Nicobar Islands</option><option>Chandigarh</option><option>Dadra and Nagar Haveli and Daman and Diu</option><option>Delhi</option><option>Jammu and Kashmir</option><option>Ladakh</option><option>Lakshadweep</option><option>Puducherry</option>
                    </optgroup>
                </select>

                <input type="text" id="sig-mobile" placeholder="10-Digit Mobile Number" maxlength="10">
                
                <div class="button-row">
                    <button class="btn-fetch" onclick="handleSignup()">Sign up</button>
                    <button class="btn-edit" style="background:#666;" onclick="clearForm('signup-form')">Clear</button>
                </div>
            </div>
        </div>

        <!-- Login -->
        <div class="card" style="flex: 1; min-width: 320px;">
            <h3>Login</h3>
            <div class="form-grid" style="grid-template-columns: 1fr;" id="login-form">
                <select id="log-role">
                    <option value="">Select Status</option>
                    <option>Owner</option>
                    <option>Teacher</option>
                    <option>Student</option>
                </select>
                <input type="email" id="log-email" placeholder="Email Id">
                <div style="position: relative;">
                    <input type="password" id="log-pass" placeholder="Password">
                    <i class="fas fa-eye" onclick="togglePass('log-pass')" style="position: absolute; right: 10px; top: 12px; cursor: pointer; color: #666;"></i>
                </div>
                <div class="button-row">
                    <button class="btn-add" onclick="handleLogin()">Login</button>
                    <button class="btn-edit" style="background:#666;" onclick="clearForm('login-form')">Clear</button>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- 2. STUDENT MANAGEMENT -->
<!-- 2. STUDENT MANAGEMENT -->
<section id="students" class="content-section">
    <div class="card">
        <h3><i class="fas fa-user-plus"></i> Student Management</h3>
        <div class="form-grid">
            <div class="input-group"><label>Admission Date</label><input type="date" id="stu-date"></div>
            <div class="input-group"><label>Full Name</label><input type="text" id="stu-name" placeholder="Full Name"></div>
            <div class="input-group"><label>Mobile Number (10 Digits)</label><input type="text" id="stu-mobile" placeholder="Mobile" maxlength="10"></div>
            <div class="input-group"><label>Father's Mobile</label><input type="text" id="stu-father" maxlength="10"></div>
            <div class="input-group"><label>Mother's Mobile</label><input type="text" id="stu-mother" maxlength="10"></div>
            <div class="input-group"><label>Class / Standard</label><input type="text" id="stu-standard"></div>
            <div class="input-group"><label>Batch Time</label><input type="time" id="stu-batch"></div>
            <div class="input-group"><label>Course</label><input type="text" id="stu-course" placeholder="Course"></div>
            
            <div class="input-group"><label>Total Fees</label><input type="number" id="stu-total" oninput="calcStuPending()"></div>
            <div class="input-group"><label>Paid Amount</label><input type="number" id="stu-paid" oninput="calcStuPending()"></div>
            <div class="input-group"><label>Pending Amount</label><input type="number" id="stu-pending" readonly style="background:#eee;"></div>
<div class="input-group"><label>Payment Due Dates (e.g. March 2026, June 2026)</label><input type="text" id="stu-due-dates" placeholder="Month Year, Month Year"></div>
            
            <div class="input-group">
                <label>Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="stu-roll" placeholder="Click Generate" readonly style="background: #eee;">
                    <button class="btn-fetch" onclick="generateRollNow()" style="padding: 5px;">Gen</button>
                </div>
            </div>
            <div class="input-group"><label>Course End Date</label><input type="date" id="stu-end-date"></div>
<div class="input-group">
                <label>Status</label>
                <select id="stu-status">
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
        </div>
        <div class="button-row">
           <button class="btn-add" onclick="addStudent()">ADD Student</button>
           <button class="btn-edit" onclick="editStudentByRoll()">EDIT (by Roll No)</button>
           <button class="btn-fetch" onclick="fetchStudentByRoll()">FETCH (by Roll No)</button>
           <button class="btn-edit" style="background:#666;" onclick="clearStudentForm()">Clear</button>
        </div>
    </div>
</section>
<!-- 3. FEE MANAGEMENT -->
<section id="fee" class="content-section">
    <!-- Part 1: FEE DETAILS -->
    <div class="card" style="margin-bottom: 30px;">
        <h3>1. FEE DETAILS</h3>
        <div class="form-grid">
            <div class="input-group"><label>Date Today</label><input type="date" id="fee-today"></div>
            <div class="input-group">
                <label>Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="fee-roll" placeholder="IMS-2026-XXXX">
                    <button type="button" onclick="fetchFeeByRoll()" style="background: #007bff; color: white; border: 1px solid #000; border-radius: 5px; padding: 0 10px; cursor: pointer;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group"><label>Full Name</label><input type="text" id="fee-name"></div>
            <div class="input-group"><label>Date of Joining</label><input type="date" id="fee-join-date"></div>
            <div class="input-group"><label>Course Name</label><input type="text" id="fee-course" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Total Fees</label><input type="number" id="fee-total"></div>
            <div class="input-group"><label>Previously Paid</label><input type="number" id="fee-prev-paid" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Amount Now Paying</label><input type="number" id="fee-paid-now" oninput="calcPendingFee()"></div>
            <div class="input-group"><label>Pending Fees</label><input type="number" id="fee-pending" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Due Dates</label><input type="text" id="fee-due-dates"></div>
            <div class="input-group"><label>Status</label><select id="fee-status"><option value="Active">Active</option><option value="Closed">Closed</option></select></div>
        </div>

        <div class="button-row">
            <button class="btn-fetch" onclick="fetchFeeByRoll()">FETCH</button>
            <button class="btn-add" onclick="saveFeeUpdate()">ADD PAYMENT</button>
<button class="btn-edit" style="background:#f39c12; width: auto; padding: 10px 20px;" onclick="editFeeRecordByRoll()">
    <i class="fas fa-user-edit"></i> EDIT (by Roll No)
</button>
            <button class="btn-fetch" style="background:#673ab7;" onclick="showReceiptHistory()">VIEW RECEIPTS</button>
        </div>

        <div id="receipt-history-list" style="display:none; margin: 20px auto; max-width: 400px; background:#fff; border: 1px solid #000; padding: 10px; border-radius: 8px;">
            <p style="font-weight:bold; margin-bottom:10px; font-size: 14px; color: #000;">Payment History:</p>
            <div id="history-links-container" style="max-height: 150px; overflow-y: auto; font-size: 13px;"></div>
        </div>

        <!-- UPI QR -->
        <div id="upi-qr-area" style="display: none; margin-top: 30px; padding: 20px; background: #fff; border-radius: 15px; border: 2px solid #000; text-align: center;">
            <h4 style="color: #000; margin-bottom: 15px;">Scan to Pay Fees</h4>
            <div id="qr-container" style="background: #fff; padding: 10px; display: inline-block; border-radius: 10px; border: 1px solid #ddd;">
                <img id="upi-qr-img" src="" alt="UPI QR Code" style="width: 200px; height: 200px;">
            </div>
            <p style="margin-top: 10px; font-weight: bold; color: #1877F2;">Amount: ₹ <span id="disp-qr-amt">0</span></p>
            <button class="btn-add" style="background: #1877F2; width: 100%; margin-top:10px;" onclick="generateUPIQR()"><i class="fas fa-qrcode"></i> GENERATE PAYMENT QR</button>
        </div>
    </div>

    <!-- Part 2: FEES PORTAL -->
<!-- Part 2: FEES PORTAL (Subject-Wise Summary) -->
<!-- Part 2: FEES PORTAL (Subject-Wise Summary) -->
<!-- Part 2: FEES PORTAL (Subject-Wise Summary) -->
<!-- Part 2: FEES PORTAL (Subject-Wise Summary) -->
<!-- Part 2: FEES PORTAL (Subject-Wise Summary) -->
<div class="card" style="margin-bottom: 30px; border-top-color: #007bff; text-align: center;">
    <h3>2. SUBJECT-WISE FEES PORTAL</h3>
    <p style="margin-bottom: 20px; color: #555; font-size: 1.1rem;">Access the advanced, standalone analytics portal to view all subject-wise collections.</p>
    
    <!-- 3D Aquamarine Button -->
    <a href="subject-fees.html" target="_blank" style="
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: #7FFFD4;
        color: #000;
        font-weight: 900;
        font-family: 'Times New Roman', Times, serif;
        text-decoration: none;
        padding: 15px 30px;
        border: 2px solid #000;
        border-radius: 12px;
        box-shadow: 0 6px 0px #66ccaa, 0 12px 20px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
        font-size: 1.2rem;
        cursor: pointer;
    " 
    onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 10px 0px #66ccaa, 0 18px 25px rgba(0,0,0,0.25)';" 
    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 0px #66ccaa, 0 12px 20px rgba(0,0,0,0.15)';">
        <i class="fas fa-external-link-alt"></i> OPEN FEES PORTAL
    </a>
</div>
    <!-- Part 3: PAYMENT LOG -->
    <div class="card">
        <h3>3. PAYMENT LOG</h3>
        <div class="form-grid">
            <div class="input-group"><label>Select Month</label><input type="month" id="log-calendar"></div>
            <div class="input-group"><label>Roll Number</label><input type="text" id="log-roll" placeholder="IMS-XXXX"></div>
            <button class="btn-fetch" style="margin-top:25px;" onclick="fetchPaymentLog()">View Payments</button>
        </div>
        <div id="log-result" style="margin-top:20px; padding:15px; background:#f9f9f9; border-radius:8px; color: #000;">
            <i>Select month and roll number to view history.</i>
        </div>
    </div>
</section>
<!-- 4. BATCH MANAGEMENT -->
<section id="batch" class="content-section">
    <div class="card">
        <h3><i class="fas fa-layer-group"></i> Batch Management</h3>
        <div class="form-grid">
            <input type="text" id="batch-name" placeholder="Batch Name">
            <input type="text" id="batch-teacher-id" placeholder="Teacher ID (e.g. TCH-1234)">
            <input type="text" id="batch-teacher-name" placeholder="Teacher Name">
            <input type="time" id="batch-time">
            <input type="text" id="batch-subject" placeholder="Subject Name">
            <input type="number" id="batch-students" placeholder="Students Allotted">
            <input type="text" id="batch-remarks" placeholder="Remarks">
        </div>
        <div class="button-row">
            <button class="btn-add" onclick="addBatch()">ADD Batch</button>
            <button class="btn-fetch" onclick="fetchBatch()">FETCH (by Name)</button>
        </div>
    </div>
</section>

<!-- 5. ATTENDANCE -->
<!-- 5. ATTENDANCE -->
<section id="attendance" class="content-section">
    <div class="card">
        <h3><i class="fas fa-clipboard-check"></i> Attendance Tracker</h3>
        
        <!-- Student Link Fields -->
        <div class="form-grid">
            <div class="input-group">
                <label>Student Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="attn-roll" placeholder="e.g. IMS-2026-1234">
                    <button class="btn-fetch" onclick="fetchStudentForAttn()" style="padding: 5px 10px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group">
                <label>Student Name</label>
                <input type="text" id="attn-name" readonly style="background: #eee;" placeholder="Fetched automatically">
            </div>
        </div>

        <hr style="margin: 20px 0;">

        <div class="form-grid">
            <div class="input-group">
                <label>View Monthly Record (Old Calendar)</label>
                <input type="month" id="attn-month-view">
            </div>
            <div class="input-group">
                <label>Total Present</label>
                <input type="number" id="attn-total-p" placeholder="0" readonly>
            </div>
            <div class="input-group">
                <label>Total Absent</label>
                <input type="number" id="attn-total-a" placeholder="0" readonly>
            </div>
        </div>

        <!-- Hidden Date Picker that will be triggered by buttons -->
        <input type="date" id="attn-date-picker" style="display: none;">

        <div class="button-row">
            <button class="btn-add" onclick="triggerAttendance('Present')">
                <i class="fas fa-check-circle"></i> MARK PRESENT
            </button>
            <button class="btn-edit" style="background: #e74c3c;" onclick="triggerAttendance('Absent')">
                <i class="fas fa-times-circle"></i> MARK ABSENT
            </button>
            <button class="btn-fetch" onclick="fetchAttendanceByPrompt()">
                <i class="fas fa-sync"></i> Fetch Statistics
            </button>
        </div>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">* Clicking Mark buttons will open a calendar to select the date.</p>



<div id="whatsapp-alert-area" style="display: none; margin-top: 20px; padding: 15px; background: #fff; border-radius: 10px; border: 2px dashed #25D366; text-align: center;">
            <p style="color: #000; font-weight: bold; margin-bottom: 10px;">⚠️ Student is Absent! Notify parents?</p>
            <a id="absent-wa-link" href="#" target="_blank" style="background: #25D366; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fab fa-whatsapp"></i> SEND ABSENT ALERT
            </a>
        </div>



    </div>
</section>

<!-- 6. ADMIN DASHBOARD -->
<!-- 6. ADMIN DASHBOARD -->
<!-- ADMIN DASHBOARD: REPORTS CENTER -->
<section id="admin" class="content-section">
    <div class="card" style="margin-bottom: 20px; border-top: 5px solid #1877F2;">
        <h3><i class="fas fa-file-invoice"></i> Reports Center</h3>
        <div class="form-grid">
            <div class="input-group">
                <label>REPORT NAME</label>
                <select id="report-selector" onchange="toggleReportUI()">
                    <option value="">-- Select Report --</option>
                    <option value="attendance">1. Attendance Report (Student)</option>
                    <option value="fee">2. Fee Collection Report</option>
                    <option value="exam">3. Exam Report</option>
                    <option value="t-attendance">4. Teachers Attendance Report</option>
                </select>
            </div>
        </div>

        <!-- ATTENDANCE REPORT INPUTS (Hidden by default) -->
        <div id="report-ui-attendance" style="display:none; margin-top:20px; padding-top:20px; border-top:1px dashed #ccc;">
            <div class="form-grid">
                <div class="input-group"><label>Select Month & Year</label><input type="month" id="rep-attn-month"></div>
                <div class="input-group">
                    <label>Roll Number</label>
                    <input type="text" id="rep-attn-roll" placeholder="IMS-XXXX" oninput="populateRepName()">
                </div>
                <div class="input-group"><label>Student Name</label><input type="text" id="rep-attn-name" readonly style="background:#eee;"></div>
            </div>
            <div class="button-row">
                <button class="btn-add" onclick="generateAttendanceReport()">GENERATE REPORT</button>
            </div>
        </div>
<!-- EXAM REPORT INPUTS (Hidden by default) -->
<div id="report-ui-exam" style="display:none; margin-top:20px; padding-top:20px; border-top:1px dashed #ccc;">
    <div class="form-grid">
        <div class="input-group">
            <label>Roll Number</label>
            <input type="text" id="rep-ex-roll" placeholder="IMS-XXXX" oninput="populateExamRepName()">
        </div>
        <div class="input-group"><label>Student Name</label><input type="text" id="rep-ex-name" readonly style="background:#eee;"></div>
        <div class="input-group"><label>Course Name</label><input type="text" id="rep-ex-course" readonly style="background:#eee;"></div>
    </div>
    <div class="button-row">
        <button class="btn-add" style="background:#f39c12;" onclick="generateExamReport()">GENERATE EXAM REPORT</button>
    </div>
</div>

<!-- FEE COLLECTION REPORT INPUTS (Hidden by default) -->
<div id="report-ui-fee" style="display:none; margin-top:20px; padding-top:20px; border-top:1px dashed #ccc;">
    <div class="form-grid">
        <div class="input-group">
            <label>Select Month & Year</label>
            <input type="month" id="rep-fee-month">
        </div>
        <p style="grid-column: 1/-1; font-size: 0.8rem; color: #666;">* This report generates a financial ledger for all active students during this period.</p>
    </div>
    <div class="button-row">
        <button class="btn-add" style="background:#27ae60;" onclick="generateFeeReport()">GENERATE FEE REPORT</button>
    </div>
</div>
<!-- TEACHERS ATTENDANCE REPORT INPUTS (Hidden by default) -->
<div id="report-ui-t-attendance" style="display:none; margin-top:20px; padding-top:20px; border-top:1px dashed #ccc;">
    <div class="form-grid">
        <div class="input-group">
            <label>Select Month & Year</label>
            <input type="month" id="rep-t-month">
        </div>
        <div class="input-group">
            <label>Teacher ID</label>
            <input type="text" id="rep-t-id" placeholder="TCH-XXXX" oninput="populateTeacherRepName()">
        </div>
        <div class="input-group">
            <label>Full Name</label>
            <input type="text" id="rep-t-name" readonly style="background:#eee;">
        </div>
    </div>
    <div class="button-row">
        <button class="btn-add" style="background:#673ab7;" onclick="generateTeacherAttendanceReport()">GENERATE STAFF REPORT</button>
    </div>
</div>
    </div>

    <!-- REPORT DISPLAY AREA -->
    <div id="report-output-area" style="display:none;" class="card">
        <div id="report-print-content">
            <h2 id="rep-title">REPORT</h2>
            <div id="rep-summary-text" style="text-align:left; margin-bottom:20px;"></div>
            <table style="width:100%; border-collapse:collapse; margin-bottom:20px;" border="1">
                <thead id="rep-table-head"></thead>
                <tbody id="rep-table-body"></tbody>
            </table>
            <div class="dashboard-stats" id="rep-stats-boxes"></div>
        </div>




 <!-- ADD THIS LINE FOR THE SLICER -->
    <div id="filter_div" style="margin-bottom: 20px; padding: 10px; background: #f0fdfa; border-radius: 8px; border: 1px solid #7FFFD4;"></div>

        
        <!-- Google Charts Area -->
         <div id="chart_div" style="width: 100%; height: 400px; margin-top:30px;"></div>

        <div class="button-row">
            <button class="btn-fetch" onclick="window.print()"><i class="fas fa-print"></i> PRINT / SAVE AS PDF</button>
        </div>
    </div>
</section>

<!-- 7. FEE REMINDER -->
<!-- 7. FEE REMINDER SYSTEM -->
<section id="reminder" class="content-section">
    <div class="card" style="border-top-color: #f39c12;">
        <h3><i class="fas fa-bell"></i> Fee Reminder Dashboard</h3>
        <div class="input-group" style="max-width: 250px; margin-bottom: 20px;">
            <label>Select Admission Year</label>
            <input type="number" id="remind-year" value="2026" onchange="loadFeeReminders()">
        </div>
        <div class="dashboard-stats">
            <div class="stat-card" style="border-bottom-color: #e74c3c;"><p>Total Pending</p><h4 id="remind-total-amt" style="color: #e74c3c;">₹ 0</h4></div>
            <div class="stat-card" style="border-bottom-color: #f39c12;"><p>Pending Students</p><h4 id="remind-stu-count">0</h4></div>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>Active Students with Pending Fees</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 600px; color: #000;">
                <thead>
                    <tr style="background: #f4f7f6; text-align: left; border-bottom: 2px solid #ddd;">
                        <th>Roll Number</th><th>Student Name</th><th>Mobile</th><th>Pending</th><th>Action</th>
                    </tr>
                </thead>
                <tbody id="reminder-table-body"></tbody>
            </table>
        </div>
    </div>
</section>

<!-- 8. LEAD MANAGEMENT -->
<!-- 8. LEAD MANAGEMENT -->
<section id="leads" class="content-section">
    <div class="card">
        <h3><i class="fas fa-funnel-dollar"></i> Lead Management</h3>
        <div class="form-grid">
            <input type="text" id="lead-name" placeholder="Full Name">
            <input type="text" id="lead-contact" placeholder="Contact Number">
            <input type="email" id="lead-email" placeholder="Email Address">
            <input type="text" id="lead-course" placeholder="Interested Course">
            <input type="date" id="lead-date" placeholder="Date of Visit">
            <input type="text" id="lead-ref" placeholder="Reference (How they found us)">
            <select id="lead-status">
                <option value="Follow up">Status: Follow up</option>
                <option value="Converted">Converted</option>
                <option value="Not interested">Not interested</option>
            </select>
            <input type="text" id="lead-remarks" placeholder="Remarks">
        </div>
        <div class="button-row">
            <button class="btn-add" onclick="addLead()">ADD Lead</button>
            <button class="btn-fetch" onclick="fetchLead()">FETCH (by Contact)</button>
            <button class="btn-edit" style="background:#666;" onclick="clearLeadForm()">Clear</button>
        </div>
    </div>
</section>

<!-- 9. EXPENSE TRACKING -->
<!-- 9. EXPENSE TRACKING -->
<!-- 9. EXPENSE TRACKING -->
<section id="expense" class="content-section">
    <div class="card" style="border-top-color: #ff0000;">
        <h3><i class="fas fa-wallet"></i> Monthly Expense & Income Tracker</h3>



        
        <!-- CALENDAR HEADER -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 20px;">
            <div class="input-group" style="flex: 1;">
                <label>Select Month & Year</label>
                <input type="month" id="exp-month-year" onchange="fetchAutoFees()">
            </div>
            <p style="flex: 1; font-size: 0.85rem; color: #666;">* Selecting a month will automatically pull the actual Fees Collection from the database.</p>
        </div>

        <div class="form-grid">
            <div class="input-group"><label>Rent</label><input type="number" id="exp-rent" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Electricity</label><input type="number" id="exp-elec" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Maintenance</label><input type="number" id="exp-maint" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Teacher Salaries</label><input type="number" id="exp-t-sal" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Admin Salaries</label><input type="number" id="exp-a-sal" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Marketing</label><input type="number" id="exp-mark" value="0" oninput="calculateFinancials()"></div>
            <div class="input-group"><label>Other Expenses</label><input type="number" id="exp-other" value="0" oninput="calculateFinancials()"></div>
        </div>

   <div class="stat-card" style="background: #fff8f8; margin-top: 20px; text-align: left; border: 1px solid #ff0000;">
    <h4 style="color: #ff0000; margin: 0; text-decoration: none;">
        TOTAL MONTHLY EXPENSES: <span id="disp-total-exp">₹ 0.00</span>
    </h4>
</div>
        <div class="button-row">
           <button class="btn-add" onclick="saveExpenses()">ADD RECORD</button>
           <button class="btn-fetch" onclick="fetchSavedExpense()">FETCH (by Month)</button>
           <button class="btn-edit" style="background:#666;" onclick="clearExpenseForm()">CLEAR</button>
        </div>
    </div>
</section>

<!-- 10. REPORTS -->
<section id="reports" class="content-section">
    <div class="card">
        <h3>Reports Center</h3>
        <ul style="line-height: 2.5;">
            <li><a href="#"><i class="fas fa-file-invoice"></i> Monthly Collection Report</a></li>
            <li><a href="#"><i class="fas fa-user-chart"></i> Student Report</a></li>
            <li><a href="#"><i class="fas fa-layer-group"></i> Batch Report</a></li>
            <li><a href="#"><i class="fas fa-check-double"></i> Attendance Report</a></li>
        </ul>
    </div>
</section>


<!-- 11. TEACHER PORTAL -->
<!-- 11. TEACHER PORTAL -->
<section id="teacher" class="content-section">
    <div class="card">
        <h3>Teacher Management</h3>
        <div class="form-grid">
            <!-- ID GENERATOR -->
       <div class="input-group" style="grid-column: 1 / -1; margin-bottom: 10px;">
                <label>Teacher ID</label>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <input type="text" id="tch-id" readonly style="flex: 1; background: #eee; border: 2px solid #007bff; padding: 10px;" placeholder="ID">
                    <button type="button" onclick="generateTchID()" 
                            style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; display: block !important; visibility: visible !important;">
                        GEN
                    </button>
                </div>
            </div>
            <!-- OTHER FIELDS -->
            <div class="input-group"><label>Teacher Name</label><input type="text" id="tch-name"></div>
            <div class="input-group"><label>Age</label><input type="number" id="tch-age"></div>
            <div class="input-group"><label>Joining Date</label><input type="date" id="tch-join"></div>
            <div class="input-group"><label>Qualification</label><input type="text" id="tch-qual"></div>
            <div class="input-group"><label>Subject Taught</label><input type="text" id="tch-subject"></div>
            <div class="input-group"><label>Salary</label><input type="number" id="tch-salary"></div>
			<!-- Inside <section id="teacher"> inside <div class="form-grid"> -->

<!-- Other inputs like Name, Age, etc are here... -->
<!-- START OF NEW TEACHER FIELDS -->
<div class="input-group">
    <label>Gender</label>
    <select id="tch-gender">
        <option value="">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
    </select>
</div>
<div class="input-group"><label>Email</label><input type="email" id="tch-email" placeholder="Email Address"></div>
<div class="input-group"><label>Full Address</label><input type="text" id="tch-address" placeholder="Complete Address"></div>
<div class="input-group"><label>Experience (Years)</label><input type="number" id="tch-exp" placeholder="e.g. 5"></div>
<div class="input-group"><label>Rating (/5)</label><input type="number" step="0.1" max="5" id="tch-rating" placeholder="e.g. 4.5"></div>
<div class="input-group">
    <label>Status</label>
    <select id="tch-status">
        <option value="Active">Active</option>
        <option value="Inactive">Inactive</option>
    </select>
</div>










<!-- START NEW TEACHER AVAILABILITY FIELDS -->
<div class="input-group">
    <label>Availability Status (<span id="tch-tomorrow-date" style="color:#007bff;"></span>)</label>
    <select id="tch-availability" onchange="toggleTeacherTimeSlots()">
        <option value="No">No</option>
        <option value="Yes">Yes</option>
    </select>
</div>

<div class="input-group" id="tch-timeslots-container" style="display: none; grid-column: 1 / -1; background: #f0faff; padding: 15px; border: 2px solid #007bff; border-radius: 8px; margin-top: 10px;">
    <label style="margin-bottom: 10px; color: #007bff;">Select Available Time Slots (Check all that apply):</label>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;" id="tch-time-checkboxes">
        <label><input type="checkbox" value="09:00 AM to 10:00 AM"> 09:00 AM to 10:00 AM</label>
        <label><input type="checkbox" value="10:00 AM to 11:00 AM"> 10:00 AM to 11:00 AM</label>
        <label><input type="checkbox" value="11:00 AM to 12:00 PM"> 11:00 AM to 12:00 PM</label>
        <label><input type="checkbox" value="12:00 PM to 01:00 PM"> 12:00 PM to 01:00 PM</label>
        <label><input type="checkbox" value="01:00 PM to 02:00 PM"> 01:00 PM to 02:00 PM</label>
        <label><input type="checkbox" value="02:00 PM to 03:00 PM"> 02:00 PM to 03:00 PM</label>
        <label><input type="checkbox" value="03:00 PM to 04:00 PM"> 03:00 PM to 04:00 PM</label>
        <label><input type="checkbox" value="04:00 PM to 05:00 PM"> 04:00 PM to 05:00 PM</label>
        <label><input type="checkbox" value="05:00 PM to 06:00 PM"> 05:00 PM to 06:00 PM</label>
        <label><input type="checkbox" value="06:00 PM to 07:00 PM"> 06:00 PM to 07:00 PM</label>
        <label><input type="checkbox" value="07:00 PM to 08:00 PM"> 07:00 PM to 08:00 PM</label>
        <label><input type="checkbox" value="08:00 PM to 09:00 PM"> 08:00 PM to 09:00 PM</label>
    </div>
</div>
<!-- END NEW TEACHER AVAILABILITY FIELDS -->






<!-- END OF NEW TEACHER FIELDS -->
<div class="input-group" style="grid-column: 1 / -1; width: 100%; max-width: 350px; margin: 15px auto 0; text-align: center;">
    <label style="display: block; margin-bottom: 5px; color: #000; font-weight: bold;">WhatsApp Mobile Number</label>
    <input type="text" id="tch-mobile" placeholder="10-Digit Mobile Number" maxlength="10" style="text-align: center; border: 2px solid #25D366;">
</div>

<!-- ... the </div> for form-grid follows -->
        </div>
       <div class="button-row" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
    <button class="btn-add" style="width: auto; padding: 10px 20px;" onclick="addTeacherDetails()">ADD TEACHER</button>
    <button class="btn-fetch" style="width: auto; padding: 10px 20px;" onclick="fetchTeacher()">FETCH</button>

<!-- START ADDED BUTTONS -->
    <button class="btn-edit" style="width: auto; padding: 10px 20px;" onclick="editTeacher()">UPDATE TEACHER</button>
    <button class="btn-edit" style="background:#666; width: auto; padding: 10px 20px;" onclick="clearTeacherForm()">CLEAR</button>
    <!-- END ADDED BUTTONS -->


<button class="btn-add" style="background: #27ae60; width: auto; padding: 10px 20px;" onclick="saveTeacherPayment()">
    <i class="fas fa-hand-holding-usd"></i> LOG SALARY PAYMENT
</button>
    <button class="btn-fetch" style="width: auto; padding: 10px 20px; background:#673ab7;" onclick="showPayslipHistory()">VIEW PAYSLIPS</button>
</div>

<div id="payslip-history-list" style="display:none; margin: 20px auto; max-width: 400px; background:#fff; border: 1px solid #000; padding: 10px; border-radius: 8px;">
    <p style="font-weight:bold; margin-bottom:10px; font-size: 14px; color: #000;">Salary Records:</p>
    <div id="teacher-history-links-container" style="max-height: 150px; overflow-y: auto; font-size: 13px;"></div>
</div>
</div>

	
	
	<!-- STUDENT NOTICE BOARD -->
    <div class="card" style="margin-top: 20px; border-left: 10px solid #27ae60; background: #fff;">
        <h4><i class="fas fa-envelope-open-text"></i> Notifications for You</h4>
        <div id="student-notices" style="text-align: left; padding: 10px; font-size: 0.95rem;">
            <p style="color: #888;">Enter your Roll No and click 'Fetch Performance' to see messages relevant to your course.</p>
        </div>
    </div>
</section>
<!-- 12. STUDENT PORTAL (VIEW ONLY) -->
<!-- 12. STUDENT PORTAL (VIEW ONLY) -->
<section id="student-p" class="content-section">
    <div class="card" style="border-top-color: #007bff;">
        <h3><i class="fas fa-user-graduate"></i> Personal Student Dashboard</h3>
        
        <!-- Input Section -->
        <div class="form-grid" style="background: #f8f9fa; padding: 15px; border-radius: 10px; align-items: end;">
            <div class="input-group">
                <label>Enter Roll Number</label>
                <input type="text" id="portal-roll-input" placeholder="e.g. IMS-2026-1234">
            </div>
            <div class="input-group">
                <label>Select Month & Year</label>
                <input type="month" id="portal-month-input">
            </div>
            <button class="btn-fetch" onclick="fetchStudentPortalData()" style="height: 45px; font-weight: 800;">
                FETCH PERFORMANCE
            </button>
        </div>

        <hr style="margin: 30px 0;">

        <!-- Result Section (Hidden by default) -->
        <div id="portal-display-area" style="display: none;">
            <div class="form-grid" style="font-size: 1rem; line-height: 2;">
                <div>
                    <p><b>Full Name:</b> <span id="p-name">---</span></p>
                    <p><b>Course Name:</b> <span id="p-course">---</span></p>
                    <p><b>Assign Teacher:</b> <span id="p-teacher">---</span></p>
                    <p><b>Date of Joining:</b> <span id="p-join">---</span></p>
                </div>
                <div style="border-left: 1px solid #ddd; padding-left: 20px;">
                    <p><b>Total Fees Paid:</b> <span id="p-paid" style="color: green; font-weight: bold;">₹ 0</span></p>
                    <p><b>Total Fees Pending:</b> <span id="p-pending" style="color: red; font-weight: bold;">₹ 0</span></p>
                    <p><b>Days Present:</b> <span id="p-present">0</span></p>
                    <p><b>Days Absent:</b> <span id="p-absent">0</span></p>
                </div>
            </div>

            <!-- Exam Performance Card -->
            <div style="margin-top: 20px; background: #fff8ee; padding: 20px; border-radius: 12px; border: 1px solid #f39c12;">
                <h4 style="color: #f39c12; margin-bottom: 10px;"><i class="fas fa-chart-line"></i> Exam Performance</h4>
                <div class="dashboard-stats" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card" style="padding: 10px;">
                        <small>Total Marks</small>
                        <h4 id="p-total-score">0</h4>
                    </div>
                    <div class="stat-card" style="padding: 10px;">
                        <small>Exams Taken</small>
                        <h4 id="p-exam-count">0</h4>
                    </div>
                    <div class="stat-card" style="padding: 10px; border-bottom-color: #f39c12;">
                        <small>% Score</small>
                        <h4 id="p-percent">0%</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resources Section -->
    <div class="card" style="margin-top: 20px; background: #f0faff;">
        <h4><i class="fas fa-book"></i> Institute Resources</h4>
        <p>Access your study materials and textbooks below:</p>
        <a href="#" style="display: inline-block; margin-top: 10px; color: #007bff; font-weight: 600; text-decoration: none; border-bottom: 2px solid #007bff;">
            <i class="fas fa-external-link-alt"></i> Open Digital Library (Books & Resources)
        </a>
    </div>
</section>



<!-- 13. ID CARD GENERATOR -->
<!-- 13. ID CARD GENERATOR -->
<!-- 13. ID CARD GENERATOR -->
<section id="id-gen" class="content-section">
    <div class="card">
        <h3><i class="fas fa-id-card"></i> ID Card Generator</h3>
        <p>Enter Student Mobile Number and upload a photo:</p>
        
        <div class="form-grid">
            <input type="text" id="id-fetch-mobile" placeholder="Student Mobile Number">
            
            <div class="input-group">
                <label>Upload Photo</label>
                <input type="file" id="id-photo-input" accept="image/*">
            </div>

            <button class="btn-fetch" onclick="generateIDCard()">Generate & Preview</button>
        </div>

        <hr style="margin: 20px 0;">

        <!-- ID Card Visual Preview -->
        <div id="id-card-preview-area" style="display: none; justify-content: center; margin-top: 20px;">
            <div id="id-card-visual" style="width: 350px; height: 500px; background: white; border: 2px solid #007bff; border-radius: 15px; position: relative; font-family: Arial; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden;">
                
                <!-- Header -->
                <div style="background: #007bff; color: white; padding: 15px; text-align: center;">
                    <h2 id="card-inst-name" style="margin: 0; font-size: 1.2rem;">INSTITUTE NAME</h2>
                    <small id="card-branch-name">Main Branch</small>
                </div>

                <!-- Body -->
                <div style="padding: 20px; text-align: center;">
                    <!-- Photo Display -->
                    <div style="width: 100px; height: 110px; background: #eee; margin: 0 auto 15px; border: 2px solid #7FFFD4; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                        <img id="card-photo-display" src="" alt="Photo" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                        <div id="card-photo-placeholder" style="font-size: 3rem; color: #ccc;"><i class="fas fa-user"></i></div>
                    </div>

                    <!-- Details Area -->
                    <h2 id="card-student-name" style="color: #333; margin: 5px 0; font-size: 1.4rem;">Student Name</h2>
                    <p style="margin: 2px 0; color: #666;">Roll No: <b id="card-roll">---</b></p>
                    
                    <div style="text-align: center; margin-top: 20px; font-size: 0.9rem; line-height: 1.6;">
                        <p><b>Course:</b> <span id="card-course">---</span></p>
                        <p><b>Batch:</b> <span id="card-batch">---</span></p>
                        <p><b>Duration:</b> <span id="card-start">---</span> to <span id="card-end">---</span></p>
                    </div>
                </div>

                <!-- Footer -->
                <div style="position: absolute; bottom: 0; width: 100%; border-top: 1px dashed #ccc; padding: 15px; text-align: center; background: #fafafa;">
                    <div style="margin-bottom: 5px; font-weight: bold; color: #007bff;">
                       <span id="card-sign-name">Admin</span>
                    </div>
                    <small style="color: #999;">Authorised Signatory</small>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; width: 100%;">
            <button id="id-print-btn" class="btn-add" style="display: none; margin: 20px auto;" onclick="printIDCard()">
                <i class="fas fa-print"></i> Print ID Card
            </button>
        </div>
    </div>
</section>
<!-- 14. CERTIFICATE GENERATOR -->
<!-- 14. CERTIFICATE GENERATOR -->
<section id="cert-gen" class="content-section">
    <div class="card">
        <h3><i class="fas fa-certificate"></i> Professional Certificate Generator</h3>
        <div class="form-grid">
            <input type="text" id="cert-fetch-mobile" placeholder="Enter Student Mobile">
            <button class="btn-fetch" onclick="generateCertificate()">Generate Certificate</button>
        </div>

        <hr style="margin: 30px 0;">

        <!-- Certificate Preview Area -->
        <div id="cert-preview-area" style="display: none; justify-content: center;">
            <div id="certificate-visual" style="width: 800px; height: 600px; background: white; border: 15px double #007bff; padding: 40px; position: relative; font-family: 'Poppins', sans-serif; box-shadow: 0 15px 40px rgba(0,0,0,0.2); background-image: radial-gradient(#7FFFD4 0.5px, transparent 0.5px); background-size: 20px 20px;">
                
                <!-- Logo Provision (Top Right) -->
                <div style="position: absolute; top: 30px; right: 30px; width: 80px; height: 80px;">
                    <img src="classmanager.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
                </div>

                <!-- Certificate Content -->
                <div style="text-align: center; margin-top: 20px;">
                    <h1 style="color: #007bff; font-size: 3.5rem; margin-bottom: 0; font-weight: 800;">CERTIFICATE</h1>
                    <p style="letter-spacing: 5px; color: #333; font-weight: 600;">OF COMPLETION</p>
                    
                    <div style="margin-top: 40px;">
                        <p style="font-size: 1.2rem; color: #666;">This is to certify that</p>
                        <h2 id="cert-name" style="font-size: 2.5rem; color: #ff0000; border-bottom: 2px solid #ccc; display: inline-block; padding: 0 30px; margin: 10px 0;">Student Name</h2>
                        <p style="font-size: 1.1rem; color: #666; margin-top: 15px;">
                            Roll Number: <b id="cert-roll">---</b> | Certificate No: <b id="cert-number" style="color: #007bff;">---</b>
                        </p>
                    </div>

                    <div style="margin-top: 30px; line-height: 1.8;">
                        <p style="font-size: 1.3rem; color: #333;">
                            has <b>Successfully Completed the Course</b> in <br>
                            <span id="cert-course" style="font-size: 1.8rem; color: #007bff; font-weight: 700;">Course Name</span>
                        </p>
                        <p style="font-size: 1.1rem;">Course Duration: <span id="cert-duration">---</span></p>
                    </div>

                    <!-- Signatory Section -->
                    <div style="margin-top: 60px; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 50px;">
                        <div style="text-align: center;">
                            <p style="margin: 0; font-weight: bold; border-top: 1px solid #333; padding-top: 5px;" id="cert-inst-branch">Main Branch</p>
                            <small>Institute Branch</small>
                        </div>
                        <div style="text-align: center;">
                            <p style="margin: 0; font-family: 'Brush Script MT', cursive; font-size: 1.8rem; color: #333;" id="cert-signatory">Admin Name</p>
                            <p style="margin: 0; font-weight: bold; border-top: 1px solid #333; padding-top: 5px;">Authorised Signatory</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button id="cert-print-btn" class="btn-add" style="display: none; margin: 30px auto;" onclick="printCertificate()">
            <i class="fas fa-print"></i> Print Certificate
        </button>
    </div>
</section>

<!-- 15. PERFORMANCE TRACKING -->
<section id="tracking" class="content-section">
    <div class="card">
        <h3><i class="fas fa-chart-line"></i> Student Performance Tracking</h3>
        <div class="form-grid">
            <input type="text" id="perf-fetch-mobile" placeholder="Enter Student Mobile">
            <button class="btn-fetch" onclick="fetchPerformanceData()">Fetch Performance</button>
        </div>

        <hr style="margin: 20px 0;">

        <!-- Performance Dashboard (Hidden until fetched) -->
        <div id="performance-report-area" style="display: none;">
            <div class="form-grid">
                <div class="input-group"><label>Date Today</label><input type="text" id="perf-today" readonly></div>
                <div class="input-group"><label>Full Name</label><input type="text" id="perf-name" readonly></div>
                <div class="input-group"><label>Roll Number</label><input type="text" id="perf-roll" readonly></div>
                <div class="input-group"><label>Course</label><input type="text" id="perf-course" readonly></div>
                <div class="input-group"><label>Date of Joining</label><input type="text" id="perf-joining" readonly></div>
                <div class="input-group"><label>Course Duration</label><input type="text" id="perf-duration" readonly></div>
            </div>

            <div class="dashboard-stats" style="margin: 20px 0;">
                <div class="stat-card" style="border-bottom-color: #ff0000;">
                    <p>Days Absent (This Month)</p>
                    <h4 id="perf-absent">0</h4>
                </div>
                <div class="stat-card" style="border-bottom-color: #27ae60;">
                    <p>Attendance %</p>
                    <h4 id="perf-attendance-pct">0%</h4>
                </div>
            </div>

            <div class="card" style="background: #f0fffb; border: 1px solid var(--aquamarine);">
                <h4>Exam Scores & Grading</h4>
                <div class="form-grid">
                    <div class="input-group"><label>Total Marks Secured</label><input type="number" id="perf-marks" oninput="calculateAvgScore()"></div>
                    <div class="input-group"><label>Total No. of Exams</label><input type="number" id="perf-exam-count" oninput="calculateAvgScore()"></div>
                    <div class="input-group"><label>Average Score (%)</label><input type="text" id="perf-avg-display" readonly style="font-weight: bold; color: #007bff;"></div>
                    <div class="input-group"><label>Teacher's Name</label><input type="text" id="perf-teacher"></div>
                </div>
                <button class="btn-add" style="width: 100%; margin-top: 10px;" onclick="savePerformanceData()">Update Performance Record</button>
            </div>
        </div>
    </div>
</section>





<!-- EXAM MANAGEMENT SECTION -->
<section id="exam-mod" class="content-section">
    <div class="card">
        <h3><i class="fas fa-file-alt"></i> Exam Record Entry</h3>
        <div class="form-grid">
            <div class="input-group"><label>Exam Date</label><input type="date" id="ex-date"></div>
            <div class="input-group">
                <label>Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="ex-roll" placeholder="IMS-XXXX">
                    <button class="btn-fetch" onclick="fetchStudentForExam()" style="padding: 5px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group"><label>Full Name</label><input type="text" id="ex-name" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Course</label><input type="text" id="ex-course" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Total Marks</label><input type="number" id="ex-total" oninput="calcExamResult()"></div>
            <div class="input-group"><label>Marks Obtained</label><input type="number" id="ex-obt" oninput="calcExamResult()"></div>
            <div class="input-group"><label>Percentage (%)</label><input type="text" id="ex-pct" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Result</label><input type="text" id="ex-res" readonly style="font-weight:bold; background:#eee;"></div>
        </div>
        <div class="button-row">
            <button class="btn-add" onclick="addExamRecord()">ADD Result</button>
            <button class="btn-fetch" onclick="fetchExamByRoll()">FETCH (Roll No)</button>
        </div>
    </div>
</section>

<!-- TEACHER ATTENDANCE SECTION -->
<section id="t-attn-mod" class="content-section">
    <div class="card">
        <h3><i class="fas fa-calendar-check"></i> Staff Attendance Tracker</h3>
        <div class="form-grid">
            <div class="input-group"><label>Select Month/Year</label><input type="month" id="t-attn-month"></div>
            <div class="input-group">
                <label>Teacher ID</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="t-attn-id" placeholder="TCH-XXXX">
                    <button class="btn-fetch" onclick="fetchTeacherForTAttn()" style="padding: 5px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group"><label>Full Name</label><input type="text" id="t-attn-name" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Last Marked Status</label><input type="text" id="t-attn-status" readonly style="background:#eee;"></div>
        </div>
        <!-- Hidden Date Picker -->
        <input type="date" id="t-date-picker" style="display:none;">
        <div class="button-row">
            <button class="btn-add" onclick="triggerTAttn('Present')">MARK PRESENT</button>
            <button class="btn-edit" style="background:#e74c3c;" onclick="triggerTAttn('Absent')">MARK ABSENT</button>
            <button class="btn-fetch" onclick="fetchTeacherHistory()">FETCH Records</button>
        </div>
    </div>
</section>


<section id="allocation-mod" class="content-section">
    <div class="card">
        <h3><i class="fas fa-user-tag"></i> Link Student to Teacher</h3>
        <div class="form-grid">
            <div class="input-group">
                <label>Teacher ID</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="alloc-tid" placeholder="TCH-XXXX">
                    <button class="btn-fetch" onclick="fetchTeacherForAlloc()" style="padding:5px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group"><label>Teacher Name</label><input type="text" id="alloc-tname" readonly style="background:#eee;"></div>
            
            <div class="input-group">
                <label>Student Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="alloc-roll" placeholder="IMS-XXXX">
                    <button class="btn-fetch" onclick="fetchStudentForAlloc()" style="padding:5px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group"><label>Student Name</label><input type="text" id="alloc-sname" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Subject / Batch</label><input type="text" id="alloc-subject" placeholder="e.g. Mathematics"></div>
        </div>
        <div class="button-row">
            <button class="btn-add" onclick="saveAllocation()">LINK STUDENT</button>
            <button class="btn-fetch" onclick="viewTeacherStudents()">VIEW ALLOCATION</button>
        </div>
    </div>
    
    <!-- Area to show list of students under a teacher -->
    <div id="allocation-list-area" style="display:none; margin-top:20px;" class="card">
        <h4>Students Assigned to Teacher</h4>
        <ul id="alloc-list" style="text-align: left; list-style: square; padding-left: 20px;"></ul>
    </div>
</section>




<!-- STANDALONE MESSAGE HUB -->
<!-- STANDALONE MESSAGE HUB - FINAL COMBINED VERSION -->
<section id="message-corner" class="content-section">
    <div class="card" style="border-top: 5px solid #25D366; background: #fff;">
        <h2 style="text-decoration: none; color: #000;"><i class="fab fa-whatsapp"></i> Quick Connect Hub</h2>
        
        <!-- ROW 1: DIRECT & FILTERED SEARCH -->
        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div style="padding: 15px; border: 2px solid #000; border-radius: 10px; background: #f9f9f9;">
                <h4><i class="fas fa-user-tie"></i> Owner</h4>
                <button class="btn-add" style="background: #25D366; width: 100%; border: none; margin-top:10px;" onclick="connectToOwner()">CHAT WITH OWNER</button>
            </div>

            <div style="padding: 15px; border: 2px solid #000; border-radius: 10px; background: #f9f9f9;">
                <h4><i class="fas fa-chalkboard-teacher"></i> Teachers</h4>
                <select id="wa-teacher-subject" style="width: 100%; margin: 5px 0;"><option value="All">All Staff</option><option>Mathematics</option><option>History</option><option>Geography</option></select>
                <button class="btn-add" style="background: #128C7E; width: 100%; border: none;" onclick="fetchTeachersBySubject()">FIND TEACHERS</button>
            </div>

            <div style="padding: 15px; border: 2px solid #000; border-radius: 10px; background: #f9f9f9;">
                <h4><i class="fas fa-user-graduate"></i> Students</h4>
                <select id="wa-student-course" style="width: 100%; margin: 5px 0;"><option value="All">All Students</option><option>Mathematics</option><option>History</option><option>Geography</option></select>
                <button class="btn-add" style="background: #075E54; width: 100%; border: none;" onclick="fetchStudentsByCourse()">FIND STUDENTS</button>
            </div>
        </div>

        <!-- ROW 2: GROUP BROADCAST (For 500+ Students) -->
        <div style="margin-top: 25px; padding: 20px; border: 2px solid #000; border-radius: 15px; background: #fff8e1;">
            <h4 style="text-decoration: underline;">Global Broadcast Links</h4>
            <div class="form-grid">
                <input type="text" id="link-group-teachers" placeholder="Teacher Group Link">
                <input type="text" id="link-group-students" placeholder="Student Group Link">
            </div>
            <div class="button-row" style="margin-top: 15px;">
                <button class="btn-fetch" style="background: #000;" onclick="saveGroupLinks()">SAVE LINKS</button>
                <button class="btn-add" style="background: #25D366;" onclick="broadcastToGroup('Teacher')">OPEN TEACHER GROUP</button>
                <button class="btn-add" style="background: #25D366;" onclick="broadcastToGroup('Student')">OPEN STUDENT GROUP</button>
            </div>
        </div>

        <!-- ROW 3: INTERNAL NOTICE BOARD (Sends to Student Portals) -->
        <div style="margin-top: 25px; padding: 20px; border: 2px solid #000; border-radius: 15px; background: #fff8f8; border-top: 5px solid #ff0000;">
            <h4><i class="fas fa-bullhorn"></i> Official Portal Notice Board</h4>
            <div class="form-grid">
                <select id="notice-subject" style="border: 1px solid #ff0000;"><option value="General">All Batches</option><option>Mathematics</option><option>History</option><option>Geography</option></select>
                <textarea id="notice-text" placeholder="Type message to appear in Student Portal..." rows="2"></textarea>
            </div>
            <button class="btn-add" style="background: #ff0000; width: 100%; margin-top: 10px;" onclick="sendInternalNotice()">POST TO PORTALS</button>
        </div>

        <!-- RESULTS LIST -->
        <div id="wa-results-area" style="display: none; margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 20px;"><div id="wa-contact-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;"></div></div>
    </div>
</section>


<section id="calendar-mod" class="content-section">
    <!-- OWNER: Add Event -->
    <div class="card" id="calendar-admin-view" style="border-top: 5px solid #ff0000;">
        <h3><i class="fas fa-calendar-plus"></i> Manage Holidays & Events</h3>
        <div class="form-grid">
            <div class="input-group"><label>Event Date</label><input type="date" id="cal-date"></div>
            <div class="input-group"><label>Event Name</label><input type="text" id="cal-name" placeholder="e.g. Diwali Holiday"></div>
            <div class="input-group">
                <label>Type</label>
                <select id="cal-type">
                    <option>Holiday</option>
                    <option>Exam</option>
                    <option>Event/Function</option>
                </select>
            </div>
            <div class="input-group"><label>Short Description</label><input type="text" id="cal-desc" placeholder="e.g. Institute will remain closed"></div>
        </div>
        <div class="button-row">
            <button class="btn-add" onclick="saveCalendarEvent()">ADD TO CALENDAR</button>
        </div>
    </div>

    <!-- EVERYONE: View Calendar -->
    <div class="card" style="margin-top: 20px;">
        <h3><i class="fas fa-calendar-day"></i> Upcoming Dates</h3>
        <div id="calendar-list" style="text-align: left; margin-top: 15px;">
            <p style="color: #888; text-align: center;">Loading calendar...</p>
        </div>
    </div>
</section>





<!-- ALUMNI & PLACEMENT SECTION -->
<section id="alumni-mod" class="content-section">
    <div class="card" style="border-top: 5px solid #673ab7;">
        <h3><i class="fas fa-award"></i> Alumni & Placement Tracker</h3>
        <p style="font-size: 0.8rem; color: #666; margin-bottom: 20px;">Note: Only students whose status is NOT 'Active' can be added here.</p>
        
        <div class="form-grid">
            <div class="input-group">
                <label>Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="al-roll" placeholder="IMS-XXXX">
                    <button class="btn-fetch" onclick="fetchStudentForAlumni()" style="padding: 5px 10px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group"><label>Full Name</label><input type="text" id="al-name" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Course Enrolled</label><input type="text" id="al-course" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Enrollment Date</label><input type="text" id="al-enroll" readonly style="background:#eee;"></div>
            
            <div class="input-group"><label>Name of College</label><input type="text" id="al-college" placeholder="Higher Education Institute"></div>
            <div class="input-group"><label>Stream</label><input type="text" id="al-stream" placeholder="e.g. Science, Commerce"></div>
            <div class="input-group"><label>Name of Company</label><input type="text" id="al-company" placeholder="Workplace"></div>
            <div class="input-group"><label>Designation</label><input type="text" id="al-designation" placeholder="Job Role"></div>
            <div class="input-group"><label>Annual Salary / Package</label><input type="number" id="al-salary" placeholder="Amount"></div>
        </div>

        <div class="button-row">
            <button class="btn-add" onclick="addAlumni()">ADD ALUMNI</button>
            <button class="btn-edit" onclick="editAlumni()">EDIT (Roll No)</button>
            <button class="btn-fetch" onclick="fetchSavedAlumni()">FETCH SAVED</button>
            <button class="btn-edit" style="background:#666;" onclick="clearAlumniForm()">CLEAR</button>
        </div>
    </div>
</section>





<!-- INVENTORY MANAGER SECTION -->
<!-- INVENTORY MANAGER SECTION -->
<section id="inventory-mod" class="content-section">
    <div class="card" style="border-top: 5px solid #2c3e50; max-width: 1100px;">
        <h3><i class="fas fa-boxes"></i> Inventory & Stationery Manager</h3>
        
        <!-- STEP 1: Manage Catalog -->
        <div style="text-align: left; margin-bottom: 20px;">
            <button class="btn-fetch" onclick="toggleInventoryGrid()" style="background: #34495e;">
                <i class="fas fa-edit"></i> UPDATE STOCK & PRICES
            </button>
        </div>

        <div id="inventory-grid-container" style="display:none; margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 15px; border: 1px solid #ddd; overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
               <thead style="background: #eee;">
    <tr>
        <th style="padding: 10px; border: 1px solid #ccc;">Select</th>
        <th style="padding: 10px; border: 1px solid #ccc;">Item Name</th>
        <th style="padding: 10px; border: 1px solid #ccc;">Stock Level</th>
        <th style="padding: 10px; border: 1px solid #ccc;">Item Price</th>
        <th style="padding: 10px; border: 1px solid #ccc;">Qty Bought</th> <!-- NEW COLUMN -->
        <th style="padding: 10px; border: 1px solid #ccc;">Vendors (A-E)</th>
    </tr>
</thead>
                <tbody id="inventory-items-body">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
            <div class="button-row" style="margin-top: 15px;">
                <button class="btn-add" onclick="saveInventoryMaster()">SAVE UPDATED CATALOG</button>
            </div>
        </div>

        <!-- STEP 2: Sales Section -->
        <div class="card" style="background: #fff; border: 1px solid #000; padding: 20px; margin: 0;">
            <h4><i class="fas fa-shopping-cart"></i> Student Purchase Entry</h4>
            <div class="form-grid">
                <div class="input-group">
                    <label>Student Roll Number</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="inv-stu-roll" placeholder="IMS-XXXX">
                        <button class="btn-fetch" onclick="fetchStudentForInv()" style="padding: 5px 10px;"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div class="input-group"><label>Full Name</label><input type="text" id="inv-stu-name" readonly style="background:#eee;"></div>
                <div class="input-group"><label>Course</label><input type="text" id="inv-stu-course" readonly style="background:#eee;"></div>
                <div class="input-group"><label>Total Amount to Pay</label><input type="number" id="inv-total-calc" readonly style="background:#eee; font-weight: bold; color: green;"></div>
                <div class="input-group" style="grid-column: 1/-1;"><label>Remarks</label><input type="text" id="inv-remarks"></div>
            </div>

            <div class="button-row">
                <button class="btn-add" style="background: #27ae60;" onclick="processInventorySale()">ADD SALE RECORD</button>
                <button class="btn-fetch" onclick="fetchInventorySale()">FETCH (Roll No)</button>
                <button class="btn-edit" style="background:#666;" onclick="clearInventoryUI()">CLEAR</button>
            </div>
        </div>

        <!-- LOW STOCK WARNING -->
        <div id="low-stock-alert" style="display:none; margin-top: 20px; padding: 15px; background: #fff; border: 2px solid #ff0000; border-radius: 10px; color: #ff0000; font-weight: bold;">
            <i class="fas fa-exclamation-circle"></i> LOW STOCK WARNING: <span id="low-stock-items"></span>
        </div>
    </div>
</section>







<!-- 23. SCHOLARSHIP TRACKER SECTION -->
<section id="scholarship-mod" class="content-section">
    <div class="card" style="border-top: 5px solid #f39c12; max-width: 1000px;">
        <h3><i class="fas fa-award"></i> Scholarship Tracker & Award Generator</h3>
        
        <div class="form-grid">
            <div class="input-group"><label>1. Today's Date</label><input type="date" id="sch-today"></div>
            
            <div class="input-group">
                <label>3. Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="sch-roll" placeholder="IMS-XXXX">
                    <button class="btn-fetch" onclick="fetchStudentForScholarship()" style="padding: 5px 10px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            
            <div class="input-group"><label>2. Full Name</label><input type="text" id="sch-name" readonly style="background:#eee;"></div>
            <div class="input-group"><label>4. Course Name</label><input type="text" id="sch-course" readonly style="background:#eee;"></div>
            <div class="input-group"><label>6. Total Course Fee (₹)</label><input type="number" id="sch-total-fee" readonly style="background:#eee; font-weight:bold;"></div>
            
            <div class="input-group"><label>5. Scholarship Name</label><input type="text" id="sch-sch-name" placeholder="e.g. Talent Search 2026"></div>
            <div class="input-group"><label>7. Applied On</label><input type="date" id="sch-applied-date"></div>
            <div class="input-group"><label>8. Documents Required</label><input type="text" id="sch-docs" placeholder="e.g. Income Cert, Marksheet"></div>
            
            <div class="input-group">
                <label>9. Status</label>
                <select id="sch-status" onchange="calculateScholarship()">
                    <option value="Pending">Pending</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>
            
            <div class="input-group"><label>10. Scholarship %</label><input type="number" id="sch-pct" value="0" oninput="calculateScholarship()" placeholder="0"></div>
            <div class="input-group"><label>11. Scholarship Amount (₹)</label><input type="text" id="sch-amt" readonly style="background:#eee; color:#27ae60; font-weight:bold;"></div>
            <div class="input-group"><label>12. Final Fees (₹)</label><input type="text" id="sch-final-fee" readonly style="background:#eee; color:#ff0000; font-weight:bold;"></div>
            
            <div class="input-group"><label>13. Valid From</label><input type="date" id="sch-valid-from"></div>
            <div class="input-group"><label>14. Valid To</label><input type="date" id="sch-valid-to"></div>
            <div class="input-group" style="grid-column: 1/-1;"><label>15. Remarks</label><input type="text" id="sch-remarks" placeholder="Reasons for rejection / Applied on total fee, etc."></div>
            
            <div class="input-group" style="grid-column: 1/-1; border: 2px dashed #007bff; padding: 10px; border-radius: 8px;">
                <label>Upload Student Documents (Optional)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="sch-upload" accept=".pdf, .jpg, .png">
                    <button class="btn-add" style="background:#1877F2; padding: 8px 15px;" onclick="uploadScholarshipDoc()"><i class="fas fa-upload"></i> UPLOAD</button>
                    <span id="sch-upload-status" style="font-size: 0.8rem; color: #27ae60; font-weight: bold;"></span>
                </div>
            </div>
        </div>

        <div class="button-row" style="margin-top: 25px;">
            <button class="btn-add" onclick="addScholarship()">ADD RECORD</button>
            <button class="btn-fetch" onclick="fetchScholarshipByRoll()">FETCH (Roll No)</button>
            <button class="btn-edit" onclick="updateScholarship()">UPDATE (Roll No)</button>
            <button class="btn-add" style="background:#673ab7;" onclick="printScholarship()"><i class="fas fa-print"></i> PRINT AWARD LETTER</button>
        </div>
    </div>
</section>














<!-- 24. PTM SCHEDULE SECTION -->
<section id="ptm-mod" class="content-section">
    <div class="card" style="border-top: 5px solid #e84393; max-width: 1000px;">
        <h3><i class="fas fa-handshake"></i> Parent-Teacher Meeting (PTM) Scheduler</h3>
        
        <!-- PTM Setup Parameters -->
        <div style="background: #fff0f5; padding: 15px; border-radius: 10px; border: 1px solid #e84393; margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px; color: #e84393;">Step 1: PTM Configuration</h4>
            <div class="form-grid">
                <div class="input-group"><label>Month & Year</label><input type="month" id="ptm-month"></div>
                <div class="input-group"><label>PTM Date</label><input type="date" id="ptm-date" onchange="checkPTMDateValidity()"></div>
                <div class="input-group"><label>Start Time</label><input type="time" id="ptm-start" value="09:00"></div>
                <div class="input-group"><label>End Time</label><input type="time" id="ptm-end" value="12:00"></div>
                <div class="input-group"><label>Slot Duration (Mins)</label><input type="number" id="ptm-duration" value="15"></div>
                <div class="input-group">
                    <label>Status</label>
                    <select id="ptm-status" onchange="togglePTMStatus()">
                        <option value="Open">Open</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Student & Auto-Slot Generation -->
        <div id="ptm-booking-area">
            <h4 style="margin-bottom: 10px; color: #000; text-align: left;">Step 2: Auto-Allocate Slot</h4>
            <div class="form-grid">
                <div class="input-group">
                    <label>Student Roll Number</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="ptm-roll" placeholder="IMS-XXXX">
                        <button class="btn-fetch" onclick="fetchAndAllocatePTM()" style="padding: 5px 10px;"><i class="fas fa-magic"></i> Auto-Slot</button>
                    </div>
                </div>
                
                <div class="input-group"><label>Student Name</label><input type="text" id="ptm-sname" readonly style="background:#eee;"></div>
                <div class="input-group"><label>Course</label><input type="text" id="ptm-course" readonly style="background:#eee;"></div>
                
                <div class="input-group"><label>Teacher ID</label><input type="text" id="ptm-tid" readonly style="background:#eee;"></div>
                <div class="input-group"><label>Teacher Name</label><input type="text" id="ptm-tname" readonly style="background:#eee;"></div>
                
                <div class="input-group"><label>Allocated Slot Time</label><input type="time" id="ptm-slot-time" readonly style="background:#dff9fb; border: 2px solid #22a6b3; font-weight: bold; color: #000;"></div>
            </div>

            <!-- Communication Area -->
            <hr style="margin: 20px 0;">
            <div class="form-grid" style="align-items: center;">
                <div class="input-group"><label>Teacher Mobile</label><input type="text" id="ptm-tmob" readonly style="background:#eee;"></div>
                <a href="#" id="wa-ptm-teacher" target="_blank" style="background:#25D366; color:#fff; padding:10px; border-radius:5px; text-decoration:none; text-align:center; margin-top:15px; pointer-events:none; opacity:0.5;"><i class="fab fa-whatsapp"></i> Inform Teacher</a>

                <div class="input-group"><label>Mother's Mobile</label><input type="text" id="ptm-mmob" readonly style="background:#eee;"></div>
                <a href="#" id="wa-ptm-mother" target="_blank" style="background:#25D366; color:#fff; padding:10px; border-radius:5px; text-decoration:none; text-align:center; margin-top:15px; pointer-events:none; opacity:0.5;"><i class="fab fa-whatsapp"></i> Inform Mother</a>

                <div class="input-group"><label>Father's Mobile</label><input type="text" id="ptm-fmob" readonly style="background:#eee;"></div>
                <a href="#" id="wa-ptm-father" target="_blank" style="background:#25D366; color:#fff; padding:10px; border-radius:5px; text-decoration:none; text-align:center; margin-top:15px; pointer-events:none; opacity:0.5;"><i class="fab fa-whatsapp"></i> Inform Father</a>
            </div>

            <div class="input-group" style="margin-top: 15px;"><label>Remarks</label><input type="text" id="ptm-remarks" placeholder="e.g. Parents informed, Confirmed present"></div>
            
            <div class="button-row" style="margin-top: 20px;">
                <button class="btn-add" style="background:#e84393; border-color:#d63031;" onclick="addPTMRecord()">ADD PTM RECORD</button>
<button class="btn-fetch" onclick="fetchPTMRecordByRoll()">FETCH PTM RECORD</button>
            </div>
        </div>
    </div>
</section>










<!-- 25. BATCH MASTER SECTION -->
<section id="batch-master" class="content-section">
    <div class="card" style="border-top: 5px solid #2980b9; max-width: 1100px;">
        <h3><i class="fas fa-users-cog"></i> Batch Master List</h3>
        
        <div class="form-grid">
            <div class="input-group"><label>Date Today</label><input type="date" id="bm-date"></div>
            
            <div class="input-group">
                <label>Student Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="bm-roll" placeholder="IMS-XXXX">
                    <button class="btn-fetch" onclick="autopopulateBatchMaster()" style="padding: 5px 10px;"><i class="fas fa-search"></i> Auto-Fill</button>
                </div>
            </div>
            
            <div class="input-group"><label>Student Full Name</label><input type="text" id="bm-sname" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Course Name</label><input type="text" id="bm-course" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Teacher ID</label><input type="text" id="bm-tid" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Teacher Name</label><input type="text" id="bm-tname" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Batch Name</label><input type="text" id="bm-bname" readonly style="background:#eee;"></div>
            <div class="input-group" style="grid-column: 1/-1;"><label>Remarks</label><input type="text" id="bm-remarks" placeholder="Add remarks..."></div>
        </div>

        <div class="button-row">
            <button class="btn-add" onclick="addBatchMasterRecord()">ADD RECORD</button>
            <button class="btn-fetch" onclick="fetchBatchMasterRecord()">FETCH (By Roll No)</button>
            <button class="btn-fetch" style="background:#8e44ad;" onclick="listAllByBatch()">LIST STUDENTS (By Batch)</button>
            <button class="btn-edit" style="background:#666;" onclick="clearBatchMaster()">CLEAR</button>
        </div>

        <!-- Table Display Area -->
        <div id="bm-list-area" style="display:none; margin-top: 30px; overflow-x: auto; background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #ddd;">
            <h4 style="margin-bottom: 15px; color: #000; text-align: left;" id="bm-list-title">Student List</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; color: #000;">
                <thead style="background: #eee;">
                    <tr>
                        <th style="padding:10px; border:1px solid #ccc; text-align:left;">Batch Name</th>
                        <th style="padding:10px; border:1px solid #ccc; text-align:left;">Roll No</th>
                        <th style="padding:10px; border:1px solid #ccc; text-align:left;">Full Name</th>
                        <th style="padding:10px; border:1px solid #ccc; text-align:left;">Teacher ID</th>
                        <th style="padding:10px; border:1px solid #ccc; text-align:left;">Teacher Name</th>
                        <th style="padding:10px; border:1px solid #ccc; text-align:left;">Course Name</th>
                    </tr>
                </thead>
                <tbody id="bm-list-body">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </div>
    </div>
</section>
        </main>
    </div>

    <footer>
        <div class="footer-grid">
            <div class="footer-col">
                <h4>Product</h4>
                <ul>
                    <li><a href="features.html">Features</a></li>
                    <li><a href="pricing.html">Pricing</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Support</h4>
                <ul>
                    <li><a href="FAQ.html">FAQs</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Company</h4>
                <ul>
                    <li><a href="about.html">About</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Legal</h4>
                <ul>
                    <li><a href="privacy.html">Privacy Policy</a></li>
                    <li><a href="terms.html">Terms</a></li>
                    <li><a href="disclaimer.html">Disclaimer</a></li>
                    <li><a href="refund.html">Refund Policy</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Social Media</h4>
                <ul>
                    <li><a href="https://www.linkedin.com/in/sunil-vasarkar-216184158/"><i class="fab fa-linkedin"></i> Linkedin</a></li>
                </ul>
            </div>
        </div>
     <div class="footer-bottom">
            <p>Made in India | Built for coaching institutes</p>
            <p>2026 ClassManager. All rights Reserved</p>
        </div>
    </footer>
<script>
/* ==========================================
   1. CORE INITIALIZATION
   ========================================== */
/* ==========================================
   1. CORE INITIALIZATION
   ========================================== */
const _supabaseUrl = 'https://erzwijnlbnwjdlluvxyk.supabase.co';
const _supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyendpam5sYm53amRsbHV2eHlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNTkzMDgsImV4cCI6MjA4NjgzNTMwOH0.H8c9tT5HsxeL4xJAM9KrKmb1v6KKO8dZ-NOB-Pz2G2k';
const db =  supabase.createClient(_supabaseUrl, _supabaseKey);


google.charts.load('current', {'packages':['corechart', 'controls']});

// ADD THESE TWO LINES HERE
let sessionInstID = ""; 
let sessionUserName = "";


let portalCurrentPage = 1;
let portalDataRows = []; // To store the grouped data
const rowsPerPage = 5;





async function checkCurrentSession() {
    const { data: { user } } = await db.auth.getUser();
    if (user) {
        const { data: profile } = await db.from('profiles').select('full_name, institute_id').eq('id', user.id).single();
        if (profile) {
            sessionUserName = profile.full_name;
            sessionInstID = profile.institute_id; 

            document.getElementById('auth-status-bar').style.display = 'flex';
            document.getElementById('user-greeting').innerText = `Welcome ${sessionUserName} (${sessionInstID})`;
            
            // SHOW the Stats, HIDE the "Still managing manually" text
            document.getElementById('home-visitor-view').style.display = 'none';
            document.getElementById('home-user-view').style.display = 'block';
            
            loadHomeDashboardStats();
        }
    } else {
        document.getElementById('auth-status-bar').style.display = 'none';
        document.getElementById('home-visitor-view').style.display = 'block';
        document.getElementById('home-user-view').style.display = 'none';
    }
}
checkCurrentSession();

// Helper to get input values easily
const val = (id, selector) => {
    const el = document.querySelector(`${id} ${selector}`);
    if (!el) {
        console.warn(`Element ${id} ${selector} not found`);
        return ""; // Return empty string instead of crashing
    }
    return el.value;
};
/* ==========================================
   2. LOGIN SYSTEM (Signup, Login, Auth)
   ========================================== */
/* ==========================================
   UPDATED LOGIN & SIGNUP WITH VALIDATION
   ========================================== */

// 1. Toggle Password Visibility
function togglePass(id) {
    const el = document.getElementById(id);
    el.type = el.type === "password" ? "text" : "password";
}

// 2. Clear Form Data
function clearForm(formId) {
    const inputs = document.querySelectorAll(`#${formId} input, #${formId} select`);
    inputs.forEach(input => input.value = "");
}

// 3. Validation Helpers
function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function isValidMobile(mobile) {
    return /^[6-9]\d{9}$/.test(mobile); // Indian mobile starts with 6,7,8,9
}



function toggleInstIdField() {
    const role = document.getElementById('sig-role').value;
    const instIdField = document.getElementById('sig-inst-id');
    if (instIdField) {
        if (role === 'Teacher' || role === 'Student') {
            instIdField.style.display = 'block'; // Show box
        } else {
            instIdField.style.display = 'none';  // Hide box for Owner
            instIdField.value = "";
        }
    }
}




async function handleSignup() {
    const name = document.getElementById('sig-name').value.trim();
    const role = document.getElementById('sig-role').value;
    const email = document.getElementById('sig-email').value.trim();
    const pass = document.getElementById('sig-pass').value;
    const state = document.getElementById('sig-state').value;
    const mobile = document.getElementById('sig-mobile').value.trim();

    // 1. Basic Validations FIRST
    if (!name) return alert("Error: Please enter Full Name");
    if (!role) return alert("Error: Please select your Status (Role)");
    if (!isValidEmail(email)) return alert("Error: Please enter a valid Email ID");
    if (pass.length < 6) return alert("Error: Password must be at least 6 characters long");
    if (!state) return alert("Error: Please select your State/UT");
    if (!isValidMobile(mobile)) return alert("Error: Please enter a valid 10-digit Indian Mobile Number");

    // 2. Institute ID Logic (The Fix)
    let finalInstID = "";
    if (role === 'Owner') {
        // Owners get a brand new ID generated
        finalInstID = "CM-" + Math.floor(1000 + Math.random() * 9000);
    } else {
        // Teachers & Students MUST type the Owner's ID
        finalInstID = document.getElementById('sig-inst-id').value.trim().toUpperCase();
        if (!finalInstID) return alert("Error: Please enter the Owner's Institute ID to join their institute.");
    }

    // 3. Supabase Auth Signup
    const { data, error } = await db.auth.signUp({ email, password: pass });

    if (error) return alert("Signup Failed: " + error.message);

    if (data.user) {
        // 4. Create Profile in DB using finalInstID
        const { error: profileError } = await db.from('profiles').insert([{ 
            id: data.user.id, 
            full_name: name, 
            email: email, 
            role: role, 
            mobile_number: mobile,
            state: state,
            institute_id: finalInstID 
        }]);

        if (profileError) {
            alert("Profile Error: " + profileError.message);
        } else {
            // Show correct success message based on role
            if (role === 'Owner') {
                alert("Success! Account created.\n\nYour newly generated Institute ID is: " + finalInstID + "\n(Share this ID with your teachers & students!).\n\nPlease check your email for verification.");
            } else {
                alert("Success! You have been successfully linked to Institute " + finalInstID + ".\n\nPlease check your email for verification.");
            }
            clearForm('signup-form');
        }
    }
}










// 5. Handle Login
// 5. Updated Handle Login with Role Verification
// Global variable to store name for the "Bye Bye" message


// 1. Updated Handle Login
async function handleLogin() {
    const roleSelected = document.getElementById('log-role').value;
    const email = document.getElementById('log-email').value.trim();
    const pass = document.getElementById('log-pass').value;

    if (!roleSelected || !email || !pass) return alert("Error: Please fill all login fields");

    const { data, error } = await db.auth.signInWithPassword({ email, password: pass });
    
    if (error) return alert("Login Failed: " + error.message);

    // Fetch profile to get the Full Name
    const { data: profile, error: profileError } = await db
        .from('profiles')
        .select('full_name, role')
        .eq('id', data.user.id)
        .single();

    if (profileError || !profile) {
        await db.auth.signOut();
        return alert("Error: Profile not found.");
    }

    if (profile.role !== roleSelected) {
        await db.auth.signOut();
        return alert(`Access Denied: You are registered as "${profile.role}".`);
    }

    // SUCCESS LOGIC
    sessionUserName = profile.full_name;
    
    // Update UI
    document.getElementById('auth-status-bar').style.display = 'flex';
    document.getElementById('user-greeting').innerText = "Welcome " + sessionUserName;
    document.getElementById('logout-btn').style.display = 'block';

    alert(`Login Successful! Welcome ${sessionUserName}.`);
    showSection('home'); // Automatically take them to home after login
}

// 2. New Handle Logout Function
async function handleLogout() {
    const { error } = await db.auth.signOut();
    
    if (error) {
        alert("Error logging out: " + error.message);
    } else {
        // Change message to "Bye Bye"
        document.getElementById('user-greeting').innerText = "Bye Bye " + sessionUserName;
        document.getElementById('logout-btn').style.display = 'none';

        // Wait 2 seconds so they can read the message, then refresh or hide sections
        setTimeout(() => {
            alert("Session Closed.");
            location.reload(); // Refresh to clear all sensitive data from memory
        }, 2000);
    }
}

async function loadHomeDashboardStats() {
    if (!sessionInstID) return;
    
    // ADDED 'due_dates' to the select statement below
    const { data: students } = await db.from('students')
        .select('paid_amount, pending_amount, due_dates') 
        .eq('institute_id', sessionInstID)
        .eq('status', 'Active');

    if (students) {
        const totalStu = students.length;
        const totalColl = students.reduce((sum, s) => sum + (Number(s.paid_amount) || 0), 0);
        const totalPend = students.reduce((sum, s) => sum + (Number(s.pending_amount) || 0), 0);

        document.getElementById('home-total-stu').innerText = totalStu;
        document.getElementById('home-total-coll').innerText = "₹ " + totalColl.toLocaleString('en-IN');
        document.getElementById('home-total-pend').innerText = "₹ " + totalPend.toLocaleString('en-IN');
loadHomeInventoryStats();

        // --- ADDED FOR FORECASTING ---
        generateFinancialForecast(students);
    }
}

/* ==========================================
   HOME DASHBOARD STATS LOGIC
   ========================================== */

/* ==========================================
   3. STUDENT MANAGEMENT (Add, Edit, Fetch)
   ========================================== */
/* ==========================================
   UPDATED STUDENT MANAGEMENT LOGIC
   ========================================== */

// 1. Auto-Calculate Pending Amount
function calcStuPending() {
    const total = parseFloat(document.getElementById('stu-total').value) || 0;
    const paid = parseFloat(document.getElementById('stu-paid').value) || 0;
    if (paid > total) {
        alert("Error: Paid amount cannot be more than Total Fees");
        document.getElementById('stu-paid').value = total;
        document.getElementById('stu-pending').value = 0;
    } else {
        document.getElementById('stu-pending').value = total - paid;
    }
}

// 2. Clear Form
function clearStudentForm() {
    const ids = ['stu-date','stu-name','stu-mobile','stu-father','stu-mother','stu-standard','stu-batch','stu-course','stu-total','stu-paid','stu-pending','stu-roll','stu-end-date'];
    ids.forEach(id => document.getElementById(id).value = "");
}

// 3. Generate Roll Number Immediately
function generateRollNow() {
    const year = new Date().getFullYear();
    const random = Math.floor(1000 + Math.random() * 9000);
    document.getElementById('stu-roll').value = `IMS-${year}-${random}`;
}

// 4. Validation & Add Student
async function addStudent() {
if (!sessionInstID || sessionInstID === "") {
        return alert("Error: Institute ID is missing. Please refresh the page or log in again.");
    }
    // 1. Get Values from UI
    const admissionDate = document.getElementById('stu-date').value;
    const endDate = document.getElementById('stu-end-date').value;
    const mobile = document.getElementById('stu-mobile').value;
    const fMobile = document.getElementById('stu-father').value;
    const mMobile = document.getElementById('stu-mother').value;
    const roll = document.getElementById('stu-roll').value;
    const today = new Date().setHours(0,0,0,0);

    // 2. Validations
    if (!admissionDate) return alert("Error: Admission Date is required.");
    if (!roll) return alert("Error: Please click 'Gen' to create a Roll Number first.");
    if (mobile.length !== 10) return alert("Error: Mobile Number must be 10 digits.");



// START OF ADDED VALIDATIONS
    if (fMobile && fMobile.length !== 10) return alert("Error: Father's Mobile Number must be exactly 10 digits.");
    if (mMobile && mMobile.length !== 10) return alert("Error: Mother's Mobile Number must be exactly 10 digits.");

    const tFees = parseFloat(document.getElementById('stu-total').value) || 0;
    const pAmt = parseFloat(document.getElementById('stu-paid').value) || 0;
    if (pAmt > tFees) return alert("Error: Paid amount cannot be greater than Total Fees.");

    if (endDate && new Date(endDate).setHours(0,0,0,0) < today) return alert("Error: Course End Date cannot be in the past.");

    const fullNameStr = document.getElementById('stu-name').value.trim();
    const nameWords = fullNameStr.split(/\s+/);
    if (nameWords.length < 2 || nameWords[1].length < 2) return alert("Error: Please enter a valid Full Name. A Second word (Surname) with at least 2 letters is required.");

    const dueDatesStr = document.getElementById('stu-due-dates').value.trim();
    if (dueDatesStr) {
        const currentMonthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).getTime();
        const dateArray = dueDatesStr.split(',');
        for (let d of dateArray) {
            const parsedD = new Date(d.trim() + " 1"); // e.g., parses "March 2026" as "March 1, 2026"
            if (parsedD.toString() !== "Invalid Date" && parsedD.getTime() < currentMonthStart) {
                return alert("Error: Payment Due Date '" + d.trim() + "' cannot be in the past.");
            }
        }
    }
    // END OF ADDED VALIDATIONS

    // 3. Check if this Roll Number already exists in the database to prevent the "Duplicate" error
    const { data: existingRoll } = await db.from('student_details').select('roll_number').eq('roll_number', roll).single();
    if (existingRoll) {
        return alert("Error: This Roll Number (" + roll + ") is already assigned to someone else. Please generate a new one.");
    }

    // 4. Prepare the Data Object
    const stuData = {
 institute_id: sessionInstID,
        admission_date: admissionDate,
        full_name: document.getElementById('stu-name').value,
        mobile: mobile,
        father_mobile: fMobile,
        mother_mobile: mMobile,
        standard: document.getElementById('stu-standard').value,
        batch_time: document.getElementById('stu-batch').value,
        course: document.getElementById('stu-course').value,
        total_fees: parseFloat(document.getElementById('stu-total').value) || 0,
        paid_amount: parseFloat(document.getElementById('stu-paid').value) || 0,
        pending_amount: parseFloat(document.getElementById('stu-pending').value) || 0,
        roll_number: roll,
        user_id: (await db.auth.getUser()).data.user?.id ,
due_dates: document.getElementById('stu-due-dates').value,
status: document.getElementById('stu-status').value 
    };

    // 5. Save to 'students' table
    const { data: newStu, error: stuError } = await db.from('students').insert([stuData]).select();

    if (stuError) {
        console.error(stuError);
        return alert("Save Error: " + stuError.message);
    }

    // 6. Save to 'student_details' using UPSERT (This prevents the 'Unique Constraint' crash)
    if (newStu && newStu[0]) {
        const { error: detailError } = await db.from('student_details').upsert([{
 institute_id: sessionInstID,
            student_id: newStu[0].id,
            roll_number: roll,
            course_end_date: endDate
        }], { onConflict: 'student_id' }); // If ID exists, it updates; it won't crash.
        
        if (detailError) {
            alert("Error in secondary details: " + detailError.message);
        } else {

// --- NEW LOGIC: Log the initial payment into Payment History ---
  if (parseFloat(stuData.paid_amount) > 0) {
        const payDate = stuData.admission_date;
        const monthYearStr = new Date(payDate).toLocaleString('default', { month: 'long', year: 'numeric' });
        
        await db.from('payment_history').insert([{
            institute_id: sessionInstID,
            student_id: newStu[0].id,
            roll_number: roll,
            amount: stuData.paid_amount,
            payment_date: payDate,
            month_year: monthYearStr
        }]);
    }

    // --- End of New Logic ---






    alert("SUCCESS! Student " + stuData.full_name + " saved with Roll No: " + roll);
    clearStudentForm();
            alert("SUCCESS! Student " + stuData.full_name + " saved with Roll No: " + roll);
            clearStudentForm();
        }
    }
}

// 5. Fetch Details by Roll Number
async function fetchStudentByRoll() {
    // 1. Session Safety Check
    if (!sessionInstID) {
        await checkCurrentSession();
    }
    if (!sessionInstID) return alert("Error: Institute ID not loaded.");

    let roll = prompt("Enter Student Roll Number:");
    if (!roll) return;

    roll = roll.trim().toUpperCase(); 

    // 2. Fetch all columns from students and course_end_date from details
    const { data, error } = await db
        .from('student_details')
        .select(`
            roll_number, 
            course_end_date, 
            students (
                admission_date, 
                full_name, 
                mobile, 
                father_mobile, 
                mother_mobile, 
                standard, 
                batch_time, 
                course, 
                total_fees, 
                paid_amount, 
                pending_amount,
due_dates,
status
            )
        `)
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (error) return alert("Database Error: " + error.message);
    if (!data || !data.students) {
        return alert("NOT FOUND: Roll Number '" + roll + "' not found in your institute.");
    }

    const s = data.students;

    // 3. POPULATE EVERY FIELD IN THE FORM
    document.getElementById('stu-date').value = s.admission_date || "";
    document.getElementById('stu-name').value = s.full_name || "";
    document.getElementById('stu-mobile').value = s.mobile || "";
    document.getElementById('stu-father').value = s.father_mobile || "";
    document.getElementById('stu-mother').value = s.mother_mobile || "";
    document.getElementById('stu-standard').value = s.standard || "";
    document.getElementById('stu-batch').value = s.batch_time || "";
    document.getElementById('stu-course').value = s.course || "";
    document.getElementById('stu-total').value = s.total_fees || 0;
    document.getElementById('stu-paid').value = s.paid_amount || 0;
    document.getElementById('stu-pending').value = s.pending_amount || 0;
document.getElementById('stu-due-dates').value = s.due_dates || "";
 document.getElementById('stu-status').value = s.status || "Active";
    
    // Values from the student_details table
    document.getElementById('stu-roll').value = data.roll_number || "";
    document.getElementById('stu-end-date').value = data.course_end_date || "";

    alert("Full Profile Loaded for " + s.full_name);
}
// 6. Edit Details by Roll Number
async function editStudentByRoll() {
    const roll = document.getElementById('stu-roll').value;
    const admissionDate = document.getElementById('stu-date').value;
    const endDate = document.getElementById('stu-end-date').value;
    const today = new Date().setHours(0,0,0,0);

    if (!roll) return alert("Error: Please fetch a student first using Roll Number.");

    // Re-validate dates before updating
    if (new Date(admissionDate).setHours(0,0,0,0) < today) 
        return alert("Error: Admission Date cannot be in the past.");
    if (new Date(endDate).setHours(0,0,0,0) < today) 
        return alert("Error: Course End Date cannot be in the past.");

    // 1. Find the internal ID linked to this Roll Number
    const { data: detail, error: fetchErr } = await db.from('student_details')
        .select('student_id')
        .eq('roll_number', roll)
        .single();

    if (fetchErr || !detail) return alert("Error finding student link.");

    // 2. Prepare the data exactly as it appears in the UI
    const updateData = {
        admission_date: admissionDate,
        full_name: document.getElementById('stu-name').value,
        mobile: document.getElementById('stu-mobile').value,
        father_mobile: document.getElementById('stu-father').value,
        mother_mobile: document.getElementById('stu-mother').value,
        standard: document.getElementById('stu-standard').value,
        batch_time: document.getElementById('stu-batch').value,
        course: document.getElementById('stu-course').value,
        total_fees: parseFloat(document.getElementById('stu-total').value) || 0,
        paid_amount: parseFloat(document.getElementById('stu-paid').value) || 0,
due_dates: document.getElementById('stu-due-dates').value,
status: document.getElementById('stu-status').value, 
        pending_amount: parseFloat(document.getElementById('stu-pending').value) || 0 // CRITICAL LINE
    };

    // 3. Update the main students table
    const { error: stuErr } = await db.from('students').update(updateData).eq('id', detail.student_id);
    
    // 4. Update the course end date in the details table
    const { error: detErr } = await db.from('student_details').update({
        course_end_date: endDate
    }).eq('student_id', detail.student_id);

    if (stuErr || detErr) {
        alert("Update Failed: " + (stuErr?.message || detErr?.message));
    } else {
        alert("Success: Student details for " + roll + " have been updated.");
    }
}
/* ==========================================
   4. FEE MANAGEMENT (Stats & Links)
   ========================================== */
/* ==========================================
   UPDATED FEE MANAGEMENT LOGIC
   ========================================== */
/* ==========================================
   FEE MANAGEMENT LOGIC (FIXED)
   ========================================== */

// 1. Math: Total - (Previous + Now) = New Pending
function calcPendingFee() {
    const total = parseFloat(document.getElementById('fee-total').value) || 0;
    const prev = parseFloat(document.getElementById('fee-prev-paid').value) || 0;
    const now = parseFloat(document.getElementById('fee-paid-now').value) || 0;
    
    const remaining = total - (prev + now);
    document.getElementById('fee-pending').value = remaining.toFixed(2);
}

function clearFeeForm() {
    ['fee-roll','fee-name','fee-course','fee-total','fee-prev-paid','fee-paid-now','fee-pending','fee-due-dates','fee-today'].forEach(id => {
        document.getElementById(id).value = "";
    });
}

// 2. Fetch Student with Balance
async function fetchFeeByRoll() {
    const roll = document.getElementById('fee-roll').value.trim().toUpperCase();
    if (!roll) return alert("Please enter a Roll Number.");

    const { data: detail } = await db.from('student_details')
        .select('student_id').eq('roll_number', roll).eq('institute_id', sessionInstID).maybeSingle();

    if (!detail) return alert("Roll Number not found.");

    // ADDED 'pending_amount' to your original select below
    const { data: s } = await db.from('students')
        .select('full_name, course, total_fees, paid_amount, pending_amount, due_dates, status')
        .eq('id', detail.student_id).maybeSingle();

    if (s) {
        document.getElementById('fee-name').value = s.full_name;
        document.getElementById('fee-course').value = s.course;
        document.getElementById('fee-total').value = s.total_fees;
        document.getElementById('fee-prev-paid').value = s.paid_amount;
        // POPULATING the 3rd greyed field
        document.getElementById('fee-pending').value = s.pending_amount; 
        
        document.getElementById('fee-due-dates').value = s.due_dates || "";
        document.getElementById('fee-status').value = s.status || "Active";
        document.getElementById('fee-today').value = new Date().toISOString().split('T')[0];
        calcPendingFee();
    }
}
// 3. Save Payment & Record in History
async function saveFeeUpdate() {
    // 1. GET INPUTS
    const roll = document.getElementById('fee-roll').value.trim().toUpperCase();
    const nowPaying = parseFloat(document.getElementById('fee-paid-now').value) || 0;
    const totalFees = parseFloat(document.getElementById('fee-total').value) || 0;
    const payDate = document.getElementById('fee-today').value;
    const fullNameVal = document.getElementById('fee-name').value.trim();
    const prevPaidVal = parseFloat(document.getElementById('fee-prev-paid').value) || 0;
    const joinDateVal = document.getElementById('fee-join-date').value;
    const todayStr = new Date().toISOString().split('T')[0];

    // 2. FULL ORIGINAL VALIDATIONS RESTORED
    if (!roll || !payDate) return alert("Error: Roll Number and Date are required.");
    
    // Name validation (Ensure first + surname)
    if (fullNameVal.split(/\s+/).filter(w => w.length > 0).length < 2) {
        return alert("Error: Enter Full Name (Initial + Surname).");
    }
    
    // Future date check
    if (joinDateVal > todayStr) return alert("Error: Date of Joining cannot be in future.");
    
    // Financial logic checks
    if (prevPaidVal > totalFees) return alert("Error: Previously Paid cannot exceed Total Fees.");
    if (nowPaying > (totalFees - prevPaidVal)) {
        return alert("Error: Payment exceeds remaining balance.");
    }







// --- START OF NEW ADDED VALIDATIONS ---
    
    // Fetch remaining fields to check if they are empty
    const courseVal = document.getElementById('fee-course').value.trim();
    const dueDatesVal = document.getElementById('fee-due-dates').value.trim();
    const statusVal = document.getElementById('fee-status').value;
    
    // 5. All fields are compulsory
    if (!fullNameVal || !joinDateVal || !courseVal || !dueDatesVal || !statusVal || 
        document.getElementById('fee-total').value === "" || 
        document.getElementById('fee-prev-paid').value === "" || 
        document.getElementById('fee-paid-now').value === "" || 
        document.getElementById('fee-pending').value === "") {
        return alert("Error: All fields are compulsory.");
    }

    // 1. Date today cannot be in the past
    if (payDate < todayStr) {
        return alert("Error: 'Date Today' cannot be in the past.");
    }

    // 2. Second word of Name should be at least 2 letters long
    const nameParts = fullNameVal.split(/\s+/).filter(w => w.length > 0);
    if (nameParts.length >= 2 && nameParts[1].length < 2) {
        return alert("Error: The second word (Surname) must be at least 2 letters long.");
    }

    // 3. Amount now paying cannot be more than total fees
    if (nowPaying > totalFees) {
        return alert("Error: Amount Now Paying cannot be more than Total Fees.");
    }

    // 4. Due dates cannot be in the past (Validates format like "March 2026")
    const currentMonthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).getTime();
    const dateArray = dueDatesVal.split(',');
    for (let d of dateArray) {
        const parsedD = new Date(d.trim() + " 1"); // Parses "March 2026" as "March 1, 2026"
        if (parsedD.toString() !== "Invalid Date" && parsedD.getTime() < currentMonthStart) {
            return alert("Error: Due Date '" + d.trim() + "' cannot be in the past.");
        }
    }
    
    // --- END OF NEW ADDED VALIDATIONS ---

    // 3. DATABASE CONNECTION (BRIDGE TO STUDENT_DETAILS)
    const { data: detail, error: fetchErr } = await db.from('student_details')
        .select('student_id')
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if(fetchErr || !detail) return alert("Fetch student first using roll number.");

    const newPaidTotal = prevPaidVal + nowPaying;

    // 4. UPDATE MASTER STUDENTS TABLE
    const { error: upError } = await db.from('students').update({
        paid_amount: newPaidTotal,
        pending_amount: totalFees - newPaidTotal,
        status: document.getElementById('fee-status').value,
        due_dates: document.getElementById('fee-due-dates').value
    }).eq('id', detail.student_id);

    if (upError) return alert("Student Update Failed: " + upError.message);

    // 5. INSERT INTO PAYMENT HISTORY (STAMP WITH INSTITUTE ID)
   
 const monthYearStr = new Date(payDate).toLocaleString('default', { month: 'long', year: 'numeric' });
    const { error: histError } = await db.from('payment_history').insert([{
        institute_id: sessionInstID, // Crucial for multi-tenant isolation
        student_id: detail.student_id,
        roll_number: roll,
        amount: nowPaying,
        payment_date: payDate,
        month_year: monthYearStr
    }]);

    if (histError) {
        alert("Balance updated, but history log failed: " + histError.message);
    } else {
        alert("SUCCESS: Payment Recorded, Master Student Table Updated & Transaction Logged!");
        
        // REFRESH UI
        fetchFeeByRoll();
        if (typeof loadFeesPortal === "function") loadFeesPortal();
    }
}




/* ==========================================
   FIXED FEES PORTAL: INSTITUTE-SPECIFIC DATA
   ========================================== */
/* ==========================================
   FIXED FEES PORTAL: SUBJECT-WISE PAGINATION
   ========================================== */
/* ==========================================
   FIXED FEES PORTAL: ROBUST VERSION
   ========================================== */
/* ==========================================
   FEES PORTAL: SUBJECT-WISE SUMMARY LOGIC
   ========================================== */

/* --- CONSOLIDATED FEES PORTAL LOGIC --- */
/* --- FINAL FIXED FEES PORTAL --- */


async function fetchPaymentLog() {
    const roll = document.getElementById('log-roll').value;
    const monthInput = document.getElementById('log-calendar').value; // YYYY-MM
    if(!roll || !monthInput) return alert("Please select Roll Number and Month Calendar.");

    const formattedMonth = new Date(monthInput + "-01").toLocaleString('default', { month: 'long', year: 'numeric' });
    const { data, error } = await db.from('payment_history').select('*').eq('roll_number', roll).eq('month_year', formattedMonth);

    const logDiv = document.getElementById('log-result');
    if (data && data.length > 0) {
        logDiv.innerHTML = `<strong>Payments for ${formattedMonth}:</strong><br>` + 
            data.map(p => `<p style="color:green;">✔ ₹${p.amount} on ${p.payment_date}</p>`).join('');
    } else {
        logDiv.innerHTML = `<span style="color:red;">No records found for ${formattedMonth}.</span>`;
    }
}





async function generateUPIQR() {
    // 1. Get current data from the Fee Form
    const amount = document.getElementById('fee-paid-now').value;
    const studentName = document.getElementById('fee-name').value;
    const roll = document.getElementById('fee-roll').value;

    // 2. Validation
    if (!amount || amount <= 0) return alert("Please enter the 'Amount Now Paying' first.");
    if (!studentName) return alert("Please fetch student details first.");

    // 3. Get UPI ID (VPA) from the owner
    // For a production system, we pull this from 'institute_settings' table.
    // As a shortcut, we will prompt once or you can hardcode it.
    let upiID = prompt("Enter Institute UPI ID (e.g., owner@okaxis or 9876543210@upi):");
    
    if (!upiID) return;

    // 4. Construct the UPI String
    // Format: upi://pay?pa=VPA&pn=NAME&am=AMOUNT&tn=REMARK&cu=INR
    const payeeName = encodeURIComponent("ClassManager Institute");
    const remarks = encodeURIComponent(`Fees-${roll}`);
    const upiString = `upi://pay?pa=${upiID}&pn=${payeeName}&am=${amount}&tn=${remarks}&cu=INR`;

    // 5. Use Google Chart API or GoQR to generate the image
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiString)}`;

    // 6. Update UI
    document.getElementById('upi-qr-img').src = qrUrl;
    document.getElementById('disp-qr-amt').innerText = amount;
    document.getElementById('disp-qr-name').innerText = studentName;
    document.getElementById('upi-qr-area').style.display = 'block';

    // Scroll to the QR code so the user sees it
    document.getElementById('upi-qr-area').scrollIntoView({ behavior: 'smooth' });
}
/* ==========================================
   5. BATCH MANAGEMENT
   ========================================== */
async function addBatch() {
    const batchData = {
 institute_id: sessionInstID,
        batch_name: document.getElementById('batch-name').value,
        teacher_id: document.getElementById('batch-teacher-id').value,
        teacher_name: document.getElementById('batch-teacher-name').value,
        batch_time: document.getElementById('batch-time').value,
        subject_name: document.getElementById('batch-subject').value,
        students_allotted: parseInt(document.getElementById('batch-students').value) || 0,
        remarks: document.getElementById('batch-remarks').value
    };

    const { error } = await db.from('batches').insert([batchData]);
    if (error) alert("Save Error: " + error.message);
    else alert("Batch Saved Successfully!");
}

// 4. THE MISSING FETCH FUNCTION
async function fetchBatch() {
    const name = prompt("Enter Batch Name to search:");
    if (!name) return;

    const { data, error } = await db.from('batches')
        .select('*')
        .eq('batch_name', name)
 .eq('institute_id', sessionInstID)
        .single();

    if (error || !data) return alert("Batch not found.");

    document.getElementById('batch-name').value = data.batch_name;
    document.getElementById('batch-teacher-id').value = data.teacher_id;
    document.getElementById('batch-teacher-name').value = data.teacher_name;
    document.getElementById('batch-time').value = data.batch_time;
    document.getElementById('batch-subject').value = data.subject_name;
    document.getElementById('batch-students').value = data.students_allotted;
    document.getElementById('batch-remarks').value = data.remarks;
    alert("Batch details loaded!");
}
async function editBatch() {
    const tID = val('#batch', 'input[placeholder="Teacher ID"]');
    const updateData = {
        batch_name: val('#batch', 'input[placeholder="Batch Name"]'),
        batch_time: val('#batch', 'input[type="time"]'),
        subject_name: val('#batch', 'input[placeholder="Subject Name"]')
    };
    const { error } = await db.from('batches').update(updateData).eq('teacher_id', tID);
    if (error) alert(error.message); else alert("Batch Updated Successfully!");
}
/* ==========================================
   6. ATTENDANCE (Mark & Fetch)
   ========================================== */
/* ==========================================
   UPDATED ATTENDANCE LOGIC
   ========================================== */

// 1. Fetch Student Name using Roll Number for the UI
async function fetchStudentForAttn() {
    const roll = document.getElementById('attn-roll').value.trim(); // .trim() handles accidental spaces
    if (!roll) return alert("Please enter a Roll Number");

    // Query the main 'students' table directly
    const { data, error } = await db
        .from('students')
        .select('full_name')
        .eq('roll_number', roll)
 .eq('institute_id', sessionInstID)
        .single();

    if (error || !data) {
        console.error("Fetch Error:", error);
        alert("Error: Roll Number '" + roll + "' not found in admission records.");
        document.getElementById('attn-name').value = "";
    } else {
        document.getElementById('attn-name').value = data.full_name;
    }
}
// 2. Trigger the calendar popup
let currentAttnStatus = "";
function triggerAttendance(status) {
    const name = document.getElementById('attn-name').value;
    if (!name) return alert("Please fetch a student by Roll Number first!");
    
    currentAttnStatus = status;
    const picker = document.getElementById('attn-date-picker');
    
    // Programmatically open the calendar
    picker.showPicker(); 
    
    // Listen for the date selection
    picker.onchange = async function() {
        if (this.value) {
            await saveAttendance(this.value, currentAttnStatus);
            this.value = ""; // reset
        }
    };
}

// 3. Save to Supabase
/* ==========================================
   FIXED ATTENDANCE & STATISTICS LOGIC
   ========================================== */

// 1. SAVE ATTENDANCE (Fixing the NULL user_id)
async function saveAttendance(dateValue, status) {
    const roll = document.getElementById('attn-roll').value.trim();
    if (!roll) return alert("Enter Roll Number first.");

    // Get Student ID and current User Session
    const { data: student } = await db.from('students').select('id').eq('roll_number', roll).single();
    const { data: { user } } = await db.auth.getUser(); // Fetches active login session

    if (!student) return alert("Student record not found.");
    if (!user) return alert("Error: You must be logged in to mark attendance.");

    const monthYear = new Date(dateValue).toLocaleString('default', { month: 'long', year: 'numeric' });

    const { error } = await db.from('attendance').insert([{
 institute_id: sessionInstID,
        student_id: student.id,
        roll_number: roll,
        attendance_date: dateValue,
        status: status,
        month_year: monthYear,
        user_id: user.id // Captures the ID of the person (Owner/Teacher) marking it
    }]);

    if (error) alert("Error: " + error.message);
    else alert(`Success: Marked ${status} for ${dateValue}`);


// NEW ALERT LOGIC
      // REFINED ALERT LOGIC: Connects to Parent Mobile Numbers
        if (status === "Absent") {
            const stuName = document.getElementById('attn-name').value;
            
            // 1. Fetch Father, Mother, and Student mobile numbers from the database
            const { data: stuData } = await db.from('students')
                .select('mobile, father_mobile, mother_mobile')
                .eq('roll_number', roll)
                .single();
            
            if (stuData) {
                // 2. Priority Logic: Use Father's mobile, if empty use Mother's, if empty use Student's
                const targetMobile = stuData.father_mobile || stuData.mother_mobile || stuData.mobile;
                
                if (targetMobile) {
                    const alertArea = document.getElementById('whatsapp-alert-area');
                    const waLink = document.getElementById('absent-wa-link');
                    
                    // Formulate the message to the Parent
                    const msg = encodeURIComponent(`Dear Parent, this is to inform you that your child ${stuName} was ABSENT for class on ${dateValue}. Please ensure their regular attendance. Regards, ClassManager IMS.`);
                    
                    waLink.href = `https://wa.me/91${targetMobile}?text=${msg}`;
                    alertArea.style.display = 'block'; 
                }
            }
        } else {
            document.getElementById('whatsapp-alert-area').style.display = 'none'; 
        }
}

// 2. FETCH STATISTICS (Displaying data in UI)
async function fetchAttendanceByPrompt() {
    // A. Input Verification
    const roll = prompt("Enter Student Roll Number to see statistics:");
    if (!roll) return;

    const monthView = document.getElementById('attn-month-view').value; // YYYY-MM from calendar
    if (!monthView) return alert("Please select a month in the 'View Monthly Record' calendar first.");

    // B. Format the month string to match database (e.g., "March 2026")
    const dateObj = new Date(monthView + "-01");
    const targetMonthYear = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    // C. Query Database for Present Days
    const { count: pCount, error: pErr } = await db.from('attendance')
        .select('*', { count: 'exact', head: true })
        .eq('roll_number', roll)
        .eq('month_year', targetMonthYear)
        .eq('status', 'Present');

    // D. Query Database for Absent Days
    const { count: aCount, error: aErr } = await db.from('attendance')
        .select('*', { count: 'exact', head: true })
        .eq('roll_number', roll)
        .eq('month_year', targetMonthYear)
        .eq('status', 'Absent');

    if (pErr || aErr) return alert("Error fetching stats.");

    // E. Update UI Fields
    document.getElementById('attn-total-p').value = pCount || 0;
    document.getElementById('attn-total-a').value = aCount || 0;
    document.getElementById('attn-roll').value = roll;
    
    // Automatically fetch name so user knows who the stats belong to
    fetchStudentForAttn(); 
    
    alert(`Statistics for ${roll} in ${targetMonthYear} updated successfully!`);
}
/* ==========================================
   7. ADMIN DASHBOARD (Dynamic Counts)
   ========================================== */
/* ==========================================
   DYNAMIC ADMIN DASHBOARD LOGIC
   ========================================== */
// 1. Toggle UI based on Dropdown
function toggleReportUI() {
    const val = document.getElementById('report-selector').value;
    document.getElementById('report-ui-attendance').style.display = (val === 'attendance') ? 'block' : 'none';
    document.getElementById('report-ui-exam').style.display = (val === 'exam') ? 'block' : 'none';
    document.getElementById('report-ui-fee').style.display = (val === 'fee') ? 'block' : 'none';
    document.getElementById('report-ui-t-attendance').style.display = (val === 't-attendance') ? 'block' : 'none'; // ADD THIS LINE
    document.getElementById('report-output-area').style.display = 'none';
}

// 2. Auto-populate name in report
async function populateRepName() {
    const roll = document.getElementById('rep-attn-roll').value.toUpperCase();
    const { data } = await db.from('students').select('full_name').eq('roll_number', roll).eq('institute_id', sessionInstID).maybeSingle();
    if(data) document.getElementById('rep-attn-name').value = data.full_name;
}

// 3. Generate the Report
async function generateAttendanceReport() {
    const roll = document.getElementById('rep-attn-roll').value.toUpperCase();
    const monthInput = document.getElementById('rep-attn-month').value; // YYYY-MM
    const name = document.getElementById('rep-attn-name').value;

    if(!roll || !monthInput) return alert("Please fill Roll Number and Month");

    // Convert YYYY-MM to Month Year (e.g. "February 2026")
    const dateObj = new Date(monthInput + "-01");
    const monthYearStr = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    // Fetch records
    const { data: records, error } = await db.from('attendance')
        .select('attendance_date, status')
        .eq('roll_number', roll)
        .eq('month_year', monthYearStr)
        .eq('institute_id', sessionInstID)
        .order('attendance_date', { ascending: true });

    if(error) return alert(error.message);

    // Build Table
    let tableBody = "";
    let present = 0, absent = 0;
    
    records.forEach(r => {
        const day = new Date(r.attendance_date).getDate();
        tableBody += `<tr><td>${day}</td><td style="color:${r.status==='Present'?'green':'red'}">${r.status}</td></tr>`;
        if(r.status === 'Present') present++; else absent++;
    });

    // Update UI
    document.getElementById('rep-title').innerText = `Attendance Report: ${monthYearStr}`;
    document.getElementById('rep-summary-text').innerHTML = `<b>Student:</b> ${name} | <b>Roll No:</b> ${roll}`;
    document.getElementById('rep-table-head').innerHTML = `<tr><th>Date</th><th>Status</th></tr>`;
    document.getElementById('rep-table-body').innerHTML = tableBody;
    
    document.getElementById('rep-stats-boxes').innerHTML = `
        <div class="stat-card"><b>Total Days</b><h4>${records.length}</h4></div>
        <div class="stat-card" style="border-bottom:5px solid green;"><b>Present</b><h4>${present}</h4></div>
        <div class="stat-card" style="border-bottom:5px solid red;"><b>Absent</b><h4>${absent}</h4></div>
    `;

    document.getElementById('report-output-area').style.display = 'block';

    // Draw Google Chart
    drawAttendanceChart(present, absent);
}

// 4. Google Charts Integration
function drawAttendanceChart(p, a) {
    // No need to load again here
    var data = google.visualization.arrayToDataTable([
        ['Status', 'Days'],
        ['Present', p],
        ['Absent', a]
    ]);

    var dashboard = new google.visualization.Dashboard(document.getElementById('report-output-area'));

    var statusPicker = new google.visualization.ControlWrapper({
        'controlType': 'CategoryFilter',
        'containerId': 'filter_div',
        'options': {
            'filterColumnLabel': 'Status',
            'ui': {'label': 'Filter Status:', 'allowTyping': false, 'allowMultiple': true}
        }
    });

    var barChart = new google.visualization.ChartWrapper({
        'chartType': 'BarChart',
        'containerId': 'chart_div',
        'options': { 'title': 'Attendance Overview', 'colors': ['#27ae60'], 'height': 300, 'legend':'none' }
    });

    dashboard.bind(statusPicker, barChart);
    dashboard.draw(data);
}

// Apply the same logic to drawStaffAttendanceChart
function drawStaffAttendanceChart(p, a) {
    drawAttendanceChart(p, a); // Re-use the same slicer logic
}






async function generateFeeReport() {
    const monthInput = document.getElementById('rep-fee-month').value;
    if (!monthInput) return alert("Please select a Month and Year");

    const dateObj = new Date(monthInput + "-01");
    const monthYearStr = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    // 1. Fetch all students for this institute
    const { data: students, error } = await db.from('students')
        .select('roll_number, full_name, course, total_fees, paid_amount, pending_amount')
        .eq('institute_id', sessionInstID)
        .eq('status', 'Active');

    if (error) return alert("Error fetching data: " + error.message);
    if (students.length === 0) return alert("No active student records found.");

    // 2. Build Table and Calculate Totals
    let tableBody = "";
    let grandTotal = 0, grandPaid = 0, grandPending = 0;

    students.forEach(s => {
        tableBody += `
            <tr>
                <td>${s.roll_number}</td>
                <td>${s.full_name}</td>
                <td>${s.course}</td>
                <td>₹${s.total_fees}</td>
                <td style="color:green;">₹${s.paid_amount}</td>
                <td style="color:red;">₹${s.pending_amount}</td>
            </tr>`;
        grandTotal += Number(s.total_fees);
        grandPaid += Number(s.paid_amount);
        grandPending += Number(s.pending_amount);
    });

    // 3. Update UI
    document.getElementById('rep-title').innerText = `Fee Collection Report: ${monthYearStr}`;
    document.getElementById('rep-summary-text').innerHTML = `<b>Total Students Tracked:</b> ${students.length}`;
    document.getElementById('rep-table-head').innerHTML = `
        <tr>
            <th>Roll No</th>
            <th>Full Name</th>
            <th>Course</th>
            <th>Total Fees</th>
            <th>Paid</th>
            <th>Pending</th>
        </tr>`;
    document.getElementById('rep-table-body').innerHTML = tableBody;

    document.getElementById('rep-stats-boxes').innerHTML = `
        <div class="stat-card"><b>Grand Total</b><h4>₹${grandTotal.toLocaleString()}</h4></div>
        <div class="stat-card" style="border-bottom:5px solid green;"><b>Grand Paid</b><h4>₹${grandPaid.toLocaleString()}</h4></div>
        <div class="stat-card" style="border-bottom:5px solid red;"><b>Grand Pending</b><h4>₹${grandPending.toLocaleString()}</h4></div>
    `;

    document.getElementById('report-output-area').style.display = 'block';

    // 4. Draw Google Chart
    drawFeeCharts(grandPaid, grandPending);
}

function drawFeeCharts(paid, pending) {
    // 1. Prepare Data
    var data = google.visualization.arrayToDataTable([
        ['Type', 'Amount'],
        ['Collected', paid],
        ['Outstanding', pending]
    ]);

    // 2. Define the Dashboard
    var dashboard = new google.visualization.Dashboard(document.getElementById('report-output-area'));

    // 3. Create the Slicer (Filter between Collected vs Outstanding)
    var feePicker = new google.visualization.ControlWrapper({
        'controlType': 'CategoryFilter',
        'containerId': 'filter_div',
        'options': {
            'filterColumnLabel': 'Type',
            'ui': {
                'label': 'Filter Financial Type:',
                'allowTyping': false,
                'allowMultiple': true
            }
        }
    });

    // 4. Create the Horizontal Bar Chart
    var barChart = new google.visualization.ChartWrapper({
        'chartType': 'BarChart',
        'containerId': 'chart_div',
        'options': {
            'title': 'Revenue Overview (Actuals vs Dues)',
            'colors': ['#27ae60'], // Brand Green
            'hAxis': { title: 'Amount in ₹', minValue: 0 },
            'chartArea': { width: '50%' },
            'legend': 'none',
            'height': 300
        }
    });

    // 5. Bind and Draw
    dashboard.bind(feePicker, barChart);
    dashboard.draw(data);
}
// 1. Auto-populate Student & Course info for Exam Report
async function populateExamRepName() {
    const roll = document.getElementById('rep-ex-roll').value.toUpperCase().trim();
    if (roll.length < 4) return;
    const { data } = await db.from('students').select('full_name, course').eq('roll_number', roll).eq('institute_id', sessionInstID).maybeSingle();
    if(data) {
        document.getElementById('rep-ex-name').value = data.full_name;
        document.getElementById('rep-ex-course').value = data.course;
    }
}

// 2. Generate the Detailed Exam Report
async function generateExamReport() {
    const roll = document.getElementById('rep-ex-roll').value.toUpperCase().trim();
    const name = document.getElementById('rep-ex-name').value;
    
    if(!roll || !name) return alert("Please enter a valid Roll Number");

    const { data: records, error } = await db.from('exam')
        .select('*')
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .order('exam_date', { ascending: true });

    if(error) return alert(error.message);
    if(records.length === 0) return alert("No exam records found.");

    // --- SHORTCUT FIX: Show the area FIRST so the graph has space to draw ---
    document.getElementById('report-output-area').style.display = 'block';

    let tableBody = "";
    let totalObtained = 0;
    let totalPossible = 0;

    records.forEach(r => {
        tableBody += `<tr><td>${r.exam_date}</td><td>${r.marks_obtained} / ${r.total_marks}</td><td>${r.percentage}%</td><td style="font-weight:bold;">${r.result}</td></tr>`;
        totalObtained += Number(r.marks_obtained);
        totalPossible += Number(r.total_marks);
    });

    document.getElementById('rep-title').innerText = `Student Performance Report`;
    document.getElementById('rep-summary-text').innerHTML = `<b>Student:</b> ${name} | <b>Roll No:</b> ${roll}`;
    document.getElementById('rep-table-head').innerHTML = `<tr><th>Date</th><th>Score</th><th>%</th><th>Result</th></tr>`;
    document.getElementById('rep-table-body').innerHTML = tableBody;
    
    const avgPct = ((totalObtained / totalPossible) * 100).toFixed(2);
    document.getElementById('rep-stats-boxes').innerHTML = `
        <div class="stat-card"><b>Exams Taken</b><h4>${records.length}</h4></div>
        <div class="stat-card" style="border-bottom:5px solid #1877F2;"><b>Total Marks</b><h4>${totalObtained}</h4></div>
        <div class="stat-card" style="border-bottom:5px solid #f39c12;"><b>Avg Percentage</b><h4>${avgPct}%</h4></div>
    `;

    // Now call the graph
    drawExamTrendChart(records);
}
// 3. Google Chart: Line Chart for Performance Trend
function drawExamTrendChart(records) {
    // Header must be 'Date' and 'Percentage' to stop the "Staff" label
    let dataArr = [['Date', 'Percentage']]; 
    records.forEach(r => dataArr.push([r.exam_date, parseFloat(r.percentage)]));

    var data = google.visualization.arrayToDataTable(dataArr);
    var dashboard = new google.visualization.Dashboard(document.getElementById('report-output-area'));

    var percentageSlider = new google.visualization.ControlWrapper({
        'controlType': 'NumberRangeFilter',
        'containerId': 'filter_div',
        'options': { 'filterColumnLabel': 'Percentage', 'ui': {'label': 'Filter by Score:'} }
    });

    var lineChart = new google.visualization.ChartWrapper({
        'chartType': 'LineChart',
        'containerId': 'chart_div',
        'options': {
            'title': 'Student Academic Progress Trend', // Corrected Title
            'colors': ['#f39c12'], 
            'curveType': 'function',
            'vAxis': { title: 'Percentage (%)', minValue: 0, maxValue: 100 },
            'height': 400,
            'legend': { position: 'bottom' }
        }
    });

    dashboard.bind(percentageSlider, lineChart);
    dashboard.draw(data);
}



// 1. Auto-populate Teacher Name
async function populateTeacherRepName() {
    const tid = document.getElementById('rep-t-id').value.toUpperCase().trim();
    if (tid.length < 4) return;
    const { data } = await db.from('teacher_details')
        .select('teacher_name')
        .eq('id', tid)
        .eq('institute_id', sessionInstID)
        .maybeSingle();
    if(data) document.getElementById('rep-t-name').value = data.teacher_name;
}

// 2. Generate the Staff Attendance Report
async function generateTeacherAttendanceReport() {
    const tid = document.getElementById('rep-t-id').value.toUpperCase().trim();
    const monthInput = document.getElementById('rep-t-month').value;
    const name = document.getElementById('rep-t-name').value;

    if(!tid || !monthInput || !name) return alert("Please enter Teacher ID and select a Month.");

    // Format Month Year string (e.g., "March 2026")
    const dateObj = new Date(monthInput + "-01");
    const monthYearStr = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    // Fetch attendance records
    const { data: records, error } = await db.from('teachers_attendance')
        .select('attendance_date, status')
        .eq('teacher_id', tid)
        .eq('month_year', monthYearStr)
        .eq('institute_id', sessionInstID)
        .order('attendance_date', { ascending: true });

    if(error) return alert("Error: " + error.message);

    // Build the table body and count stats
    let tableBody = "";
    let presentCount = 0;
    let absentCount = 0;

    records.forEach(r => {
        const dayNum = new Date(r.attendance_date).getDate();
        const statusColor = r.status === 'Present' ? 'green' : 'red';
        tableBody += `<tr><td>${dayNum}</td><td style="color:${statusColor}; font-weight:bold;">${r.status}</td></tr>`;
        if(r.status === 'Present') presentCount++; else absentCount++;
    });

    // 3. Update the Output UI
    document.getElementById('rep-title').innerText = `Staff Attendance: ${monthYearStr}`;
    document.getElementById('rep-summary-text').innerHTML = `<b>Teacher:</b> ${name} | <b>ID:</b> ${tid}`;
    document.getElementById('rep-table-head').innerHTML = `<tr><th>Date</th><th>Status</th></tr>`;
    document.getElementById('rep-table-body').innerHTML = tableBody;

    document.getElementById('rep-stats-boxes').innerHTML = `
        <div class="stat-card"><b>Total Records</b><h4>${records.length}</h4></div>
        <div class="stat-card" style="border-bottom:5px solid green;"><b>Present</b><h4>${presentCount}</h4></div>
        <div class="stat-card" style="border-bottom:5px solid red;"><b>Absent</b><h4>${absentCount}</h4></div>
    `;

    document.getElementById('report-output-area').style.display = 'block';

    // 4. Draw Google Chart (Bar chart for summary)
    drawStaffAttendanceChart(presentCount, absentCount);
}

function drawStaffAttendanceChart(p, a) {
    // 1. Prepare Data
    var data = google.visualization.arrayToDataTable([
        ['Status', 'Days'],
        ['Present', p],
        ['Absent', a]
    ]);

    // 2. Define the Dashboard
    var dashboard = new google.visualization.Dashboard(document.getElementById('report-output-area'));

    // 3. Create the Slicer (Status Filter)
    var staffStatusPicker = new google.visualization.ControlWrapper({
        'controlType': 'CategoryFilter',
        'containerId': 'filter_div',
        'options': {
            'filterColumnLabel': 'Status',
            'ui': {
                'label': 'Filter Staff Attendance:',
                'allowTyping': false,
                'allowMultiple': true
            }
        }
    });

    // 4. Create the Pie Chart (Great for Staff Ratios)
    var pieChart = new google.visualization.ChartWrapper({
        'chartType': 'PieChart',
        'containerId': 'chart_div',
        'options': {
            'title': 'Staff Attendance Distribution',
            'colors': ['#2e7d32', '#c62828'], // Deep Green and Red
            'is3D': true,
            'height': 300,
            'chartArea': { width: '90%', height: '80%' }
        }
    });

    // 5. Bind and Draw
    dashboard.bind(staffStatusPicker, pieChart);
    dashboard.draw(data);
}



// 1. Toggle visibility of calendars based on filter type
function toggleAdminCalendar() {
    const type = document.getElementById('admin-filter-type').value;
    document.getElementById('admin-month-container').style.display = type === 'monthly' ? 'block' : 'none';
    document.getElementById('admin-year-container').style.display = (type === 'yearly' || type === 'quarterly') ? 'block' : 'none';
    document.getElementById('admin-quarter-container').style.display = type === 'quarterly' ? 'block' : 'none';
    loadAdminDashboard();
}

// 2. Main Loader Function
async function loadAdminDashboard() {
    const type = document.getElementById('admin-filter-type').value;
    const year = document.getElementById('admin-filter-year').value;
    let startDate, endDate, label;

    // A. Determine Date Range
    if (type === 'monthly') {
        const monthVal = document.getElementById('admin-filter-month').value;
        if(!monthVal) return;
        startDate = `${monthVal}-01`;
        endDate = `${monthVal}-31`;
        label = new Date(startDate).toLocaleString('default', { month: 'short', year: 'numeric' });
    } else if (type === 'yearly') {
        startDate = `${year}-01-01`;
        endDate = `${year}-12-31`;
        label = `Year ${year}`;
    } else if (type === 'quarterly') {
        const q = document.getElementById('admin-filter-quarter').value;
        const qMap = { "1": ["01-01", "03-31"], "2": ["04-01", "06-30"], "3": ["07-01", "09-30"], "4": ["10-01", "12-31"] };
        startDate = `${year}-${qMap[q][0]}`;
        endDate = `${year}-${qMap[q][1]}`;
        label = `Q${q} ${year}`;
    }

    document.querySelectorAll('.filter-label').forEach(el => el.innerText = label);

    // B. Query Total Students (Joined in this period)
    const { count: stuCount } = await db.from('students')
        .select('*', { count: 'exact', head: true })
 .eq('institute_id', sessionInstID)
        .gte('admission_date', startDate)
        .lte('admission_date', endDate);
    document.getElementById('dash-students').innerText = stuCount || 0;

    // C. Query Total Revenue (Payments made in this period)
    const { data: revenueData } = await db.from('payment_history')
        .select('amount')
        .gte('payment_date', startDate)
        .lte('payment_date', endDate);
    const totalRev = revenueData ? revenueData.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0) : 0;
    document.getElementById('dash-revenue').innerText = `₹ ${totalRev.toLocaleString('en-IN')}`;

    // D. Query Pending Fees (From students active in this period)
    const { data: pendingData } = await db.from('students')
        .select('pending_amount')
        .eq('status', 'Active')
        .gte('admission_date', startDate)
        .lte('admission_date', endDate);
    const totalPen = pendingData ? pendingData.reduce((sum, p) => sum + (parseFloat(p.pending_amount) || 0), 0) : 0;
    document.getElementById('dash-pending').innerText = `₹ ${totalPen.toLocaleString('en-IN')}`;

    // E. Query Attendance %
    const { data: attData } = await db.from('attendance')
        .select('status')
        .gte('attendance_date', startDate)
        .lte('attendance_date', endDate);
    
    if (attData && attData.length > 0) {
        const present = attData.filter(a => a.status === 'Present').length;
        const percent = ((present / attData.length) * 100).toFixed(1);
        document.getElementById('dash-attendance').innerText = `${percent}%`;
    } else {
        document.getElementById('dash-attendance').innerText = `0%`;
    }

    // F. Load Current Month Reminders (Auto-populated)
    loadReminders();
}

// 3. Load Fee Reminders for the Current Month
async function loadReminders() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

    const { data: reminders, error } = await db.from('students')
        .select('full_name, roll_number, pending_amount, mobile')
        .eq('status', 'Active')
        .gt('pending_amount', 0);

    const container = document.getElementById('reminder-list');
    if (reminders && reminders.length > 0) {
        let html = '<table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">';
        html += '<tr style="background:#eee; text-align:left;"><th>Student</th><th>Roll No</th><th>Pending</th><th>Action</th></tr>';
        
        reminders.forEach(r => {
            html += `<tr style="border-bottom: 1px solid #ddd;">
                <td style="padding:10px;">${r.full_name}</td>
                <td>${r.roll_number}</td>
                <td style="color:red; font-weight:bold;">₹${r.pending_amount}</td>
                <td><a href="https://wa.me/91${r.mobile}?text=Reminder: Fee pending ₹${r.pending_amount}" target="_blank" style="color:green;"><i class="fab fa-whatsapp"></i> Notify</a></td>
            </tr>`;
        });
        html += '</table>';
        container.innerHTML = html;
    } else {
        container.innerHTML = "<p style='color:gray;'>No pending fees for the current month.</p>";
    }
}

/* ==========================================
   8. FEE REMINDER (SMS/WhatsApp)
   ========================================== */
async function loadFeeReminders() {
    const selectedYear = document.getElementById('remind-year').value || 2026;
    const startDate = `${selectedYear}-01-01`;
    const endDate = `${selectedYear}-12-31`;

    // Update labels in UI
    document.querySelectorAll('.display-year').forEach(el => el.innerText = selectedYear);

    try {
        // Fetch Active students with pending balance admitted in the selected year
        const { data: students, error } = await db
            .from('students')
            .select('full_name, roll_number, mobile, pending_amount')
.eq('institute_id', sessionInstID)
            .eq('status', 'Active')
            .gt('pending_amount', 0)
            .gte('admission_date', startDate)
            .lte('admission_date', endDate);

        if (error) throw error;

        const tableBody = document.getElementById('reminder-table-body');
        let totalPendingAmt = 0;
        let pendingStuCount = 0;

        if (students && students.length > 0) {
            tableBody.innerHTML = ''; // Clear old rows
            pendingStuCount = students.length;

            students.forEach(s => {
                totalPendingAmt += parseFloat(s.pending_amount) || 0;

                // Create WhatsApp Message
                const msg = encodeURIComponent(`Hello ${s.full_name}, this is a reminder regarding your pending fee of ₹${s.pending_amount} for the year ${selectedYear}. Please settle it at the earliest. Thank you.`);
                
                tableBody.innerHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px; font-weight: bold;">${s.roll_number}</td>
                        <td style="padding: 12px;">${s.full_name}</td>
                        <td style="padding: 12px;">${s.mobile}</td>
                        <td style="padding: 12px; color: red; font-weight: bold;">₹ ${parseFloat(s.pending_amount).toLocaleString('en-IN')}</td>
                        <td style="padding: 12px;">
                            <a href="https://wa.me/91${s.mobile}?text=${msg}" target="_blank" 
                               style="background: #25D366; color: white; padding: 6px 12px; border-radius: 5px; text-decoration: none; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px;">
                               <i class="fab fa-whatsapp"></i> Send Reminder
                            </a>
                        </td>
                    </tr>
                `;
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #888;">No active students with pending fees found for this year.</td></tr>';
        }

        // Update Stats
        document.getElementById('remind-total-amt').innerText = `₹ ${totalPendingAmt.toLocaleString('en-IN')}`;
        document.getElementById('remind-stu-count').innerText = pendingStuCount;

    } catch (err) {
        console.error("Reminder Error:", err.message);
    }
}

/* ==========================================
   9. LEAD MANAGEMENT
   ========================================== */
/* ==========================================
   LEAD MANAGEMENT LOGIC (FIXED)
   ========================================== */

function clearLeadForm() {
    ['lead-name','lead-contact','lead-email','lead-course','lead-date','lead-ref','lead-status','lead-remarks'].forEach(id => {
        document.getElementById(id).value = (id === 'lead-status') ? 'Follow up' : '';
    });
}

async function addLead() {
    const leadData = {
 institute_id: sessionInstID,
        full_name: document.getElementById('lead-name').value,
        contact: document.getElementById('lead-contact').value,
        email: document.getElementById('lead-email').value, // NO MORE NULL
        interested_course: document.getElementById('lead-course').value,
        date_of_visit: document.getElementById('lead-date').value,
        reference: document.getElementById('lead-ref').value, // NO MORE NULL
        status: document.getElementById('lead-status').value,
        remarks: document.getElementById('lead-remarks').value
    };

    if (!leadData.full_name || !leadData.contact) {
        return alert("Error: Name and Contact are mandatory.");
    }

    const { error } = await db.from('leads').insert([leadData]);

    if (error) {
        alert("Save Error: " + error.message);
    } else {
        alert("Lead for " + leadData.full_name + " saved successfully!");
        clearLeadForm();
    }
}

async function fetchLead() {
    const contact = prompt("Enter Lead Contact Number:");
    if (!contact) return;

    const { data, error } = await db
        .from('leads')
        .select('*')
        .eq('contact', contact)
 .eq('institute_id', sessionInstID)
        .single();

    if (error || !data) return alert("Lead not found.");

    document.getElementById('lead-name').value = data.full_name;
    document.getElementById('lead-contact').value = data.contact;
    document.getElementById('lead-email').value = data.email || "";
    document.getElementById('lead-course').value = data.interested_course || "";
    document.getElementById('lead-date').value = data.date_of_visit || "";
    document.getElementById('lead-ref').value = data.reference || "";
    document.getElementById('lead-status').value = data.status || "Follow up";
    document.getElementById('lead-remarks').value = data.remarks || "";
    
    alert("Lead details loaded!");
}
/* ==========================================
   10. EXPENSE TRACKING (Add, Edit, Fetch)
   ========================================== */
// Function to calculate totals and profit
/* ==========================================
   EXPENSE LOGIC (MANUAL ENTRY)
   ========================================== */

/* ==========================================
   EXPENSE & INCOME LOGIC (SYNCED)
   ========================================== */

// 1. AUTO-POPULATE Fees from Payment History
// This function is now only for background data if needed, 
// it will no longer try to update the Expenses UI.
async function fetchAutoFees() {
    console.log("Expenses UI is now Expense-only. Skipping auto-fees update.");
    return 0; 
}
// 2. FORMULA CALCULATION
function calculateFinancials() {
    // We only sum the 7 expense types now
    const expenseIds = [
        'exp-rent', 'exp-elec', 'exp-maint', 
        'exp-t-sal', 'exp-a-sal', 'exp-mark', 'exp-other'
    ];
    
    let totalExp = 0;
    expenseIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) totalExp += (parseFloat(el.value) || 0);
    });

    // Update the red display box
    const display = document.getElementById('disp-total-exp');
    if (display) {
        display.innerText = "₹ " + totalExp.toLocaleString('en-IN', {minimumFractionDigits: 2});
    }
}

// 3. SAVE TO SUPABASE
// 1. Corrected Fetch (No longer looks for income)
async function fetchSavedExpense() {
    const monthYear = document.getElementById('exp-month-year').value;
    if (!monthYear) return alert("Select Month & Year to fetch.");

    const { data, error } = await db.from('expenses')
        .select('*')
        .eq('month_year', monthYear)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (data) {
        document.getElementById('exp-rent').value = data.rent || 0;
        document.getElementById('exp-elec').value = data.electricity || 0;
        document.getElementById('exp-maint').value = data.maintenance || 0;
        document.getElementById('exp-t-sal').value = data.teacher_salary || 0;
        document.getElementById('exp-a-sal').value = data.admin_salary || 0;
        document.getElementById('exp-mark').value = data.marketing || 0;
        document.getElementById('exp-other').value = data.other_exp || 0;
        alert("Expense records loaded!");
    } else {
        // Reset to zero if no record found
        ['exp-rent','exp-elec','exp-maint','exp-t-sal','exp-a-sal','exp-mark','exp-other']
        .forEach(id => document.getElementById(id).value = 0);
    }
    calculateFinancials();
}

// 2. Corrected Save (No longer saves income)
async function saveExpenses() {
    const monthYear = document.getElementById('exp-month-year').value;
    if (!monthYear) return alert("Select Month & Year first.");

    const dataObj = {
        institute_id: sessionInstID,
        month_year: monthYear,
        rent: parseFloat(document.getElementById('exp-rent').value) || 0,
        electricity: parseFloat(document.getElementById('exp-elec').value) || 0,
        maintenance: parseFloat(document.getElementById('exp-maint').value) || 0,
        teacher_salary: parseFloat(document.getElementById('exp-t-sal').value) || 0,
        admin_salary: parseFloat(document.getElementById('exp-a-sal').value) || 0,
        marketing: parseFloat(document.getElementById('exp-mark').value) || 0,
        other_exp: parseFloat(document.getElementById('exp-other').value) || 0,
        other_income: 0, // Hardcoded to 0 since we removed it
        auto_fees_collected: 0, // Hardcoded to 0 since we removed it
        total_expenses: parseFloat(document.getElementById('disp-total-exp').innerText.replace(/[₹, ]/g, '')) || 0
    };

    const { error } = await db.from('expenses').upsert(dataObj, { onConflict: 'institute_id, month_year' });
    if (error) alert("Save Error: " + error.message);
    else alert("Expense record saved!");
}
function clearExpenseForm() {
    const inputs = ['exp-rent','exp-elec','exp-maint','exp-t-sal','exp-a-sal','exp-mark','exp-other','exp-income'];
    inputs.forEach(id => document.getElementById(id).value = 0);
    calculateFinancials();
}


/* ==========================================
   11. TEACHER PORTAL (Admin Side)
   ========================================== */
function generateTchID() {
    const random = Math.floor(1000 + Math.random() * 9000);
    const id = "TCH-" + random;
    const field = document.getElementById('tch-id');
    if (field) {
        field.value = id;
        console.log("Teacher ID Created: " + id);
    } else {
        alert("System Error: 'tch-id' input not found in HTML!");
    }
}

/* ==========================================
   COMPLETE FEE PORTAL LOGIC
   ========================================== */
async function loadFeesPortal() {
    console.log("Syncing Fees Portal Statistics...");

    try {
        // 1. FETCH DATA FROM STUDENTS TABLE (Active Students Only)
        // We fetch paid_amount and pending_amount for the totals
        const { data: students, error: stuError } = await db
            .from('students')
            .select('paid_amount, pending_amount')
            .eq('status', 'Active');

        if (stuError) throw stuError;

        if (students) {
            const activeCount = students.length;
            const totalReceived = students.reduce((sum, s) => sum + (parseFloat(s.paid_amount) || 0), 0);
            const totalPending = students.reduce((sum, s) => sum + (parseFloat(s.pending_amount) || 0), 0);

            // Update UI Counters
            const elCount = document.getElementById('stat-active-count');
            const elRec = document.getElementById('stat-total-received');
            const elPen = document.getElementById('stat-total-pending');

            if (elCount) elCount.innerText = activeCount;
            if (elRec) elRec.innerText = "₹ " + totalReceived.toLocaleString('en-IN');
            if (elPen) elPen.innerText = "₹ " + totalPending.toLocaleString('en-IN');
        }

        // 2. FETCH DATA FROM PAYMENT HISTORY (Yearly Collection Stats)
        // Get the year from the UI input
        const yearInput = document.getElementById('portal-year');
        const selectedYear = yearInput ? yearInput.value : new Date().getFullYear();

        // Calculate start and end of the year for the database query
        const startDate = `${selectedYear}-01-01`;
        const endDate = `${selectedYear}-12-31`;

        const { data: history, error: histError } = await db
            .from('payment_history')
            .select('amount')
            .gte('payment_date', startDate)
            .lte('payment_date', endDate);

        if (histError) throw histError;

        const yearlySum = history ? history.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0) : 0;

        // Update Yearly UI
        const elYearly = document.getElementById('stat-yearly');
        const elLabel = document.getElementById('yearly-label');

        if (elYearly) elYearly.innerText = "₹ " + yearlySum.toLocaleString('en-IN');
        if (elLabel) elLabel.innerText = selectedYear + " Total Collection";

    } catch (err) {
        console.error("Fee Portal Refresh Failed:", err.message);
    }
}
// 2. Clear Form
function clearTeacherForm() {
   const ids = ['tch-id','tch-name','tch-age','tch-gender','tch-join','tch-qual','tch-subject','tch-salary','tch-gender','tch-email','tch-address','tch-exp','tch-status','tch-rating','tch-mobile'];
    ids.forEach(id => {
        let el = document.getElementById(id);
        if (el) el.value = "";
    });
    let statusEl = document.getElementById('tch-status');
    if (statusEl) statusEl.value = "Active";
}

document.getElementById('tch-availability').value = "No";
    toggleTeacherTimeSlots();
    setTeacherTimeSlots("");

// 3. ADD TEACHER
// 1. UPDATED: ADD TEACHER (Now includes Mobile)
async function addTeacherDetails() {
    const id = document.getElementById('tch-id').value;
    const name = document.getElementById('tch-name').value;
    const mobile = document.getElementById('tch-mobile').value;




    if (!id || !name || !mobile) return alert("Error: ID, Name, and Mobile are mandatory.");


// --- START OF NEW TEACHER VALIDATIONS ---
    const tchNameVal = document.getElementById('tch-name').value.trim();
    const tchAgeVal = parseInt(document.getElementById('tch-age').value) || 0;
    const tchSalaryVal = parseFloat(document.getElementById('tch-salary').value) || 0;
    const tchEmailVal = document.getElementById('tch-email').value.trim();
    const tchAddressVal = document.getElementById('tch-address').value.trim();
    const tchRatingVal = parseFloat(document.getElementById('tch-rating').value) || 0;
    const tchMobileVal = document.getElementById('tch-mobile').value.trim();

    // 1. Full name validation (Must have at least 2 words, second word >= 2 letters)
    const tchNameWords = tchNameVal.split(/\s+/).filter(w => w.length > 0);
    if (tchNameWords.length < 2 || tchNameWords[1].length < 2) {
        return alert("Error: Please enter the Teacher's Full Name. The second word (Surname) must be at least 2 letters long.");
    }

    // 2. Age cannot be 0 or negative
    if (tchAgeVal <= 0) {
        return alert("Error: Age cannot be 0 or negative.");
    }

    // 3. Salary cannot be 0 or negative
    if (tchSalaryVal <= 0) {
        return alert("Error: Salary cannot be 0 or negative.");
    }

    // 4. Email has to have @ symbol
    if (!tchEmailVal || !tchEmailVal.includes('@')) {
        return alert("Error: Please enter a valid Email address containing the '@' symbol.");
    }

    // 5 & 6. Full address provided, minimum 15 chars, and contains numeric values
    if (!tchAddressVal) {
        return alert("Error: Full Address must be provided.");
    }
    if (tchAddressVal.length < 15 || !/\d/.test(tchAddressVal)) {
        return alert("Error: Full Address must be at least 15 characters long and include numeric values (e.g., House Number, Pincode).");
    }

    // 7. Rating cannot be more than 5
    if (tchRatingVal > 5) {
        return alert("Error: Rating cannot be more than 5.");
    }

    // 8. WhatsApp mobile number should be exactly 10 digits
    if (!/^\d{10}$/.test(tchMobileVal)) {
        return alert("Error: WhatsApp Mobile Number must be exactly 10 digits long.");
    }
    // --- END OF NEW TEACHER VALIDATIONS ---





    const { error } = await db.from('teacher_details').insert([{
        institute_id: sessionInstID,
        id: id,
        teacher_name: name,
        mobile: mobile, // New Column
        age: parseInt(document.getElementById('tch-age').value) || 0,
        joining_date: document.getElementById('tch-join').value,
        qualification: document.getElementById('tch-qual').value,
        subject_taught: document.getElementById('tch-subject').value,
        salary_offered: parseFloat(document.getElementById('tch-salary').value) || 0,
gender: document.getElementById('tch-gender').value,
        email: document.getElementById('tch-email').value,
        full_address: document.getElementById('tch-address').value,
        experience: parseFloat(document.getElementById('tch-exp').value) || 0,
        rating: parseFloat(document.getElementById('tch-rating').value) || 0,
availability: document.getElementById('tch-availability').value,
        status: document.getElementById('tch-status').value || "Active",
time_of_slot: (document.getElementById('tch-availability').value === 'Yes') ? getSelectedTeacherTimeSlots() : ""
    }]);

    if (error) alert("DB Error: " + error.message);
    else alert("Teacher Saved Successfully!");
}

// 2. UPDATED: FETCH TEACHER (Now includes Mobile)
async function fetchTeacher() {
    const id = prompt("Enter Teacher ID to fetch:");
    if (!id) return;

    const { data, error } = await db.from('teacher_details')
        .select('*')
        .eq('id', id.toUpperCase())
        .eq('institute_id', sessionInstID)
        .single();

    if (error || !data) return alert("Error: Teacher not found.");

    // Populate UI
    document.getElementById('tch-id').value = data.id;
    document.getElementById('tch-name').value = data.teacher_name;
    document.getElementById('tch-mobile').value = data.mobile || ""; // New Field
    document.getElementById('tch-age').value = data.age;
    document.getElementById('tch-join').value = data.joining_date;
    document.getElementById('tch-qual').value = data.qualification;
    document.getElementById('tch-subject').value = data.subject_taught;
    document.getElementById('tch-salary').value = data.salary_offered;
document.getElementById('tch-gender').value = data.gender || "";
    document.getElementById('tch-email').value = data.email || "";
    document.getElementById('tch-address').value = data.full_address || "";
    document.getElementById('tch-exp').value = data.experience || "";
    document.getElementById('tch-rating').value = data.rating || "";
    document.getElementById('tch-status').value = data.status || "Active";
document.getElementById('tch-availability').value = data.availability || "No";
    toggleTeacherTimeSlots();
    setTeacherTimeSlots(data.time_of_slot);

    alert("Details Loaded for " + data.teacher_name);
}

// 5. EDIT TEACHER
async function editTeacher() {
    const id = document.getElementById('tch-id').value;
    if (!id) return alert("Error: Fetch a teacher first using FETCH button.");







// --- START OF NEW VALIDATIONS TO ADD ---
    const vName = document.getElementById('tch-name').value.trim();
    const vAge = parseInt(document.getElementById('tch-age').value) || 0;
    const vSalary = parseFloat(document.getElementById('tch-salary').value) || 0;
    const vEmail = document.getElementById('tch-email').value.trim();
    const vAddress = document.getElementById('tch-address').value.trim();
    const vRating = parseFloat(document.getElementById('tch-rating').value) || 0;
    const vMobile = document.getElementById('tch-mobile').value.trim();

    // 1. Full name: Second word should have 2 or more letters
    const nameWords = vName.split(/\s+/).filter(w => w.length > 0);
    if (nameWords.length < 2 || nameWords[1].length < 2) {
        return alert("Error: Teacher's Name must include a surname (second word) with at least 2 letters.");
    }

    // 2. Age cannot be 0 or negative
    if (vAge <= 0) return alert("Error: Age cannot be 0 or negative.");

    // 3. Salary cannot be 0 or negative
    if (vSalary <= 0) return alert("Error: Salary cannot be 0 or negative.");

    // 4. Email has to have @ symbol
    if (!vEmail.includes('@')) return alert("Error: Email must contain an '@' symbol.");

    // 5 & 6. Address: Must be provided, >= 15 chars, and contain numbers
    if (!vAddress) return alert("Error: Full address must be provided.");
    if (vAddress.length < 15 || !/\d/.test(vAddress)) {
        return alert("Error: Address must be at least 15 characters long and contain numeric values.");
    }

    // 7. Rating cannot be more than 5
    if (vRating > 5) return alert("Error: Rating cannot be more than 5.");

    // 8. Mobile no should be 10 digits long
    if (!/^\d{10}$/.test(vMobile)) return alert("Error: WhatsApp Mobile Number must be exactly 10 digits long.");
    // --- END OF NEW VALIDATIONS TO ADD ---











    const tchData = {
        teacher_name: document.getElementById('tch-name').value,
        age: parseInt(document.getElementById('tch-age').value) || 0,
        gender: document.getElementById('tch-gender').value,
        joining_date: document.getElementById('tch-join').value,
        qualification: document.getElementById('tch-qual').value,
        subject_taught: document.getElementById('tch-subject').value,
        salary_offered: parseFloat(document.getElementById('tch-salary').value) || 0,
mobile: document.getElementById('tch-mobile').value,
        gender: document.getElementById('tch-gender').value,
        email: document.getElementById('tch-email').value,
        full_address: document.getElementById('tch-address').value,
        experience: parseFloat(document.getElementById('tch-exp').value) || 0,
        rating: parseFloat(document.getElementById('tch-rating').value) || 0,
        status: document.getElementById('tch-status').value || "Active",
availability: document.getElementById('tch-availability').value, // <-- ADD THIS
        time_of_slot: (document.getElementById('tch-availability').value === 'Yes') ? getSelectedTeacherTimeSlots() : "" 
    };

    const { error } = await db.from('teacher_details').update(tchData).eq('id', id);

    if (error) alert("Update Error: " + error.message);
    else alert("Success! Teacher details updated.");
}









// Helper functions for Availability
document.addEventListener('DOMContentLoaded', () => {
    const tmrw = new Date();
    tmrw.setDate(tmrw.getDate() + 1);
    const labelEl = document.getElementById('tch-tomorrow-date');
    if(labelEl) labelEl.innerText = "For " + tmrw.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
});

function toggleTeacherTimeSlots() {
    const avail = document.getElementById('tch-availability').value;
    document.getElementById('tch-timeslots-container').style.display = (avail === 'Yes') ? 'block' : 'none';
}

function getSelectedTeacherTimeSlots() {
    const checkboxes = document.querySelectorAll('#tch-time-checkboxes input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value).join(', ');
}

function setTeacherTimeSlots(slotsStr) {
    const checkboxes = document.querySelectorAll('#tch-time-checkboxes input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false); // clear all
    if (!slotsStr) return;
    const slotsArr = slotsStr.split(',').map(s => s.trim());
    checkboxes.forEach(cb => {
        if (slotsArr.includes(cb.value)) cb.checked = true;
    });
}





/* ==========================================
   12. STUDENT PORTAL (View Only)
   ========================================== */
/* ==========================================
   STUDENT PORTAL DATA SYNC
   ========================================== */
async function fetchStudentPortalData() {
    const roll = document.getElementById('portal-roll-input').value.trim();
    const monthVal = document.getElementById('portal-month-input').value;

    if (!roll || !monthVal) {
        return alert("Please enter Roll Number and select a Month.");
    }

    // Convert YYYY-MM to "Month Year" for attendance query
    const dateObj = new Date(monthVal + "-01");
    const targetMonthYear = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    try {
        // 1. Fetch Student & Fee Data
        const { data: student, error: stuErr } = await db
            .from('students')
            .select('*')
            .eq('roll_number', roll)
            .single();

        if (stuErr || !student) throw new Error("Student Roll Number not found.");

if (monthVal < student.admission_date.substring(0, 7)) return alert("NOT AVAILABLE: Selected month is before the student's date of joining.");

        // 2. Fetch Attendance Data for the selected month
        const { data: attendance } = await db
            .from('attendance')
            .select('status')
            .eq('roll_number', roll)
            .eq('month_year', targetMonthYear);

        const presentDays = attendance ? attendance.filter(a => a.status === 'Present').length : 0;
        const absentDays = attendance ? attendance.filter(a => a.status === 'Absent').length : 0;

        // 3. Fetch Performance Data (Exams)
        const { data: performance } = await db
            .from('performance_tracking')
            .select('*')
            .eq('student_id', student.id)
            .single();

        // 4. Update UI
        document.getElementById('portal-display-area').style.display = 'block';
        
        // Basic Info
        document.getElementById('p-name').innerText = student.full_name;
        document.getElementById('p-course').innerText = student.course || "N/A";
        document.getElementById('p-join').innerText = student.admission_date;
        
        // Fee Info
        document.getElementById('p-paid').innerText = "₹ " + (student.paid_amount || 0).toLocaleString('en-IN');
        document.getElementById('p-pending').innerText = "₹ " + (student.pending_amount || 0).toLocaleString('en-IN');
        
        // Attendance Info
        document.getElementById('p-present').innerText = presentDays;
        document.getElementById('p-absent').innerText = absentDays;

if(student.course) fetchStudentMessages(student.course); 

        // Performance & Teacher Info
        if (performance) {
            const marks = parseFloat(performance.total_marks_secured) || 0;
            const exams = parseInt(performance.total_exams) || 0;
            const percent = exams > 0 ? ((marks / (exams * 100)) * 100).toFixed(1) : 0;

            document.getElementById('p-teacher').innerText = performance.teacher_name || "N/A";
            document.getElementById('p-total-score').innerText = marks;
            document.getElementById('p-exam-count').innerText = exams;
            document.getElementById('p-percent').innerText = percent + "%";
        } else {
            document.getElementById('p-teacher').innerText = "Not Assigned";
            document.getElementById('p-total-score').innerText = "0";
            document.getElementById('p-exam-count').innerText = "0";
            document.getElementById('p-percent').innerText = "0%";
        }

    } catch (err) {
        alert(err.message);
        document.getElementById('portal-display-area').style.display = 'none';
    }
}
/* ==========================================
   13. GENERATORS (ID Card & Certificate)
   ========================================== */
/* ==========================================
   ID CARD GENERATION LOGIC
   ========================================== */
async function generateIDCard() {
    const mobile = document.getElementById('id-fetch-mobile').value.trim();
    const photoInput = document.getElementById('id-photo-input');
    
    if(!mobile) return alert("Please enter a mobile number");

    // 1. Handle Photo Preview First
    const photoDisplay = document.getElementById('card-photo-display');
    const placeholder = document.getElementById('card-photo-placeholder');
    
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            photoDisplay.src = e.target.result;
            photoDisplay.style.display = 'block';
            placeholder.style.display = 'none';
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        // Reset to placeholder if no file selected
        photoDisplay.style.display = 'none';
        placeholder.style.display = 'block';
    }

    // 2. Fetch Student Data from Supabase
    const { data: student, error: stuErr } = await db
        .from('students')
        .select('*')
        .eq('mobile', mobile)
        .single();

    if (stuErr || !student) return alert("Student not found with this mobile number.");

    // 3. Fetch Roll Number and End Date from Details
    const { data: detail } = await db
        .from('student_details')
        .select('*')
        .eq('student_id', student.id)
        .single();

    // 4. Update the Visual Card UI
    document.getElementById('card-student-name').innerText = student.full_name;
    document.getElementById('card-course').innerText = student.course || "N/A";
    document.getElementById('card-batch').innerText = student.batch_time || "N/A";
    document.getElementById('card-start').innerText = student.admission_date || "N/A";
    
    // Data from details table
    document.getElementById('card-roll').innerText = detail ? detail.roll_number : "PENDING";
    document.getElementById('card-end').innerText = detail ? detail.course_end_date : "N/A";

    // 5. Show the Preview Area and Print Button
    document.getElementById('id-card-preview-area').style.display = 'flex';
    document.getElementById('id-print-btn').style.display = 'block';
    
    console.log("ID Card Generated for: " + student.full_name);
}

/* ==========================================
   CERTIFICATE GENERATION LOGIC
   ========================================== */
async function generateCertificate() {
    const mobile = document.getElementById('cert-fetch-mobile').value;
    if(!mobile) return alert("Please enter mobile number");

    // 1. Fetch Student Data
    const { data: student, error: err1 } = await db.from('students').select('*').eq('mobile', mobile).single();
    if (err1 || !student) return alert("Student not found.");

    // 2. Fetch Extended Details (Roll No & End Date)
    const { data: details } = await db.from('student_details').select('*').eq('student_id', student.id).single();
    if (!details) return alert("ID card details not found. Please save student management details first.");

    // 3. Fetch Institute Settings
    const { data: settings } = await db.from('institute_settings').select('*').limit(1).single();

    // 4. Generate or Fetch unique Certificate Number
    let certNo;
    const { data: existingCert } = await db.from('certificates').select('cert_number').eq('student_id', student.id).single();
    
    if (existingCert) {
        certNo = existingCert.cert_number;
    } else {
        const randomID = Math.floor(1000 + Math.random() * 9000);
        certNo = `IMS/CERT/${new Date().getFullYear()}/${randomID}`;
        // Save it so it never changes for this student
        await db.from('certificates').insert([{
 institute_id: sessionInstID, student_id: student.id, cert_number: certNo }]);
    }

    // 5. Populate Template
    document.getElementById('cert-name').innerText = student.full_name;
    document.getElementById('cert-roll').innerText = details.roll_number;
    document.getElementById('cert-number').innerText = certNo;
    document.getElementById('cert-course').innerText = student.course;
    
    // Duration Logic
    const duration = `${student.admission_date} to ${details.course_end_date || 'Ongoing'}`;
    document.getElementById('cert-duration').innerText = duration;
    
    document.getElementById('cert-inst-branch').innerText = settings.branch_name;
    document.getElementById('cert-signatory').innerText = settings.authorised_signatory;

    // 6. Show Preview
    document.getElementById('cert-preview-area').style.display = 'flex';
    document.getElementById('cert-print-btn').style.display = 'block';
}

function printCertificate() {
    const content = document.getElementById('certificate-visual').outerHTML;
    const win = window.open('', '_blank', 'width=1000,height=800');
    win.document.write(`
        <html>
            <head>
                <title>IMS Certificate</title>
                <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
                <style>
                    body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
                    @media print { @page { size: landscape; margin: 0; } }
                </style>
            </head>
            <body onload="window.print(); window.close();">${content}</body>
        </html>
    `);
    win.document.close();
}

/* ==========================================
   14. PERFORMANCE TRACKING
   ========================================== */
/* ==========================================
   PERFORMANCE TRACKING LOGIC
   ========================================== */

// 1. Calculate Average Score Formula
function calculateAvgScore() {
    const marks = parseFloat(document.getElementById('perf-marks').value) || 0;
    const exams = parseInt(document.getElementById('perf-exam-count').value) || 0;
    
    if (exams > 0) {
        // Formula: (Marks / (Exams * 100)) * 100 -> Simplified: Marks / Exams
        const avg = (marks / exams).toFixed(2);
        document.getElementById('perf-avg-display').value = avg + "%";
    } else {
        document.getElementById('perf-avg-display').value = "0%";
    }
}

// 2. Fetch and Calculate All Data
async function fetchPerformanceData() {
    const mobile = document.getElementById('perf-fetch-mobile').value.trim();
    if (!mobile) return alert("Please enter Mobile Number");

    try {
        // 1. GET STUDENT + ROLL NO (From Students Table)
        const { data: student, error: sErr } = await db.from('students').select('*')
            .eq('mobile', mobile).eq('institute_id', sessionInstID).maybeSingle();
        
        if (!student) return alert("Student not found in your institute.");
        const roll = student.roll_number;

        // 2. GET DURATION (From Student_Details Table)
        const { data: details } = await db.from('student_details').select('course_end_date')
            .eq('roll_number', roll).eq('institute_id', sessionInstID).maybeSingle();

        // 3. GET TEACHER NAME (From Batches Table by matching Batch Time)
        const { data: batch } = await db.from('batches').select('teacher_name')
            .eq('batch_time', student.batch_time).eq('institute_id', sessionInstID).maybeSingle();

        // 4. GET EXAMS & CALCULATE ACCURATE PERCENTAGE (Raw Math)
        const { data: exams } = await db.from('exam').select('marks_obtained, total_marks')
            .eq('roll_number', roll).eq('institute_id', sessionInstID);

        let totalObt = 0, totalPoss = 0, count = 0;
        if (exams && exams.length > 0) {
            count = exams.length;
            exams.forEach(e => {
                totalObt += parseFloat(e.marks_obtained || 0);
                totalPoss += parseFloat(e.total_marks || 0);
            });
        }

        // 5. GET ATTENDANCE (This Month)
        const monthYear = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
        const { data: att } = await db.from('attendance').select('status')
            .eq('roll_number', roll).eq('month_year', monthYear).eq('institute_id', sessionInstID);

        let abs = att?.filter(a => a.status === 'Absent').length || 0;
        let pct = att?.length > 0 ? (((att.length - abs) / att.length) * 100).toFixed(1) : "100";

        // 6. POPULATE UI WITH FULL DATA
        document.getElementById('perf-name').value = student.full_name;
        document.getElementById('perf-roll').value = roll;
        document.getElementById('perf-course').value = student.course;
        document.getElementById('perf-joining').value = student.admission_date;
        
        // Fix for Duration: Show joining to end date
        document.getElementById('perf-duration').value = details?.course_end_date ? `${student.admission_date} to ${details.course_end_date}` : "Ongoing";
        
        // Fix for Teacher: Use data from Batches table
        document.getElementById('perf-teacher').value = batch?.teacher_name || "Not Assigned in Batches";
        
        document.getElementById('perf-absent').innerText = abs;
        document.getElementById('perf-attendance-pct').innerText = pct + "%";
        document.getElementById('perf-marks').value = totalObt;
        document.getElementById('perf-exam-count').value = count;
        
        // Final Math Fix: (Total Obtained / Total Possible) * 100
        const finalAvg = totalPoss > 0 ? ((totalObt / totalPoss) * 100).toFixed(2) : "0.00";
        document.getElementById('perf-avg-display').value = finalAvg + "%";

        document.getElementById('performance-report-area').style.display = 'block';

    } catch (err) { alert("System Error: " + err.message); }
}
// 3. Save performance to database
async function savePerformanceData() {
    const roll = document.getElementById('perf-roll').value;
    if (!roll) return alert("Please fetch a student first.");

    const updateData = {
        institute_id: sessionInstID,
        roll_number: roll,
        total_marks_secured: parseFloat(document.getElementById('perf-marks').value) || 0,
        total_exams: parseInt(document.getElementById('perf-exam-count').value) || 0,
        teacher_name: document.getElementById('perf-teacher').value,
        updated_at: new Date().toISOString()
    };

    // This uses the 'onConflict' rule we set in SQL in Part 1
    const { error } = await db
        .from('performance_tracking')
        .upsert(updateData, { onConflict: 'roll_number, institute_id' });

    if (error) alert("Save Error: " + error.message);
    else alert("Performance summary updated successfully!");
}

/* ==========================================
   EXAM MODULE LOGIC
   ========================================== */

async function fetchStudentForExam() {
    const roll = document.getElementById('ex-roll').value.trim().toUpperCase();
    if(!roll) return alert("Enter Roll Number");
    const { data } = await db.from('students').select('full_name, course').eq('roll_number', roll).eq('institute_id', sessionInstID).maybeSingle();
    if(data) {
        document.getElementById('ex-name').value = data.full_name;
        document.getElementById('ex-course').value = data.course;
    } else alert("Student not found in your institute.");
}

function calcExamResult() {
    const total = parseFloat(document.getElementById('ex-total').value) || 0;
    const obt = parseFloat(document.getElementById('ex-obt').value) || 0;
    
    if (total > 0) {
        const pctValue = (obt / total) * 100;
        document.getElementById('ex-pct').value = pctValue.toFixed(2); // Store as number for DB
        
        let res = "";
        if (pctValue >= 85) res = "Distinction";
        else if (pctValue >= 75) res = "A Grade";
        else if (pctValue >= 60) res = "B Grade";
        else if (pctValue >= 40) res = "C Grade";
        else res = "Failed";
        
        document.getElementById('ex-res').value = res;
    }
}


async function addExamRecord() {
const { data: att } = await db.from('attendance').select('status').eq('roll_number', document.getElementById('ex-roll').value.toUpperCase()).eq('attendance_date', document.getElementById('ex-date').value).eq('institute_id', sessionInstID).maybeSingle(); if (att?.status === 'Absent') return alert("ENTRY BLOCKED: Student was marked ABSENT in attendance on this date!");
    if(!sessionInstID) return alert("Login required");
    
    const record = {
        institute_id: sessionInstID,
        exam_date: document.getElementById('ex-date').value,
        roll_number: document.getElementById('ex-roll').value.toUpperCase(),
        full_name: document.getElementById('ex-name').value,
        course_name: document.getElementById('ex-course').value,
        total_marks: parseFloat(document.getElementById('ex-total').value),
        marks_obtained: parseFloat(document.getElementById('ex-obt').value),
        percentage: parseFloat(document.getElementById('ex-pct').value), // Numerical
        result: document.getElementById('ex-res').value
    };

    if(!record.exam_date || !record.roll_number) return alert("Please fill Date and Roll Number");

    const { error } = await db.from('exam').insert([record]);
    if(error) alert("Error: " + error.message); 
    else alert("Exam Result Saved Successfully!");
}


async function fetchExamByRoll() {
    const roll = prompt("Enter Roll Number to see last exam:");
    const { data, error } = await db.from('exam').select('*').eq('roll_number', roll.toUpperCase()).eq('institute_id', sessionInstID).order('exam_date', {ascending: false}).limit(1).maybeSingle();
    if(data) {
        document.getElementById('ex-date').value = data.exam_date;
        document.getElementById('ex-roll').value = data.roll_number;
        document.getElementById('ex-name').value = data.full_name;
        document.getElementById('ex-course').value = data.course_name;
        document.getElementById('ex-total').value = data.total_marks;
        document.getElementById('ex-obt').value = data.marks_obtained;
        calcExamResult();
    } else alert("No exam records found.");
}

/* ==========================================
   TEACHER ATTENDANCE LOGIC
   ========================================== */

async function fetchTeacherForTAttn() {
    const tid = document.getElementById('t-attn-id').value.trim().toUpperCase();
    const { data } = await db.from('teacher_details').select('teacher_name').eq('id', tid).eq('institute_id', sessionInstID).maybeSingle();
    if(data) document.getElementById('t-attn-name').value = data.teacher_name;
    else alert("Teacher ID not found.");
}

function triggerTAttn(status) {
    const name = document.getElementById('t-attn-name').value;
    const tid = document.getElementById('t-attn-id').value.trim().toUpperCase();
    
    if(!name || !tid) return alert("Please Fetch a Teacher first!");

    const picker = document.getElementById('t-date-picker');
    
    // 1. CRITICAL FIX: Reset the picker value so 'onchange' fires every time
    picker.value = ""; 

    // 2. Define what happens when the date is picked
    picker.onchange = async function() {
        if(!this.value) return;
        
        const selectedDate = this.value;
        const monthYearStr = new Date(selectedDate).toLocaleString('default', { month: 'long', year: 'numeric' });

        const { error } = await db.from('teachers_attendance').insert([{
            institute_id: sessionInstID,
            teacher_id: tid,
            full_name: name,
            attendance_date: selectedDate,
            status: status,
            month_year: monthYearStr
        }]);

        if(error) {
            alert("Database Error: " + error.message);
        } else {
            // This message will now pop up every single time
            alert(`SUCCESS: ${name} marked ${status} for ${selectedDate}`);
            document.getElementById('t-attn-status').value = status;
        }
        
        // Cleanup the listener to prevent memory leaks
        this.onchange = null; 
    };

    // 3. Open the calendar
    picker.showPicker();
}

async function fetchTeacherHistory() {
    const tid = document.getElementById('t-attn-id').value.toUpperCase();
    const month = document.getElementById('t-attn-month').value; // YYYY-MM
    if(!tid || !month) return alert("Select Teacher ID and Month");
    const monthYear = new Date(month + "-01").toLocaleString('default', { month: 'long', year: 'numeric' });
    
    const { count } = await db.from('teachers_attendance')
        .select('*', { count: 'exact', head: true })
        .eq('teacher_id', tid).eq('month_year', monthYear).eq('status', 'Present');
    
    alert(`Teacher ${tid} was Present for ${count} days in ${monthYear}`);
}

// 1. Fetch Teacher Info
async function fetchTeacherForAlloc() {
    const tid = document.getElementById('alloc-tid').value.toUpperCase();
    const { data } = await db.from('teacher_details').select('teacher_name').eq('id', tid).eq('institute_id', sessionInstID).maybeSingle();
    if(data) document.getElementById('alloc-tname').value = data.teacher_name;
    else alert("Teacher not found.");
}

// 2. Fetch Student Info
async function fetchStudentForAlloc() {
    const roll = document.getElementById('alloc-roll').value.toUpperCase();
    
    // We now select both 'full_name' AND 'course'
    const { data } = await db.from('students')
        .select('full_name, course')
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if(data) {
        document.getElementById('alloc-sname').value = data.full_name;
        // Autopopulate Subject with the Course name
        document.getElementById('alloc-subject').value = data.course || "N/A";
    } else {
        alert("Student not found.");
    }
}

// 3. Save the Relationship
async function saveAllocation() {
    const data = {
        institute_id: sessionInstID,
        teacher_id: document.getElementById('alloc-tid').value.toUpperCase(),
        teacher_name: document.getElementById('alloc-tname').value,
        roll_number: document.getElementById('alloc-roll').value.toUpperCase(),
        student_name: document.getElementById('alloc-sname').value,
        subject: document.getElementById('alloc-subject').value
    };
    if(!data.teacher_id || !data.roll_number) return alert("Please select both Teacher and Student.");
    
    const { error } = await db.from('student_allocations').insert([data]);
    if(error) alert(error.message); else alert("Link Created Successfully!");
}

// 4. View all students assigned to a specific teacher
async function viewTeacherStudents() {
    const tid = document.getElementById('alloc-tid').value.toUpperCase();
    const { data, error } = await db.from('student_allocations').select('student_name, subject').eq('teacher_id', tid).eq('institute_id', sessionInstID);
    
    const listArea = document.getElementById('allocation-list-area');
    const listUl = document.getElementById('alloc-list');
    
    if(data && data.length > 0) {
        listUl.innerHTML = data.map(item => `<li>${item.student_name} (${item.subject})</li>`).join('');
        listArea.style.display = 'block';
    } else {
        alert("No students allocated to this teacher yet.");
        listArea.style.display = 'none';
    }
}


// 1. Save Event (For Owners)
async function saveCalendarEvent() {
    const data = {
        institute_id: sessionInstID,
        event_date: document.getElementById('cal-date').value,
        event_name: document.getElementById('cal-name').value,
        event_type: document.getElementById('cal-type').value,
        description: document.getElementById('cal-desc').value
    };

    if (!data.event_date || !data.event_name) return alert("Date and Name are required!");

    const { error } = await db.from('institute_calendar').insert([data]);
    if (error) alert(error.message);
    else {
        alert("Event Added!");
        loadCalendar();
        document.getElementById('cal-name').value = "";
        document.getElementById('cal-desc').value = "";
    }
}

// 2. Load Events (For Everyone)
async function loadCalendar() {
    const listDiv = document.getElementById('calendar-list');
    const today = new Date().toISOString().split('T')[0];

    const { data, error } = await db.from('institute_calendar')
        .select('*')
        .eq('institute_id', sessionInstID)
        .gte('event_date', today)
        .order('event_date', { ascending: true });

    if (data && data.length > 0) {
        listDiv.innerHTML = data.map(item => `
            <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="background: #000; color: #fff; padding: 10px; border-radius: 8px; text-align: center; min-width: 80px;">
                        <small>${new Date(item.event_date).toLocaleString('default', { month: 'short' })}</small>
                        <h2 style="margin:0; color: #7FFFD4 !important; text-decoration: none !important;">${new Date(item.event_date).getDate()}</h2>
                    </div>
                    <div>
                        <b style="font-size: 1.1rem;">${item.event_name}</b> 
                        <span style="font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: ${item.event_type === 'Holiday' ? '#ffcccc' : '#ccffea'}; color: #000; margin-left: 10px;">${item.event_type}</span>
                        <p style="margin: 5px 0 0; color: #666; font-size: 0.9rem;">${item.description}</p>
                    </div>
                </div>
                <!-- Delete Button (Only works/shows for Owners) -->
                ${sessionUserName ? `<button onclick="deleteEvent('${item.id}')" style="background:none; border:none; color:red; cursor:pointer;"><i class="fas fa-trash"></i></button>` : ''}
            </div>
        `).join('');
    } else {
        listDiv.innerHTML = "<p style='text-align:center; color: #999;'>No upcoming holidays or events.</p>";
    }
}

// Function to delete an event
async function deleteEvent(id) {
    if (!confirm("Are you sure you want to remove this event?")) return;
    
    const { error } = await db.from('institute_calendar').delete().eq('id', id);
    if (error) alert("Error: " + error.message);
    else {
        alert("Event Removed");
        loadCalendar();
    }
}
/* ==========================================
   15. NAVIGATION & INIT
   ========================================== */
/* ==========================================
   FINAL NAVIGATION & AUTO-POPULATION LOGIC
   ========================================== */
function showSection(id) {
    // 1. UI SWITCHING: Hide all sections and show the target one
    const sections = document.querySelectorAll('.content-section');
    sections.forEach(s => s.classList.remove('active'));

    const targetSection = document.getElementById(id);
    if (targetSection) {
        targetSection.classList.add('active');
        console.log("Navigated to: " + id);
    } else {
        console.error("Error: Section ID '" + id + "' does not exist in HTML.");
        return;
    }

    // 2. DATA AUTO-POPULATION: Trigger specific loaders based on the tab
    try {
        switch (id) {
            case 'admin':
                // Set default month to current month for Admin Dashboard if empty
                const adminMonthInput = document.getElementById('admin-filter-month');
                if (adminMonthInput && !adminMonthInput.value) {
                    adminMonthInput.value = new Date().toISOString().substring(0, 7);
                }
                if (typeof loadAdminDashboard === 'function') loadAdminDashboard();
                break;

            case 'fee':
                // Auto-load Fee Management Summary
                if (typeof loadFeesPortal === 'function') loadFeesPortal();
                break;

            case 'reminder':
                // Auto-load Fee Reminder Dashboard
                if (typeof loadFeeReminders === 'function') loadFeeReminders();
                break;

            case 'student-p':
                // Auto-load Personal Student Portal
                if (typeof loadStudentPortal === 'function') loadStudentPortal();
                break;
				
				// Inside your switch (id) statement in showSection(id)
case 'calendar-mod':
    loadCalendar();
    break;

            default:
                // No auto-population required for other sections
                break;
        }
    } catch (err) {
        // This catch block prevents a crash in one module from killing the whole app
        console.warn("Auto-population notice for section [" + id + "]: " + err.message);
    }
}


/* --- PWA INSTALL LOGIC WRAPPED IN DOM CONTENT LOADED --- */
document.addEventListener('DOMContentLoaded', () => {
    let deferredPrompt;
    const installBtn = document.getElementById('pwa-install-btn');

    // 1. Listen for the browser's install signal
    window.addEventListener('beforeinstallprompt', (e) => {
        // Stop the browser from showing its own small bar
        e.preventDefault();
        // Save the event so we can use it when the user clicks our button
        deferredPrompt = e;
        
        // Show our flamboyant install button
        if (installBtn) {
            installBtn.style.display = 'flex';
        }
    });

    // 2. Handle the click on our custom button
    if (installBtn) {
        installBtn.addEventListener('click', () => {
            if (deferredPrompt) {
                // Show the official prompt
                deferredPrompt.prompt();
                
                // See what the user chose
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User installed IMS');
                    }
                    // Hide our button regardless of choice
                    installBtn.style.display = 'none';
                    deferredPrompt = null;
                });
            }
        });
    }

    // 3. Hide button if already installed
    window.addEventListener('appinstalled', () => {
        if (installBtn) installBtn.style.display = 'none';
        deferredPrompt = null;
        console.log('IMS installed successfully');
    });
});



let currentTarget = ""; // Global to track Teacher vs Student

/* ==========================================
   FINAL WHATSAPP BULK LOGIC
   ========================================== */

/* --- COMPLETE MESSAGING ENGINE --- */
function msgEngine(tab) {
    showSection('message-corner');
    document.getElementById('link-group-teachers').value = localStorage.getItem('wa_teachers_group') || "";
    document.getElementById('link-group-students').value = localStorage.getItem('wa_students_group') || "";
}

async function connectToOwner() {
    const { data } = await db.from('profiles').select('mobile_number').eq('institute_id', sessionInstID).eq('role', 'Owner').single();
    if (data?.mobile_number) window.open(`https://wa.me/91${data.mobile_number}`, '_blank');
    else alert("Owner number not found.");
}

async function fetchTeachersBySubject() {
    const sub = document.getElementById('wa-teacher-subject').value;
    let query = db.from('teacher_details').select('teacher_name, mobile, subject_taught').eq('institute_id', sessionInstID);
    if (sub !== "All") query = query.eq('subject_taught', sub);
    const { data } = await query;
    displayWAContactList(data);
}

async function fetchStudentsByCourse() {
    const crs = document.getElementById('wa-student-course').value;
    let query = db.from('students').select('full_name, mobile, course').eq('institute_id', sessionInstID).eq('status', 'Active');
    if (crs !== "All") query = query.eq('course', crs);
    const { data } = await query;
    displayWAContactList(data);
}

function displayWAContactList(list) {
    const area = document.getElementById('wa-results-area');
    const container = document.getElementById('wa-contact-list');
    container.innerHTML = ""; area.style.display = "block";
    if (!list || list.length === 0) return container.innerHTML = "<p>No contacts found.</p>";
    list.forEach(p => {
        const name = p.teacher_name || p.full_name;
        container.innerHTML += `<div style="background:#fff; border:1px solid #000; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold;">${name}</span><a href="https://wa.me/91${p.mobile}" target="_blank" style="background:#25D366; color:white; padding:5px 10px; border-radius:5px; text-decoration:none; font-size:0.8rem;">CHAT</a></div>`;
    });
    area.scrollIntoView({ behavior: 'smooth' });
}

function saveGroupLinks() {
    localStorage.setItem('wa_teachers_group', document.getElementById('link-group-teachers').value);
    localStorage.setItem('wa_students_group', document.getElementById('link-group-students').value);
    alert("Links Saved!");
}

function broadcastToGroup(target) {
    const link = (target === 'Teacher') ? localStorage.getItem('wa_teachers_group') : localStorage.getItem('wa_students_group');
    if (!link) return alert("Save link first!");
    window.open(link, '_blank');
}

async function sendInternalNotice() {
    const text = document.getElementById('notice-text').value.trim();
    const sub = document.getElementById('notice-subject').value;
    if(!text) return alert("Empty message!");
    const { error } = await db.from('messages').insert([{ institute_id: sessionInstID, sender_name: sessionUserName, sender_role: "Owner", message_type: "Student", target_subject: sub, content: text }]);
    if(error) alert(error.message); else { alert("Notice Published!"); document.getElementById('notice-text').value = ""; }
}

async function fetchStudentMessages(course) {
    const noticeDiv = document.getElementById('student-notices');
    const { data } = await db.from('messages').select('*').eq('institute_id', sessionInstID).eq('message_type', 'Student').or(`target_subject.eq.General,target_subject.eq.${course}`).order('created_at', { ascending: false });
    if (data && data.length > 0) {
        noticeDiv.innerHTML = data.map(m => `<div style="background:#f0fff4; padding:10px; border-bottom:1px solid #27ae60; margin-bottom:5px; border-radius:5px;"><b style="color:#27ae60;">[${m.target_subject}]</b> ${m.content}</div>`).join('');
    } else noticeDiv.innerHTML = "No new batch notices.";
}


async function saveTeacherPayment() {
    const data = {
        institute_id: sessionInstID,
        teacher_id: document.getElementById('tch-id').value.toUpperCase(),
        full_name: document.getElementById('tch-name').value,
        subject_taught: document.getElementById('tch-subject').value,
        joining_date: document.getElementById('tch-join').value,
        amount_paid: parseFloat(prompt("Enter Amount Paid Today:")) || 0,
        pending_amount: parseFloat(prompt("Enter Remaining Balance (if any):")) || 0,
        month_year: new Date().toLocaleString('default', { month: 'long', year: 'numeric' })
    };

    if(!data.teacher_id || !data.amount_paid) return alert("Teacher ID and Amount are required!");

    const { error } = await db.from('teacher_payments').insert([data]);
    if(error) alert(error.message);
    else alert("Payment Logged Successfully!");
}



/* ==========================================
   PDF GENERATOR LOGIC (STUDENT & TEACHER)
   ========================================== */

/* ==========================================
   PDF GENERATOR LOGIC (STUDENT & TEACHER)
   ========================================== */

/* ==========================================
   ADVANCED RECEIPT SYSTEM (HISTORY BASED)
   ========================================== */

// --- STUDENT HISTORY & PDF ---
// --- SHOW HISTORY FOR STUDENTS ---
async function showReceiptHistory() {
    const roll = document.getElementById('fee-roll').value.trim().toUpperCase();
    if (!roll) return alert("Fetch student details first!");
    
    const { data: history } = await db.from('payment_history').select('*')
        .eq('roll_number', roll).eq('institute_id', sessionInstID).order('payment_date', { ascending: false });

    if (!history || history.length === 0) return alert("No history found.");
    
    document.getElementById('receipt-history-list').style.display = 'block';
    const container = document.getElementById('history-links-container');
    container.innerHTML = history.map(row => `
        <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee; align-items:center; color:#000;">
            <span>${row.payment_date} (₹${row.amount})</span>
            <button onclick="runPrint('${row.payment_date}', '${row.amount}', 'Student')" style="background:green; color:white; border:none; padding:3px 8px; border-radius:3px; cursor:pointer;">PRINT</button>
        </div>
    `).join('');
}

// --- SHOW HISTORY FOR TEACHERS ---
async function showPayslipHistory() {
    // 1. Get the Teacher ID from the input field
    const tid = document.getElementById('tch-id').value.trim().toUpperCase();
    
    if (!tid) {
        return alert("Please FETCH teacher details first so I know whose payslips to look for!");
    }

    // 2. Fetch records from the TEACHER_PAYMENTS table (Not the student one)
    const { data: history, error } = await db.from('teacher_payments')
        .select('*')
        .eq('teacher_id', tid)
        .eq('institute_id', sessionInstID)
        .order('payment_date', { ascending: false });

    // 3. Handle Errors or Empty Data
    if (error) {
        console.error("Fetch Error:", error.message);
        return alert("Error loading records: " + error.message);
    }

    if (!history || history.length === 0) {
        return alert("No salary records found for ID: " + tid + ". Did you 'LOG SALARY' yet?");
    }

    // 4. Show the list and clear old data
    const listArea = document.getElementById('payslip-history-list');
    const container = document.getElementById('teacher-history-links-container');
    
    listArea.style.display = 'block';
    container.innerHTML = ""; // Clear old list

    // 5. Generate the clickable links for the Payslips
    history.forEach(row => {
        container.innerHTML += `
            <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #ddd; align-items:center; color:#000;">
                <span><b>${row.month_year}</b>: ₹${row.amount_paid}</span>
                <button onclick="runPrintTeacher('${row.payment_date}', '${row.amount_paid}', '${row.pending_amount}', '${row.month_year}')" 
                        style="background:#27ae60; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">
                    <i class="fas fa-print"></i> PRINT
                </button>
            </div>
        `;
    });
}

// --- FINAL PRINT COMMAND ---
function runPrint(date, amt, type) {
    // 1. Get Data
    const instID = sessionInstID || "N/A";
    const name = (type === 'Student') ? document.getElementById('fee-name').value : document.getElementById('tch-name').value;
    const id = (type === 'Student') ? document.getElementById('fee-roll').value : document.getElementById('tch-id').value;
    const course = (type === 'Student') ? document.getElementById('fee-course').value : document.getElementById('tch-subject').value;
    const balance = (type === 'Student') ? document.getElementById('fee-pending').value : "Salary Logged";

    // 2. Create the Receipt Content (Clean HTML)
// 2. Create the Receipt Content (Clean HTML with Logo)
    const receiptHtml = `
        <html>
        <head>
            <title>Receipt_${id}</title>
            <style>
                body { font-family: 'Times New Roman', serif; padding: 40px; color: black; }
                .container { border: 2px solid black; padding: 30px; width: 600px; margin: auto; }
                .header { text-align: center; border-bottom: 2px solid black; margin-bottom: 20px; padding-bottom: 10px; }
                
                /* Logo Styling */
                .logo { width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; }
                
                .row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 18px; }
                .amount-box { border: 3px solid black; padding: 20px; text-align: center; margin: 30px 0; background: #eee; }
                .footer { margin-top: 60px; display: flex; justify-content: space-between; }
                .sign { border-top: 1px solid black; width: 200px; text-align: center; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <!-- LOGO INSERTED HERE -->
                    <img src="icon-192x192.png" class="logo" alt="Institute Logo">
                    
                    <h1 style="margin:0;">FEE RECEIPT</h1>
                    <p style="margin:5px 0;"><b>Institute ID:</b> ${instID}</p>
                </div>
                
                <div class="row">
                    <span><b>Date:</b> ${date}</span> 
                    <span><b>No:</b> ${Math.floor(Math.random()*9000)+1000}</span>
                </div>
                
                <div class="row"><span><b>Name:</b> ${name}</span></div>
                <div class="row"><span><b>Roll/ID:</b> ${id}</span></div>
                <div class="row"><span><b>Course:</b> ${course}</span></div>
                
                <div class="amount-box">
                    <h2 style="margin:0; font-size: 32px;">AMOUNT PAID: ₹ ${amt}</h2>
                </div>
                
                <div class="row"><span><b>Outstanding Balance:</b> ₹ ${balance}</span></div>
                
                <div class="footer">
                    <div class="sign">Receiver Signature</div>
                    <div class="sign">Authorized Signatory</div>
                </div>
                <p style="text-align:center; margin-top:30px; font-size:12px;">Computer Generated Official Document</p>
            </div>
        </body>
        </html>
    `;

    // 3. Open New Window and Print
    const printWindow = window.open('', '_blank', 'width=800,height=800');
    printWindow.document.write(receiptHtml);
    printWindow.document.close();
    
    // Give it a tiny moment to load, then print
    printWindow.setTimeout(function() {
        printWindow.print();
        printWindow.close();
    }, 500);
}





function runPrintTeacher(date, paid, pending, month) {
    const instID = sessionInstID || "N/A";
    const name = document.getElementById('tch-name').value;
    const id = document.getElementById('tch-id').value;
    const sub = document.getElementById('tch-subject').value;

    const receiptHtml = `
        <html>
        <head>
            <title>Payslip_${id}</title>
            <style>
                body { font-family: serif; padding: 40px; color: black; }
                .container { border: 2px solid black; padding: 30px; width: 600px; margin: auto; }
                .header { text-align: center; border-bottom: 2px solid black; margin-bottom: 20px; }
                .logo { width: 80px; height: 80px; margin-bottom: 10px; }
                .row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 18px; }
                .amount-box { border: 3px solid black; padding: 20px; text-align: center; margin: 30px 0; background: #eee; }
                .sign-row { margin-top: 60px; display: flex; justify-content: space-between; }
                .sign-box { border-top: 1px solid black; width: 200px; text-align: center; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <img src="icon-192x192.png" class="logo">
                    <h1 style="margin:0;">SALARY PAYSLIP</h1>
                    <p><b>Institute ID:</b> ${instID}</p>
                    <p>For Month: <b>${month}</b></p>
                </div>
                <div class="row"><span><b>Date:</b> ${date}</span> <span><b>No:</b> ${Math.floor(Math.random()*9000)+1000}</span></div>
                <div class="row"><b>Name:</b> ${name}</div>
                <div class="row"><b>ID:</b> ${id}</div>
                <div class="row"><b>Subject:</b> ${sub}</div>
                
                <div class="amount-box">
                    <h2 style="margin:0;">AMOUNT PAID: ₹ ${paid}</h2>
                </div>
                
                <div class="row"><b>Balance Pending:</b> ₹ ${pending}</div>
                
                <div class="sign-row">
                    <div class="sign-box">Staff Signature</div>
                    <div class="sign-box">Authorized Signatory</div>
                </div>
            </div>
        </body>
        </html>
    `;

    const printWindow = window.open('', '_blank', 'width=800,height=800');
    printWindow.document.write(receiptHtml);
    printWindow.document.close();
    setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
}






/* ==========================================
   FINANCIAL INTELLIGENCE: FORECASTING ENGINE
   ========================================== */

async function generateFinancialForecast(students) {
    const monthsToShow = 6;
    const forecastData = {};
    const chartRows = [];

    // 1. Initialize the next 6 months in the object
    for (let i = 0; i < monthsToShow; i++) {
        let d = new Date();
        d.setMonth(d.getMonth() + i);
        let monthName = d.toLocaleString('default', { month: 'long', year: 'numeric' });
        forecastData[monthName] = 0;
    }

    // 2. Parse Student Due Dates and distribute Pending Amounts
    students.forEach(s => {
        if (s.pending_amount > 0 && s.due_dates) {
            // Split "March 2026, July 2026" into an array
            const dates = s.due_dates.split(',').map(d => d.trim());
            const perInstallment = s.pending_amount / dates.length;

            dates.forEach(d => {
                if (forecastData.hasOwnProperty(d)) {
                    forecastData[d] += perInstallment;
                }
            });
        }
    });

    // 3. Update the UI Cards
    const cardContainer = document.getElementById('forecast-cards');
    cardContainer.innerHTML = "";
    
    // Total numbers for the Chart
    const totalAdmissions = students.length;
    const totalReceived = students.reduce((sum, s) => sum + (Number(s.paid_amount) || 0), 0);
    const totalPending = students.reduce((sum, s) => sum + (Number(s.pending_amount) || 0), 0);

    Object.keys(forecastData).forEach(month => {
        cardContainer.innerHTML += `
            <div class="stat-card" style="padding: 15px; min-width: 130px; border-bottom: 4px solid #f39c12;">
                <p style="font-size: 0.7rem; margin-bottom: 5px;">${month.toUpperCase()}</p>
                <h4 style="font-size: 1.2rem !important; color: #000;">₹${Math.round(forecastData[month]).toLocaleString()}</h4>
            </div>
        `;
        // Prepare row for chart: [Month, Admissions, Collection, Pending, Incoming]
        chartRows.push([month, totalAdmissions, totalReceived, totalPending, Math.round(forecastData[month])]);
    });

    // 4. Draw the Google Chart with Slicer
    drawHomeForecastingChart(chartRows);
}

function drawHomeForecastingChart(chartRows) {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Month');
    data.addColumn('number', 'Admissions');
    data.addColumn('number', 'Total Collection');
    data.addColumn('number', 'Total Pending');
    data.addColumn('number', 'Incoming (Forecast)');

    data.addRows(chartRows);

    var dashboard = new google.visualization.Dashboard(document.getElementById('home_dashboard_div'));

    var slicer = new google.visualization.ControlWrapper({
        'controlType': 'CategoryFilter',
        'containerId': 'home_filter_div',
        'options': {
            'filterColumnLabel': 'Month',
            'ui': {
                'label': 'Filter Specific Month:',
                'allowTyping': false,
                'allowMultiple': true
            }
        }
    });

    var lineChart = new google.visualization.ChartWrapper({
        'chartType': 'LineChart',
        'containerId': 'home_line_chart',
        'options': {
            'title': 'Financial Outlook (Next 6 Months)',
            'curveType': 'function',
            'legend': { position: 'bottom' },
            'colors': ['#27ae60', '#1877F2', '#ff0000', '#f39c12'],
            'pointSize': 7,
            'vAxis': { title: 'Amount / Count', minValue: 0 },
            'hAxis': { title: 'Timeline' },
            'chartArea': { width: '85%', height: '70%' }
        }
    });

    dashboard.bind(slicer, lineChart);
    dashboard.draw(data);
}




/* ==========================================
   ALUMNI & PLACEMENT TRACKER LOGIC
   ========================================== */

// 1. Fetch Student from Master Table and Check Status
async function fetchStudentForAlumni() {
    const roll = document.getElementById('al-roll').value.trim().toUpperCase();
    if(!roll) return alert("Please enter a Roll Number");

    const { data: student, error } = await db.from('students')
        .select('full_name, course, admission_date, status')
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if(error || !student) return alert("Student not found in admission records.");

    // CONDITION: Cannot add ACTIVE students
    if(student.status === 'Active') {
        alert("ERROR: This student is currently 'Active'. You can only add students to Alumni section once their course is Closed or Graduated.");
        clearAlumniForm();
        return;
    }

    // Autopopulate fields
    document.getElementById('al-name').value = student.full_name;
    document.getElementById('al-course').value = student.course;
    
    // Format enrollment date to Month Year
    const enrollDate = new Date(student.admission_date).toLocaleString('default', { month: 'long', year: 'numeric' });
    document.getElementById('al-enroll').value = enrollDate;
    
    alert("Record found for " + student.full_name + ". You may now fill placement details.");
}

// 2. Add Alumni Record
async function addAlumni() {
    const roll = document.getElementById('al-roll').value.toUpperCase();
    const name = document.getElementById('al-name').value;
    
    if(!roll || !name) return alert("Please fetch student details first.");

    const alumniData = {
        institute_id: sessionInstID,
        roll_number: roll,
        full_name: name,
        course_enrolled: document.getElementById('al-course').value,
        enrollment_month_year: document.getElementById('al-enroll').value,
        college_name: document.getElementById('al-college').value,
        stream: document.getElementById('al-stream').value,
        company_name: document.getElementById('al-company').value,
        designation: document.getElementById('al-designation').value,
        salary: parseFloat(document.getElementById('al-salary').value) || 0
    };

    const { error } = await db.from('alumni_tracker').insert([alumniData]);
    if(error) {
        if(error.code === "23505") alert("Error: An alumni record for this Roll Number already exists.");
        else alert("Save Error: " + error.message);
    } else {
        alert("Success! Alumni record for " + name + " saved.");
        clearAlumniForm();
    }
}

// 3. Edit Alumni Record
async function editAlumni() {
    const roll = document.getElementById('al-roll').value.toUpperCase();
    if(!roll) return alert("Enter Roll Number to edit.");

    const updateData = {
        college_name: document.getElementById('al-college').value,
        stream: document.getElementById('al-stream').value,
        company_name: document.getElementById('al-company').value,
        designation: document.getElementById('al-designation').value,
        salary: parseFloat(document.getElementById('al-salary').value) || 0
    };

    const { error } = await db.from('alumni_tracker').update(updateData).eq('roll_number', roll).eq('institute_id', sessionInstID);
    if(error) alert("Update Error: " + error.message);
    else alert("Success: Placement details updated for " + roll);
}

// 4. Fetch Saved Alumni Record
async function fetchSavedAlumni() {
    const roll = document.getElementById('al-roll').value.trim().toUpperCase();
    if(!roll) return alert("Enter Roll Number to fetch saved record.");

    const { data, error } = await db.from('alumni_tracker').select('*').eq('roll_number', roll).eq('institute_id', sessionInstID).maybeSingle();
    
    if(error || !data) return alert("No saved alumni record found for this roll number.");

    document.getElementById('al-name').value = data.full_name;
    document.getElementById('al-course').value = data.course_enrolled;
    document.getElementById('al-enroll').value = data.enrollment_month_year;
    document.getElementById('al-college').value = data.college_name;
    document.getElementById('al-stream').value = data.stream;
    document.getElementById('al-company').value = data.company_name;
    document.getElementById('al-designation').value = data.designation;
    document.getElementById('al-salary').value = data.salary;
    
    alert("Saved record loaded!");
}

function clearAlumniForm() {
    const ids = ['al-roll','al-name','al-course','al-enroll','al-college','al-stream','al-company','al-designation','al-salary'];
    ids.forEach(id => document.getElementById(id).value = "");
}
















/* ==========================================
   INVENTORY & STATIONERY TRACKER LOGIC
   ========================================== */

/* ==========================================
   INVENTORY MANAGER: GRID & VENDOR LOGIC
   ========================================== */

const INVENTORY_ITEMS = [
    'Algebra','Geometry','Physics','Chemistry','Biology','History','Geography','Spoken English',
    'English Grammar','Economics','Accounting','Drawing','JEE','NEET','French','Spanish','German',
    'Uniforms','Bags','Calendars','Others'
];

// Initialize Grid on Load
function initInventoryGrid() {
    const tbody = document.getElementById('inventory-items-body');
    tbody.innerHTML = INVENTORY_ITEMS.map(item => {
        const id = item.replace(/\s+/g, '-').toLowerCase();
        return `
            <tr id="row-${id}">
                <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">
                    <input type="checkbox" class="inv-check" data-item="${item}" onchange="calculateInvTotal()">
                </td>
                <td style="padding: 10px; border: 1px solid #ccc; font-weight: bold; color: #000;">${item}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    <!-- PERMANENTLY DISABLED -->
                    <input type="number" class="inv-stock-val" style="width: 70px; background: #f0f0f0; border: none; text-align: center; font-weight: bold;" disabled>
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    <!-- PERMANENTLY DISABLED -->
                    <input type="number" class="inv-price-val" style="width: 70px; background: #f0f0f0; border: none; text-align: center; font-weight: bold;" disabled>
                </td>
                <td style="padding: 10px; border: 1px solid #ccc;">
                    <input type="number" class="inv-qty-val" style="width: 60px;" value="1" min="1" oninput="calculateInvTotal()">
                </td>
                <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">
                    ${['A','B','C','D','E'].map(v => `
                        <a href="https://wa.me/910000000000?text=Order:${item}" target="_blank" 
                           style="text-decoration:none; margin: 0 2px; font-size: 0.7rem; background: #25D366; color: white; padding: 3px 6px; border-radius: 3px; display: inline-block;">
                           ${v} <i class="fab fa-whatsapp"></i>
                        </a>
                    `).join('')}
                </td>
            </tr>
        `;
    }).join('');
}
function toggleInventoryGrid() {
    const grid = document.getElementById('inventory-grid-container');
    const isOpening = grid.style.display === 'none';
    grid.style.display = isOpening ? 'block' : 'none';
    
    // Simply load the data from Supabase into the locked fields
    if(isOpening) loadMasterInventory();
}

function calculateInvTotal() {
    let total = 0;
    document.querySelectorAll('.inv-check:checked').forEach(cb => {
        const row = cb.closest('tr');
        const price = parseFloat(row.querySelector('.inv-price-val').value) || 0;
        const qty = parseInt(row.querySelector('.inv-qty-val').value) || 1;
        total += (price * qty);
    });
    document.getElementById('inv-total-calc').value = total.toFixed(2);
}

// Check for stock < 10 across all rows
function checkLowStockGlobal() {
    let lowItems = [];
    document.querySelectorAll('#inventory-items-body tr').forEach(row => {
        const name = row.querySelector('.inv-check').dataset.item;
        const stock = parseInt(row.querySelector('.inv-stock-val').value) || 0;
        if(stock > 0 && stock < 10) lowItems.push(name);
    });

    const alertBox = document.getElementById('low-stock-alert');
    if(lowItems.length > 0) {
        alertBox.style.display = 'block';
        document.getElementById('low-stock-items').innerText = lowItems.join(', ') + " are running low!";
    } else {
        alertBox.style.display = 'none';
    }
}

// SAVE THE PRICES & STOCK TO SUPABASE
async function saveInventoryMaster() {
    const updates = [];
    document.querySelectorAll('#inventory-items-body tr').forEach(row => {
        const name = row.querySelector('.inv-check').dataset.item;
        const stock = parseInt(row.querySelector('.inv-stock-val').value) || 0;
        const price = parseFloat(row.querySelector('.inv-price-val').value) || 0;

        updates.push({
            institute_id: sessionInstID,
            item_name: name,
            current_stock: stock,
            item_price: price
        });
    });

    const { error } = await db.from('inventory_master').upsert(updates, { onConflict: 'institute_id, item_name' });
    if(error) alert(error.message); else alert("Catalog and Master Stock updated!");
}

async function loadMasterInventory() {
    const { data } = await db.from('inventory_master').select('*').eq('institute_id', sessionInstID);
    if(data) {
        data.forEach(item => {
            const id = item.item_name.replace(/\s+/g, '-').toLowerCase();
            const row = document.getElementById(`row-${id}`);
            if(row) {
                row.querySelector('.inv-stock-val').value = item.current_stock;
                row.querySelector('.inv-price-val').value = item.item_price;
            }
        });
        checkLowStockGlobal();
    }
}

// PROCESS SALE
async function processInventorySale() {
    const roll = document.getElementById('inv-stu-roll').value;
    const selectedRows = Array.from(document.querySelectorAll('.inv-check:checked')).map(cb => {
        const row = cb.closest('tr');
        return {
            name: cb.dataset.item,
            qty: parseInt(row.querySelector('.inv-qty-val').value) || 1
        };
    });

    const total = parseFloat(document.getElementById('inv-total-calc').value);

    if(!roll || selectedRows.length === 0) return alert("Select student and items first!");

    const itemsStr = selectedRows.map(i => `${i.name} (${i.qty})`).join(', ');

    const saleData = {
        institute_id: sessionInstID,
        student_roll: roll,
        student_name: document.getElementById('inv-stu-name').value,
        course_name: document.getElementById('inv-stu-course').value,
		month_year: new Date().toLocaleString('default', { month: 'long', year: 'numeric' }),
        items_bought: itemsStr,
        total_paid: total,
        remarks: document.getElementById('inv-remarks').value
};

    

    const { error } = await db.from('inventory_sales').insert([saleData]);
    if(error) alert(error.message);
    else {
        // Updated deduction loop to use correct quantity
        for(let item of selectedRows) {
            const { data } = await db.from('inventory_master')
                .select('current_stock')
                .eq('item_name', item.name)
                .eq('institute_id', sessionInstID)
                .single();
            
            if(data) {
                await db.from('inventory_master')
                    .update({ current_stock: data.current_stock - item.qty })
                    .eq('item_name', item.name)
                    .eq('institute_id', sessionInstID);
            }
        }
        
        syncToOtherIncome(total);
        alert("Sale Recorded & " + itemsStr + " deducted from stock!");
        clearInventoryUI();
loadMasterInventory(); 
    }
}



function clearInventoryUI() {
    ['inv-stu-roll','inv-stu-name','inv-stu-course','inv-total-calc','inv-remarks'].forEach(id => document.getElementById(id).value = "");
    document.querySelectorAll('.inv-check').forEach(cb => cb.checked = false);
    document.querySelectorAll('.inv-qty-val').forEach(input => input.value = 1);
}

async function deductStock(itemList) {
    for(let item of itemList) {
        const { data } = await db.from('inventory_master').select('current_stock').eq('item_name', item).eq('institute_id', sessionInstID).single();
        if(data) {
            await db.from('inventory_master').update({ current_stock: data.current_stock - 1 }).eq('item_name', item).eq('institute_id', sessionInstID);
        }
    }
}

// Finally, call init in your script load section
initInventoryGrid();





async function fetchStudentForInv() {
    const roll = document.getElementById('inv-stu-roll').value.trim().toUpperCase();
    if (!roll) return alert("Please enter a Roll Number first.");

    const { data, error } = await db.from('students')
        .select('full_name, course')
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (error) return alert("Error: " + error.message);
    if (data) {
        document.getElementById('inv-stu-name').value = data.full_name;
        document.getElementById('inv-stu-course').value = data.course;
        alert("Student details loaded!");
    } else {
        alert("No student found with Roll No: " + roll);
    }
}




/* --- MINIMAL FIX: FINANCIAL SYNC FOR INVENTORY --- */
/* --- SAFE SYNC: STOPS EXPENSE SECTION CRASHES --- */
async function syncToOtherIncome(amount) {
    // We only log the sale to the console now.
    // The Inventory Income is already being calculated and displayed 
    // on the HOME PAGE card, so we don't need to force it into the Expense table.
    console.log("Inventory Sale Recorded: ₹" + amount + ". Home Page stats will update on refresh.");
}


async function calculateInventoryIncome(monthYear) {
    // monthYear is "2026-02"
    // We need to filter records where created_at is within this month
    const startDate = `${monthYear}-01T00:00:00Z`;
    const endDate = `${monthYear}-31T23:59:59Z`; // SQL handles the 31st safely

    const { data, error } = await db.from('inventory_sales')

        .select('total_paid')
        .eq('institute_id', sessionInstID)
        .gte('created_at', startDate)
        .lte('created_at', endDate);

    if (error) {
        console.error("Inventory Sum Error:", error.message);
        return 0;
    }

    // Sum up all the 'total_paid' values for that month
    return data.reduce((sum, record) => sum + (parseFloat(record.total_paid) || 0), 0);
}



/* --- HOME PAGE: REAL-TIME INVENTORY SUM --- */
async function loadHomeInventoryStats() {
    if (!sessionInstID) return;

    // Get the start and end of the current month
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).toISOString();

    const { data, error } = await db.from('inventory_sales')
        .select('total_paid')
        .eq('institute_id', sessionInstID)
        .gte('created_at', startOfMonth)
        .lte('created_at', endOfMonth);

    if (error) {
        console.error("Home Inventory Error:", error.message);
        return;
    }

    const totalInv = data ? data.reduce((sum, item) => sum + (parseFloat(item.total_paid) || 0), 0) : 0;
    
    // Update the new Home Page card
    document.getElementById('home-total-inventory').innerText = "₹ " + totalInv.toLocaleString('en-IN');
}





/* --- EXPENSE SECTION: AUTO-PULL INVENTORY SALES --- */
async function fetchAutoInventory() {
    const monthInput = document.getElementById('exp-month-year').value; // "2026-02"
    if (!monthInput || !sessionInstID) return;

    // CONVERT "2026-02" to "February 2026" (Exactly like Student Fees)
    const dateObj = new Date(monthInput + "-01");
    const formattedMonth = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    console.log("Fetching Inventory for:", formattedMonth);

    const { data, error } = await db.from('inventory_sales')
        .select('total_paid')
        .eq('institute_id', sessionInstID)
        .eq('month_year', formattedMonth); // THE KEY CHANGE: Match by String Name

    if (error) {
        console.error("Inventory Fetch Error:", error.message);
        return;
    }

    const totalSales = data ? data.reduce((sum, item) => sum + (parseFloat(item.total_paid) || 0), 0) : 0;
    
    // Update the UI Label
    document.getElementById('disp-auto-inv').innerText = "₹ " + totalSales.toFixed(2);
    
    // Refresh the master calculation
    calculateFinancials();
}



/* --- LOGIC: FETCH INVENTORY TOTAL FOR THE SELECTED MONTH --- */
async function fetchAutoInventory() {
    const monthVal = document.getElementById('exp-month-year').value; // e.g. "2026-02"
    if (!monthVal || !sessionInstID) return;

    // Create date range for the selected month
    const startDate = `${monthVal}-01T00:00:00Z`;
    const endDate = `${monthVal}-31T23:59:59Z`;

    const { data, error } = await db.from('inventory_sales')
        .select('total_paid')
        .eq('institute_id', sessionInstID)
        .gte('created_at', startDate)
        .lte('created_at', endDate);

    if (error) {
        console.error("Inventory Fetch Error:", error.message);
        return;
    }

    // Calculate the sum exactly like your Fee logic
    const totalSales = data ? data.reduce((sum, item) => sum + (parseFloat(item.total_paid) || 0), 0) : 0;
    
    // Update the UI Label (The Purple one)
    document.getElementById('disp-auto-inv').innerText = "₹ " + totalSales.toFixed(2);
    
    // Update the Math
    calculateFinancials();
}







/* ==========================================
   23. SCHOLARSHIP TRACKER LOGIC
   ========================================== */

// 1. Set Today's Date on Load
document.addEventListener('DOMContentLoaded', () => {
    const schToday = document.getElementById('sch-today');
    if(schToday) schToday.value = new Date().toISOString().split('T')[0];
});

// 2. Fetch Base Student Details
// 2. Fetch Base Student Details
async function fetchStudentForScholarship() {
    const roll = document.getElementById('sch-roll').value.trim().toUpperCase();
    if (!roll) return alert("Please enter Roll Number first.");

    // Step A: Fetch base data
    const { data: student, error } = await db.from('students')
        .select('full_name, course, total_fees')
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (error || !student) return alert("Student not found. Ensure Roll No is correct.");

    document.getElementById('sch-name').value = student.full_name;
    document.getElementById('sch-course').value = student.course;
    document.getElementById('sch-total-fee').value = student.total_fees || 0;

    // Step B: Fetch course_end_date and store it temporarily
    const { data: details } = await db.from('student_details')
        .select('course_end_date')
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (details && details.course_end_date) {
        // Save it invisibly in the dataset to use during calculation
        document.getElementById('sch-valid-to').dataset.autoEnd = details.course_end_date;
    }

    calculateScholarship(); // Initialize calculations
}

// 3. Dynamic Calculation Engine
function calculateScholarship() {
    const status = document.getElementById('sch-status').value;
    const totalFee = parseFloat(document.getElementById('sch-total-fee').value) || 0;
    const pctInput = document.getElementById('sch-pct');
    const validFrom = document.getElementById('sch-valid-from');
    const validTo = document.getElementById('sch-valid-to');

    if (status === 'Approved') {
        pctInput.readOnly = false;
        validFrom.disabled = false;
        validTo.disabled = false;
        
        // Auto-fill Valid To with course end date if it is currently empty
        if (!validTo.value && validTo.dataset.autoEnd) {
            validTo.value = validTo.dataset.autoEnd;
        }
        
        const pct = parseFloat(pctInput.value) || 0;
        const schAmount = (totalFee * pct) / 100;
        const finalFee = totalFee - schAmount;

        document.getElementById('sch-amt').value = schAmount.toFixed(2);
        document.getElementById('sch-final-fee').value = finalFee.toFixed(2);
    } else {
        // If Pending or Rejected
        pctInput.value = 0;
        pctInput.readOnly = true;
        validFrom.value = "";
        validTo.value = "";
        validFrom.disabled = true;
        validTo.disabled = true;

        document.getElementById('sch-amt').value = "NA";
        document.getElementById('sch-final-fee').value = totalFee.toFixed(2);
    }
}

// 4. File Upload (Supabase Storage)
let uploadedDocUrl = "";
async function uploadScholarshipDoc() {
    const fileInput = document.getElementById('sch-upload');
    const roll = document.getElementById('sch-roll').value.trim().toUpperCase();
    
    if(!roll) return alert("Enter Roll Number before uploading.");
    if(fileInput.files.length === 0) return alert("Select a file first.");

    const file = fileInput.files[0];
    const filePath = `${sessionInstID}/${roll}_${file.name}`;
    
    document.getElementById('sch-upload-status').innerText = "Uploading...";

    const { data, error } = await db.storage.from('scholarship_docs').upload(filePath, file, { upsert: true });
    
    if(error) {
        document.getElementById('sch-upload-status').innerText = "Upload Failed!";
        alert("Upload Error: " + error.message);
    } else {
        const { data: publicUrlData } = db.storage.from('scholarship_docs').getPublicUrl(filePath);
        uploadedDocUrl = publicUrlData.publicUrl;
        document.getElementById('sch-upload-status').innerText = "File Uploaded Successfully ✓";
    }
}

// 5. Build Data Object
function getScholarshipData() {
    return {
        institute_id: sessionInstID,
        roll_number: document.getElementById('sch-roll').value.trim().toUpperCase(),
        student_name: document.getElementById('sch-name').value,
        course_name: document.getElementById('sch-course').value,
        total_course_fee: parseFloat(document.getElementById('sch-total-fee').value) || 0,
        scholarship_name: document.getElementById('sch-sch-name').value,
        applied_on: document.getElementById('sch-applied-date').value,
        docs_required: document.getElementById('sch-docs').value,
        status: document.getElementById('sch-status').value,
        scholarship_pct: parseFloat(document.getElementById('sch-pct').value) || 0,
        scholarship_amount: parseFloat(document.getElementById('sch-amt').value) || 0,
        final_fees: parseFloat(document.getElementById('sch-final-fee').value) || 0,
        valid_from: document.getElementById('sch-valid-from').value || null,
        valid_to: document.getElementById('sch-valid-to').value || null,
        remarks: document.getElementById('sch-remarks').value,
        document_url: uploadedDocUrl
    };
}

// 6. ADD Record
async function addScholarship() {
    const data = getScholarshipData();
    if (!data.roll_number || !data.scholarship_name) return alert("Roll Number and Scholarship Name are required.");

    const { error } = await db.from('scholarships').insert([data]);
    
    if (error) {
        if (error.code === '23505') alert("Error: A scholarship record already exists for this Roll Number. Use UPDATE instead.");
        else alert("Save Error: " + error.message);
    } else {
        alert("Success: Scholarship Record Added!");
    }
}

// 7. FETCH Record
async function fetchScholarshipByRoll() {
    const roll = prompt("Enter Roll Number to fetch Scholarship Record:");
    if(!roll) return;

    const { data, error } = await db.from('scholarships')
        .select('*').eq('roll_number', roll.toUpperCase()).eq('institute_id', sessionInstID).maybeSingle();

    if(error || !data) return alert("No scholarship record found for this student.");

    document.getElementById('sch-roll').value = data.roll_number;
    document.getElementById('sch-name').value = data.student_name;
    document.getElementById('sch-course').value = data.course_name;
    document.getElementById('sch-total-fee').value = data.total_course_fee;
    document.getElementById('sch-sch-name').value = data.scholarship_name;
    document.getElementById('sch-applied-date').value = data.applied_on;
    document.getElementById('sch-docs').value = data.docs_required;
    document.getElementById('sch-status').value = data.status;
    document.getElementById('sch-pct').value = data.scholarship_pct;
    document.getElementById('sch-valid-from').value = data.valid_from || "";
    document.getElementById('sch-valid-to').value = data.valid_to || "";
    document.getElementById('sch-remarks').value = data.remarks;
    
    if(data.document_url) {
        document.getElementById('sch-upload-status').innerHTML = `<a href="${data.document_url}" target="_blank">View Saved Document</a>`;
    }
    
    calculateScholarship();
    alert("Record Loaded Successfully.");
}

// 8. UPDATE Record
async function updateScholarship() {
    const data = getScholarshipData();
    if (!data.roll_number) return alert("Fetch a record first before updating.");

    const { error } = await db.from('scholarships')
        .update(data)
        .eq('roll_number', data.roll_number)
        .eq('institute_id', sessionInstID);

    if (error) alert("Update Error: " + error.message);
    else alert("Success: Scholarship Record Updated!");
}

// 9. PRINT Award Letter
function printScholarship() {
    const status = document.getElementById('sch-status').value;
    if(status !== 'Approved') return alert("Award letters can only be printed for 'Approved' scholarships.");

    const name = document.getElementById('sch-name').value;
    const roll = document.getElementById('sch-roll').value;
    const schName = document.getElementById('sch-sch-name').value;
    const schAmt = document.getElementById('sch-amt').value;
    const course = document.getElementById('sch-course').value;
    const date = new Date().toLocaleDateString('en-GB');

    const html = `
    <html>
        <head>
            <title>Scholarship Award - ${roll}</title>
            <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { margin: 0; padding: 40px; display: flex; justify-content: center; background: #fff; }
                .cert-container { width: 800px; padding: 40px; border: 10px double #f39c12; font-family: 'Poppins', sans-serif; text-align: center; position: relative; }
                .logo { width: 80px; position: absolute; top: 30px; left: 30px; }
                .title { color: #f39c12; font-size: 40px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; }
                .sub-title { font-size: 20px; letter-spacing: 3px; color: #555; margin-bottom: 40px; }
                .content { font-size: 18px; line-height: 1.8; color: #333; }
                .highlight { font-size: 26px; color: #d35400; font-weight: bold; border-bottom: 2px solid #ccc; padding: 0 20px; display: inline-block; margin: 15px 0; }
                .amount { font-size: 35px; color: #27ae60; font-weight: bold; margin: 20px 0; }
                .footer { margin-top: 80px; display: flex; justify-content: space-between; padding: 0 40px; }
                .sign-line { border-top: 2px solid #333; width: 200px; padding-top: 5px; font-weight: bold; }
                @media print { @page { size: landscape; } body { padding: 0; } }
            </style>
        </head>
        <body onload="window.print(); window.close();">
            <div class="cert-container">
                <img src="icon-192x192.png" class="logo" alt="Logo">
                <div class="title">OFFICIAL AWARD LETTER</div>
                <div class="sub-title">SCHOLARSHIP & FINANCIAL AID</div>
                
                <div class="content">
                    This is to officially certify and congratulate<br>
                    <span class="highlight">${name}</span><br>
                    (Roll Number: <b>${roll}</b>)<br><br>
                    For demonstrating outstanding merit and being selected for the<br>
                    <b>${schName}</b> for the <b>${course}</b> program.<br>
                    
                    <div class="amount">Award Amount: ₹ ${schAmt}</div>
                    
                    This scholarship amount has been applied directly to your academic fees. <br>
                    We wish you continued excellence in your academic journey!
                </div>
                
                <div class="footer">
                    <div>
                        <p style="margin-bottom: 40px;">Date: <b>${date}</b></p>
                        <div class="sign-line">Institute Seal</div>
                    </div>
                    <div>
                        <p style="margin-bottom: 40px;"><br></p>
                        <div class="sign-line">Authorized Signatory</div>
                    </div>
                </div>
            </div>
        </body>
    </html>`;

    const win = window.open('', '_blank', 'width=1000,height=750');
    win.document.write(html);
    win.document.close();
}
















/* ==========================================
   24. PTM SCHEDULER LOGIC
   ========================================== */

// Default month setup
document.addEventListener('DOMContentLoaded', () => {
    const ptmMonth = document.getElementById('ptm-month');
    if (ptmMonth) ptmMonth.value = new Date().toISOString().substring(0, 7);
});

// Rule 3: Close Booking if current date > ptm_date
function checkPTMDateValidity() {
    const ptmDate = document.getElementById('ptm-date').value;
    const statusSelect = document.getElementById('ptm-status');
    const today = new Date().toISOString().split('T')[0];
    
    if (ptmDate && today > ptmDate) {
        alert("Notice: The selected PTM Date has passed. Bookings will be closed automatically.");
        statusSelect.value = "Closed";
    } else {
        statusSelect.value = "Open";
    }
    togglePTMStatus();
}

function togglePTMStatus() {
    const status = document.getElementById('ptm-status').value;
    const area = document.getElementById('ptm-booking-area');
    if (status === 'Closed') {
        area.style.pointerEvents = 'none';
        area.style.opacity = '0.5';
    } else {
        area.style.pointerEvents = 'auto';
        area.style.opacity = '1';
    }
}

// Helper to add minutes to time (HH:MM)
function addMinutesToTime(timeStr, minsToAdd) {
    const [h, m] = timeStr.split(':').map(Number);
    let date = new Date();
    date.setHours(h, m, 0, 0);
    date.setMinutes(date.getMinutes() + minsToAdd);
    return String(date.getHours()).padStart(2, '0') + ':' + String(date.getMinutes()).padStart(2, '0');
}

// Fetch Student, Teacher, and Calculate Slot
async function fetchAndAllocatePTM() {
    const ptmMonth = document.getElementById('ptm-month').value;
    const ptmDate = document.getElementById('ptm-date').value;
    const startTime = document.getElementById('ptm-start').value;
    const endTime = document.getElementById('ptm-end').value;
    const duration = parseInt(document.getElementById('ptm-duration').value);
    const roll = document.getElementById('ptm-roll').value.trim().toUpperCase();

    if (!ptmMonth || !ptmDate || !startTime || !endTime || !duration || !roll) {
        return alert("Please configure Step 1 fully and enter a Roll Number.");
    }

    const monthYearStr = new Date(ptmMonth + "-01").toLocaleString('default', { month: 'long', year: 'numeric' });

    // 1. Fetch Student Details
    const { data: stu, error: stuErr } = await db.from('students')
        .select('full_name, course, mother_mobile, father_mobile')
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (stuErr || !stu) return alert("Student not found.");

    // 2. Fetch Teacher Allocation
    const { data: alloc, error: allocErr } = await db.from('student_allocations')
        .select('teacher_id')
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (allocErr || !alloc) return alert(`No teacher allocated to ${roll}. Please allocate a teacher first in Module 18.`);

    // 3. Fetch Teacher Details
    const { data: teacher } = await db.from('teacher_details')
        .select('teacher_name, mobile')
        .eq('id', alloc.teacher_id)
        .eq('institute_id', sessionInstID)
        .single();

    // 4. Find Available Slot (Rule 1 Logic)
    // Fetch all existing slots for this teacher on this date
    const { data: booked } = await db.from('ptm_schedule')
        .select('slot_time')
        .eq('teacher_id', alloc.teacher_id)
        .eq('ptm_date', ptmDate)
        .eq('institute_id', sessionInstID);

    const bookedTimes = booked ? booked.map(b => b.slot_time.substring(0, 5)) : []; // Get "HH:MM"
    
    let currentSlot = startTime;
    let allocatedSlot = null;

    while (currentSlot < endTime) {
        if (!bookedTimes.includes(currentSlot)) {
            allocatedSlot = currentSlot;
            break;
        }
        currentSlot = addMinutesToTime(currentSlot, duration);
    }

    if (!allocatedSlot) {
        return alert(`All slots for ${teacher.teacher_name} are booked on this date between ${startTime} and ${endTime}.`);
    }

    // Populate UI
    document.getElementById('ptm-sname').value = stu.full_name;
    document.getElementById('ptm-course').value = stu.course;
    document.getElementById('ptm-tid').value = alloc.teacher_id;
    document.getElementById('ptm-tname').value = teacher.teacher_name;
    document.getElementById('ptm-slot-time').value = allocatedSlot;
    
    document.getElementById('ptm-tmob').value = teacher.mobile || "";
    document.getElementById('ptm-mmob').value = stu.mother_mobile || "";
    document.getElementById('ptm-fmob').value = stu.father_mobile || "";

    // Generate WhatsApp Messages
    generatePTMWhatsAppLinks(monthYearStr, ptmDate, startTime, endTime, allocatedSlot, teacher.teacher_name, teacher.mobile, stu.mother_mobile, stu.father_mobile);
}

// Generate the specific automated WhatsApp messages
function generatePTMWhatsAppLinks(mYear, date, start, end, slot, tName, tMob, mMob, fMob) {
    const tMsg = encodeURIComponent(`Dear ${tName}, this is to inform you that the PTM for the current month ${mYear} is going to be conducted on ${date} between ${start} and ${end}. Your presence is highly essential. Please confirm.`);
    const mMsg = encodeURIComponent(`Dear mam, this is to inform you that the PTM for ${mYear} is going to be conducted on ${date} between ${start} to ${end} and the slot allotted to you is from ${slot} so, kindly ensure that you are present for the PTM.`);
    const fMsg = encodeURIComponent(`Dear sir, this is to inform you that the PTM for ${mYear} is going to be conducted on ${date} between ${start} to ${end} and the slot allotted to you is from ${slot} so, kindly ensure that you are present for the PTM.`);

    setupWALink('wa-ptm-teacher', tMob, tMsg);
    setupWALink('wa-ptm-mother', mMob, mMsg);
    setupWALink('wa-ptm-father', fMob, fMsg);
}

function setupWALink(btnId, mobile, msg) {
    const btn = document.getElementById(btnId);
    if (mobile && mobile.length === 10) {
        btn.href = `https://wa.me/91${mobile}?text=${msg}`;
        btn.style.pointerEvents = 'auto';
        btn.style.opacity = '1';
    } else {
        btn.href = "#";
        btn.style.pointerEvents = 'none';
        btn.style.opacity = '0.5';
    }
}

// Add PTM Record to Database
async function addPTMRecord() {
    const ptmMonth = document.getElementById('ptm-month').value;
    const monthYearStr = new Date(ptmMonth + "-01").toLocaleString('default', { month: 'long', year: 'numeric' });

    const data = {
        institute_id: sessionInstID,
        month_year: monthYearStr,
        ptm_date: document.getElementById('ptm-date').value,
        start_time: document.getElementById('ptm-start').value,
        end_time: document.getElementById('ptm-end').value,
        slot_duration: parseInt(document.getElementById('ptm-duration').value),
        status: document.getElementById('ptm-status').value,
        roll_number: document.getElementById('ptm-roll').value.trim().toUpperCase(),
        student_name: document.getElementById('ptm-sname').value,
        course_name: document.getElementById('ptm-course').value,
        teacher_id: document.getElementById('ptm-tid').value,
        teacher_name: document.getElementById('ptm-tname').value,
        slot_time: document.getElementById('ptm-slot-time').value,
        teacher_mobile: document.getElementById('ptm-tmob').value,
        mother_mobile: document.getElementById('ptm-mmob').value,
        father_mobile: document.getElementById('ptm-fmob').value,
        remarks: document.getElementById('ptm-remarks').value
    };

    if (!data.roll_number || !data.slot_time) {
        return alert("Error: Please fetch and allocate a slot before saving.");
    }

    const { error } = await db.from('ptm_schedule').insert([data]);

    if (error) {
        if (error.code === '23505') {
            alert("Database Error: This slot is either already taken OR the student already has a PTM booked for this month.");
        } else {
            alert("Save Error: " + error.message);
        }
    } else {
        alert(`Success! Slot ${data.slot_time} booked for ${data.student_name}. You can now use the WhatsApp buttons to inform everyone.`);
    }
}





// Fetch Existing PTM Record by Roll Number
async function fetchPTMRecordByRoll() {
    const roll = prompt("Enter Student Roll Number to fetch PTM record:");
    if (!roll) return;

    const ptmMonth = document.getElementById('ptm-month').value;
    if (!ptmMonth) return alert("Please select the Month & Year in Step 1 first.");
    
    const monthYearStr = new Date(ptmMonth + "-01").toLocaleString('default', { month: 'long', year: 'numeric' });

    const { data, error } = await db.from('ptm_schedule')
        .select('*')
        .eq('roll_number', roll.toUpperCase())
        .eq('month_year', monthYearStr)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (error || !data) return alert("No PTM record found for this student in " + monthYearStr + ".");

    // Populate UI Step 1 (Config)
    document.getElementById('ptm-date').value = data.ptm_date;
    document.getElementById('ptm-start').value = data.start_time;
    document.getElementById('ptm-end').value = data.end_time;
    document.getElementById('ptm-duration').value = data.slot_duration;
    document.getElementById('ptm-status').value = data.status;

    // Populate UI Step 2 (Booking & Details)
    document.getElementById('ptm-roll').value = data.roll_number;
    document.getElementById('ptm-sname').value = data.student_name;
    document.getElementById('ptm-course').value = data.course_name;
    document.getElementById('ptm-tid').value = data.teacher_id;
    document.getElementById('ptm-tname').value = data.teacher_name;
    document.getElementById('ptm-slot-time').value = data.slot_time;
    document.getElementById('ptm-tmob').value = data.teacher_mobile || "";
    document.getElementById('ptm-mmob').value = data.mother_mobile || "";
    document.getElementById('ptm-fmob').value = data.father_mobile || "";
    document.getElementById('ptm-remarks').value = data.remarks || "";

    // Reactivate WhatsApp communication buttons
    generatePTMWhatsAppLinks(
        data.month_year, data.ptm_date, data.start_time, data.end_time, 
        data.slot_time, data.teacher_name, data.teacher_mobile, 
        data.mother_mobile, data.father_mobile
    );

    alert("PTM Record for " + data.student_name + " loaded successfully!");
}







/* ==========================================
   25. BATCH MASTER LOGIC (TABLE: "list")
   ========================================== */

// 1. Initialize Date on Load
document.addEventListener('DOMContentLoaded', () => {
    const bmDate = document.getElementById('bm-date');
    if(bmDate) bmDate.value = new Date().toISOString().split('T')[0];
});

// 2. Clear Form
function clearBatchMaster() {
    ['bm-roll','bm-sname','bm-course','bm-tid','bm-tname','bm-bname','bm-remarks'].forEach(id => {
        document.getElementById(id).value = "";
    });
    document.getElementById('bm-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('bm-list-area').style.display = 'none';
}

// 3. Auto-populate from multiple tables
async function autopopulateBatchMaster() {
    const roll = document.getElementById('bm-roll').value.trim().toUpperCase();
    if(!roll) return alert("Please enter a Roll Number first.");

    // A. Fetch from STUDENTS table
    const { data: stu, error: stuErr } = await db.from('students')
        .select('full_name, course').eq('roll_number', roll).eq('institute_id', sessionInstID).maybeSingle();

    if (stuErr || !stu) return alert("Student not found in admission records.");
    
    document.getElementById('bm-sname').value = stu.full_name;
    document.getElementById('bm-course').value = stu.course || "N/A";

    // B. Fetch linked Teacher ID from STUDENT_ALLOCATIONS
    const { data: alloc } = await db.from('student_allocations')
        .select('teacher_id').eq('roll_number', roll).eq('institute_id', sessionInstID).maybeSingle();

    if (alloc && alloc.teacher_id) {
        document.getElementById('bm-tid').value = alloc.teacher_id;

        // C. Fetch Teacher Name from TEACHER_DETAILS
        const { data: teacher } = await db.from('teacher_details')
            .select('teacher_name').eq('id', alloc.teacher_id).eq('institute_id', sessionInstID).maybeSingle();
        
        if (teacher) document.getElementById('bm-tname').value = teacher.teacher_name;

        // D. Fetch Batch Name from BATCHES table using Teacher ID
        const { data: batch } = await db.from('batches')
            .select('batch_name').eq('teacher_id', alloc.teacher_id).eq('institute_id', sessionInstID).maybeSingle();
        
        if (batch) document.getElementById('bm-bname').value = batch.batch_name;
        else document.getElementById('bm-bname').value = "No Batch Assigned";

    } else {
        alert("This student is not allocated to a teacher yet. Go to Module 18 (Student Allocation) first.");
        document.getElementById('bm-tid').value = "N/A";
        document.getElementById('bm-tname').value = "N/A";
        document.getElementById('bm-bname').value = "N/A";
    }
}

// 4. ADD RECORD to "list" table
async function addBatchMasterRecord() {
    const data = {
        institute_id: sessionInstID,
        date_today: document.getElementById('bm-date').value,
        roll_number: document.getElementById('bm-roll').value.trim().toUpperCase(),
        student_name: document.getElementById('bm-sname').value,
        course_name: document.getElementById('bm-course').value,
        teacher_id: document.getElementById('bm-tid').value,
        teacher_name: document.getElementById('bm-tname').value,
        batch_name: document.getElementById('bm-bname').value,
        remarks: document.getElementById('bm-remarks').value
    };

    if (!data.roll_number || !data.student_name) return alert("Please Auto-Fill the student details first.");

    const { error } = await db.from('list').insert([data]);

    if (error) alert("Error saving record: " + error.message);
    else {
        alert("Success! Record added to Batch Master.");
        clearBatchMaster();
    }
}

// 5. FETCH RECORD (By Roll Number)
async function fetchBatchMasterRecord() {
    const roll = prompt("Enter Student Roll Number to fetch from Batch Master:");
    if (!roll) return;

    const { data, error } = await db.from('list')
        .select('*').eq('roll_number', roll.toUpperCase()).eq('institute_id', sessionInstID).order('created_at', {ascending: false}).limit(1).maybeSingle();

    if (error || !data) return alert("No Batch Master record found for Roll Number: " + roll);

    document.getElementById('bm-date').value = data.date_today || "";
    document.getElementById('bm-roll').value = data.roll_number;
    document.getElementById('bm-sname').value = data.student_name || "";
    document.getElementById('bm-course').value = data.course_name || "";
    document.getElementById('bm-tid').value = data.teacher_id || "";
    document.getElementById('bm-tname').value = data.teacher_name || "";
    document.getElementById('bm-bname').value = data.batch_name || "";
    document.getElementById('bm-remarks').value = data.remarks || "";
    
    alert("Record Loaded Successfully.");
}

// 6. LIST ALL STUDENTS (By Batch Name - Case Insensitive)
async function listAllByBatch() {
    const bName = prompt("Enter Batch Name to view list of students:");
    if (!bName) return;

    // Use .ilike() for Case Insensitive matching
    const { data, error } = await db.from('list')
        .select('*')
        .eq('institute_id', sessionInstID)
        .ilike('batch_name', `%${bName}%`)
        .order('student_name', { ascending: true });

    if (error) return alert("Error fetching list: " + error.message);

    const listArea = document.getElementById('bm-list-area');
    const tbody = document.getElementById('bm-list-body');
    const title = document.getElementById('bm-list-title');

    if (!data || data.length === 0) {
        listArea.style.display = 'none';
        return alert("No students found assigned to Batch matching: " + bName);
    }

    // Render Table Rows
    tbody.innerHTML = data.map(row => `
        <tr style="border-bottom: 1px solid #ddd;">
            <td style="padding:10px;"><b>${row.batch_name}</b></td>
            <td style="padding:10px;">${row.roll_number}</td>
            <td style="padding:10px;">${row.student_name}</td>
            <td style="padding:10px;">${row.teacher_id}</td>
            <td style="padding:10px;">${row.teacher_name}</td>
            <td style="padding:10px;">${row.course_name}</td>
        </tr>
    `).join('');

    title.innerText = `Search Results for Batch: "${bName}" (${data.length} students)`;
    listArea.style.display = 'block';
    listArea.scrollIntoView({ behavior: 'smooth' });
}







/* ==========================================
   ROLE-BASED TAB VISIBILITY (ADD-ON)
   ========================================== */
async function applyRoleVisibility() {
    const { data: { user } } = await db.auth.getUser();
    if (!user) return; 

    // Fetch the user's role from the database
    const { data: profile } = await db.from('profiles').select('role').eq('id', user.id).single();
    if (!profile) return;

    const role = profile.role;
    
    // --- NEW: HIDE DASHBOARD STATS FOR STUDENTS & TEACHERS ---
    if (role !== 'Owner') {
        document.getElementById('home-user-view').style.display = 'none';
        document.getElementById('home-visitor-view').style.display = 'block';
    }
    // ---------------------------------------------------------

    const tabs = document.querySelectorAll('aside.sidebar .nav-tab');
    const studentAllowed = ['home', 'login', 'students', 'student-p', 'id-gen', 'cert-gen', 'tracking', 'exam-mod', 'message-corner', 'calendar-mod', 'scholarship-mod', 'ptm-mod'];
    const teacherBlocked = ['fee', 'reminder'];

    // Apply the rules by reading the 'onclick' attribute of each tab
    tabs.forEach(tab => {
        const clickAttr = tab.getAttribute('onclick') || "";
        const match = clickAttr.match(/showSection\('([^']+)'\)/);
        
        if (match) {
            const sectionId = match[1];
            
            if (role === 'Owner') {
                tab.style.display = ''; // Shows all 25 tabs
            } else if (role === 'Teacher') {
                tab.style.display = teacherBlocked.includes(sectionId) ? 'none' : ''; // Hides Fee and Reminder
            } else if (role === 'Student') {
                tab.style.display = studentAllowed.includes(sectionId) ? '' : 'none'; // Shows only the 10 listed + Home/Login
            }
        }
    });
}
// Observe changes to the Auth Status Bar to trigger visibility rules securely on login/page load
const authObserver = new MutationObserver((mutations) => {
    mutations.forEach(mutation => {
        if (mutation.attributeName === 'style') {
            const displayStyle = document.getElementById('auth-status-bar').style.display;
            if (displayStyle === 'flex') {
                applyRoleVisibility();
            } else {
                // Restore all tabs when logged out
                document.querySelectorAll('aside.sidebar .nav-tab').forEach(tab => tab.style.display = '');
            }
        }
    });
});

// Initialize the observer
const authBar = document.getElementById('auth-status-bar');
if (authBar) {
    authObserver.observe(authBar, { attributes: true });
    // Safety check in case the session loaded faster than the observer
    if (authBar.style.display === 'flex') applyRoleVisibility();
}













    </script>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
    .then(() => console.log("IMS Service Worker Registered"))
    .catch(err => console.log("Service Worker Failed", err));
}





/* ==========================================
   FEE SECTION: EDIT STUDENT RECORD
   ========================================== */
async function editFeeRecordByRoll() {
    const roll = document.getElementById('fee-roll').value.trim().toUpperCase();
    if (!roll) return alert("Please enter and FETCH a Roll Number first.");

    // Step 1: Find the internal Student ID
    const { data: detail, error: fetchErr } = await db.from('student_details')
        .select('student_id')
        .eq('roll_number', roll)
        .eq('institute_id', sessionInstID)
        .maybeSingle();

    if (fetchErr || !detail) return alert("Roll number not found. Fetch the details first.");

    // Step 2: Prepare updated data from the UI
    const updatedData = {
        full_name: document.getElementById('fee-name').value,
        course: document.getElementById('fee-course').value,
        total_fees: parseFloat(document.getElementById('fee-total').value) || 0,
        status: document.getElementById('fee-status').value, // This is key for Alumni testing
        due_dates: document.getElementById('fee-due-dates').value
    };

    // Step 3: Update the Master Students table
    const { error: updateErr } = await db.from('students')
        .update(updatedData)
        .eq('id', detail.student_id);

    if (updateErr) {
        alert("Update Failed: " + updateErr.message);
    } else {
        alert("Success: Record for " + roll + " has been updated in the database.");
    }
}
</script>
<!-- PWA Install Button -->
<button id="pwa-install-btn" style="display: none;">
    <i class="fas fa-download"></i> INSTALL APP
</button>

</body>
</html>
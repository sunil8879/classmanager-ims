<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Supabase JS Library CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Class Manager - IMS</title>
    <!-- PWA Setup -->
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --aquamarine: #7FFFD4;
            --modern-blue: #007bff;
            --deep-blue: #0056b3;
            --white: #ffffff;
            --dark: #333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--white);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Header Section --- */
        header {
            background: linear-gradient(135deg, var(--white), var(--aquamarine));
            padding: 40px 5%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            border-bottom: 5px solid var(--modern-blue);
        }

        .logo-container {
            width: 50px;
            height: 50px;
            perspective: 1000px;
        }

        .rotating-logo {
            width: 100%;
            height: 100%;
            background: var(--modern-blue);
            border-radius: 20%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            animation: rotate3D 5s linear infinite;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        @keyframes rotate3D {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }

        .title-box {
            transform: rotate(-5deg) skew(5deg); /* Flamboyant Tilt */
            text-align: center;
        }

        .main-title {
            font-size: 4rem;
            font-weight: 900;
            line-height: 1;
            position: relative;
            display: inline-block;
            text-transform: uppercase;
            /* 3D Effect */
            text-shadow: 
                0 1px 0 #ccc, 0 2px 0 #c9c9c9, 0 3px 0 #bbb, 0 4px 0 #b9b9b9,
                0 5px 0 #aaa, 0 6px 1px rgba(0,0,0,.1), 0 0 5px rgba(0,0,0,.1),
                0 1px 3px rgba(0,0,0,.3), 0 3px 5px rgba(0,0,0,.2),
                0 5px 10px rgba(0,0,0,.25), 0 10px 10px rgba(0,0,0,.2),
                0 20px 20px rgba(0,0,0,.15);
            /* Red-Black Split */
            background: linear-gradient(to bottom, #ff0000 50%, #000000 50%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tagline {
            display: block;
            font-size: 1.5rem;
            color: var(--modern-blue);
            font-weight: 600;
            margin-top: 10px;
            letter-spacing: 2px;
        }

        /* --- Main Layout --- */
        .app-container {
            display: flex;
            flex: 1;
        }

        /* --- Sidebar Tabs --- */
        nav.sidebar {
            width: 280px;
            background: var(--modern-blue);
            padding: 20px 0;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .nav-tab {
            width: 100%;
            padding: 15px 25px;
            border: none;
            background: transparent;
            color: white;
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 5px solid transparent;
        }

        .nav-tab:hover, .nav-tab.active {
            background: var(--deep-blue);
            border-left: 5px solid var(--aquamarine);
            padding-left: 35px;
        }

        .nav-tab i {
            width: 20px;
            text-align: center;
        }

        /* --- Content Area --- */
        main.content {
            flex: 1;
            padding: 40px;
            background: #f4f7f6;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Home Page Specific Styling --- */
        .hero-title { font-size: 2.5rem; color: var(--dark); margin-bottom: 20px; }
        .bullet-list { list-style: none; margin-bottom: 30px; }
        .bullet-list li { margin: 10px 0; padding-left: 30px; position: relative; font-size: 1.1rem; }
        .bullet-list li::before {
            content: 'âœ•'; color: red; position: absolute; left: 0; font-weight: bold;
        }
        .solve-text { color: var(--modern-blue); font-weight: 700; font-size: 1.5rem; margin-top: 20px; }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-top: 4px solid var(--aquamarine);
        }

        .card h3 { color: var(--modern-blue); margin-bottom: 10px; }

        /* --- Footer --- */
        footer {
            background: #1a1a1a;
            color: white;
            padding: 60px 5% 20px;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-col h4 {
            color: var(--aquamarine);
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .footer-col ul { list-style: none; }
        .footer-col ul li { margin-bottom: 10px; }
        .footer-col ul li a { color: #ccc; text-decoration: none; transition: 0.3s; }
        .footer-col ul li a:hover { color: white; }

        .footer-bottom {
            border-top: 1px solid #333;
            padding-top: 20px;
            text-align: center;
            font-size: 0.9rem;
        }

        .india-flag { width: 20px; vertical-align: middle; }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 992px) {
            .app-container { flex-direction: column; }
            nav.sidebar { width: 100%; display: flex; overflow-x: auto; white-space: nowrap; }
            .nav-tab { display: inline-flex; width: auto; }
            .main-title { font-size: 2.5rem; }
            header { flex-direction: column; text-align: center; }
        }





/* Update Sidebar to Aquamarine */
nav.sidebar {
    background: #7FFFD4 !important; /* Aquamarine */
}

/* Make Tab text dark for contrast against Aquamarine */
.nav-tab {
    color: #000 !important;
    font-weight: 600;
}

.nav-tab:hover, .nav-tab.active {
    background: #007bff !important; /* Modern Blue */
    color: #fff !important;
}

/* Form & Input Styling */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.input-group {
    display: flex;
    flex-direction: column;
}

.input-group label {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 5px;
    color: #444;
}

input, select, textarea {
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 0.95rem;
}

input:focus {
    border-color: #007bff;
    outline: none;
}

.button-row {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.btn-add { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
.btn-edit { background: #f39c12; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
.btn-fetch { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }

.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
}

.stat-card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border-bottom: 4px solid #007bff;
}

.stat-card h4 { font-size: 1.5rem; color: #007bff; }



#pwa-install-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, var(--aquamarine), var(--modern-blue));
    color: var(--dark);
    border: none;
    padding: 15px 25px;
    border-radius: 50px;
    font-weight: 800;
    cursor: pointer;
    z-index: 10000;
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    transition: transform 0.3s ease;
}

#pwa-install-btn:hover {
    transform: scale(1.1) translateY(-5px);
}

#pwa-install-btn i {
    font-size: 1.2rem;
}

.logo-container { width: 60px !important; height: 60px !important; }
.rotating-logo img { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <!-- Provision for Logo -->
            <div class="rotating-logo">
    <img src="classmanager.png" alt="ClassManager Logo">
</div>

        </div>
        <div class="title-box">
            <h1 class="main-title">CLASS MANAGER- IMS</h1>
            <span class="tagline">Track Right, Grow Bright.</span>
        </div>
    </header>

    <div class="app-container">
        <aside class="sidebar">
            <button class="nav-tab active" onclick="showSection('home')"><i class="fas fa-home"></i> Home</button>
            <button class="nav-tab" onclick="showSection('login')"><i class="fas fa-user-lock"></i> Login System</button>
            <button class="nav-tab" onclick="showSection('students')"><i class="fas fa-user-graduate"></i> Student Management</button>
            <button class="nav-tab" onclick="showSection('fee')"><i class="fas fa-money-bill-wave"></i> Fee Management</button>
            <button class="nav-tab" onclick="showSection('batch')"><i class="fas fa-layer-group"></i> Batch Management</button>
            <button class="nav-tab" onclick="showSection('attendance')"><i class="fas fa-clipboard-check"></i> Attendance</button>
            <button class="nav-tab" onclick="showSection('admin')"><i class="fas fa-user-shield"></i> Admin Dashboard</button>
            <button class="nav-tab" onclick="showSection('reminder')"><i class="fas fa-bell"></i> Fee Reminder System</button>
            <button class="nav-tab" onclick="showSection('leads')"><i class="fas fa-funnel-dollar"></i> Lead Management</button>
            <button class="nav-tab" onclick="showSection('expense')"><i class="fas fa-wallet"></i> Expense Tracking</button>
            <button class="nav-tab" onclick="showSection('teacher')"><i class="fas fa-chalkboard-teacher"></i> Teacher Portal</button>
            <button class="nav-tab" onclick="showSection('student-p')"><i class="fas fa-user"></i> Students Portal</button>
            <button class="nav-tab" onclick="showSection('id-gen')"><i class="fas fa-id-card"></i> ID Card Generator</button>
            <button class="nav-tab" onclick="showSection('cert-gen')"><i class="fas fa-certificate"></i> Certificate Generator</button>
            <button class="nav-tab" onclick="showSection('tracking')"><i class="fas fa-chart-line"></i> Performance Tracking</button>
        </aside>

        <main class="content" id="main-content">
            <!-- DEFAULT HOME PAGE -->
            <section id="home" class="content-section active">
                <div class="hero-title">Still managing your institute manually?</div>
                <ul class="bullet-list">
                    <li>Tracking fees in notebooks?</li>
                    <li>Forgetting pending payments?</li>
                    <li>Managing students in Excel?</li>
                    <li>Confused batch records?</li>
                </ul>
                <div class="solve-text">ClassManager solves all this.</div>

                <hr style="margin: 40px 0;">

                <h2 class="hero-title">Everything you need to manage your institute</h2>
                <div class="feature-grid">
                    <div class="card">
                        <h3>Student Management</h3>
                        <p>Centralized database for all student profiles and documents.</p>
                    </div>
                    <div class="card">
                        <h3>Fee Tracking</h3>
                        <p>Automated receipts and pending fee alerts for parents.</p>
                    </div>
                    <div class="card">
                        <h3>Batch Management</h3>
                        <p>Organize students into batches with scheduled timings.</p>
                    </div>
                    <div class="card">
                        <h3>Attendance Tracking</h3>
                        <p>Digital attendance with instant SMS notification to parents.</p>
                    </div>
                    <div class="card">
                        <h3>Reports & Dashboard</h3>
                        <p>Comprehensive visual reports for growth and revenue.</p>
                    </div>
                    <div class="card">
                        <h3>Enquiry Management</h3>
                        <p>Convert leads into admissions with effective follow-ups.</p>
                    </div>
                </div>

                <hr style="margin: 40px 0;">

                <h2 class="hero-title">Why coaching institutes choose ClassManager</h2>
                <div class="feature-grid">
                    <div class="card"><li>Save hours daily</li></div>
                    <div class="card"><li>Never miss fee collection</li></div>
                    <div class="card"><li>Stay fully organized</li></div>
                    <div class="card"><li>Access anywhere anytime</li></div>
                    <div class="card"><li>Works on mobile and desktop</li></div>
                </div>

                <div style="margin-top: 50px; text-align: center; background: var(--aquamarine); padding: 30px; border-radius: 15px;">
                    <h3>Built for coaching institutes</h3>
                    <p>Secure and reliable | Made in India ðŸ‡®ðŸ‡³</p>
                    <p><strong>Trusted by 100+ institutes</strong></p>
                </div>
            </section>

          <!-- 1. LOGIN SYSTEM -->

<section id="login" class="content-section">
    <div style="display: flex; gap: 40px; flex-wrap: wrap;">
        <!-- Signup -->
        <div class="card" style="flex: 1; min-width: 320px;">
            <h3>Signup</h3>
            <div class="form-grid" style="grid-template-columns: 1fr;" id="signup-form">
                <input type="text" id="sig-name" placeholder="Full Name">
                <select id="sig-role">
                    <option value="">Select Status</option>
                    <option>Owner</option>
                    <option>Teacher</option>
                    <option>Student</option>
                </select>
                <input type="email" id="sig-email" placeholder="Email Id">
                
                <div style="position: relative;">
                    <input type="password" id="sig-pass" placeholder="Password (Min 6 chars)" style="width: 100%;">
                    <i class="fas fa-eye" onclick="togglePass('sig-pass')" style="position: absolute; right: 10px; top: 12px; cursor: pointer; color: #666;"></i>
                </div>

                <select id="sig-state">
                    <option value="">Select State / UT</option>
                    <optgroup label="States">
                        <option>Andhra Pradesh</option><option>Arunachal Pradesh</option><option>Assam</option><option>Bihar</option><option>Chhattisgarh</option><option>Goa</option><option>Gujarat</option><option>Haryana</option><option>Himachal Pradesh</option><option>Jharkhand</option><option>Karnataka</option><option>Kerala</option><option>Madhya Pradesh</option><option>Maharashtra</option><option>Manipur</option><option>Meghalaya</option><option>Mizoram</option><option>Nagaland</option><option>Odisha</option><option>Punjab</option><option>Rajasthan</option><option>Sikkim</option><option>Tamil Nadu</option><option>Telangana</option><option>Tripura</option><option>Uttar Pradesh</option><option>Uttarakhand</option><option>West Bengal</option>
                    </optgroup>
                    <optgroup label="Union Territories">
                        <option>Andaman and Nicobar Islands</option><option>Chandigarh</option><option>Dadra and Nagar Haveli and Daman and Diu</option><option>Delhi</option><option>Jammu and Kashmir</option><option>Ladakh</option><option>Lakshadweep</option><option>Puducherry</option>
                    </optgroup>
                </select>

                <input type="text" id="sig-mobile" placeholder="10-Digit Mobile Number" maxlength="10">
                
                <div class="button-row">
                    <button class="btn-fetch" onclick="handleSignup()">Sign up</button>
                    <button class="btn-edit" style="background:#666;" onclick="clearForm('signup-form')">Clear</button>
                </div>
            </div>
        </div>

        <!-- Login -->
        <div class="card" style="flex: 1; min-width: 320px;">
            <h3>Login</h3>
            <div class="form-grid" style="grid-template-columns: 1fr;" id="login-form">
                <select id="log-role">
                    <option value="">Select Status</option>
                    <option>Owner</option>
                    <option>Teacher</option>
                    <option>Student</option>
                </select>
                <input type="email" id="log-email" placeholder="Email Id">
                <div style="position: relative;">
                    <input type="password" id="log-pass" placeholder="Password">
                    <i class="fas fa-eye" onclick="togglePass('log-pass')" style="position: absolute; right: 10px; top: 12px; cursor: pointer; color: #666;"></i>
                </div>
                <div class="button-row">
                    <button class="btn-add" onclick="handleLogin()">Login</button>
                    <button class="btn-edit" style="background:#666;" onclick="clearForm('login-form')">Clear</button>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- 2. STUDENT MANAGEMENT -->
<section id="students" class="content-section">
    <div class="card">
        <h3><i class="fas fa-user-plus"></i> Student Management</h3>
        <div class="form-grid">
            <div class="input-group"><label>Admission Date</label><input type="date" id="stu-date"></div>
            <div class="input-group"><label>Full Name</label><input type="text" id="stu-name" placeholder="Full Name"></div>
            <div class="input-group"><label>Mobile Number</label><input type="text" id="stu-mobile" placeholder="Mobile"></div>
            <div class="input-group"><label>Father's Mobile</label><input type="text" id="stu-father"></div>
            <div class="input-group"><label>Mother's Mobile</label><input type="text" id="stu-mother"></div>
            <div class="input-group"><label>Class / Standard</label><input type="text" id="stu-standard"></div>
            <div class="input-group"><label>Batch Time</label><input type="time" id="stu-batch"></div>
            <div class="input-group"><label>Course</label><input type="text" id="stu-course" placeholder="Course"></div>
            <div class="input-group"><label>Total Fees</label><input type="number" id="stu-total"></div>
            <div class="input-group"><label>Paid Amount</label><input type="number" id="stu-paid"></div>
            <!-- Extra fields needed for ID Card -->
           <div class="input-group">
    <label>Roll Number (Auto-Generated)</label>
    <input type="text" id="stu-roll" placeholder="Assigned on Save" readonly style="background: #eee;">
</div>
            <div class="input-group"><label>Course End Date</label><input type="date" id="stu-end-date"></div>
        </div>
        <div class="button-row">
           <button class="btn-add" onclick="addStudent()">ADD Student</button>
           <button class="btn-edit" onclick="editStudent()">EDIT Details</button>
           <button class="btn-fetch" onclick="fetchStudentByMobile()">FETCH Details</button>
        </div>
    </div>
</section>

<!-- 3. FEE MANAGEMENT -->
<!-- 3. FEE MANAGEMENT -->
<section id="fee" class="content-section">
    <!-- Part 1: FEE DETAILS -->
    <div class="card" style="margin-bottom: 30px;">
        <h3>1. FEE DETAILS</h3>
        <div class="form-grid">
            <div class="input-group"><label>Date Today</label><input type="date" id="fee-today"></div>
            <div class="input-group"><label>Roll Number</label><input type="text" id="fee-roll" placeholder="IMS-2026-XXXX"></div>
            <div class="input-group"><label>Full Name</label><input type="text" id="fee-name" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Date of Joining</label><input type="text" id="fee-join-date" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Course Name</label><input type="text" id="fee-course" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Total Fees</label><input type="number" id="fee-total" oninput="calcPendingFee()"></div>
            <div class="input-group"><label>Amount Now Paying</label><input type="number" id="fee-paid-now" oninput="calcPendingFee()" placeholder="Enter payment"></div>
            <div class="input-group"><label>Previously Paid</label><input type="number" id="fee-prev-paid" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Pending Fees</label><input type="number" id="fee-pending" readonly style="background:#eee;"></div>
            <div class="input-group"><label>Due Dates (e.g. March 2026)</label><input type="text" id="fee-due-dates" placeholder="March 2026, July 2026"></div>
            <div class="input-group">
                <label>Status</label>
                <select id="fee-status">
                    <option value="Active">Active</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
        </div>
        <div class="button-row">
            <button class="btn-fetch" onclick="fetchFeeByRoll()">FETCH Details</button>
            <button class="btn-add" onclick="saveFeeUpdate('add')">ADD Payment</button>
            <button class="btn-edit" onclick="saveFeeUpdate('edit')">EDIT Details</button>
        </div>
    </div>

    <!-- Part 2: FEES PORTAL -->
    <div class="card" style="margin-bottom: 30px; border-top-color: #007bff;">
        <h3>2. FEES PORTAL</h3>
        <div class="form-grid">
            <div class="input-group"><label>Select Month & Year</label><input type="month" id="portal-month" onchange="loadFeesPortal()"></div>
            <div class="input-group"><label>Select Year Only</label><input type="number" id="portal-year" value="2026" onchange="loadFeesPortal()"></div>
        </div>
        <div class="dashboard-stats">
            <div class="stat-card"><p>Active Students</p><h4 id="stat-active-count">0</h4></div>
            <div class="stat-card"><p>Total Received</p><h4 id="stat-total-received">â‚¹ 0</h4></div>
            <div class="stat-card"><p>Total Pending</p><h4 id="stat-total-pending" style="color:red;">â‚¹ 0</h4></div>
            <div class="stat-card"><p>Yearly Collection</p><h4 id="stat-yearly">â‚¹ 0</h4></div>
        </div>
    </div>

    <!-- Part 3: PAYMENT LOG -->
    <div class="card">
        <h3>3. PAYMENT LOG</h3>
        <div class="form-grid">
            <div class="input-group"><label>Select Month & Year</label><input type="month" id="log-month"></div>
            <div class="input-group"><label>Student Roll Number</label><input type="text" id="log-roll" placeholder="IMS-XXXX"></div>
            <button class="btn-fetch" style="margin-top:25px;" onclick="fetchPaymentLog()">View Payments</button>
        </div>
        <div id="log-result" style="margin-top:20px; padding:15px; background:#f9f9f9; border-radius:8px; line-height:2;">
            <i>Payments will appear here...</i>
        </div>
    </div>
</section>

<!-- 4. BATCH MANAGEMENT -->
<section id="batch" class="content-section">
    <div class="card">
        <h3>Batch Management</h3>
        <div class="form-grid">
            <input type="date">
            <input type="text" placeholder="Teacher Name">
            <input type="text" placeholder="Teacher ID">
            <input type="text" placeholder="Batch Name">
            <input type="time" placeholder="Batch Time">
            <input type="text" placeholder="Subject Name">
            <input type="number" placeholder="Students Allotted">
            <input type="text" placeholder="Remarks">
        </div>
        <div class="button-row">
          <button class="btn-add" onclick="addBatch()">ADD Batch</button>
<button class="btn-edit" onclick="editBatch()">EDIT (by ID)</button>
<button class="btn-fetch" onclick="fetchBatch()">FETCH (by ID)</button>
        </div>
    </div>
</section>

<!-- 5. ATTENDANCE -->
<!-- 5. ATTENDANCE -->
<section id="attendance" class="content-section">
    <div class="card">
        <h3><i class="fas fa-clipboard-check"></i> Attendance Tracker</h3>
        
        <!-- Student Link Fields -->
        <div class="form-grid">
            <div class="input-group">
                <label>Student Roll Number</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="attn-roll" placeholder="e.g. IMS-2026-1234">
                    <button class="btn-fetch" onclick="fetchStudentForAttn()" style="padding: 5px 10px;"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <div class="input-group">
                <label>Student Name</label>
                <input type="text" id="attn-name" readonly style="background: #eee;" placeholder="Fetched automatically">
            </div>
        </div>

        <hr style="margin: 20px 0;">

        <div class="form-grid">
            <div class="input-group">
                <label>View Monthly Record (Old Calendar)</label>
                <input type="month" id="attn-month-view">
            </div>
            <div class="input-group">
                <label>Total Present</label>
                <input type="number" id="attn-total-p" placeholder="0" readonly>
            </div>
            <div class="input-group">
                <label>Total Absent</label>
                <input type="number" id="attn-total-a" placeholder="0" readonly>
            </div>
        </div>

        <!-- Hidden Date Picker that will be triggered by buttons -->
        <input type="date" id="attn-date-picker" style="display: none;">

        <div class="button-row">
            <button class="btn-add" onclick="triggerAttendance('Present')">
                <i class="fas fa-check-circle"></i> MARK PRESENT
            </button>
            <button class="btn-edit" style="background: #e74c3c;" onclick="triggerAttendance('Absent')">
                <i class="fas fa-times-circle"></i> MARK ABSENT
            </button>
            <button class="btn-fetch" onclick="fetchAttendanceByPrompt()">
                <i class="fas fa-sync"></i> Fetch Statistics
            </button>
        </div>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">* Clicking Mark buttons will open a calendar to select the date.</p>
    </div>
</section>

<!-- 6. ADMIN DASHBOARD -->
<section id="admin" class="content-section">
    <div class="dashboard-stats">
        <div class="stat-card"><p>Total Students</p><h4>120</h4></div>
        <div class="stat-card"><p>Total Revenue</p><h4>â‚¹ 4.5L</h4></div>
        <div class="stat-card"><p>Pending Fees</p><h4 style="color: red;">â‚¹ 85k</h4></div>
        <div class="stat-card"><p>Today's Attendance</p><h4>92%</h4></div>
    </div>
    <div class="card" style="margin-top:20px;">
        <h3>Upcoming Fee Reminders</h3>
        <p>No immediate reminders.</p>
    </div>
</section>

<!-- 7. FEE REMINDER -->
<section id="reminder" class="content-section">
    <div class="card">
        <h3>Fee Reminder System</h3>
        <input type="month" style="margin-bottom: 20px;">
        <div class="stat-card" style="margin-bottom: 20px;">
            <p>Total Pending Students</p><h4>15</h4>
        </div>
        <div class="button-row">
           <!-- Find these in Section #7 -->
<button class="btn-fetch" onclick="sendReminder('SMS')">
    <i class="fas fa-sms"></i> Send SMS Reminder
</button>
<button class="btn-add" style="background: #25D366;" onclick="sendReminder('WA')">
    <i class="fab fa-whatsapp"></i> WhatsApp Reminder
</button>
        </div>
    </div>
</section>

<!-- 8. LEAD MANAGEMENT -->
<section id="leads" class="content-section">
    <div class="card">
        <h3>Lead Management</h3>
        <div class="form-grid">
            <input type="text" placeholder="Full Name">
            <input type="text" placeholder="Contact">
            <input type="email" placeholder="Email">
            <input type="text" placeholder="Interested Course">
            <input type="date" placeholder="Date of Visit">
            <input type="text" placeholder="Reference">
            <select>
                <option>Status: Follow up</option>
                <option>Converted</option>
                <option>Not interested</option>
            </select>
            <input type="text" placeholder="Remarks">
        </div>
        <div class="button-row">
          <button class="btn-add" onclick="addLead()">ADD Lead</button>
<button class="btn-fetch" onclick="fetchLead()">FETCH (Email/Contact)</button>
        </div>
    </div>
</section>

<!-- 9. EXPENSE TRACKING -->
<!-- 9. EXPENSE TRACKING -->
<section id="expense" class="content-section">
    <div class="card">
        <h3><i class="fas fa-wallet"></i> Expense Tracking & Profitability</h3>
        
        <div class="input-group" style="margin-bottom: 20px; max-width: 300px;">
            <label>Select Month</label>
            <input type="month" id="exp-month" onchange="fetchExpense()">
        </div>

        <div class="form-grid">
            <div class="input-group"><label>Rent</label><input type="number" id="exp-rent" value="0" oninput="calcExp()"></div>
            <div class="input-group"><label>Electricity</label><input type="number" id="exp-elec" value="0" oninput="calcExp()"></div>
            <div class="input-group"><label>Maintenance (AC/Fridge)</label><input type="number" id="exp-maint" value="0" oninput="calcExp()"></div>
            <div class="input-group"><label>Teacher Salary</label><input type="number" id="exp-t-sal" value="0" oninput="calcExp()"></div>
            <div class="input-group"><label>Admin Salary</label><input type="number" id="exp-a-sal" value="0" oninput="calcExp()"></div>
            <div class="input-group"><label>Marketing</label><input type="number" id="exp-mark" value="0" oninput="calcExp()"></div>
            <div class="input-group"><label>Other Expenses</label><input type="number" id="exp-other" value="0" oninput="calcExp()"></div>
            <div class="input-group" style="border: 1px solid #7FFFD4; border-radius: 8px; padding: 5px;">
			<div class="input-group" style="border: 1px solid #007bff; border-radius: 8px; padding: 5px;">
    <label style="color: #007bff;">Total Fees Collection (Manual)</label>
    <input type="number" id="exp-fees-coll" value="0" oninput="calcExp()">
</div>
                <label style="color: #0056b3;">Other Income (Sales/Misc)</label>
                <input type="number" id="exp-income" value="0" oninput="calcExp()">
            </div>
        </div>

        <div class="stat-card" style="background: #f8f9fa; margin-top: 20px; border-bottom: 5px solid var(--modern-blue);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; text-align: left;">
                <p>Total Fees Collection: <b id="disp-fees">â‚¹ 0.00</b></p>
                <p>Total Other Income: <b id="disp-other-inc">â‚¹ 0.00</b></p>
                <p>Total Expenses: <b style="color: red;" id="disp-total-exp">â‚¹ 0.00</b></p>
            </div>
            <hr style="margin: 15px 0;">
            <h4 style="color: green; font-size: 1.8rem;">Net Profit: <span id="disp-profit">â‚¹ 0.00</span></h4>
        </div>

        <div class="button-row">
           <button class="btn-add" onclick="saveExpense()">SAVE RECORD</button>
           <button class="btn-fetch" onclick="fetchExpense()">REFRESH DATA</button>
        </div>
    </div>
</section>

<!-- 10. REPORTS -->
<section id="reports" class="content-section">
    <div class="card">
        <h3>Reports Center</h3>
        <ul style="line-height: 2.5;">
            <li><a href="#"><i class="fas fa-file-invoice"></i> Monthly Collection Report</a></li>
            <li><a href="#"><i class="fas fa-user-chart"></i> Student Report</a></li>
            <li><a href="#"><i class="fas fa-layer-group"></i> Batch Report</a></li>
            <li><a href="#"><i class="fas fa-check-double"></i> Attendance Report</a></li>
        </ul>
    </div>
</section>

<!-- 11. TEACHER PORTAL -->
<section id="teacher" class="content-section">
    <div class="card">
        <h3>Teacher Management</h3>
        <div class="form-grid">
            <input type="month">
            <input type="text" placeholder="Teacher Name">
            <input type="number" placeholder="Age">
            <select><option>Male</option><option>Female</option></select>
            <input type="text" placeholder="Teacher ID">
            <input type="date" placeholder="Joining Date">
            <input type="text" placeholder="Qualification">
            <input type="text" placeholder="Subject Taught">
            <input type="number" placeholder="Salary Offered">
        </div>
        <div class="button-row">
         <button class="btn-add" onclick="addTeacherDetails()">ADD Teacher</button>
<button class="btn-fetch" onclick="fetchTeacher()">FETCH (ID)</button>
<button class="btn-edit" onclick="editTeacher()">EDIT (ID)</button>
        </div>
    </div>
</section>

<!-- 12. STUDENT PORTAL (VIEW ONLY) -->
<section id="student-p" class="content-section">
    <div class="card" style="border-top-color: #007bff;">
        <h3>My Portal (View Only)</h3>
        <div class="form-grid">
            <p><b>Name:</b> Rahul Sharma</p>
            <p><b>Roll No:</b> CM102</p>
            <p><b>Course:</b> Mathematics</p>
            <p><b>Enrolled:</b> 12-Jan-2026</p>
            <p><b>Fees Paid:</b> â‚¹ 5,000</p>
            <p style="color: red;"><b>Pending:</b> â‚¹ 2,000</p>
            <p><b>Present Days:</b> 22</p>
            <p><b>Absent Days:</b> 2</p>
        </div>
        <hr>
        <p><i>Remarks: Excellent progress in weekly tests.</i></p>
    </div>
</section>



<!-- 13. ID CARD GENERATOR -->
<!-- 13. ID CARD GENERATOR -->
<section id="id-gen" class="content-section">
    <div class="card">
        <h3><i class="fas fa-id-card"></i> ID Card Generator</h3>
        <p>Enter Student Mobile Number to generate the card:</p>
        
        <div class="form-grid">
            <input type="text" id="id-fetch-mobile" placeholder="Student Mobile Number">
            <button class="btn-fetch" onclick="generateIDCard()">Generate & Preview</button>
        </div>

        <hr style="margin: 20px 0;">

        <!-- ID Card Visual Preview (Hidden by default) -->
        <div id="id-card-preview-area" style="display: none; justify-content: center; margin-top: 20px;">
            <div id="id-card-visual" style="width: 350px; height: 500px; background: white; border: 2px solid #007bff; border-radius: 15px; position: relative; font-family: Arial; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden;">
                
                <!-- Header -->
                <div style="background: #007bff; color: white; padding: 15px; text-align: center;">
                    <h2 id="card-inst-name" style="margin: 0; font-size: 1.2rem;">INSTITUTE NAME</h2>
                    <small id="card-branch-name">Branch Name</small>
                </div>

                <!-- Body -->
                <div style="padding: 20px; text-align: center;">
                    <div style="width: 100px; height: 100px; background: #eee; margin: 0 auto 15px; border: 2px solid #7FFFD4; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #ccc;">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 id="card-student-name" style="color: #333; margin: 5px 0;">Student Name</h2>
                    <p style="margin: 2px 0; color: #666;">Roll No: <b id="card-roll">---</b></p>
                    
                    <div style="text-align: left; margin-top: 20px; font-size: 0.9rem; line-height: 1.6;">
                        <p><b>Course:</b> <span id="card-course">---</span></p>
                        <p><b>Batch:</b> <span id="card-batch">---</span></p>
                        <p><b>Duration:</b> <span id="card-start">---</span> to <span id="card-end">---</span></p>
                    </div>
                </div>

                <!-- Footer / Signatory -->
                <div style="position: absolute; bottom: 0; width: 100%; border-top: 1px dashed #ccc; padding: 15px; text-align: center;">
                    <div style="margin-bottom: 5px; font-family: 'Dancing Script', cursive; font-size: 1.2rem; color: #007bff;">
                       <span id="card-sign-name">Admin</span>
                    </div>
                    <small style="color: #999;">Authorised Signatory</small>
                </div>
            </div>
        </div>
        
        <button id="id-print-btn" class="btn-add" style="display: none; margin: 20px auto;" onclick="printIDCard()">
            <i class="fas fa-print"></i> Print ID Card
        </button>
    </div>
</section>

<!-- 14. CERTIFICATE GENERATOR -->
<!-- 14. CERTIFICATE GENERATOR -->
<section id="cert-gen" class="content-section">
    <div class="card">
        <h3><i class="fas fa-certificate"></i> Professional Certificate Generator</h3>
        <div class="form-grid">
            <input type="text" id="cert-fetch-mobile" placeholder="Enter Student Mobile">
            <button class="btn-fetch" onclick="generateCertificate()">Generate Certificate</button>
        </div>

        <hr style="margin: 30px 0;">

        <!-- Certificate Preview Area -->
        <div id="cert-preview-area" style="display: none; justify-content: center;">
            <div id="certificate-visual" style="width: 800px; height: 600px; background: white; border: 15px double #007bff; padding: 40px; position: relative; font-family: 'Poppins', sans-serif; box-shadow: 0 15px 40px rgba(0,0,0,0.2); background-image: radial-gradient(#7FFFD4 0.5px, transparent 0.5px); background-size: 20px 20px;">
                
                <!-- Logo Provision (Top Right) -->
                <div style="position: absolute; top: 30px; right: 30px; width: 80px; height: 80px;">
                    <img src="classmanager.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
                </div>

                <!-- Certificate Content -->
                <div style="text-align: center; margin-top: 20px;">
                    <h1 style="color: #007bff; font-size: 3.5rem; margin-bottom: 0; font-weight: 800;">CERTIFICATE</h1>
                    <p style="letter-spacing: 5px; color: #333; font-weight: 600;">OF COMPLETION</p>
                    
                    <div style="margin-top: 40px;">
                        <p style="font-size: 1.2rem; color: #666;">This is to certify that</p>
                        <h2 id="cert-name" style="font-size: 2.5rem; color: #ff0000; border-bottom: 2px solid #ccc; display: inline-block; padding: 0 30px; margin: 10px 0;">Student Name</h2>
                        <p style="font-size: 1.1rem; color: #666; margin-top: 15px;">
                            Roll Number: <b id="cert-roll">---</b> | Certificate No: <b id="cert-number" style="color: #007bff;">---</b>
                        </p>
                    </div>

                    <div style="margin-top: 30px; line-height: 1.8;">
                        <p style="font-size: 1.3rem; color: #333;">
                            has <b>Successfully Completed the Course</b> in <br>
                            <span id="cert-course" style="font-size: 1.8rem; color: #007bff; font-weight: 700;">Course Name</span>
                        </p>
                        <p style="font-size: 1.1rem;">Course Duration: <span id="cert-duration">---</span></p>
                    </div>

                    <!-- Signatory Section -->
                    <div style="margin-top: 60px; display: flex; justify-content: space-between; align-items: flex-end; padding: 0 50px;">
                        <div style="text-align: center;">
                            <p style="margin: 0; font-weight: bold; border-top: 1px solid #333; padding-top: 5px;" id="cert-inst-branch">Main Branch</p>
                            <small>Institute Branch</small>
                        </div>
                        <div style="text-align: center;">
                            <p style="margin: 0; font-family: 'Brush Script MT', cursive; font-size: 1.8rem; color: #333;" id="cert-signatory">Admin Name</p>
                            <p style="margin: 0; font-weight: bold; border-top: 1px solid #333; padding-top: 5px;">Authorised Signatory</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button id="cert-print-btn" class="btn-add" style="display: none; margin: 30px auto;" onclick="printCertificate()">
            <i class="fas fa-print"></i> Print Certificate
        </button>
    </div>
</section>

<!-- 15. PERFORMANCE TRACKING -->
<section id="tracking" class="content-section">
    <div class="card">
        <h3><i class="fas fa-chart-line"></i> Student Performance Tracking</h3>
        <div class="form-grid">
            <input type="text" id="perf-fetch-mobile" placeholder="Enter Student Mobile">
            <button class="btn-fetch" onclick="fetchPerformanceData()">Fetch Performance</button>
        </div>

        <hr style="margin: 20px 0;">

        <!-- Performance Dashboard (Hidden until fetched) -->
        <div id="performance-report-area" style="display: none;">
            <div class="form-grid">
                <div class="input-group"><label>Date Today</label><input type="text" id="perf-today" readonly></div>
                <div class="input-group"><label>Full Name</label><input type="text" id="perf-name" readonly></div>
                <div class="input-group"><label>Roll Number</label><input type="text" id="perf-roll" readonly></div>
                <div class="input-group"><label>Course</label><input type="text" id="perf-course" readonly></div>
                <div class="input-group"><label>Date of Joining</label><input type="text" id="perf-joining" readonly></div>
                <div class="input-group"><label>Course Duration</label><input type="text" id="perf-duration" readonly></div>
            </div>

            <div class="dashboard-stats" style="margin: 20px 0;">
                <div class="stat-card" style="border-bottom-color: #ff0000;">
                    <p>Days Absent (This Month)</p>
                    <h4 id="perf-absent">0</h4>
                </div>
                <div class="stat-card" style="border-bottom-color: #27ae60;">
                    <p>Attendance %</p>
                    <h4 id="perf-attendance-pct">0%</h4>
                </div>
            </div>

            <div class="card" style="background: #f0fffb; border: 1px solid var(--aquamarine);">
                <h4>Exam Scores & Grading</h4>
                <div class="form-grid">
                    <div class="input-group"><label>Total Marks Secured</label><input type="number" id="perf-marks" oninput="calculateAvgScore()"></div>
                    <div class="input-group"><label>Total No. of Exams</label><input type="number" id="perf-exam-count" oninput="calculateAvgScore()"></div>
                    <div class="input-group"><label>Average Score (%)</label><input type="text" id="perf-avg-display" readonly style="font-weight: bold; color: #007bff;"></div>
                    <div class="input-group"><label>Teacher's Name</label><input type="text" id="perf-teacher"></div>
                </div>
                <button class="btn-add" style="width: 100%; margin-top: 10px;" onclick="savePerformanceData()">Update Performance Record</button>
            </div>
        </div>
    </div>
</section>
        </main>
    </div>

    <footer>
        <div class="footer-grid">
            <div class="footer-col">
                <h4>Product</h4>
                <ul>
                    <li><a href="#">Features</a></li>
                    <li><a href="#">Pricing</a></li>
                    <li><a href="#">Demo</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Support</h4>
                <ul>
                    <li><a href="#">Help Center</a></li>
                    <li><a href="#">FAQs</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Company</h4>
                <ul>
                    <li><a href="#">About</a></li>
                    <li><a href="#">Blog</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Legal</h4>
                <ul>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms</a></li>
                    <li><a href="#">Disclaimer</a></li>
                    <li><a href="#">Refund Policy</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Social Media</h4>
                <ul>
                    <li><a href="#"><i class="fab fa-linkedin"></i> Linkedin</a></li>
                    <li><a href="#"><i class="fab fa-instagram"></i> Instagram</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Made in India <img src="https://upload.wikimedia.org/wikipedia/en/4/41/Flag_of_India.svg" class="india-flag" alt="India"> | Built for coaching institutes</p>
            <p>2026 ClassManager. All rights Reserved</p>
        </div>
    </footer>
<script>
/* ==========================================
   1. CORE INITIALIZATION
   ========================================== */
const _supabaseUrl = 'https://erzwijnlbnwjdlluvxyk.supabase.co';
const _supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyendpam5sYm53amRsbHV2eHlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNTkzMDgsImV4cCI6MjA4NjgzNTMwOH0.H8c9tT5HsxeL4xJAM9KrKmb1v6KKO8dZ-NOB-Pz2G2k';
const db =  supabase.createClient(_supabaseUrl, _supabaseKey);

let currentUser = null;

// Helper to get input values easily
const val = (id, selector) => {
    const el = document.querySelector(`${id} ${selector}`);
    if (!el) {
        console.warn(`Element ${id} ${selector} not found`);
        return ""; // Return empty string instead of crashing
    }
    return el.value;
};
/* ==========================================
   2. LOGIN SYSTEM (Signup, Login, Auth)
   ========================================== */
/* ==========================================
   UPDATED LOGIN & SIGNUP WITH VALIDATION
   ========================================== */

// 1. Toggle Password Visibility
function togglePass(id) {
    const el = document.getElementById(id);
    el.type = el.type === "password" ? "text" : "password";
}

// 2. Clear Form Data
function clearForm(formId) {
    const inputs = document.querySelectorAll(`#${formId} input, #${formId} select`);
    inputs.forEach(input => input.value = "");
}

// 3. Validation Helpers
function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function isValidMobile(mobile) {
    return /^[6-9]\d{9}$/.test(mobile); // Indian mobile starts with 6,7,8,9
}

// 4. Handle Signup
async function handleSignup() {
    const name = document.getElementById('sig-name').value.trim();
    const role = document.getElementById('sig-role').value;
    const email = document.getElementById('sig-email').value.trim();
    const pass = document.getElementById('sig-pass').value;
    const state = document.getElementById('sig-state').value;
    const mobile = document.getElementById('sig-mobile').value.trim();

    // Validations
    if (!name) return alert("Error: Please enter Full Name");
    if (!role) return alert("Error: Please select your Status (Role)");
    if (!isValidEmail(email)) return alert("Error: Please enter a valid Email ID");
    if (pass.length < 6) return alert("Error: Password must be at least 6 characters long");
    if (!state) return alert("Error: Please select your State/UT");
    if (!isValidMobile(mobile)) return alert("Error: Please enter a valid 10-digit Indian Mobile Number");

    const { data, error } = await db.auth.signUp({ email, password: pass });

    if (error) return alert("Signup Failed: " + error.message);

    if (data.user) {
        // Create Profile in DB
        const { error: profileError } = await db.from('profiles').insert([{ 
            id: data.user.id, 
            full_name: name, 
            email: email, 
            role: role, 
            mobile_number: mobile,
            state: state
        }]);

        if (profileError) alert("Profile Error: " + profileError.message);
        else {
            alert("Success! Account created. Please check your email for verification.");
            clearForm('signup-form');
        }
    }
}

// 5. Handle Login
async function handleLogin() {
    const role = document.getElementById('log-role').value;
    const email = document.getElementById('log-email').value.trim();
    const pass = document.getElementById('log-pass').value;

    if (!role || !email || !pass) return alert("Error: Please fill all login fields");
    if (!isValidEmail(email)) return alert("Error: Invalid Email format");

    const { data, error } = await db.auth.signInWithPassword({ email, password: pass });
    
    if (error) return alert("Login Failed: " + error.message);
    
    alert("Login Successful!");
    location.reload(); 
}
/* ==========================================
   3. STUDENT MANAGEMENT (Add, Edit, Fetch)
   ========================================== */
async function addStudent() {
    // 1. AUTO-GENERATE ROLL NUMBER (Format: IMS-Year-RandomNumber)
    const year = new Date().getFullYear();
    const randomSuffix = Math.floor(1000 + Math.random() * 9000);
    const autoRollNo = `IMS-${year}-${randomSuffix}`;

    // 2. Collect ALL Data (Ensuring Father/Mother/User_ID are included)
    const stuData = {
        full_name: document.getElementById('stu-name').value,
        mobile: document.getElementById('stu-mobile').value,
        father_mobile: document.getElementById('stu-father').value, // Fixed Null
        mother_mobile: document.getElementById('stu-mother').value, // Fixed Null
        standard: document.getElementById('stu-standard').value,
        course: document.getElementById('stu-course').value,
        batch_time: document.getElementById('stu-batch').value,
        total_fees: parseFloat(document.getElementById('stu-total').value) || 0,
        paid_amount: parseFloat(document.getElementById('stu-paid').value) || 0,
        admission_date: document.getElementById('stu-date').value,
        user_id: currentUser ? currentUser.id : null // Saves the ID of the Admin who added them
    };

    // 3. Save to 'students' table
    const { data: newStu, error: stuError } = await db.from('students').insert([stuData]).select();

    if (stuError) {
        console.error(stuError);
        return alert("Error: " + stuError.message);
    }

    // 4. Save to 'student_details' (Now with Auto-Generated Roll Number)
    if (newStu && newStu[0]) {
        const detailData = {
            student_id: newStu[0].id,
            roll_number: autoRollNo, // Use the generated number
            course_end_date: document.getElementById('stu-end-date').value
        };

        const { error: detailError } = await db.from('student_details').insert([detailData]);
        
        if (detailError) {
            alert("Basic info saved, but ID card details failed: " + detailError.message);
        } else {
            // Show the user the Roll Number they just got
            alert(`STUDENT SAVED SUCCESSFULLY!\nGenerated Roll No: ${autoRollNo}`);
            
            // Optional: Update the UI to show the new Roll Number
            if(document.getElementById('stu-roll')) {
                document.getElementById('stu-roll').value = autoRollNo;
            }
        }
    }
}
async function fetchStudentByMobile() {
    const mobile = val('#students', 'input[placeholder="Mobile"]');
    const { data, error } = await db.from('students').select('*').eq('mobile', mobile).single();
    if (data) {
        document.querySelector('#students input[placeholder="Full Name"]').value = data.full_name;
        document.querySelector('#students input[placeholder="Total Fees"]').value = data.total_fees;
        document.querySelector('#students input[placeholder="Paid Amount"]').value = data.paid_amount;
    } else alert("Not Found");
}

async function editStudent() {
    const mobile = val('#students', 'input[placeholder="Mobile"]');
    const { error } = await db.from('students').update({
        full_name: val('#students', 'input[placeholder="Full Name"]'),
        paid_amount: parseFloat(val('#students', 'input[placeholder="Paid Amount"]'))
    }).eq('mobile', mobile);
    if (error) alert(error.message); else alert("Updated!");
}

/* ==========================================
   4. FEE MANAGEMENT (Stats & Links)
   ========================================== */
/* ==========================================
   UPDATED FEE MANAGEMENT LOGIC
   ========================================== */

// 1. Calculate Pending Fee in Real-time
function calcPendingFee() {
    const total = parseFloat(document.getElementById('fee-total').value) || 0;
    const prevPaid = parseFloat(document.getElementById('fee-prev-paid').value) || 0;
    const nowPaying = parseFloat(document.getElementById('fee-paid-now').value) || 0;
    const pending = total - (prevPaid + nowPaying);
    document.getElementById('fee-pending').value = pending;
}

// 2. Fetch Student Fee Details by Roll
async function fetchFeeByRoll() {
    const roll = document.getElementById('fee-roll').value;
    if (!roll) return alert("Enter Roll Number");

    const { data, error } = await db.from('student_details')
        .select('roll_number, course_end_date, students(*)')
        .eq('roll_number', roll)
        .single();

    if (error || !data) return alert("Roll Number not found");

    const s = data.students;
    document.getElementById('fee-name').value = s.full_name;
    document.getElementById('fee-join-date').value = s.admission_date;
    document.getElementById('fee-course').value = s.course;
    document.getElementById('fee-total').value = s.total_fees;
    document.getElementById('fee-prev-paid').value = s.paid_amount;
    document.getElementById('fee-status').value = s.status || "Active";
    document.getElementById('fee-due-dates').value = s.due_dates || "";
    calcPendingFee();
}

// 3. Add or Edit Payment/Fee Details
async function saveFeeUpdate(mode) {
    const roll = document.getElementById('fee-roll').value;
    const nowPaying = parseFloat(document.getElementById('fee-paid-now').value) || 0;
    const totalFees = parseFloat(document.getElementById('fee-total').value) || 0;
    
    // Get current student ID
    const { data: detail } = await db.from('student_details').select('student_id').eq('roll_number', roll).single();
    if(!detail) return alert("Fetch student first");

    const newPaidTotal = parseFloat(document.getElementById('fee-prev-paid').value) + nowPaying;

    // A. Update Students Table
    const { error: upError } = await db.from('students').update({
        total_fees: totalFees,
        paid_amount: newPaidTotal,
        status: document.getElementById('fee-status').value,
        due_dates: document.getElementById('fee-due-dates').value
    }).eq('id', detail.student_id);

    if (upError) return alert(upError.message);

    // B. If adding a payment, record in history
    if (nowPaying > 0) {
        const payDate = document.getElementById('fee-today').value || new Date().toISOString().split('T')[0];
        const monthYear = new Date(payDate).toLocaleString('default', { month: 'long', year: 'numeric' });
        
        await db.from('payment_history').insert([{
            student_id: detail.student_id,
            roll_number: roll,
            amount: nowPaying,
            payment_date: payDate,
            month_year: monthYear
        }]);
    }

    alert("Fee Record Updated Successfully!");
    fetchFeeByRoll(); // Refresh UI
    loadFeesPortal(); // Refresh Portal
}

// 4. Load Fees Portal Statistics
async function loadFeesPortal() {
    const { data: students, error } = await db.from('students').select('*').eq('status', 'Active');
    if (error) return;

    const activeCount = students.length;
    const totalReceived = students.reduce((sum, s) => sum + (s.paid_amount || 0), 0);
    const totalPending = students.reduce((sum, s) => sum + ((s.total_fees - s.paid_amount) || 0), 0);

    document.getElementById('stat-active-count').innerText = activeCount;
    document.getElementById('stat-total-received').innerText = `â‚¹ ${totalReceived.toLocaleString()}`;
    document.getElementById('stat-total-pending').innerText = `â‚¹ ${totalPending.toLocaleString()}`;

    // Yearly Collection Logic
    const year = document.getElementById('portal-year').value;
    const { data: yearlyData } = await db.from('payment_history').select('amount').like('payment_date', `${year}%`);
    const yearlySum = yearlyData ? yearlyData.reduce((sum, p) => sum + (p.amount || 0), 0) : 0;
    document.getElementById('stat-yearly').innerText = `â‚¹ ${yearlySum.toLocaleString()}`;
}

// 5. Fetch Payment Log
async function fetchPaymentLog() {
    const roll = document.getElementById('log-roll').value;
    const monthVal = document.getElementById('log-month').value; // YYYY-MM
    if(!roll || !monthVal) return alert("Enter Roll No and Month");

    const dateObj = new Date(monthVal + "-01");
    const targetMonthYear = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    const { data, error } = await db.from('payment_history')
        .select('*')
        .eq('roll_number', roll)
        .eq('month_year', targetMonthYear);

    const logDiv = document.getElementById('log-result');
    if (data && data.length > 0) {
        let html = `<strong>Payments for ${targetMonthYear}:</strong><br>`;
        data.forEach(p => {
            html += `<span style="color:green;">âœ” â‚¹ ${p.amount}</span> paid on ${p.payment_date}<br>`;
        });
        logDiv.innerHTML = html;
    } else {
        logDiv.innerHTML = `<span style="color:red;">No payments found for this period.</span>`;
    }
}
/* ==========================================
   5. BATCH MANAGEMENT
   ========================================== */
async function addBatch() {
    await db.from('batches').insert([{
        batch_name: val('#batch', 'input[placeholder="Batch Name"]'),
        teacher_id: val('#batch', 'input[placeholder="Teacher ID"]'),
        batch_time: val('#batch', 'input[type="time"]')
    }]);
    alert("Batch Created");
}

async function fetchBatch() {
    const tID = val('#batch', 'input[placeholder="Teacher ID"]');
    const { data, error } = await db.from('batches').select('*').eq('teacher_id', tID).single();
    
    if (error) return alert("Batch not found for this Teacher ID");
    if (data) {
        document.querySelector('#batch input[placeholder="Batch Name"]').value = data.batch_name;
        document.querySelector('#batch input[type="time"]').value = data.batch_time;
        document.querySelector('#batch input[placeholder="Subject Name"]').value = data.subject_name;
        document.querySelector('#batch input[placeholder="Teacher Name"]').value = data.teacher_name;
        alert("Batch details loaded!");
    }
}

async function editBatch() {
    const tID = val('#batch', 'input[placeholder="Teacher ID"]');
    const updateData = {
        batch_name: val('#batch', 'input[placeholder="Batch Name"]'),
        batch_time: val('#batch', 'input[type="time"]'),
        subject_name: val('#batch', 'input[placeholder="Subject Name"]')
    };
    const { error } = await db.from('batches').update(updateData).eq('teacher_id', tID);
    if (error) alert(error.message); else alert("Batch Updated Successfully!");
}
/* ==========================================
   6. ATTENDANCE (Mark & Fetch)
   ========================================== */
/* ==========================================
   UPDATED ATTENDANCE LOGIC
   ========================================== */

// 1. Fetch Student Name using Roll Number for the UI
async function fetchStudentForAttn() {
    const roll = document.getElementById('attn-roll').value;
    if (!roll) return alert("Please enter a Roll Number");

    // Join student_details and students to get the name
    const { data, error } = await db
        .from('student_details')
        .select('students(full_name)')
        .eq('roll_number', roll)
        .single();

    if (error || !data) {
        alert("Roll Number not found!");
        document.getElementById('attn-name').value = "";
    } else {
        document.getElementById('attn-name').value = data.students.full_name;
    }
}

// 2. Trigger the calendar popup
let currentAttnStatus = "";
function triggerAttendance(status) {
    const name = document.getElementById('attn-name').value;
    if (!name) return alert("Please fetch a student by Roll Number first!");
    
    currentAttnStatus = status;
    const picker = document.getElementById('attn-date-picker');
    
    // Programmatically open the calendar
    picker.showPicker(); 
    
    // Listen for the date selection
    picker.onchange = async function() {
        if (this.value) {
            await saveAttendance(this.value, currentAttnStatus);
            this.value = ""; // reset
        }
    };
}

// 3. Save to Supabase
async function saveAttendance(dateValue, status) {
    const roll = document.getElementById('attn-roll').value;
    
    // Get student ID
    const { data: detail } = await db.from('student_details').select('student_id').eq('roll_number', roll).single();
    
    const monthYear = new Date(dateValue).toLocaleString('default', { month: 'long', year: 'numeric' });

    const { error } = await db.from('attendance').insert([{
        student_id: detail.student_id,
        roll_number: roll,
        attendance_date: dateValue,
        status: status,
        month_year: monthYear, // for old calendar compatibility
        user_id: currentUser.id // Admin/Teacher who marked it
    }]);

    if (error) alert("Error: " + error.message);
    else alert(`Success: Marked ${status} for ${dateValue}`);
}

// 4. Fetch Statistics via Prompt
async function fetchAttendanceByPrompt() {
    const roll = prompt("Enter Student Roll Number to fetch records:");
    if (!roll) return;

    const monthView = document.getElementById('attn-month-view').value; // e.g., "2026-03"
    if (!monthView) return alert("Please select a month in the 'View Monthly Record' field first.");

    // Format month for query
    const dateObj = new Date(monthView + "-01");
    const formattedMonth = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });

    // Fetch Present Count
    const { count: pCount } = await db.from('attendance')
        .select('*', { count: 'exact', head: true })
        .eq('roll_number', roll)
        .eq('month_year', formattedMonth)
        .eq('status', 'Present');

    // Fetch Absent Count
    const { count: aCount } = await db.from('attendance')
        .select('*', { count: 'exact', head: true })
        .eq('roll_number', roll)
        .eq('month_year', formattedMonth)
        .eq('status', 'Absent');

    // Update UI
    document.getElementById('attn-total-p').value = pCount || 0;
    document.getElementById('attn-total-a').value = aCount || 0;
    document.getElementById('attn-roll').value = roll;
    fetchStudentForAttn(); // Update name field too
    
    alert(`Stats for ${roll} in ${formattedMonth} updated.`);
}
/* ==========================================
   7. ADMIN DASHBOARD (Dynamic Counts)
   ========================================== */
async function loadDashboard() {
    const { data: students } = await db.from('students').select('*');
    document.querySelector('#admin .stat-card h4').innerText = students.length;
    // Repeat for revenue and pending by summing students data
}

/* ==========================================
   8. FEE REMINDER (SMS/WhatsApp)
   ========================================== */
async function sendReminder(type) {
    const { data } = await db.from('students').select('full_name, mobile, pending_amount').gt('pending_amount', 0);
    data.forEach(s => {
        const msg = `Hi ${s.full_name}, your pending fee is â‚¹${s.pending_amount}. Please pay ASAP.`;
        if (type === 'WA') window.open(`https://wa.me/${s.mobile}?text=${encodeURIComponent(msg)}`);
        else console.log("Sending SMS to " + s.mobile);
    });
}

/* ==========================================
   9. LEAD MANAGEMENT
   ========================================== */
async function addLead() {
    await db.from('leads').insert([{
        full_name: val('#leads', 'input[placeholder="Full Name"]'),
        contact: val('#leads', 'input[placeholder="Contact"]'),
        status: 'Follow up'
    }]);
    alert("Lead Added");
}
async function fetchLead() {
    const contact = val('#leads', 'input[placeholder="Contact"]');
    const { data, error } = await db.from('leads').select('*').eq('contact', contact).single();
    
    if (error) return alert("Lead not found");
    if (data) {
        document.querySelector('#leads input[placeholder="Full Name"]').value = data.full_name;
        document.querySelector('#leads input[placeholder="Interested Course"]').value = data.interested_course;
        document.querySelector('#leads select').value = "Status: " + data.status;
        alert("Lead details loaded!");
    }
}
/* ==========================================
   10. EXPENSE TRACKING (Add, Edit, Fetch)
   ========================================== */
// Function to calculate totals and profit
/* ==========================================
   EXPENSE LOGIC (MANUAL ENTRY)
   ========================================== */

async function calcExp() {
    // 1. Get Values from UI
    const feesColl = parseFloat(document.getElementById('exp-fees-coll').value) || 0;
    const otherInc = parseFloat(document.getElementById('exp-income').value) || 0;
    
    const rent = parseFloat(document.getElementById('exp-rent').value) || 0;
    const elec = parseFloat(document.getElementById('exp-elec').value) || 0;
    const maint = parseFloat(document.getElementById('exp-maint').value) || 0;
    const tSal = parseFloat(document.getElementById('exp-t-sal').value) || 0;
    const aSal = parseFloat(document.getElementById('exp-a-sal').value) || 0;
    const mark = parseFloat(document.getElementById('exp-mark').value) || 0;
    const otherExp = parseFloat(document.getElementById('exp-other').value) || 0;

    // 2. Calculation Formulas
    const totalExpenses = rent + elec + maint + tSal + aSal + mark + otherExp;
    const totalRevenue = feesColl + otherInc;
    const netProfit = totalRevenue - totalExpenses;

    // 3. Update UI Display
    document.getElementById('disp-fees').innerText = `â‚¹ ${feesColl.toFixed(2)}`;
    document.getElementById('disp-other-inc').innerText = `â‚¹ ${otherInc.toFixed(2)}`;
    document.getElementById('disp-total-exp').innerText = `â‚¹ ${totalExpenses.toFixed(2)}`;
    document.getElementById('disp-profit').innerText = `â‚¹ ${netProfit.toFixed(2)}`;
    
    document.getElementById('disp-profit').style.color = netProfit >= 0 ? "green" : "red";

    return { totalExpenses, totalRevenue, netProfit };
}

async function saveExpense() {
    const month = document.getElementById('exp-month').value;
    if (!month) return alert("Please select a month");

    const stats = await calcExp();

    const expData = {
        month_year: month,
        total_fees_manual: parseFloat(document.getElementById('exp-fees-coll').value) || 0,
        other_income: parseFloat(document.getElementById('exp-income').value) || 0,
        rent: parseFloat(document.getElementById('exp-rent').value) || 0,
        electricity: parseFloat(document.getElementById('exp-elec').value) || 0,
        maintenance: parseFloat(document.getElementById('exp-maint').value) || 0,
        teacher_salary: parseFloat(document.getElementById('exp-t-sal').value) || 0,
        admin_salary: parseFloat(document.getElementById('exp-a-sal').value) || 0,
        marketing: parseFloat(document.getElementById('exp-mark').value) || 0,
        other_exp: parseFloat(document.getElementById('exp-other').value) || 0,
        total_expenses: stats.totalExpenses,
        total_collection: stats.totalRevenue,
        net_profit: stats.netProfit
    };

    const { error } = await db.from('expenses').upsert(expData);
    
    if (error) {
        console.error(error);
        alert("Error: " + error.message);
    } else {
        alert("Record Saved Successfully!");
    }
}

async function fetchExpense() {
    const month = document.getElementById('exp-month').value;
    if (!month) return;

    const { data, error } = await db.from('expenses').select('*').eq('month_year', month).single();

    if (data) {
        document.getElementById('exp-fees-coll').value = data.total_fees_manual || 0;
        document.getElementById('exp-income').value = data.other_income || 0;
        document.getElementById('exp-rent').value = data.rent || 0;
        document.getElementById('exp-elec').value = data.electricity || 0;
        document.getElementById('exp-maint').value = data.maintenance || 0;
        document.getElementById('exp-t-sal').value = data.teacher_salary || 0;
        document.getElementById('exp-a-sal').value = data.admin_salary || 0;
        document.getElementById('exp-mark').value = data.marketing || 0;
        document.getElementById('exp-other').value = data.other_exp || 0;
    } else {
        // Reset inputs if no data for the month
        const ids = ['exp-fees-coll','exp-income','exp-rent','exp-elec','exp-maint','exp-t-sal','exp-a-sal','exp-mark','exp-other'];
        ids.forEach(id => document.getElementById(id).value = 0);
    }
    calcExp(); // Recalculate displays
}
/* ==========================================
   11. TEACHER PORTAL (Admin Side)
   ========================================== */
async function addTeacherDetails() {
    await db.from('teacher_details').insert([{
        id: val('#teacher', 'input[placeholder="Teacher ID"]'),
        qualification: val('#teacher', 'input[placeholder="Qualification"]'),
        salary_offered: val('#teacher', 'input[placeholder="Salary Offered"]')
    }]);
    alert("Teacher Profile Updated");
}
async function fetchTeacher() {
    const tID = val('#teacher', 'input[placeholder="Teacher ID"]');
    const { data, error } = await db.from('teacher_details').select('*').eq('id', tID).single();
    
    if (error) return alert("Teacher ID not found");
    if (data) {
        document.querySelector('#teacher input[placeholder="Teacher Name"]').value = data.teacher_name || "";
        document.querySelector('#teacher input[placeholder="Qualification"]').value = data.qualification;
        document.querySelector('#teacher input[placeholder="Salary Offered"]').value = data.salary_offered;
        document.querySelector('#teacher input[placeholder="Subject Taught"]').value = data.subject_taught;
        alert("Teacher profile loaded!");
    }
}

async function editTeacher() {
    const tID = val('#teacher', 'input[placeholder="Teacher ID"]');
    const updateData = {
        qualification: val('#teacher', 'input[placeholder="Qualification"]'),
        salary_offered: parseFloat(val('#teacher', 'input[placeholder="Salary Offered"]')),
        subject_taught: val('#teacher', 'input[placeholder="Subject Taught"]')
    };
    const { error } = await db.from('teacher_details').update(updateData).eq('id', tID);
    if (error) alert(error.message); else alert("Teacher Profile Updated!");
}
/* ==========================================
   12. STUDENT PORTAL (View Only)
   ========================================== */
async function loadStudentPortal() {
    const { data } = await db.from('student_portal_view').select('*').eq('user_id', currentUser.id).single();
    if (data) {
        const container = document.querySelector('#student-p .form-grid');
        container.innerHTML = `<p><b>Name:</b> ${data.full_name}</p><p><b>Pending:</b> â‚¹${data.total_fees_pending}</p>`;
    }
}

/* ==========================================
   13. GENERATORS (ID Card & Certificate)
   ========================================== */
/* ==========================================
   ID CARD GENERATION LOGIC
   ========================================== */
async function generateIDCard() {
    const mobile = document.getElementById('id-fetch-mobile').value;
    if(!mobile) return alert("Please enter a mobile number");

    // 1. Fetch Student Basic Data
    const { data: student, error: err1 } = await db.from('students').select('*').eq('mobile', mobile).single();
    if (err1 || !student) return alert("Student not found in admission records.");

    // 2. Fetch Student Extended Data (Roll No, End Date)
    const { data: details, error: err2 } = await db.from('student_details').select('*').eq('student_id', student.id).single();
    
    // 3. Fetch Institute Settings
    const { data: settings } = await db.from('institute_settings').select('*').limit(1).single();

    // 4. Update the Visual Card
    document.getElementById('card-inst-name').innerText = settings.institute_name;
    document.getElementById('card-branch-name').innerText = settings.branch_name;
    document.getElementById('card-student-name').innerText = student.full_name;
    document.getElementById('card-course').innerText = student.course;
    document.getElementById('card-batch').innerText = student.batch_time || "N/A";
    document.getElementById('card-roll').innerText = details ? details.roll_number : "---";
    document.getElementById('card-start').innerText = student.admission_date;
    document.getElementById('card-end').innerText = details ? details.course_end_date : "---";
    document.getElementById('card-sign-name').innerText = settings.authorised_signatory;

    // 5. Show the card area
    document.getElementById('id-card-preview-area').style.display = 'flex';
    document.getElementById('id-print-btn').style.display = 'block';
}

function printIDCard() {
    const cardContent = document.getElementById('id-card-visual').outerHTML;
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    printWindow.document.write(`
        <html>
            <head>
                <title>Print ID Card</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
                <style>
                    body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
                    @media print { .no-print { display: none; } }
                </style>
            </head>
            <body onload="window.print(); window.close();">
                ${cardContent}
            </body>
        </html>
    `);
    printWindow.document.close();
}

/* ==========================================
   CERTIFICATE GENERATION LOGIC
   ========================================== */
async function generateCertificate() {
    const mobile = document.getElementById('cert-fetch-mobile').value;
    if(!mobile) return alert("Please enter mobile number");

    // 1. Fetch Student Data
    const { data: student, error: err1 } = await db.from('students').select('*').eq('mobile', mobile).single();
    if (err1 || !student) return alert("Student not found.");

    // 2. Fetch Extended Details (Roll No & End Date)
    const { data: details } = await db.from('student_details').select('*').eq('student_id', student.id).single();
    if (!details) return alert("ID card details not found. Please save student management details first.");

    // 3. Fetch Institute Settings
    const { data: settings } = await db.from('institute_settings').select('*').limit(1).single();

    // 4. Generate or Fetch unique Certificate Number
    let certNo;
    const { data: existingCert } = await db.from('certificates').select('cert_number').eq('student_id', student.id).single();
    
    if (existingCert) {
        certNo = existingCert.cert_number;
    } else {
        const randomID = Math.floor(1000 + Math.random() * 9000);
        certNo = `IMS/CERT/${new Date().getFullYear()}/${randomID}`;
        // Save it so it never changes for this student
        await db.from('certificates').insert([{ student_id: student.id, cert_number: certNo }]);
    }

    // 5. Populate Template
    document.getElementById('cert-name').innerText = student.full_name;
    document.getElementById('cert-roll').innerText = details.roll_number;
    document.getElementById('cert-number').innerText = certNo;
    document.getElementById('cert-course').innerText = student.course;
    
    // Duration Logic
    const duration = `${student.admission_date} to ${details.course_end_date || 'Ongoing'}`;
    document.getElementById('cert-duration').innerText = duration;
    
    document.getElementById('cert-inst-branch').innerText = settings.branch_name;
    document.getElementById('cert-signatory').innerText = settings.authorised_signatory;

    // 6. Show Preview
    document.getElementById('cert-preview-area').style.display = 'flex';
    document.getElementById('cert-print-btn').style.display = 'block';
}

function printCertificate() {
    const content = document.getElementById('certificate-visual').outerHTML;
    const win = window.open('', '_blank', 'width=1000,height=800');
    win.document.write(`
        <html>
            <head>
                <title>IMS Certificate</title>
                <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
                <style>
                    body { margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
                    @media print { @page { size: landscape; margin: 0; } }
                </style>
            </head>
            <body onload="window.print(); window.close();">${content}</body>
        </html>
    `);
    win.document.close();
}

/* ==========================================
   14. PERFORMANCE TRACKING
   ========================================== */
/* ==========================================
   PERFORMANCE TRACKING LOGIC
   ========================================== */

// 1. Calculate Average Score Formula
function calculateAvgScore() {
    const marks = parseFloat(document.getElementById('perf-marks').value) || 0;
    const exams = parseInt(document.getElementById('perf-exam-count').value) || 0;
    
    if (exams > 0) {
        // Formula: (Marks / (Exams * 100)) * 100 -> Simplified: Marks / Exams
        const avg = (marks / exams).toFixed(2);
        document.getElementById('perf-avg-display').value = avg + "%";
    } else {
        document.getElementById('perf-avg-display').value = "0%";
    }
}

// 2. Fetch and Calculate All Data
async function fetchPerformanceData() {
    const mobile = document.getElementById('perf-fetch-mobile').value;
    if(!mobile) return alert("Please enter mobile number");

    // A. Fetch Basic & Extended Data
    const { data: student } = await db.from('students').select('*').eq('mobile', mobile).single();
    if (!student) return alert("Student not found.");

    const { data: details } = await db.from('student_details').select('*').eq('student_id', student.id).single();
    
    // B. Fetch Attendance for this month
    const now = new Date();
    const dayOfMonth = now.getDate();
    const monthYear = `${now.toLocaleString('default', { month: 'long' })} ${now.getFullYear()}`; // e.g. "February 2026"
    
    const { count: absentCount } = await db.from('attendance')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', student.user_id) // Assuming user_id is linked
        .eq('status', 'Absent')
        .eq('month_year', monthYear);

    // C. Fetch Saved Performance (if any)
    const { data: perfSaved } = await db.from('performance_tracking').select('*').eq('student_id', student.id).single();

    // D. Calculations
    const daysAbsent = absentCount || 0;
    const attendancePct = (((dayOfMonth - daysAbsent) / dayOfMonth) * 100).toFixed(2);

    // E. Populate UI
    document.getElementById('perf-today').value = now.toLocaleDateString();
    document.getElementById('perf-name').value = student.full_name;
    document.getElementById('perf-roll').value = details ? details.roll_number : "Not Assigned";
    document.getElementById('perf-course').value = student.course;
    document.getElementById('perf-joining').value = student.admission_date;
    document.getElementById('perf-duration').value = details ? details.course_duration : "N/A";
    
    document.getElementById('perf-absent').innerText = daysAbsent;
    document.getElementById('perf-attendance-pct').innerText = attendancePct + "%";

    if (perfSaved) {
        document.getElementById('perf-marks').value = perfSaved.total_marks_secured;
        document.getElementById('perf-exam-count').value = perfSaved.total_exams;
        document.getElementById('perf-teacher').value = perfSaved.teacher_name;
        calculateAvgScore();
    }

    document.getElementById('performance-report-area').style.display = 'block';
}

// 3. Save performance to database
async function savePerformanceData() {
    const mobile = document.getElementById('perf-fetch-mobile').value;
    if (!mobile) return alert("Please fetch a student first.");

    // 1. Get the student ID
    const { data: student, error: stuErr } = await db.from('students').select('id').eq('mobile', mobile).single();
    if (stuErr || !student) return alert("Student not found.");

    // 2. Prepare the data
    const updateData = {
        student_id: student.id,
        total_marks_secured: parseFloat(document.getElementById('perf-marks').value) || 0,
        total_exams: parseInt(document.getElementById('perf-exam-count').value) || 0,
        teacher_name: document.getElementById('perf-teacher').value,
        updated_at: new Date().toISOString() // Use ISO string for Supabase timestamps
    };

    // 3. Perform Upsert (This will now work because of the Unique Constraint)
    const { error } = await db
        .from('performance_tracking')
        .upsert(updateData, { 
            onConflict: 'student_id' 
        });

    if (error) {
        console.error("Supabase Error:", error);
        alert("Error saving: " + error.message);
    } else {
        alert("Performance record updated successfully!");
    }
}
/* ==========================================
   15. NAVIGATION & INIT
   ========================================== */
function showSection(id) {
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    // Auto-load data based on tab
    if (id === 'admin') loadDashboard();
    if (id === 'fee') loadFeeStats();
    if (id === 'student-p') loadStudentPortal();
}

// Initial check on load
// Initial check on load
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Use 'db' here, NOT 'supabase'
        const { data: { user } } = await db.auth.getUser();
        if (user) {
            currentUser = user;
            console.log("User detected:", user.email);
        }
    } catch (e) {
        console.log("No active session.");
    }
});




/* --- PWA INSTALL LOGIC WRAPPED IN DOM CONTENT LOADED --- */
document.addEventListener('DOMContentLoaded', () => {
    let deferredPrompt;
    const installBtn = document.getElementById('pwa-install-btn');

    // 1. Listen for the browser's install signal
    window.addEventListener('beforeinstallprompt', (e) => {
        // Stop the browser from showing its own small bar
        e.preventDefault();
        // Save the event so we can use it when the user clicks our button
        deferredPrompt = e;
        
        // Show our flamboyant install button
        if (installBtn) {
            installBtn.style.display = 'flex';
        }
    });

    // 2. Handle the click on our custom button
    if (installBtn) {
        installBtn.addEventListener('click', () => {
            if (deferredPrompt) {
                // Show the official prompt
                deferredPrompt.prompt();
                
                // See what the user chose
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User installed IMS');
                    }
                    // Hide our button regardless of choice
                    installBtn.style.display = 'none';
                    deferredPrompt = null;
                });
            }
        });
    }

    // 3. Hide button if already installed
    window.addEventListener('appinstalled', () => {
        if (installBtn) installBtn.style.display = 'none';
        deferredPrompt = null;
        console.log('IMS installed successfully');
    });
});
    </script>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
    .then(() => console.log("IMS Service Worker Registered"))
    .catch(err => console.log("Service Worker Failed", err));
}
</script>
<!-- PWA Install Button -->
<button id="pwa-install-btn" style="display: none;">
    <i class="fas fa-download"></i> INSTALL APP
</button>
</body>
</html>